{"pageProps":{"post":{"slug":"2019-08-08-autolock-with-yubikey","title":"Linux: Login/sudo with Yubikey","categories":["diary"],"image":"https://koka831.github.io/img/icon.png","tags":["Linux","udev","yubikey"],"content":"<h2 id=\"abstract\"><a href=\"#abstract\">Abstract</a></h2>\n<ul>\n<li>Linux Desktopのログイン時及び<code class=\"language-unknown\">sudo</code>時にYubikey + Passwordを必須にしてみた.</li>\n<li>ログインした状態でYubikeyを抜くとlockするようにした.</li>\n</ul>\n<h2 id=\"env\"><a href=\"#env\">Env</a></h2>\n<ul>\n<li>Ubuntu 18.04</li>\n<li>FIDO U2F Security Key(自分は<a href=\"https://www.amazon.co.jp/dp/B06XHTKFH3/ref=cm_sw_em_r_mt_dp_U_Ha5sDbS6H12P6\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">これ</a>つかってます. 端子ガードついてるKey他にも出てほしい)</li>\n</ul>\n<h2 id=\"install-dependencies\"><a href=\"#install-dependencies\">Install Dependencies</a></h2>\n<div class=\"remark-highlight\"><pre data-file=\"terminal\" class=\"language-shell-session\"><code class=\"language-shell-session\"><span class=\"token command\"><span class=\"token shell-symbol important\">$</span> <span class=\"token bash language-bash\"><span class=\"token function\">sudo</span> add-apt-repository ppa:yubico/stable</span></span>\n<span class=\"token command\"><span class=\"token shell-symbol important\">$</span> <span class=\"token bash language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> yubikey-manager-qt yubioath-desktop yubikey-personalization-gui</span></span>\n</code></pre></div>\n<h2 id=\"setup-u2f-key\"><a href=\"#setup-u2f-key\">Setup U2F Key</a></h2>\n<h3 id=\"u2f-keyの登録\"><a href=\"#u2f-key%E3%81%AE%E7%99%BB%E9%8C%B2\">U2F Keyの登録</a></h3>\n<div class=\"remark-highlight\"><pre data-file=\"terminal\" class=\"language-shell-session\"><code class=\"language-shell-session\"><span class=\"token command\"><span class=\"token shell-symbol important\">$</span> <span class=\"token bash language-bash\"><span class=\"token function\">mkdir</span> -p <span class=\"token environment constant\">$HOME</span>/.config/Yubico</span></span>\n<span class=\"token command\"><span class=\"token shell-symbol important\">$</span> <span class=\"token bash language-bash\">pamu2fcfg -u<span class=\"token variable\">${<span class=\"token environment constant\">USER</span>}</span> <span class=\"token operator\">></span> <span class=\"token environment constant\">$HOME</span>/.config/Yubico/u2f_keys</span></span>\n</code></pre></div>\n<p>またバックアップデバイスを追加する場合には<code class=\"language-unknown\">--nouser</code>をつけて追記<sup id=\"fnref-pamu2fcfg\"><a href=\"#fn-pamu2fcfg\" class=\"footnote-ref\">pamu2fcfg</a></sup>.</p>\n<div class=\"remark-highlight\"><pre data-file=\"terminal\" class=\"language-shell-session\"><code class=\"language-shell-session\"><span class=\"token command\"><span class=\"token shell-symbol important\">$</span> <span class=\"token bash language-bash\">pamu2fcfg -n <span class=\"token operator\">>></span> <span class=\"token environment constant\">$HOME</span>/.config/Yubico/u2f_keys</span></span>\n</code></pre></div>\n<h3 id=\"u2f-for-sudo\"><a href=\"#u2f-for-sudo\">U2F for SUDO</a></h3>\n<p>以下の6行目を追記. PAM(Pluggable Authentication Modules)での認証において，password入力後にYubikeyがrequireされるようになる(Yubikeyが無いとauthできない).</p>\n<p><strong><code class=\"language-unknown\">/etc/pam.d/sudo</code></strong></p>\n<div class=\"remark-highlight\"><pre data-file=\"/etc/pam.d/sudo\" class=\"language-diff\"><code class=\"language-diff\"><span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span>#%PAM-1.0\n</span>\n<span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span>session    required    pam_env.so readenv=1 user_readenv=0\n<span class=\"token prefix unchanged\"> </span>session    required    pam_env.so readenv=1 envfile=/etc/default/locale user_readenv=0\n<span class=\"token prefix unchanged\"> </span>@include   common-auth\n</span><span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span>auth       required    pam_u2f.so\n</span><span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span>@include   common-account\n<span class=\"token prefix unchanged\"> </span>@include   common-session-noninteractive</span>\n</code></pre></div>\n<h3 id=\"u2f-for-login\"><a href=\"#u2f-for-login\">U2F for Login</a></h3>\n<p>Display ManagerにGDM(Gnome Display Manager)を用いている場合は以下のファイルに<code class=\"language-unknown\">pam_u2f.so</code>の行を追記する.<br>\n<strong><code class=\"language-unknown\">/etc/pam.d/gdm-password</code></strong>\nその他のDMを用いている場合(KDE等)は <strong><code class=\"language-unknown\">/etc/pam.d/lightdm</code></strong> に追記する.</p>\n<div class=\"remark-highlight\"><pre data-file=\"/etc/pam.d/gdm-password\" class=\"language-diff\"><code class=\"language-diff\"><span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span>#%PAM-1.0\n<span class=\"token prefix unchanged\"> </span>auth     requisite       pam_nologin.so\n<span class=\"token prefix unchanged\"> </span>auth     required        pam_succeed_if.so user != root quiet_success\n<span class=\"token prefix unchanged\"> </span>@include common-auth\n</span><span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span>auth     required        pam_u2f.so\n</span><span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span>auth     optional        pam_gnome_keyring.so\n<span class=\"token prefix unchanged\"> </span>@include common-account\n<span class=\"token prefix unchanged\"> </span>...omit</span>\n</code></pre></div>\n<h2 id=\"auto-lock-without-u2f\"><a href=\"#auto-lock-without-u2f\">Auto-lock without U2F</a></h2>\n<p>ここからが本題. U2F Keyの接続が解除されると端末をロックする.</p>\n<p>もともと自分の使っているLaptopには指紋認証センサが付属している．一般に生体認証はU2Fよりもセキュアであるし，自分も異論はない.<br>\nではU2Fが生体認証より優れている点はなにか. 自分の答えは認証の持続性をコントロールできる点である.</p>\n<p>指紋認証を例に取ると，一度ログインした端末は一定時間操作をしない際のオートロックまたはユーザ自身の能動的なログアウトをしない限り，認証を再度必要としない.<br>\n対してU2Fでは<strong>デバイスが接続されている間だけ認証されている</strong>という状態をもたらすことができる.</p>\n<p>Apple Watchを身に着けた状態でMacの自動ログインが可能<sup id=\"fnref-applewatch\"><a href=\"#fn-applewatch\" class=\"footnote-ref\">applewatch</a></sup>という例がある.\nこれはbluetooth接続したU2Fデバイスが一定距離離れるもしくはUSB接続したデバイスをejectすることで端末からログアウトする，という仕様で再現できる.</p>\n<h3 id=\"monitoring-u2f-key-by-udev\"><a href=\"#monitoring-u2f-key-by-udev\">monitoring U2F key by udev</a></h3>\n<p>U2F Keyモニターをudevに任せることにする. まず対象のIDを特定する.\n<code class=\"language-unknown\">udevadm monitor</code>でudevのイベントをモニタリングした状態でU2F Keyを抜き差しすると <code class=\"language-unknown\">bind</code>, <code class=\"language-unknown\">remove</code> イベントが通知されるので， <code class=\"language-unknown\">$ID_MODEL_ID</code> 及び <code class=\"language-unknown\">$ID_VENDOR_ID</code> を取得する.</p>\n<div class=\"remark-highlight\"><pre data-file=\"terminal\" class=\"language-shell-session\"><code class=\"language-shell-session\"><span class=\"token command\"><span class=\"token shell-symbol important\">$</span> <span class=\"token bash language-bash\">udevadm monitor --environment --udev</span></span>\n\n<span class=\"token output\">UDEV  [28028.490650] bind     /devices/pci0000:00/0000:00:14.0/usb1/1-3 (usb)</span>\n<span class=\"token output\">ACTION=bind</span>\n<span class=\"token output\">BUSNUM=001</span>\n<span class=\"token output\">DEVNAME=/dev/bus/usb/001/013</span>\n<span class=\"token output\">DEVNUM=013</span>\n<span class=\"token output\">DEVPATH=/devices/pci0000:00/0000:00:14.0/usb1/1-3</span>\n<span class=\"token output\">DEVTYPE=usb_device</span>\n<span class=\"token output\">DRIVER=usb</span>\n<span class=\"token output\">ID_BUS=usb</span>\n<span class=\"token output\">ID_MODEL=XXXXX</span>\n<span class=\"token output\">ID_MODEL_ENC=XXXXX</span>\n<span class=\"token output\">ID_MODEL_ID=f025</span>\n<span class=\"token output\">ID_REVISION=0100</span>\n<span class=\"token output\">ID_SERIAL=ExcelSecu_EsecuFIDO_HID</span>\n<span class=\"token output\">ID_USB_INTERFACES=:030000:</span>\n<span class=\"token output\">ID_VENDOR=ExcelSecu</span>\n<span class=\"token output\">ID_VENDOR_ENC=ExcelSecu</span>\n<span class=\"token output\">ID_VENDOR_ID=1ea8</span>\n<span class=\"token output\">MAJOR=189</span>\n<span class=\"token output\">MINOR=12</span>\n<span class=\"token output\">PRODUCT=1ea8/f025/100</span>\n<span class=\"token output\">SEQNUM=12938</span>\n<span class=\"token output\">SUBSYSTEM=usb</span>\n<span class=\"token output\">TYPE=0/0/0</span>\n<span class=\"token output\">USEC_INITIALIZED=28027949334</span>\n</code></pre></div>\n<p>上記の例では <code class=\"language-unknown\">ID_MODEL_ID=f025</code>，<code class=\"language-unknown\">ID_VENDOR_ID=1ea8</code> となっている.\nこのIDペアを用いて，U2F Key解除時の<code class=\"language-unknown\">udev</code>ルールを作成する.</p>\n<p><strong><code class=\"language-unknown\">/etc/udev/rules.d/xx-u2fkey.rules</code></strong> (xxは適当な数字)</p>\n<div class=\"remark-highlight\"><pre data-file=\"/etc/udev/rules.d/xx-u2fkey.rules\" class=\"language-config\"><code class=\"language-config\">ACTION==&#x26;quot;remove&#x26;quot;, ENV{ID_VENDOR_ID}==&#x26;quot;1ea8&#x26;quot;, ENV{ID_MODEL_ID}==&#x26;quot;f025&#x26;quot;, RUN+=&#x26;quot;/usr/local/bin/i3lock&#x26;quot;</code></pre></div>\n<p>最後にrulesを登録し完了.</p>\n<div class=\"remark-highlight\"><pre data-file=\"terminal\" class=\"language-shell-session\"><code class=\"language-shell-session\"><span class=\"token command\"><span class=\"token shell-symbol important\">$</span> <span class=\"token bash language-bash\">udevadm control --reload-rules</span></span>\n<span class=\"token command\"><span class=\"token shell-symbol important\">$</span> <span class=\"token bash language-bash\"><span class=\"token function\">service</span> udev reload</span></span>\n</code></pre></div>\n<hr>\n<p>フリーランスという職業柄，PCを所持して企業へ出向くことが多くどうやってセキュリティ担保するかなーと考えてたところ<code class=\"language-unknown\">pamu2fcfg</code>を見かけたので試してみた.<br>\nYubikeyを忘れて外出するという失態を犯した<sup id=\"fnref-twi\"><a href=\"#fn-twi\" class=\"footnote-ref\">twi</a></sup>ので既に運用が危ういがデータは守れてるのでよし(よくないが)</p>\n<h2 id=\"reference\"><a href=\"#reference\">Reference</a></h2>\n<ul>\n<li><a href=\"https://wiki.gentoo.org/wiki/Pam_u2f\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Enable FIDO U2F USB support</a></li>\n<li><a href=\"https://support.yubico.com/support/solutions/articles/15000010964-enabling-the-yubico-ppa-on-ubuntu\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">support.yubico.com#enabling the Yubico PPA on Ubuntu</a></li>\n<li><a href=\"https://support.yubico.com/support/solutions/articles/15000011356-ubuntu-linux-login-guide-u2f\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">support.yubico.com#Ubuntu Linux Login Guide - U2F</a></li>\n</ul>\n<div class=\"footnotes\">\n<hr>\n<ol>\n<li id=\"fn-pamu2fcfg\"><a href=\"https://developers.yubico.com/pam-u2f/Manuals/pamu2fcfg.1.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">developers.yubico.com/pam-u2f/Manuals/pamu2fcfg.1.html</a><a href=\"#fnref-pamu2fcfg\" class=\"footnote-backref\">↩</a></li>\n<li id=\"fn-applewatch\"><a href=\"https://support.apple.com/ja-jp/HT206995\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">support.apple.com/ja-jp/HT206995</a><a href=\"#fnref-applewatch\" class=\"footnote-backref\">↩</a></li>\n<li id=\"fn-twi\"><a href=\"https://twitter.com/k_0ka/status/1159312312156561408\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">twitter.com/k_0ka/status/1159312312156561408</a><a href=\"#fnref-twi\" class=\"footnote-backref\">↩</a></li>\n</ol>\n</div>","description":"Yubikeyを自宅に忘れて１敗","commits":[{"title":"update","date":"2021-04-10 17:49:51","hash":"7fc1fe90","diff":"<div class=\"remark-highlight\"><pre data-file=\"7fc1fe90.patch\" class=\"language-git  language-diff\"><code class=\"language-git\"><span class=\"token commit-sha1\">commit 7fc1fe9095a4a16d5b29f42b7ce90933aa17d91e</span>\nAuthor: koka &#x26;<a href=\"mailto:lt;koka.code@gmail.com\" class=\"token email-link\">lt;koka.code@gmail.com</a>&#x26;gt;\nDate:   Sat Apr 10 17:49:51 2021 +0900\n\n  update\n\ndiff --git a/_posts/2019-08-08-autolock-with-yubikey.md b/_posts/2019-08-08-autolock-with-yubikey.md\nindex f40e591..e3bfc43 100644\n<span class=\"token deleted\">--- a/_posts/2019-08-08-autolock-with-yubikey.md</span>\n<span class=\"token inserted\">+++ b/_posts/2019-08-08-autolock-with-yubikey.md</span>\n@@ -20,7 +20,7 @@ description: Yubikeyを自宅に忘れて１敗\n\n<span class=\"token comment\">## Install Dependencies</span>\n\n<span class=\"token deleted\">-\\```sh</span>\n<span class=\"token inserted\">+\\```shell-session[data-file=\"terminal\"]</span>\n$ sudo add-apt-repository ppa:yubico/stable\n$ sudo apt-get install yubikey-manager-qt yubioath-desktop yubikey-personalization-gui\n\\```\n@@ -28,14 +28,14 @@ $ sudo apt-get install yubikey-manager-qt yubioath-desktop yubikey-personalizati\n<span class=\"token comment\">## Setup U2F Key</span>\n<span class=\"token comment\">### U2F Keyの登録</span>\n\n<span class=\"token deleted\">-\\```sh</span>\n<span class=\"token inserted\">+\\```shell-session[data-file=\"terminal\"]</span>\n$ mkdir -p $HOME/.config/Yubico\n$ pamu2fcfg -u${USER} &#x26;gt; $HOME/.config/Yubico/u2f_keys\n\\```\n\nまたバックアップデバイスを追加する場合には`--nouser`をつけて追記[^pamu2fcfg].\n\n<span class=\"token deleted\">-\\```sh</span>\n<span class=\"token inserted\">+\\```shell-session[data-file=\"terminal\"]</span>\n$ pamu2fcfg -n &#x26;gt;&#x26;gt; $HOME/.config/Yubico/u2f_keys\n\\```\n\n@@ -44,7 +44,7 @@ $ pamu2fcfg -n &#x26;gt;&#x26;gt; $HOME/.config/Yubico/u2f_keys\n\n**`/etc/pam.d/sudo`**\n\n<span class=\"token deleted\">-\\```diff</span>\n<span class=\"token inserted\">+\\```diff[data-file=\"/etc/pam.d/sudo\"]</span>\n<span class=\"token comment\">#%PAM-1.0</span>\n\nsession    required    pam_env.so readenv=1 user_readenv=0\n@@ -61,7 +61,7 @@ Display ManagerにGDM(Gnome Display Manager)を用いている場合は以下の\nその他のDMを用いている場合(KDE等)は **`/etc/pam.d/lightdm`** に追記する.\n\n\n<span class=\"token deleted\">-\\```diff</span>\n<span class=\"token inserted\">+\\```diff[data-file=\"/etc/pam.d/gdm-password\"]</span>\n<span class=\"token comment\">#%PAM-1.0</span>\nauth     requisite       pam_nologin.so\nauth     required        pam_succeed_if.so user != root quiet_success\n@@ -88,7 +88,7 @@ Apple Watchを身に着けた状態でMacの自動ログインが可能[^applewa\nU2F Keyモニターをudevに任せることにする. まず対象のIDを特定する.\n`udevadm monitor`でudevのイベントをモニタリングした状態でU2F Keyを抜き差しすると `bind`, `remove` イベントが通知されるので， `$ID_MODEL_ID` 及び `$ID_VENDOR_ID` を取得する.\n\n<span class=\"token deleted\">-\\```sh</span>\n<span class=\"token inserted\">+\\```shell-session[data-file=\"terminal\"]</span>\n$ udevadm monitor --environment --udev\n\nUDEV  [28028.490650] bind     /devices/pci0000:00/0000:00:14.0/usb1/1-3 (usb)\n@@ -123,13 +123,13 @@ USEC_INITIALIZED=28027949334\n\n**`/etc/udev/rules.d/xx-u2fkey.rules`** (xxは適当な数字)\n\n<span class=\"token deleted\">-\\```config</span>\n<span class=\"token inserted\">+\\```config[data-file=\"/etc/udev/rules.d/xx-u2fkey.rules\"]</span>\nACTION==<span class=\"token string\">\"remove\"</span>, ENV{ID_VENDOR_ID}==<span class=\"token string\">\"1ea8\"</span>, ENV{ID_MODEL_ID}==<span class=\"token string\">\"f025\"</span>, RUN+=<span class=\"token string\">\"/usr/local/bin/i3lock\"</span>\n\\```\n\n最後にrulesを登録し完了.\n\n<span class=\"token deleted\">-\\```sh</span>\n<span class=\"token inserted\">+\\```shell-session[data-file=\"terminal\"]</span>\n$ udevadm control --reload-rules\n$ service udev reload\n\\```\n</code></pre></div>"},{"title":"copy md","date":"2021-01-30 22:18:17","hash":"35b550ae","diff":"<div class=\"remark-highlight\"><pre data-file=\"35b550ae.patch\" class=\"language-git  language-diff\"><code class=\"language-git\"><span class=\"token commit-sha1\">commit 35b550ae83af4efaeadf33471c8ca8a32c1079c8</span>\nAuthor: koka &#x26;<a href=\"mailto:lt;koka.code@gmail.com\" class=\"token email-link\">lt;koka.code@gmail.com</a>&#x26;gt;\nDate:   Sat Jan 30 22:18:17 2021 +0900\n\n  copy md\n\ndiff --git a/_posts/2019-08-08-autolock-with-yubikey.md b/_posts/2019-08-08-autolock-with-yubikey.md\nnew file mode 100644\nindex 0000000..f40e591\n<span class=\"token deleted\">--- /dev/null</span>\n<span class=\"token inserted\">+++ b/_posts/2019-08-08-autolock-with-yubikey.md</span>\n<span class=\"token coord\">@@ -0,0 +1,148 @@</span>\n<span class=\"token inserted\">+---</span>\n<span class=\"token inserted\">+title: 'Linux: Login/sudo with Yubikey'</span>\n<span class=\"token inserted\">+date: 2019-08-08</span>\n<span class=\"token inserted\">+categories:</span>\n<span class=\"token inserted\">+- diary</span>\n<span class=\"token inserted\">+tags:</span>\n<span class=\"token inserted\">+- Linux</span>\n<span class=\"token inserted\">+- udev</span>\n<span class=\"token inserted\">+- yubikey</span>\n<span class=\"token inserted\">+description: Yubikeyを自宅に忘れて１敗</span>\n<span class=\"token inserted\">+---</span>\n<span class=\"token inserted\">+</span>\n<span class=\"token inserted\">+## Abstract</span>\n<span class=\"token inserted\">+- Linux Desktopのログイン時及び`sudo`時にYubikey + Passwordを必須にしてみた.</span>\n<span class=\"token inserted\">+- ログインした状態でYubikeyを抜くとlockするようにした.</span>\n<span class=\"token inserted\">+</span>\n<span class=\"token inserted\">+## Env</span>\n<span class=\"token inserted\">+- Ubuntu 18.04</span>\n<span class=\"token inserted\">+- FIDO U2F Security Key(自分は[これ](https://www.amazon.co.jp/dp/B06XHTKFH3/ref=cm_sw_em_r_mt_dp_U_Ha5sDbS6H12P6)つかってます. 端子ガードついてるKey他にも出てほしい)</span>\n<span class=\"token inserted\">+</span>\n<span class=\"token inserted\">+## Install Dependencies</span>\n<span class=\"token inserted\">+</span>\n<span class=\"token inserted\">+\\```sh</span>\n<span class=\"token inserted\">+$ sudo add-apt-repository ppa:yubico/stable</span>\n<span class=\"token inserted\">+$ sudo apt-get install yubikey-manager-qt yubioath-desktop yubikey-personalization-gui</span>\n<span class=\"token inserted\">+\\```</span>\n<span class=\"token inserted\">+</span>\n<span class=\"token inserted\">+## Setup U2F Key</span>\n<span class=\"token inserted\">+### U2F Keyの登録</span>\n<span class=\"token inserted\">+</span>\n<span class=\"token inserted\">+\\```sh</span>\n<span class=\"token inserted\">+$ mkdir -p $HOME/.config/Yubico</span>\n<span class=\"token inserted\">+$ pamu2fcfg -u${USER} &#x26;gt; $HOME/.config/Yubico/u2f_keys</span>\n<span class=\"token inserted\">+\\```</span>\n<span class=\"token inserted\">+</span>\n<span class=\"token inserted\">+またバックアップデバイスを追加する場合には`--nouser`をつけて追記[^pamu2fcfg].</span>\n<span class=\"token inserted\">+</span>\n<span class=\"token inserted\">+\\```sh</span>\n<span class=\"token inserted\">+$ pamu2fcfg -n &#x26;gt;&#x26;gt; $HOME/.config/Yubico/u2f_keys</span>\n<span class=\"token inserted\">+\\```</span>\n<span class=\"token inserted\">+</span>\n<span class=\"token inserted\">+### U2F for SUDO</span>\n<span class=\"token inserted\">+以下の6行目を追記. PAM(Pluggable Authentication Modules)での認証において，password入力後にYubikeyがrequireされるようになる(Yubikeyが無いとauthできない).</span>\n<span class=\"token inserted\">+</span>\n<span class=\"token inserted\">+**`/etc/pam.d/sudo`**</span>\n<span class=\"token inserted\">+</span>\n<span class=\"token inserted\">+\\```diff</span>\n<span class=\"token inserted\">+ #%PAM-1.0</span>\n<span class=\"token inserted\">+</span>\n<span class=\"token inserted\">+ session    required    pam_env.so readenv=1 user_readenv=0</span>\n<span class=\"token inserted\">+ session    required    pam_env.so readenv=1 envfile=/etc/default/locale user_readenv=0</span>\n<span class=\"token inserted\">+ @include   common-auth</span>\n<span class=\"token inserted\">++auth       required    pam_u2f.so</span>\n<span class=\"token inserted\">+ @include   common-account</span>\n<span class=\"token inserted\">+ @include   common-session-noninteractive</span>\n<span class=\"token inserted\">+\\```</span>\n<span class=\"token inserted\">+</span>\n<span class=\"token inserted\">+### U2F for Login</span>\n<span class=\"token inserted\">+Display ManagerにGDM(Gnome Display Manager)を用いている場合は以下のファイルに`pam_u2f.so`の行を追記する.  </span>\n<span class=\"token inserted\">+**`/etc/pam.d/gdm-password`**</span>\n<span class=\"token inserted\">+その他のDMを用いている場合(KDE等)は **`/etc/pam.d/lightdm`** に追記する.</span>\n<span class=\"token inserted\">+</span>\n<span class=\"token inserted\">+</span>\n<span class=\"token inserted\">+\\```diff</span>\n<span class=\"token inserted\">+ #%PAM-1.0</span>\n<span class=\"token inserted\">+ auth     requisite       pam_nologin.so</span>\n<span class=\"token inserted\">+ auth     required        pam_succeed_if.so user != root quiet_success</span>\n<span class=\"token inserted\">+ @include common-auth</span>\n<span class=\"token inserted\">++auth     required        pam_u2f.so</span>\n<span class=\"token inserted\">+ auth     optional        pam_gnome_keyring.so</span>\n<span class=\"token inserted\">+ @include common-account</span>\n<span class=\"token inserted\">+ ...omit</span>\n<span class=\"token inserted\">+\\```</span>\n<span class=\"token inserted\">+</span>\n<span class=\"token inserted\">+## Auto-lock without U2F</span>\n<span class=\"token inserted\">+ここからが本題. U2F Keyの接続が解除されると端末をロックする.  </span>\n<span class=\"token inserted\">+</span>\n<span class=\"token inserted\">+もともと自分の使っているLaptopには指紋認証センサが付属している．一般に生体認証はU2Fよりもセキュアであるし，自分も異論はない.  </span>\n<span class=\"token inserted\">+ではU2Fが生体認証より優れている点はなにか. 自分の答えは認証の持続性をコントロールできる点である.  </span>\n<span class=\"token inserted\">+</span>\n<span class=\"token inserted\">+指紋認証を例に取ると，一度ログインした端末は一定時間操作をしない際のオートロックまたはユーザ自身の能動的なログアウトをしない限り，認証を再度必要としない.  </span>\n<span class=\"token inserted\">+対してU2Fでは**デバイスが接続されている間だけ認証されている**という状態をもたらすことができる.</span>\n<span class=\"token inserted\">+</span>\n<span class=\"token inserted\">+Apple Watchを身に着けた状態でMacの自動ログインが可能[^applewatch]という例がある.</span>\n<span class=\"token inserted\">+これはbluetooth接続したU2Fデバイスが一定距離離れるもしくはUSB接続したデバイスをejectすることで端末からログアウトする，という仕様で再現できる.</span>\n<span class=\"token inserted\">+</span>\n<span class=\"token inserted\">+### monitoring U2F key by udev</span>\n<span class=\"token inserted\">+U2F Keyモニターをudevに任せることにする. まず対象のIDを特定する.</span>\n<span class=\"token inserted\">+`udevadm monitor`でudevのイベントをモニタリングした状態でU2F Keyを抜き差しすると `bind`, `remove` イベントが通知されるので， `$ID_MODEL_ID` 及び `$ID_VENDOR_ID` を取得する.</span>\n<span class=\"token inserted\">+</span>\n<span class=\"token inserted\">+\\```sh</span>\n<span class=\"token inserted\">+$ udevadm monitor --environment --udev</span>\n<span class=\"token inserted\">+</span>\n<span class=\"token inserted\">+UDEV  [28028.490650] bind     /devices/pci0000:00/0000:00:14.0/usb1/1-3 (usb)</span>\n<span class=\"token inserted\">+ACTION=bind</span>\n<span class=\"token inserted\">+BUSNUM=001</span>\n<span class=\"token inserted\">+DEVNAME=/dev/bus/usb/001/013</span>\n<span class=\"token inserted\">+DEVNUM=013</span>\n<span class=\"token inserted\">+DEVPATH=/devices/pci0000:00/0000:00:14.0/usb1/1-3</span>\n<span class=\"token inserted\">+DEVTYPE=usb_device</span>\n<span class=\"token inserted\">+DRIVER=usb</span>\n<span class=\"token inserted\">+ID_BUS=usb</span>\n<span class=\"token inserted\">+ID_MODEL=XXXXX</span>\n<span class=\"token inserted\">+ID_MODEL_ENC=XXXXX</span>\n<span class=\"token inserted\">+ID_MODEL_ID=f025</span>\n<span class=\"token inserted\">+ID_REVISION=0100</span>\n<span class=\"token inserted\">+ID_SERIAL=ExcelSecu_EsecuFIDO_HID</span>\n<span class=\"token inserted\">+ID_USB_INTERFACES=:030000:</span>\n<span class=\"token inserted\">+ID_VENDOR=ExcelSecu</span>\n<span class=\"token inserted\">+ID_VENDOR_ENC=ExcelSecu</span>\n<span class=\"token inserted\">+ID_VENDOR_ID=1ea8</span>\n<span class=\"token inserted\">+MAJOR=189</span>\n<span class=\"token inserted\">+MINOR=12</span>\n<span class=\"token inserted\">+PRODUCT=1ea8/f025/100</span>\n<span class=\"token inserted\">+SEQNUM=12938</span>\n<span class=\"token inserted\">+SUBSYSTEM=usb</span>\n<span class=\"token inserted\">+TYPE=0/0/0</span>\n<span class=\"token inserted\">+USEC_INITIALIZED=28027949334</span>\n<span class=\"token inserted\">+\\```</span>\n<span class=\"token inserted\">+</span>\n<span class=\"token inserted\">+上記の例では `ID_MODEL_ID=f025`，`ID_VENDOR_ID=1ea8` となっている.</span>\n<span class=\"token inserted\">+このIDペアを用いて，U2F Key解除時の`udev`ルールを作成する.</span>\n<span class=\"token inserted\">+</span>\n<span class=\"token inserted\">+**`/etc/udev/rules.d/xx-u2fkey.rules`** (xxは適当な数字)</span>\n<span class=\"token inserted\">+</span>\n<span class=\"token inserted\">+\\```config</span>\n<span class=\"token inserted\">+ACTION==\"remove\", ENV{ID_VENDOR_ID}==\"1ea8\", ENV{ID_MODEL_ID}==\"f025\", RUN+=\"/usr/local/bin/i3lock\"</span>\n<span class=\"token inserted\">+\\```</span>\n<span class=\"token inserted\">+</span>\n<span class=\"token inserted\">+最後にrulesを登録し完了.</span>\n<span class=\"token inserted\">+</span>\n<span class=\"token inserted\">+\\```sh</span>\n<span class=\"token inserted\">+$ udevadm control --reload-rules</span>\n<span class=\"token inserted\">+$ service udev reload</span>\n<span class=\"token inserted\">+\\```</span>\n<span class=\"token inserted\">+</span>\n<span class=\"token inserted\">+---</span>\n<span class=\"token inserted\">+フリーランスという職業柄，PCを所持して企業へ出向くことが多くどうやってセキュリティ担保するかなーと考えてたところ`pamu2fcfg`を見かけたので試してみた.  </span>\n<span class=\"token inserted\">+Yubikeyを忘れて外出するという失態を犯した[^twi]ので既に運用が危ういがデータは守れてるのでよし(よくないが)</span>\n<span class=\"token inserted\">+</span>\n<span class=\"token inserted\">+</span>\n<span class=\"token inserted\">+## Reference</span>\n<span class=\"token inserted\">+[^pamu2fcfg]: [developers.yubico.com/pam-u2f/Manuals/pamu2fcfg.1.html](https://developers.yubico.com/pam-u2f/Manuals/pamu2fcfg.1.html)</span>\n<span class=\"token inserted\">+[^applewatch]: [support.apple.com/ja-jp/HT206995](https://support.apple.com/ja-jp/HT206995)</span>\n<span class=\"token inserted\">+[^twi]: [twitter.com/k_0ka/status/1159312312156561408](https://twitter.com/k_0ka/status/1159312312156561408)</span>\n<span class=\"token inserted\">+- [Enable FIDO U2F USB support](https://wiki.gentoo.org/wiki/Pam_u2f)</span>\n<span class=\"token inserted\">+- [support.yubico.com#enabling the Yubico PPA on Ubuntu](https://support.yubico.com/support/solutions/articles/15000010964-enabling-the-yubico-ppa-on-ubuntu)</span>\n<span class=\"token inserted\">+- [support.yubico.com#Ubuntu Linux Login Guide - U2F](https://support.yubico.com/support/solutions/articles/15000011356-ubuntu-linux-login-guide-u2f)</span>\n</code></pre></div>"}],"publishedAt":"2019-08-08","updatedAt":"2021-04-10"}},"__N_SSG":true}