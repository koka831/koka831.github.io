<!DOCTYPE html><html lang="en"><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><meta name="theme-color" content="#ddd4bb"/><meta property="og:type" content="website"/><meta property="og:url" content="https://koka831.github.io"/><meta property="og:site_name" content="/var/log/koka"/><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="/var/log/koka"/><meta name="twitter:site" content="@k_0ka"/><meta name="twitter:description" content="cat /var/log/koka &gt; /dev/null"/><link rel="alternate" type="application/rss+xml" href="https://koka831.github.io/feed.xml" title="/var/log/koka RSS2.0"/><title>memo:GitHub API &amp; Serde.rs | /var/log/koka</title><meta property="title" content="memo:GitHub API &amp; Serde.rs | /var/log/koka"/><meta property="og:title" content="memo:GitHub API &amp; Serde.rs | /var/log/koka"/><meta property="twitter:title" content="memo:GitHub API &amp; Serde.rs | /var/log/koka"/><meta property="description" content="
Rusk/Task Manager in Rust の作成log.

Rust とTask から命名
## &lt;span class=&quot;olive&quot;&gt;Motivation&lt;/span&gt;
Googleカ..."/><meta property="og:description" content="
Rusk/Task Manager in Rust の作成log.

Rust とTask から命名
## &lt;span class=&quot;olive&quot;&gt;Motivation&lt;/span&gt;
Googleカ..."/><meta property="twitter:description" content="
Rusk/Task Manager in Rust の作成log.

Rust とTask から命名
## &lt;span class=&quot;olive&quot;&gt;Motivation&lt;/span&gt;
Googleカ..."/><meta property="og:image" content="https://koka831.github.io/img/icon.png"/><meta name="next-head-count" content="19"/><link rel="preload" href="/_next/static/css/55d5df5355c8116d.css" as="style"/><link rel="stylesheet" href="/_next/static/css/55d5df5355c8116d.css" data-n-g=""/><link rel="preload" href="/_next/static/css/91a87cd7c252ab33.css" as="style"/><link rel="stylesheet" href="/_next/static/css/91a87cd7c252ab33.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-9b312e20a4e32339.js" defer=""></script><script src="/_next/static/chunks/framework-5f4595e5518b5600.js" defer=""></script><script src="/_next/static/chunks/main-a054bbf31fb90f6a.js" defer=""></script><script src="/_next/static/chunks/pages/_app-e0fcf5a3a528e4c5.js" defer=""></script><script src="/_next/static/chunks/cb1608f2-ecfb8d9b659208e2.js" defer=""></script><script src="/_next/static/chunks/956-e3f9e425e596b05c.js" defer=""></script><script src="/_next/static/chunks/291-8832f908968da124.js" defer=""></script><script src="/_next/static/chunks/pages/archives/%5Bslug%5D-f3c25ca7c16881be.js" defer=""></script><script src="/_next/static/lH4xccgqp867wZq3VXLT_/_buildManifest.js" defer=""></script><script src="/_next/static/lH4xccgqp867wZq3VXLT_/_ssgManifest.js" defer=""></script><script src="/_next/static/lH4xccgqp867wZq3VXLT_/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><nav class="Header_navigation__container__Xjar7"><div class="Header_navigation__qZpeO"><a href="/">/var/log/koka</a></div><div><a href="/archives">archive</a></div></nav><main class="Layout_container__LBFOo"><div class="slug_container__f_fjw"><div class="slug_main__WMOpC"><article class="slug_article__cOl2p" role="article"><div itemscope="" class="ArticleHeader_header__container__5Gs_X"><a class="ArticleHeader_post__title__gVFje" href="/archives/2017-11-07-github-api">memo:GitHub API &amp; Serde.rs</a><p>
Rusk/Task Manager in Rust の作成log.

Rust とTask から命名
## &lt;span class=&quot;olive&quot;&gt;Motivation&lt;/span&gt;
Googleカ...</p><div class="ArticleHeader_flex__yDiMS"><div class="ArticleHeader_post__tags__uCQyx"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="tags" class="svg-inline--fa fa-tags ArticleHeader_tags__icon__U9c_O" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M472.8 168.4C525.1 221.4 525.1 306.6 472.8 359.6L360.8 472.9C351.5 482.3 336.3 482.4 326.9 473.1C317.4 463.8 317.4 448.6 326.7 439.1L438.6 325.9C472.5 291.6 472.5 236.4 438.6 202.1L310.9 72.87C301.5 63.44 301.6 48.25 311.1 38.93C320.5 29.61 335.7 29.7 344.1 39.13L472.8 168.4zM.0003 229.5V80C.0003 53.49 21.49 32 48 32H197.5C214.5 32 230.7 38.74 242.7 50.75L410.7 218.7C435.7 243.7 435.7 284.3 410.7 309.3L277.3 442.7C252.3 467.7 211.7 467.7 186.7 442.7L18.75 274.7C6.743 262.7 0 246.5 0 229.5L.0003 229.5zM112 112C94.33 112 80 126.3 80 144C80 161.7 94.33 176 112 176C129.7 176 144 161.7 144 144C144 126.3 129.7 112 112 112z"></path></svg><p class="Tag_tag__rl8WL">Rust</p><p class="Tag_tag__rl8WL">GitHub</p></div><div class="ArticleHeader_post__dates__6uEwt"><time dateTime="2017-11-07" itemProp="datePublished" class="PublishDate_post__date__jhH_w">published: <!-- -->2017-11-07</time><time dateTime="2021-01-30" itemProp="datePublished" class="PublishDate_post__date__jhH_w">updated: 2021-01-30</time></div></div></div><div class="slug_article__body__m2pRS"><p>Rusk/Task Manager in Rust の作成log.</p>
<p>Rust とTask から命名</p>
<h2 id="motivation"><a href="#motivation"><span class="olive">Motivation</span></a></h2>
<p>Googleカレンダーで主にスケジュール・タスク管理をしてたのだけど、
色々と不満点があったので小さいCLIツールを作ることにした。</p>
<ul>
<li>Web上でGoogle ToDoリストを作成するまでの導線が長い</li>
<li>ToDoにタグ付けしたい &#x26; Tag毎に確認したい</li>
<li>ターミナルからも見たい</li>
</ul>
<p>Task管理する上で欲しい項目/機能をリストアップ。</p>
<h4 id="項目"><a href="#項目">項目</a></h4>
<ul>
<li>task/name</li>
<li>description</li>
<li>tag(s)</li>
<li>deadline</li>
</ul>
<h4 id="機能"><a href="#機能">機能</a></h4>
<ul>
<li>CRUD</li>
<li>Notification</li>
<li>ターミナル/Web(スマホ)両方から確認したい</li>
</ul>
<p>で、上記を一番楽に実装しようと考えた結果、GitHubのレポジトリを立てToDoをIssueとして管理することにした。<br>
データ構造としてのタスクの項目が多いので、ToDoの作成は主にWebから。CLIから作成する場合はinteractiveな感じに。</p>
<h2 id="approach"><a href="#approach"><span class="olive">Approach</span></a></h2>
<p>Rustの<a href="https://github.com/hyperium/hyper" target="_blank" rel="nofollow noopener noreferrer">hyper</a>を使ってhttpクライアントを作成。
hyper単体だとTLS対応していないので、<a href="https://github.com/hyperium/hyper-tls" target="_blank" rel="nofollow noopener noreferrer">hyper-tls</a>をコネクタに利用した。<br>
CLIには<a href="https://github.com/TeXitoi/structopt" target="_blank" rel="nofollow noopener noreferrer">structopt</a>を用いてCRUD操作をenumとstructでいい感じに。
出力の整形は<a href="https://github.com/phsym/prettytable-rs" target="_blank" rel="nofollow noopener noreferrer">prettytable-rs</a>を使用。OSS様様。</p>
<p>GitHubのAPIコールは<a href="https://github.com/settings/tokens" target="_blank" rel="nofollow noopener noreferrer">ここ</a>から発行できる<code>personal access token</code>をヘッダに付与するだけで、curlでも簡単に呼べる。<br>
レポジトリのissue一覧を叩くと以下のようにissueに対してユーザ情報、ラベルリストが入れ子構造になって返される。</p>
<div class="remark-highlight"><pre class="language-sh"><code class="language-sh">curl -H &#x26;quot;Authorization: token $GITHUB_API_TOKEN&#x26;quot; https://api.github.com/repos/koka831/todo/issues

[
  {
    &#x26;quot;url&#x26;quot;: &#x26;quot;https://api.github.com/repos/...&#x26;quot;,
    ..
    &#x26;quot;id&#x26;quot;: 271094185,
    &#x26;quot;number&#x26;quot;: 2,
    &#x26;quot;title&#x26;quot;: &#x26;quot;hoge&#x26;quot;,
    &#x26;quot;user&#x26;quot;: {
      &#x26;quot;login&#x26;quot;: &#x26;quot;koka831&#x26;quot;,
      ...
    },
    &#x26;quot;labels&#x26;quot;: [
      {
        &#x26;quot;id&#x26;quot;: ...
        &#x26;quot;name&#x26;quot;: &#x26;quot;ToDo&#x26;quot;,
        &#x26;quot;color&#x26;quot;: &#x26;quot;3778ba&#x26;quot;,
      }
    ],
    &#x26;quot;state&#x26;quot;: &#x26;quot;open&#x26;quot;,
    ...
  }, ...
]</code></pre></div>
<p>同じことをhyperからもやってみると、403/Forbiddenが返される。
<a href="https://developer.github.com/v3/#user-agent-required" target="_blank" rel="nofollow noopener noreferrer">reference</a>を読み直すとUserAgentが必須とのこと。</p>
<blockquote>
<p>All API requests MUST include a valid User-Agent header. Requests with no User-Agent header will be rejected.</p>
</blockquote>
<p>したがって最小限必要なheaderは以下の２つ。</p>
<div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">User-Agent: app/1.0
Authorization: token $TOKEN</code></pre></div>
<p>２つ目の<code>Authorization</code>の書式が曲者で、<code>token</code>とトークン文字列の間の<strong>スペースが２つあっても</strong><code>Bad credentials</code>となる。</p>
<p>hyperで独自ヘッダを付与する際には、hyperのマクロが便利。
Authorizationのheader生成関数を作成して、TLSコネクタベースのHttpClientに渡す。
Clientサイドなのでシングルスレッドで。</p>
<div class="remark-highlight"><pre class="language-rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">hyper<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">Client</span><span class="token punctuation">,</span> <span class="token class-name">Method</span><span class="token punctuation">,</span> <span class="token class-name">Request</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">hyper<span class="token punctuation">::</span>header<span class="token punctuation">::</span></span><span class="token class-name">UserAgent</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">hyper_tls<span class="token punctuation">::</span></span><span class="token class-name">HttpsConnector</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">tokio_core<span class="token punctuation">::</span>reactor<span class="token punctuation">::</span></span><span class="token class-name">Core</span><span class="token punctuation">;</span>

<span class="token comment">// ...</span>
<span class="token macro property">header!</span> <span class="token punctuation">{</span> <span class="token punctuation">(</span> <span class="token class-name">Authorization</span><span class="token punctuation">,</span> <span class="token string">"Authorization"</span> <span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
<span class="token keyword">let</span> auth_header <span class="token operator">=</span> <span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">"token {}"</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> <span class="token keyword">mut</span> req <span class="token operator">=</span> <span class="token class-name">Request</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Method</span><span class="token punctuation">::</span><span class="token class-name">Get</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
req<span class="token punctuation">.</span><span class="token function">headers_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">UserAgent</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"todo"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
req<span class="token punctuation">.</span><span class="token function">headers_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">Authorization</span><span class="token punctuation">(</span>auth_header<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// setup client</span>
<span class="token keyword">let</span> handle <span class="token operator">=</span> core<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> client <span class="token operator">=</span> <span class="token class-name">Client</span><span class="token punctuation">::</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// creates connector with 1 thread</span>
  <span class="token punctuation">.</span><span class="token function">connector</span><span class="token punctuation">(</span><span class="token class-name">HttpsConnector</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&#x26;</span>handle<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token operator">&#x26;</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div>
<p>取得したIssueリストはdeserializeしてstructに落としこむ。<br>
とりあえずの構造体を作ってserde-jsonとすり合わせようと思っていたのだけど、
構造体のkeyをjsonのkeyと合わせておくだけでそのままシリアライズしてくれた。
今回はv3のREST APIを使ったけど、struct/enumのSerializerとGraphQLも相性がいいと思う。</p>
<div class="remark-highlight"><pre class="language-rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(Debug, Serialize, Deserialize)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Issue</span> <span class="token punctuation">{</span>
  id<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
  number<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
  title<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
  labels<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&#x3C;</span><span class="token class-name">Label</span><span class="token operator">></span><span class="token punctuation">,</span>
  state<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
  body<span class="token punctuation">:</span> <span class="token class-name">String</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[derive(Debug, Serialize, Deserialize)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Label</span> <span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> color<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    default<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">// ...</span>
<span class="token comment">// send request</span>
<span class="token keyword">let</span> res <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">and_then</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>res<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span> res<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">and_then</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>body<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> v<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&#x3C;</span><span class="token class-name">Issue</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token namespace">serde_json<span class="token punctuation">::</span></span><span class="token function">from_slice</span><span class="token punctuation">(</span><span class="token operator">&#x26;</span>body<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

core<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div>
<h2 id="todo"><a href="#todo"><span class="olive">ToDo</span></a></h2>
<ul>
<li>APIコールが1~2secかかるのでその間スピナーアイコン表示したい</li>
<li>rusk + fzf + vimでタスクをシームレスに編集できるように
<ul>
<li>CLI側のメモは後日fzf+vimインターフェースと合わせて</li>
</ul>
</li>
</ul></div></article><div class="CommitLogs_commit_logs__W6xPi" role="log"><h2>Commits</h2><details><summary><span class="CommitLogs_commit__date___q8bm">2021-01-30 22:18:17</span><span class="CommitLogs_commit__hash__Xyu7v">35b550ae</span><span class="CommitLogs_commit__message__IGUPv">copy md</span></summary><div><div class="remark-highlight"><pre data-file="35b550ae.patch" class="language-git  language-diff"><code class="language-git"><span class="token commit-sha1">commit 35b550ae83af4efaeadf33471c8ca8a32c1079c8</span>
Author: koka &#x26;<a href="mailto:lt;koka.code@gmail.com" class="token email-link">lt;koka.code@gmail.com</a>&#x26;gt;
Date:   Sat Jan 30 22:18:17 2021 +0900

  copy md

diff --git a/_posts/2017-11-07-github-api.md b/_posts/2017-11-07-github-api.md
new file mode 100644
index 0000000..032f57e
<span class="token deleted">--- /dev/null</span>
<span class="token inserted">+++ b/_posts/2017-11-07-github-api.md</span>
<span class="token coord">@@ -0,0 +1,151 @@</span>
<span class="token inserted">+---</span>
<span class="token inserted">+title: memo:GitHub API &#x26; Serde.rs</span>
<span class="token inserted">+date: 2017-11-07</span>
<span class="token inserted">+categories:</span>
<span class="token inserted">+- memo</span>
<span class="token inserted">+tags:</span>
<span class="token inserted">+- Rust</span>
<span class="token inserted">+- GitHub</span>
<span class="token inserted">+---</span>
<span class="token inserted">+</span>
<span class="token inserted">+Rusk/Task Manager in Rust の作成log.</span>
<span class="token inserted">+</span>
<span class="token inserted">+Rust とTask から命名</span>
<span class="token inserted">+## &#x26;lt;span class="olive"&#x26;gt;Motivation&#x26;lt;/span&#x26;gt;</span>
<span class="token inserted">+Googleカレンダーで主にスケジュール・タスク管理をしてたのだけど、</span>
<span class="token inserted">+色々と不満点があったので小さいCLIツールを作ることにした。  </span>
<span class="token inserted">+</span>
<span class="token inserted">+- Web上でGoogle ToDoリストを作成するまでの導線が長い</span>
<span class="token inserted">+- ToDoにタグ付けしたい &#x26; Tag毎に確認したい</span>
<span class="token inserted">+- ターミナルからも見たい</span>
<span class="token inserted">+</span>
<span class="token inserted">+Task管理する上で欲しい項目/機能をリストアップ。  </span>
<span class="token inserted">+</span>
<span class="token inserted">+#### 項目</span>
<span class="token inserted">+- task/name</span>
<span class="token inserted">+- description</span>
<span class="token inserted">+- tag(s)</span>
<span class="token inserted">+- deadline</span>
<span class="token inserted">+</span>
<span class="token inserted">+#### 機能</span>
<span class="token inserted">+- CRUD</span>
<span class="token inserted">+- Notification</span>
<span class="token inserted">+- ターミナル/Web(スマホ)両方から確認したい</span>
<span class="token inserted">+</span>
<span class="token inserted">+で、上記を一番楽に実装しようと考えた結果、GitHubのレポジトリを立てToDoをIssueとして管理することにした。  </span>
<span class="token inserted">+データ構造としてのタスクの項目が多いので、ToDoの作成は主にWebから。CLIから作成する場合はinteractiveな感じに。</span>
<span class="token inserted">+</span>
<span class="token inserted">+## &#x26;lt;span class="olive"&#x26;gt;Approach&#x26;lt;/span&#x26;gt;</span>
<span class="token inserted">+Rustの[hyper](https://github.com/hyperium/hyper)を使ってhttpクライアントを作成。</span>
<span class="token inserted">+hyper単体だとTLS対応していないので、[hyper-tls](https://github.com/hyperium/hyper-tls)をコネクタに利用した。  </span>
<span class="token inserted">+CLIには[structopt](https://github.com/TeXitoi/structopt)を用いてCRUD操作をenumとstructでいい感じに。</span>
<span class="token inserted">+出力の整形は[prettytable-rs](https://github.com/phsym/prettytable-rs)を使用。OSS様様。</span>
<span class="token inserted">+</span>
<span class="token inserted">+GitHubのAPIコールは[ここ](https://github.com/settings/tokens)から発行できる`personal access token`をヘッダに付与するだけで、curlでも簡単に呼べる。  </span>
<span class="token inserted">+レポジトリのissue一覧を叩くと以下のようにissueに対してユーザ情報、ラベルリストが入れ子構造になって返される。</span>
<span class="token inserted">+</span>
<span class="token inserted">+\```sh</span>
<span class="token inserted">+curl -H "Authorization: token $GITHUB_API_TOKEN" https://api.github.com/repos/koka831/todo/issues</span>
<span class="token inserted">+</span>
<span class="token inserted">+[</span>
<span class="token inserted">+  {</span>
<span class="token inserted">+    "url": "https://api.github.com/repos/...",</span>
<span class="token inserted">+    ..</span>
<span class="token inserted">+    "id": 271094185,</span>
<span class="token inserted">+    "number": 2,</span>
<span class="token inserted">+    "title": "hoge",</span>
<span class="token inserted">+    "user": {</span>
<span class="token inserted">+      "login": "koka831",</span>
<span class="token inserted">+      ...</span>
<span class="token inserted">+    },</span>
<span class="token inserted">+    "labels": [</span>
<span class="token inserted">+      {</span>
<span class="token inserted">+        "id": ...</span>
<span class="token inserted">+        "name": "ToDo",</span>
<span class="token inserted">+        "color": "3778ba",</span>
<span class="token inserted">+      }</span>
<span class="token inserted">+    ],</span>
<span class="token inserted">+    "state": "open",</span>
<span class="token inserted">+    ...</span>
<span class="token inserted">+  }, ...</span>
<span class="token inserted">+]</span>
<span class="token inserted">+\```</span>
<span class="token inserted">+</span>
<span class="token inserted">+同じことをhyperからもやってみると、403/Forbiddenが返される。</span>
<span class="token inserted">+[reference](https://developer.github.com/v3/#user-agent-required)を読み直すとUserAgentが必須とのこと。</span>
<span class="token inserted">+&#x26;gt; All API requests MUST include a valid User-Agent header. Requests with no User-Agent header will be rejected. </span>
<span class="token inserted">+</span>
<span class="token inserted">+したがって最小限必要なheaderは以下の２つ。</span>
<span class="token inserted">+\```</span>
<span class="token inserted">+User-Agent: app/1.0</span>
<span class="token inserted">+Authorization: token $TOKEN</span>
<span class="token inserted">+\```</span>
<span class="token inserted">+２つ目の`Authorization`の書式が曲者で、`token`とトークン文字列の間の**スペースが２つあっても**`Bad credentials`となる。</span>
<span class="token inserted">+</span>
<span class="token inserted">+hyperで独自ヘッダを付与する際には、hyperのマクロが便利。</span>
<span class="token inserted">+Authorizationのheader生成関数を作成して、TLSコネクタベースのHttpClientに渡す。</span>
<span class="token inserted">+Clientサイドなのでシングルスレッドで。</span>
<span class="token inserted">+</span>
<span class="token inserted">+\```rust</span>
<span class="token inserted">+use hyper::{Client, Method, Request};</span>
<span class="token inserted">+use hyper::header::UserAgent;</span>
<span class="token inserted">+use hyper_tls::HttpsConnector;</span>
<span class="token inserted">+use tokio_core::reactor::Core;</span>
<span class="token inserted">+</span>
<span class="token inserted">+// ...</span>
<span class="token inserted">+header! { ( Authorization, "Authorization" ) =&#x26;gt; [String] }</span>
<span class="token inserted">+let auth_header = format!("token {}", token);</span>
<span class="token inserted">+</span>
<span class="token inserted">+let mut req = Request::new(Method::Get, url);</span>
<span class="token inserted">+req.headers_mut().set(UserAgent::new("todo"));</span>
<span class="token inserted">+req.headers_mut().set(Authorization(auth_header));</span>
<span class="token inserted">+</span>
<span class="token inserted">+// setup client</span>
<span class="token inserted">+let handle = core.handle();</span>
<span class="token inserted">+let client = Client::configure()</span>
<span class="token inserted">+  // creates connector with 1 thread</span>
<span class="token inserted">+  .connector(HttpsConnector::new(1, &#x26;handle).unwrap())</span>
<span class="token inserted">+  .build(&#x26;handle);</span>
<span class="token inserted">+\```</span>
<span class="token inserted">+</span>
<span class="token inserted">+取得したIssueリストはdeserializeしてstructに落としこむ。  </span>
<span class="token inserted">+とりあえずの構造体を作ってserde-jsonとすり合わせようと思っていたのだけど、</span>
<span class="token inserted">+構造体のkeyをjsonのkeyと合わせておくだけでそのままシリアライズしてくれた。</span>
<span class="token inserted">+今回はv3のREST APIを使ったけど、struct/enumのSerializerとGraphQLも相性がいいと思う。</span>
<span class="token inserted">+</span>
<span class="token inserted">+\```rust</span>
<span class="token inserted">+#[derive(Debug, Serialize, Deserialize)]</span>
<span class="token inserted">+struct Issue {</span>
<span class="token inserted">+  id: u32,</span>
<span class="token inserted">+  number: u8,</span>
<span class="token inserted">+  title: String,</span>
<span class="token inserted">+  labels: Vec&#x26;lt;Label&#x26;gt;,</span>
<span class="token inserted">+  state: String,</span>
<span class="token inserted">+  body: String</span>
<span class="token inserted">+}</span>
<span class="token inserted">+</span>
<span class="token inserted">+#[derive(Debug, Serialize, Deserialize)]</span>
<span class="token inserted">+pub struct Label {</span>
<span class="token inserted">+    id: u32,</span>
<span class="token inserted">+    pub name: String,</span>
<span class="token inserted">+    pub color: String,</span>
<span class="token inserted">+    default: bool,</span>
<span class="token inserted">+}</span>
<span class="token inserted">+</span>
<span class="token inserted">+// ...</span>
<span class="token inserted">+// send request</span>
<span class="token inserted">+let res = client.request(req)</span>
<span class="token inserted">+  .and_then(|res| { res.body().concat2()</span>
<span class="token inserted">+  .and_then(move |body| {</span>
<span class="token inserted">+    let v: Vec&#x26;lt;Issue&#x26;gt; = serde_json::from_slice(&#x26;body).unwrap();</span>
<span class="token inserted">+    Ok(v)</span>
<span class="token inserted">+  })</span>
<span class="token inserted">+});</span>
<span class="token inserted">+</span>
<span class="token inserted">+core.run(res).unwrap()</span>
<span class="token inserted">+\```</span>
<span class="token inserted">+</span>
<span class="token inserted">+## &#x26;lt;span class="olive"&#x26;gt;ToDo&#x26;lt;/span&#x26;gt;</span>
<span class="token inserted">+- APIコールが1~2secかかるのでその間スピナーアイコン表示したい</span>
<span class="token inserted">+- rusk + fzf + vimでタスクをシームレスに編集できるように</span>
<span class="token inserted">+  - CLI側のメモは後日fzf+vimインターフェースと合わせて</span>
</code></pre></div></div></details></div><div class="Comments_comment__WxfzD" role="comment"><h2 class="Comments_title__YENiL">Comments</h2><div id="github-comment-container"></div></div></div><aside class="slug_aside__gL3UH"><nav class="Toc_toc__nav__rl0h7" role="navigation"><ul class="Toc_toc__Y4dWA"></ul></nav></aside></div></main><footer class="Footer_footer__FDcZZ"><small>Code snippets licensed under MIT, unless otherwise noted.</small></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"slug":"2017-11-07-github-api","title":"memo:GitHub API \u0026 Serde.rs","categories":["memo"],"image":"https://koka831.github.io/img/icon.png","tags":["Rust","GitHub"],"content":"\u003cp\u003eRusk/Task Manager in Rust の作成log.\u003c/p\u003e\n\u003cp\u003eRust とTask から命名\u003c/p\u003e\n\u003ch2 id=\"motivation\"\u003e\u003ca href=\"#motivation\"\u003e\u003cspan class=\"olive\"\u003eMotivation\u003c/span\u003e\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003eGoogleカレンダーで主にスケジュール・タスク管理をしてたのだけど、\n色々と不満点があったので小さいCLIツールを作ることにした。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eWeb上でGoogle ToDoリストを作成するまでの導線が長い\u003c/li\u003e\n\u003cli\u003eToDoにタグ付けしたい \u0026#x26; Tag毎に確認したい\u003c/li\u003e\n\u003cli\u003eターミナルからも見たい\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eTask管理する上で欲しい項目/機能をリストアップ。\u003c/p\u003e\n\u003ch4 id=\"項目\"\u003e\u003ca href=\"#項目\"\u003e項目\u003c/a\u003e\u003c/h4\u003e\n\u003cul\u003e\n\u003cli\u003etask/name\u003c/li\u003e\n\u003cli\u003edescription\u003c/li\u003e\n\u003cli\u003etag(s)\u003c/li\u003e\n\u003cli\u003edeadline\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch4 id=\"機能\"\u003e\u003ca href=\"#機能\"\u003e機能\u003c/a\u003e\u003c/h4\u003e\n\u003cul\u003e\n\u003cli\u003eCRUD\u003c/li\u003e\n\u003cli\u003eNotification\u003c/li\u003e\n\u003cli\u003eターミナル/Web(スマホ)両方から確認したい\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eで、上記を一番楽に実装しようと考えた結果、GitHubのレポジトリを立てToDoをIssueとして管理することにした。\u003cbr\u003e\nデータ構造としてのタスクの項目が多いので、ToDoの作成は主にWebから。CLIから作成する場合はinteractiveな感じに。\u003c/p\u003e\n\u003ch2 id=\"approach\"\u003e\u003ca href=\"#approach\"\u003e\u003cspan class=\"olive\"\u003eApproach\u003c/span\u003e\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003eRustの\u003ca href=\"https://github.com/hyperium/hyper\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003ehyper\u003c/a\u003eを使ってhttpクライアントを作成。\nhyper単体だとTLS対応していないので、\u003ca href=\"https://github.com/hyperium/hyper-tls\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003ehyper-tls\u003c/a\u003eをコネクタに利用した。\u003cbr\u003e\nCLIには\u003ca href=\"https://github.com/TeXitoi/structopt\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003estructopt\u003c/a\u003eを用いてCRUD操作をenumとstructでいい感じに。\n出力の整形は\u003ca href=\"https://github.com/phsym/prettytable-rs\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eprettytable-rs\u003c/a\u003eを使用。OSS様様。\u003c/p\u003e\n\u003cp\u003eGitHubのAPIコールは\u003ca href=\"https://github.com/settings/tokens\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eここ\u003c/a\u003eから発行できる\u003ccode\u003epersonal access token\u003c/code\u003eをヘッダに付与するだけで、curlでも簡単に呼べる。\u003cbr\u003e\nレポジトリのissue一覧を叩くと以下のようにissueに対してユーザ情報、ラベルリストが入れ子構造になって返される。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-sh\"\u003e\u003ccode class=\"language-sh\"\u003ecurl -H \u0026#x26;quot;Authorization: token $GITHUB_API_TOKEN\u0026#x26;quot; https://api.github.com/repos/koka831/todo/issues\n\n[\n  {\n    \u0026#x26;quot;url\u0026#x26;quot;: \u0026#x26;quot;https://api.github.com/repos/...\u0026#x26;quot;,\n    ..\n    \u0026#x26;quot;id\u0026#x26;quot;: 271094185,\n    \u0026#x26;quot;number\u0026#x26;quot;: 2,\n    \u0026#x26;quot;title\u0026#x26;quot;: \u0026#x26;quot;hoge\u0026#x26;quot;,\n    \u0026#x26;quot;user\u0026#x26;quot;: {\n      \u0026#x26;quot;login\u0026#x26;quot;: \u0026#x26;quot;koka831\u0026#x26;quot;,\n      ...\n    },\n    \u0026#x26;quot;labels\u0026#x26;quot;: [\n      {\n        \u0026#x26;quot;id\u0026#x26;quot;: ...\n        \u0026#x26;quot;name\u0026#x26;quot;: \u0026#x26;quot;ToDo\u0026#x26;quot;,\n        \u0026#x26;quot;color\u0026#x26;quot;: \u0026#x26;quot;3778ba\u0026#x26;quot;,\n      }\n    ],\n    \u0026#x26;quot;state\u0026#x26;quot;: \u0026#x26;quot;open\u0026#x26;quot;,\n    ...\n  }, ...\n]\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e同じことをhyperからもやってみると、403/Forbiddenが返される。\n\u003ca href=\"https://developer.github.com/v3/#user-agent-required\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003ereference\u003c/a\u003eを読み直すとUserAgentが必須とのこと。\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eAll API requests MUST include a valid User-Agent header. Requests with no User-Agent header will be rejected.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eしたがって最小限必要なheaderは以下の２つ。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003eUser-Agent: app/1.0\nAuthorization: token $TOKEN\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e２つ目の\u003ccode\u003eAuthorization\u003c/code\u003eの書式が曲者で、\u003ccode\u003etoken\u003c/code\u003eとトークン文字列の間の\u003cstrong\u003eスペースが２つあっても\u003c/strong\u003e\u003ccode\u003eBad credentials\u003c/code\u003eとなる。\u003c/p\u003e\n\u003cp\u003ehyperで独自ヘッダを付与する際には、hyperのマクロが便利。\nAuthorizationのheader生成関数を作成して、TLSコネクタベースのHttpClientに渡す。\nClientサイドなのでシングルスレッドで。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-rust\"\u003e\u003ccode class=\"language-rust\"\u003e\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token namespace\"\u003ehyper\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eClient\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eMethod\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eRequest\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token namespace\"\u003ehyper\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003eheader\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eUserAgent\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token namespace\"\u003ehyper_tls\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eHttpsConnector\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token namespace\"\u003etokio_core\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003ereactor\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eCore\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// ...\u003c/span\u003e\n\u003cspan class=\"token macro property\"\u003eheader!\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eAuthorization\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Authorization\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eString\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e auth_header \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token macro property\"\u003eformat!\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"token {}\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e token\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e \u003cspan class=\"token keyword\"\u003emut\u003c/span\u003e req \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eRequest\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003cspan class=\"token function\"\u003enew\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eMethod\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eGet\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e url\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\nreq\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eheaders_mut\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eset\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eUserAgent\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003cspan class=\"token function\"\u003enew\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"todo\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\nreq\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eheaders_mut\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eset\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eAuthorization\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eauth_header\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// setup client\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e handle \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e core\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ehandle\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e client \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eClient\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003cspan class=\"token function\"\u003econfigure\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token comment\"\u003e// creates connector with 1 thread\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003econnector\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eHttpsConnector\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003cspan class=\"token function\"\u003enew\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u003c/span\u003ehandle\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eunwrap\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ebuild\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x26;\u003c/span\u003ehandle\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e取得したIssueリストはdeserializeしてstructに落としこむ。\u003cbr\u003e\nとりあえずの構造体を作ってserde-jsonとすり合わせようと思っていたのだけど、\n構造体のkeyをjsonのkeyと合わせておくだけでそのままシリアライズしてくれた。\n今回はv3のREST APIを使ったけど、struct/enumのSerializerとGraphQLも相性がいいと思う。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-rust\"\u003e\u003ccode class=\"language-rust\"\u003e\u003cspan class=\"token attribute attr-name\"\u003e#[derive(Debug, Serialize, Deserialize)]\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003estruct\u003c/span\u003e \u003cspan class=\"token type-definition class-name\"\u003eIssue\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  id\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eu32\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  number\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eu8\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  title\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eString\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  labels\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eVec\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eLabel\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  state\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eString\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  body\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eString\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token attribute attr-name\"\u003e#[derive(Debug, Serialize, Deserialize)]\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003epub\u003c/span\u003e \u003cspan class=\"token keyword\"\u003estruct\u003c/span\u003e \u003cspan class=\"token type-definition class-name\"\u003eLabel\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    id\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eu32\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003epub\u003c/span\u003e name\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eString\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003epub\u003c/span\u003e color\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eString\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    default\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ebool\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// ...\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// send request\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e res \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e client\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003erequest\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ereq\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eand_then\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token closure-params\"\u003e\u003cspan class=\"token closure-punctuation punctuation\"\u003e|\u003c/span\u003eres\u003cspan class=\"token closure-punctuation punctuation\"\u003e|\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e res\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ebody\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003econcat2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eand_then\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003emove\u003c/span\u003e \u003cspan class=\"token closure-params\"\u003e\u003cspan class=\"token closure-punctuation punctuation\"\u003e|\u003c/span\u003ebody\u003cspan class=\"token closure-punctuation punctuation\"\u003e|\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e v\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eVec\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eIssue\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token namespace\"\u003eserde_json\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003efrom_slice\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x26;\u003c/span\u003ebody\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eunwrap\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token class-name\"\u003eOk\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ev\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\ncore\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003erun\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eres\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eunwrap\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2 id=\"todo\"\u003e\u003ca href=\"#todo\"\u003e\u003cspan class=\"olive\"\u003eToDo\u003c/span\u003e\u003c/a\u003e\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eAPIコールが1~2secかかるのでその間スピナーアイコン表示したい\u003c/li\u003e\n\u003cli\u003erusk + fzf + vimでタスクをシームレスに編集できるように\n\u003cul\u003e\n\u003cli\u003eCLI側のメモは後日fzf+vimインターフェースと合わせて\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e","description":"\nRusk/Task Manager in Rust の作成log.\n\nRust とTask から命名\n## \u003cspan class=\"olive\"\u003eMotivation\u003c/span\u003e\nGoogleカ...","commits":[{"title":"copy md","date":"2021-01-30 22:18:17","hash":"35b550ae","diff":"\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"35b550ae.patch\" class=\"language-git  language-diff\"\u003e\u003ccode class=\"language-git\"\u003e\u003cspan class=\"token commit-sha1\"\u003ecommit 35b550ae83af4efaeadf33471c8ca8a32c1079c8\u003c/span\u003e\nAuthor: koka \u0026#x26;\u003ca href=\"mailto:lt;koka.code@gmail.com\" class=\"token email-link\"\u003elt;koka.code@gmail.com\u003c/a\u003e\u0026#x26;gt;\nDate:   Sat Jan 30 22:18:17 2021 +0900\n\n  copy md\n\ndiff --git a/_posts/2017-11-07-github-api.md b/_posts/2017-11-07-github-api.md\nnew file mode 100644\nindex 0000000..032f57e\n\u003cspan class=\"token deleted\"\u003e--- /dev/null\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+++ b/_posts/2017-11-07-github-api.md\u003c/span\u003e\n\u003cspan class=\"token coord\"\u003e@@ -0,0 +1,151 @@\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+---\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+title: memo:GitHub API \u0026#x26; Serde.rs\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+date: 2017-11-07\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+categories:\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- memo\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+tags:\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- Rust\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- GitHub\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+---\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+Rusk/Task Manager in Rust の作成log.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+Rust とTask から命名\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+## \u0026#x26;lt;span class=\"olive\"\u0026#x26;gt;Motivation\u0026#x26;lt;/span\u0026#x26;gt;\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+Googleカレンダーで主にスケジュール・タスク管理をしてたのだけど、\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+色々と不満点があったので小さいCLIツールを作ることにした。  \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- Web上でGoogle ToDoリストを作成するまでの導線が長い\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- ToDoにタグ付けしたい \u0026#x26; Tag毎に確認したい\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- ターミナルからも見たい\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+Task管理する上で欲しい項目/機能をリストアップ。  \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+#### 項目\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- task/name\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- description\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- tag(s)\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- deadline\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+#### 機能\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- CRUD\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- Notification\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- ターミナル/Web(スマホ)両方から確認したい\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+で、上記を一番楽に実装しようと考えた結果、GitHubのレポジトリを立てToDoをIssueとして管理することにした。  \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+データ構造としてのタスクの項目が多いので、ToDoの作成は主にWebから。CLIから作成する場合はinteractiveな感じに。\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+## \u0026#x26;lt;span class=\"olive\"\u0026#x26;gt;Approach\u0026#x26;lt;/span\u0026#x26;gt;\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+Rustの[hyper](https://github.com/hyperium/hyper)を使ってhttpクライアントを作成。\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+hyper単体だとTLS対応していないので、[hyper-tls](https://github.com/hyperium/hyper-tls)をコネクタに利用した。  \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+CLIには[structopt](https://github.com/TeXitoi/structopt)を用いてCRUD操作をenumとstructでいい感じに。\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+出力の整形は[prettytable-rs](https://github.com/phsym/prettytable-rs)を使用。OSS様様。\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+GitHubのAPIコールは[ここ](https://github.com/settings/tokens)から発行できる`personal access token`をヘッダに付与するだけで、curlでも簡単に呼べる。  \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+レポジトリのissue一覧を叩くと以下のようにissueに対してユーザ情報、ラベルリストが入れ子構造になって返される。\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```sh\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+curl -H \"Authorization: token $GITHUB_API_TOKEN\" https://api.github.com/repos/koka831/todo/issues\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+[\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  {\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    \"url\": \"https://api.github.com/repos/...\",\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    ..\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    \"id\": 271094185,\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    \"number\": 2,\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    \"title\": \"hoge\",\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    \"user\": {\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+      \"login\": \"koka831\",\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+      ...\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    },\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    \"labels\": [\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+      {\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+        \"id\": ...\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+        \"name\": \"ToDo\",\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+        \"color\": \"3778ba\",\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+      }\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    ],\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    \"state\": \"open\",\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    ...\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  }, ...\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+]\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+同じことをhyperからもやってみると、403/Forbiddenが返される。\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+[reference](https://developer.github.com/v3/#user-agent-required)を読み直すとUserAgentが必須とのこと。\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u0026#x26;gt; All API requests MUST include a valid User-Agent header. Requests with no User-Agent header will be rejected. \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+したがって最小限必要なheaderは以下の２つ。\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+User-Agent: app/1.0\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+Authorization: token $TOKEN\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+２つ目の`Authorization`の書式が曲者で、`token`とトークン文字列の間の**スペースが２つあっても**`Bad credentials`となる。\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+hyperで独自ヘッダを付与する際には、hyperのマクロが便利。\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+Authorizationのheader生成関数を作成して、TLSコネクタベースのHttpClientに渡す。\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+Clientサイドなのでシングルスレッドで。\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```rust\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+use hyper::{Client, Method, Request};\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+use hyper::header::UserAgent;\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+use hyper_tls::HttpsConnector;\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+use tokio_core::reactor::Core;\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+// ...\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+header! { ( Authorization, \"Authorization\" ) =\u0026#x26;gt; [String] }\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+let auth_header = format!(\"token {}\", token);\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+let mut req = Request::new(Method::Get, url);\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+req.headers_mut().set(UserAgent::new(\"todo\"));\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+req.headers_mut().set(Authorization(auth_header));\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+// setup client\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+let handle = core.handle();\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+let client = Client::configure()\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  // creates connector with 1 thread\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  .connector(HttpsConnector::new(1, \u0026#x26;handle).unwrap())\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  .build(\u0026#x26;handle);\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+取得したIssueリストはdeserializeしてstructに落としこむ。  \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+とりあえずの構造体を作ってserde-jsonとすり合わせようと思っていたのだけど、\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+構造体のkeyをjsonのkeyと合わせておくだけでそのままシリアライズしてくれた。\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+今回はv3のREST APIを使ったけど、struct/enumのSerializerとGraphQLも相性がいいと思う。\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```rust\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+#[derive(Debug, Serialize, Deserialize)]\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+struct Issue {\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  id: u32,\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  number: u8,\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  title: String,\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  labels: Vec\u0026#x26;lt;Label\u0026#x26;gt;,\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  state: String,\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  body: String\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+}\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+#[derive(Debug, Serialize, Deserialize)]\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+pub struct Label {\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    id: u32,\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    pub name: String,\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    pub color: String,\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    default: bool,\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+}\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+// ...\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+// send request\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+let res = client.request(req)\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  .and_then(|res| { res.body().concat2()\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  .and_then(move |body| {\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    let v: Vec\u0026#x26;lt;Issue\u0026#x26;gt; = serde_json::from_slice(\u0026#x26;body).unwrap();\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    Ok(v)\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  })\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+});\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+core.run(res).unwrap()\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+## \u0026#x26;lt;span class=\"olive\"\u0026#x26;gt;ToDo\u0026#x26;lt;/span\u0026#x26;gt;\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- APIコールが1~2secかかるのでその間スピナーアイコン表示したい\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- rusk + fzf + vimでタスクをシームレスに編集できるように\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  - CLI側のメモは後日fzf+vimインターフェースと合わせて\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e"}],"publishedAt":"2017-11-07","updatedAt":"2021-01-30"}},"__N_SSG":true},"page":"/archives/[slug]","query":{"slug":"2017-11-07-github-api"},"buildId":"lH4xccgqp867wZq3VXLT_","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>