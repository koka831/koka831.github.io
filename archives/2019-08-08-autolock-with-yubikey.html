<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8" data-next-head=""/><meta name="viewport" content="width=device-width" data-next-head=""/><meta name="theme-color" content="#ddd4bb" data-next-head=""/><meta property="og:type" content="website" data-next-head=""/><meta property="og:url" content="https://koka831.github.io" data-next-head=""/><meta property="og:site_name" content="/var/log/koka" data-next-head=""/><meta name="twitter:card" content="summary" data-next-head=""/><meta name="twitter:title" content="/var/log/koka" data-next-head=""/><meta name="twitter:site" content="@k_0ka" data-next-head=""/><meta name="twitter:description" content="cat /var/log/koka &gt; /dev/null" data-next-head=""/><link rel="alternate" type="application/rss+xml" href="https://koka831.github.io/feed.xml" title="/var/log/koka RSS2.0" data-next-head=""/><title data-next-head=""></title><meta property="title" content="Linux: Login/sudo with Yubikey | /var/log/koka" data-next-head=""/><meta property="og:title" content="Linux: Login/sudo with Yubikey | /var/log/koka" data-next-head=""/><meta property="twitter:title" content="Linux: Login/sudo with Yubikey | /var/log/koka" data-next-head=""/><meta property="description" content="Yubikeyを自宅に忘れて１敗" data-next-head=""/><meta property="og:description" content="Yubikeyを自宅に忘れて１敗" data-next-head=""/><meta property="twitter:description" content="Yubikeyを自宅に忘れて１敗" data-next-head=""/><meta property="og:image" content="https://koka831.github.io/img/icon.png" data-next-head=""/><link rel="preload" href="/_next/static/css/3c63f1a78079399c.css" as="style"/><link rel="preload" href="/_next/static/css/5709b986f32934dd.css" as="style"/><link rel="stylesheet" href="/_next/static/css/3c63f1a78079399c.css" data-n-g=""/><link rel="stylesheet" href="/_next/static/css/5709b986f32934dd.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" noModule="" src="/_next/static/chunks/polyfills-42372ed130431b0a.js"></script><script src="/_next/static/chunks/webpack-8cac0b4b405cede1.js" defer=""></script><script src="/_next/static/chunks/framework-d7f578ab3069408c.js" defer=""></script><script src="/_next/static/chunks/main-9d035c440ec94d06.js" defer=""></script><script src="/_next/static/chunks/pages/_app-87775d45a97146af.js" defer=""></script><script src="/_next/static/chunks/98bef5de-90a314e763d10677.js" defer=""></script><script src="/_next/static/chunks/230-8a10a6030a242aaa.js" defer=""></script><script src="/_next/static/chunks/772-7af656588a6d3f4a.js" defer=""></script><script src="/_next/static/chunks/pages/archives/%5Bslug%5D-296f94b36904c5e2.js" defer=""></script><script src="/_next/static/cFpM8iTjps8Dc6EBauz9R/_buildManifest.js" defer=""></script><script src="/_next/static/cFpM8iTjps8Dc6EBauz9R/_ssgManifest.js" defer=""></script></head><body><div id="__next"><nav class="Header_navigation__container__QTqC2"><div class="Header_navigation___WOtz"><a href="/">/var/log/koka</a></div><div><a href="/archives">archive</a></div></nav><main class="Layout_container__p0wDU"><div class="slug_container__mEKwJ"><div class="slug_main__Z60A9"><article class="slug_article__bvmhe"><div itemScope="" class="ArticleHeader_header__container__rB6r3"><a class="ArticleHeader_post__title__2kJMT" href="/archives/2019-08-08-autolock-with-yubikey">Linux: Login/sudo with Yubikey</a><p>Yubikeyを自宅に忘れて１敗</p><div class="ArticleHeader_flex__HuW5L"><div class="ArticleHeader_post__tags__xNlWQ"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="tags" class="svg-inline--fa fa-tags ArticleHeader_tags__icon__U0ED6" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M345 39.1L472.8 168.4c52.4 53 52.4 138.2 0 191.2L360.8 472.9c-9.3 9.4-24.5 9.5-33.9 .2s-9.5-24.5-.2-33.9L438.6 325.9c33.9-34.3 33.9-89.4 0-123.7L310.9 72.9c-9.3-9.4-9.2-24.6 .2-33.9s24.6-9.2 33.9 .2zM0 229.5V80C0 53.5 21.5 32 48 32H197.5c17 0 33.3 6.7 45.3 18.7l168 168c25 25 25 65.5 0 90.5L277.3 442.7c-25 25-65.5 25-90.5 0l-168-168C6.7 262.7 0 246.5 0 229.5zM144 144a32 32 0 1 0 -64 0 32 32 0 1 0 64 0z"></path></svg><p class="Tag_tag__zyzRy">Linux</p><p class="Tag_tag__zyzRy">udev</p><p class="Tag_tag__zyzRy">yubikey</p></div><div class="ArticleHeader_post__dates__xh42y"><time dateTime="2019-08-08" itemProp="datePublished" class="PublishDate_post__date___a8_6">published: <!-- -->2019-08-08</time><time dateTime="2021-04-10" itemProp="datePublished" class="PublishDate_post__date___a8_6">updated: 2021-04-10</time></div></div></div><div class="slug_article__body__Y96pa"><h2 id="abstract"><a href="#abstract">Abstract</a></h2>
<ul>
<li>Linux Desktopのログイン時及び<code>sudo</code>時にYubikey + Passwordを必須にしてみた.</li>
<li>ログインした状態でYubikeyを抜くとlockするようにした.</li>
</ul>
<h2 id="env"><a href="#env">Env</a></h2>
<ul>
<li>Ubuntu 18.04</li>
<li>FIDO U2F Security Key(自分は<a href="https://www.amazon.co.jp/dp/B06XHTKFH3/ref=cm_sw_em_r_mt_dp_U_Ha5sDbS6H12P6" rel="nofollow">これ</a>つかってます. 端子ガードついてるKey他にも出てほしい)</li>
</ul>
<h2 id="install-dependencies"><a href="#install-dependencies">Install Dependencies</a></h2>
<div class="remark-highlight"><pre data-file="terminal" class="language-shell-session"><code class="language-shell-session"><span class="token command"><span class="token shell-symbol important">$</span> <span class="token bash language-bash"><span class="token function">sudo</span> add-apt-repository ppa:yubico/stable</span></span>
<span class="token command"><span class="token shell-symbol important">$</span> <span class="token bash language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> yubikey-manager-qt yubioath-desktop yubikey-personalization-gui</span></span>
</code></pre></div>
<h2 id="setup-u2f-key"><a href="#setup-u2f-key">Setup U2F Key</a></h2>
<h3 id="u2f-keyの登録"><a href="#u2f-keyの登録">U2F Keyの登録</a></h3>
<div class="remark-highlight"><pre data-file="terminal" class="language-shell-session"><code class="language-shell-session"><span class="token command"><span class="token shell-symbol important">$</span> <span class="token bash language-bash"><span class="token function">mkdir</span> -p <span class="token environment constant">$HOME</span>/.config/Yubico</span></span>
<span class="token command"><span class="token shell-symbol important">$</span> <span class="token bash language-bash">pamu2fcfg -u<span class="token variable">${<span class="token environment constant">USER</span>}</span> <span class="token operator">></span> <span class="token environment constant">$HOME</span>/.config/Yubico/u2f_keys</span></span>
</code></pre></div>
<p>またバックアップデバイスを追加する場合には<code>--nouser</code>をつけて追記<sup><a href="#user-content-fn-pamu2fcfg" id="user-content-fnref-pamu2fcfg" data-footnote-ref="" aria-describedby="footnote-label">1</a></sup>.</p>
<div class="remark-highlight"><pre data-file="terminal" class="language-shell-session"><code class="language-shell-session"><span class="token command"><span class="token shell-symbol important">$</span> <span class="token bash language-bash">pamu2fcfg -n <span class="token operator">>></span> <span class="token environment constant">$HOME</span>/.config/Yubico/u2f_keys</span></span>
</code></pre></div>
<h3 id="u2f-for-sudo"><a href="#u2f-for-sudo">U2F for SUDO</a></h3>
<p>以下の6行目を追記. PAM(Pluggable Authentication Modules)での認証において，password入力後にYubikeyがrequireされるようになる(Yubikeyが無いとauthできない).</p>
<p><strong><code>/etc/pam.d/sudo</code></strong></p>
<div class="remark-highlight"><pre data-file="/etc/pam.d/sudo" class="language-diff"><code class="language-diff"><span class="token unchanged"><span class="token prefix unchanged"> </span>#%PAM-1.0
</span>
<span class="token unchanged"><span class="token prefix unchanged"> </span>session    required    pam_env.so readenv=1 user_readenv=0
<span class="token prefix unchanged"> </span>session    required    pam_env.so readenv=1 envfile=/etc/default/locale user_readenv=0
<span class="token prefix unchanged"> </span>@include   common-auth
</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>auth       required    pam_u2f.so
</span><span class="token unchanged"><span class="token prefix unchanged"> </span>@include   common-account
<span class="token prefix unchanged"> </span>@include   common-session-noninteractive</span>
</code></pre></div>
<h3 id="u2f-for-login"><a href="#u2f-for-login">U2F for Login</a></h3>
<p>Display ManagerにGDM(Gnome Display Manager)を用いている場合は以下のファイルに<code>pam_u2f.so</code>の行を追記する.<br>
<strong><code>/etc/pam.d/gdm-password</code></strong>
その他のDMを用いている場合(KDE等)は <strong><code>/etc/pam.d/lightdm</code></strong> に追記する.</p>
<div class="remark-highlight"><pre data-file="/etc/pam.d/gdm-password" class="language-diff"><code class="language-diff"><span class="token unchanged"><span class="token prefix unchanged"> </span>#%PAM-1.0
<span class="token prefix unchanged"> </span>auth     requisite       pam_nologin.so
<span class="token prefix unchanged"> </span>auth     required        pam_succeed_if.so user != root quiet_success
<span class="token prefix unchanged"> </span>@include common-auth
</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>auth     required        pam_u2f.so
</span><span class="token unchanged"><span class="token prefix unchanged"> </span>auth     optional        pam_gnome_keyring.so
<span class="token prefix unchanged"> </span>@include common-account
<span class="token prefix unchanged"> </span>...omit</span>
</code></pre></div>
<h2 id="auto-lock-without-u2f"><a href="#auto-lock-without-u2f">Auto-lock without U2F</a></h2>
<p>ここからが本題. U2F Keyの接続が解除されると端末をロックする.</p>
<p>もともと自分の使っているLaptopには指紋認証センサが付属している．一般に生体認証はU2Fよりもセキュアであるし，自分も異論はない.<br>
ではU2Fが生体認証より優れている点はなにか. 自分の答えは認証の持続性をコントロールできる点である.</p>
<p>指紋認証を例に取ると，一度ログインした端末は一定時間操作をしない際のオートロックまたはユーザ自身の能動的なログアウトをしない限り，認証を再度必要としない.<br>
対してU2Fでは<strong>デバイスが接続されている間だけ認証されている</strong>という状態をもたらすことができる.</p>
<p>Apple Watchを身に着けた状態でMacの自動ログインが可能<sup><a href="#user-content-fn-applewatch" id="user-content-fnref-applewatch" data-footnote-ref="" aria-describedby="footnote-label">2</a></sup>という例がある.
これはbluetooth接続したU2Fデバイスが一定距離離れるもしくはUSB接続したデバイスをejectすることで端末からログアウトする，という仕様で再現できる.</p>
<h3 id="monitoring-u2f-key-by-udev"><a href="#monitoring-u2f-key-by-udev">monitoring U2F key by udev</a></h3>
<p>U2F Keyモニターをudevに任せることにする. まず対象のIDを特定する.
<code>udevadm monitor</code>でudevのイベントをモニタリングした状態でU2F Keyを抜き差しすると <code>bind</code>, <code>remove</code> イベントが通知されるので， <code>$ID_MODEL_ID</code> 及び <code>$ID_VENDOR_ID</code> を取得する.</p>
<div class="remark-highlight"><pre data-file="terminal" class="language-shell-session"><code class="language-shell-session"><span class="token command"><span class="token shell-symbol important">$</span> <span class="token bash language-bash">udevadm monitor --environment --udev</span></span>

<span class="token output">UDEV  [28028.490650] bind     /devices/pci0000:00/0000:00:14.0/usb1/1-3 (usb)</span>
<span class="token output">ACTION=bind</span>
<span class="token output">BUSNUM=001</span>
<span class="token output">DEVNAME=/dev/bus/usb/001/013</span>
<span class="token output">DEVNUM=013</span>
<span class="token output">DEVPATH=/devices/pci0000:00/0000:00:14.0/usb1/1-3</span>
<span class="token output">DEVTYPE=usb_device</span>
<span class="token output">DRIVER=usb</span>
<span class="token output">ID_BUS=usb</span>
<span class="token output">ID_MODEL=XXXXX</span>
<span class="token output">ID_MODEL_ENC=XXXXX</span>
<span class="token output">ID_MODEL_ID=f025</span>
<span class="token output">ID_REVISION=0100</span>
<span class="token output">ID_SERIAL=ExcelSecu_EsecuFIDO_HID</span>
<span class="token output">ID_USB_INTERFACES=:030000:</span>
<span class="token output">ID_VENDOR=ExcelSecu</span>
<span class="token output">ID_VENDOR_ENC=ExcelSecu</span>
<span class="token output">ID_VENDOR_ID=1ea8</span>
<span class="token output">MAJOR=189</span>
<span class="token output">MINOR=12</span>
<span class="token output">PRODUCT=1ea8/f025/100</span>
<span class="token output">SEQNUM=12938</span>
<span class="token output">SUBSYSTEM=usb</span>
<span class="token output">TYPE=0/0/0</span>
<span class="token output">USEC_INITIALIZED=28027949334</span>
</code></pre></div>
<p>上記の例では <code>ID_MODEL_ID=f025</code>，<code>ID_VENDOR_ID=1ea8</code> となっている.
このIDペアを用いて，U2F Key解除時の<code>udev</code>ルールを作成する.</p>
<p><strong><code>/etc/udev/rules.d/xx-u2fkey.rules</code></strong> (xxは適当な数字)</p>
<div class="remark-highlight"><pre data-file="/etc/udev/rules.d/xx-u2fkey.rules" class="language-config"><code class="language-config">ACTION==&#x26;quot;remove&#x26;quot;, ENV{ID_VENDOR_ID}==&#x26;quot;1ea8&#x26;quot;, ENV{ID_MODEL_ID}==&#x26;quot;f025&#x26;quot;, RUN+=&#x26;quot;/usr/local/bin/i3lock&#x26;quot;</code></pre></div>
<p>最後にrulesを登録し完了.</p>
<div class="remark-highlight"><pre data-file="terminal" class="language-shell-session"><code class="language-shell-session"><span class="token command"><span class="token shell-symbol important">$</span> <span class="token bash language-bash">udevadm control --reload-rules</span></span>
<span class="token command"><span class="token shell-symbol important">$</span> <span class="token bash language-bash"><span class="token function">service</span> udev reload</span></span>
</code></pre></div>
<hr>
<p>フリーランスという職業柄，PCを所持して企業へ出向くことが多くどうやってセキュリティ担保するかなーと考えてたところ<code>pamu2fcfg</code>を見かけたので試してみた.<br>
Yubikeyを忘れて外出するという失態を犯した<sup><a href="#user-content-fn-twi" id="user-content-fnref-twi" data-footnote-ref="" aria-describedby="footnote-label">3</a></sup>ので既に運用が危ういがデータは守れてるのでよし(よくないが)</p>
<h2 id="reference"><a href="#reference">Reference</a></h2>
<ul>
<li><a href="https://wiki.gentoo.org/wiki/Pam_u2f" rel="nofollow">Enable FIDO U2F USB support</a></li>
<li><a href="https://support.yubico.com/support/solutions/articles/15000010964-enabling-the-yubico-ppa-on-ubuntu" rel="nofollow">support.yubico.com#enabling the Yubico PPA on Ubuntu</a></li>
<li><a href="https://support.yubico.com/support/solutions/articles/15000011356-ubuntu-linux-login-guide-u2f" rel="nofollow">support.yubico.com#Ubuntu Linux Login Guide - U2F</a></li>
</ul>
<section data-footnotes="" class="footnotes"><h2 class="sr-only" id="footnote-label"><a href="#footnote-label">Footnotes</a></h2>
<ol>
<li id="user-content-fn-pamu2fcfg">
<p><a href="https://developers.yubico.com/pam-u2f/Manuals/pamu2fcfg.1.html" rel="nofollow">developers.yubico.com/pam-u2f/Manuals/pamu2fcfg.1.html</a> <a href="#user-content-fnref-pamu2fcfg" data-footnote-backref="" aria-label="Back to reference 1" class="data-footnote-backref">↩</a></p>
</li>
<li id="user-content-fn-applewatch">
<p><a href="https://support.apple.com/ja-jp/HT206995" rel="nofollow">support.apple.com/ja-jp/HT206995</a> <a href="#user-content-fnref-applewatch" data-footnote-backref="" aria-label="Back to reference 2" class="data-footnote-backref">↩</a></p>
</li>
<li id="user-content-fn-twi">
<p><a href="https://twitter.com/k_0ka/status/1159312312156561408" rel="nofollow">twitter.com/k_0ka/status/1159312312156561408</a> <a href="#user-content-fnref-twi" data-footnote-backref="" aria-label="Back to reference 3" class="data-footnote-backref">↩</a></p>
</li>
</ol>
</section></div></article><div class="CommitLogs_commit_logs__5HqJt" role="log"><h2>Commits</h2><details><summary class="CommitLogs_summary__ZlqPh"><span class="CommitLogs_commit__date__m2ycj">2021-04-10 17:49:51</span><span class="CommitLogs_commit__hash__wzS9A">7fc1fe90</span><span class="CommitLogs_commit__message__q7MGV">update</span></summary><div><div class="remark-highlight"><pre data-file="7fc1fe90.patch" class="language-git language-diff"><code class="language-git"><span class="token commit-sha1">commit 7fc1fe9095a4a16d5b29f42b7ce90933aa17d91e</span>
Author: koka &#x26;<a href="mailto:lt;koka.code@gmail.com" class="token email-link">lt;koka.code@gmail.com</a>&#x26;gt;
Date:   Sat Apr 10 17:49:51 2021 +0900

  update

diff --git a/_posts/2019-08-08-autolock-with-yubikey.md b/_posts/2019-08-08-autolock-with-yubikey.md
index f40e591..e3bfc43 100644
<span class="token deleted">--- a/_posts/2019-08-08-autolock-with-yubikey.md</span>
<span class="token inserted">+++ b/_posts/2019-08-08-autolock-with-yubikey.md</span>
@@ -20,7 +20,7 @@ description: Yubikeyを自宅に忘れて１敗

<span class="token comment">## Install Dependencies</span>

<span class="token deleted">-\```sh</span>
<span class="token inserted">+\```shell-session[data-file="terminal"]</span>
$ sudo add-apt-repository ppa:yubico/stable
$ sudo apt-get install yubikey-manager-qt yubioath-desktop yubikey-personalization-gui
\```
@@ -28,14 +28,14 @@ $ sudo apt-get install yubikey-manager-qt yubioath-desktop yubikey-personalizati
<span class="token comment">## Setup U2F Key</span>
<span class="token comment">### U2F Keyの登録</span>

<span class="token deleted">-\```sh</span>
<span class="token inserted">+\```shell-session[data-file="terminal"]</span>
$ mkdir -p $HOME/.config/Yubico
$ pamu2fcfg -u${USER} &#x26;gt; $HOME/.config/Yubico/u2f_keys
\```

またバックアップデバイスを追加する場合には`--nouser`をつけて追記[^pamu2fcfg].

<span class="token deleted">-\```sh</span>
<span class="token inserted">+\```shell-session[data-file="terminal"]</span>
$ pamu2fcfg -n &#x26;gt;&#x26;gt; $HOME/.config/Yubico/u2f_keys
\```

@@ -44,7 +44,7 @@ $ pamu2fcfg -n &#x26;gt;&#x26;gt; $HOME/.config/Yubico/u2f_keys

**`/etc/pam.d/sudo`**

<span class="token deleted">-\```diff</span>
<span class="token inserted">+\```diff[data-file="/etc/pam.d/sudo"]</span>
<span class="token comment">#%PAM-1.0</span>

session    required    pam_env.so readenv=1 user_readenv=0
@@ -61,7 +61,7 @@ Display ManagerにGDM(Gnome Display Manager)を用いている場合は以下の
その他のDMを用いている場合(KDE等)は **`/etc/pam.d/lightdm`** に追記する.


<span class="token deleted">-\```diff</span>
<span class="token inserted">+\```diff[data-file="/etc/pam.d/gdm-password"]</span>
<span class="token comment">#%PAM-1.0</span>
auth     requisite       pam_nologin.so
auth     required        pam_succeed_if.so user != root quiet_success
@@ -88,7 +88,7 @@ Apple Watchを身に着けた状態でMacの自動ログインが可能[^applewa
U2F Keyモニターをudevに任せることにする. まず対象のIDを特定する.
`udevadm monitor`でudevのイベントをモニタリングした状態でU2F Keyを抜き差しすると `bind`, `remove` イベントが通知されるので， `$ID_MODEL_ID` 及び `$ID_VENDOR_ID` を取得する.

<span class="token deleted">-\```sh</span>
<span class="token inserted">+\```shell-session[data-file="terminal"]</span>
$ udevadm monitor --environment --udev

UDEV  [28028.490650] bind     /devices/pci0000:00/0000:00:14.0/usb1/1-3 (usb)
@@ -123,13 +123,13 @@ USEC_INITIALIZED=28027949334

**`/etc/udev/rules.d/xx-u2fkey.rules`** (xxは適当な数字)

<span class="token deleted">-\```config</span>
<span class="token inserted">+\```config[data-file="/etc/udev/rules.d/xx-u2fkey.rules"]</span>
ACTION==<span class="token string">"remove"</span>, ENV{ID_VENDOR_ID}==<span class="token string">"1ea8"</span>, ENV{ID_MODEL_ID}==<span class="token string">"f025"</span>, RUN+=<span class="token string">"/usr/local/bin/i3lock"</span>
\```

最後にrulesを登録し完了.

<span class="token deleted">-\```sh</span>
<span class="token inserted">+\```shell-session[data-file="terminal"]</span>
$ udevadm control --reload-rules
$ service udev reload
\```
</code></pre></div></div></details><details><summary class="CommitLogs_summary__ZlqPh"><span class="CommitLogs_commit__date__m2ycj">2021-01-30 22:18:17</span><span class="CommitLogs_commit__hash__wzS9A">35b550ae</span><span class="CommitLogs_commit__message__q7MGV">copy md</span></summary><div><div class="remark-highlight"><pre data-file="35b550ae.patch" class="language-git language-diff"><code class="language-git"><span class="token commit-sha1">commit 35b550ae83af4efaeadf33471c8ca8a32c1079c8</span>
Author: koka &#x26;<a href="mailto:lt;koka.code@gmail.com" class="token email-link">lt;koka.code@gmail.com</a>&#x26;gt;
Date:   Sat Jan 30 22:18:17 2021 +0900

  copy md

diff --git a/_posts/2019-08-08-autolock-with-yubikey.md b/_posts/2019-08-08-autolock-with-yubikey.md
new file mode 100644
index 0000000..f40e591
<span class="token deleted">--- /dev/null</span>
<span class="token inserted">+++ b/_posts/2019-08-08-autolock-with-yubikey.md</span>
<span class="token coord">@@ -0,0 +1,148 @@</span>
<span class="token inserted">+---</span>
<span class="token inserted">+title: 'Linux: Login/sudo with Yubikey'</span>
<span class="token inserted">+date: 2019-08-08</span>
<span class="token inserted">+categories:</span>
<span class="token inserted">+- diary</span>
<span class="token inserted">+tags:</span>
<span class="token inserted">+- Linux</span>
<span class="token inserted">+- udev</span>
<span class="token inserted">+- yubikey</span>
<span class="token inserted">+description: Yubikeyを自宅に忘れて１敗</span>
<span class="token inserted">+---</span>
<span class="token inserted">+</span>
<span class="token inserted">+## Abstract</span>
<span class="token inserted">+- Linux Desktopのログイン時及び`sudo`時にYubikey + Passwordを必須にしてみた.</span>
<span class="token inserted">+- ログインした状態でYubikeyを抜くとlockするようにした.</span>
<span class="token inserted">+</span>
<span class="token inserted">+## Env</span>
<span class="token inserted">+- Ubuntu 18.04</span>
<span class="token inserted">+- FIDO U2F Security Key(自分は[これ](https://www.amazon.co.jp/dp/B06XHTKFH3/ref=cm_sw_em_r_mt_dp_U_Ha5sDbS6H12P6)つかってます. 端子ガードついてるKey他にも出てほしい)</span>
<span class="token inserted">+</span>
<span class="token inserted">+## Install Dependencies</span>
<span class="token inserted">+</span>
<span class="token inserted">+\```sh</span>
<span class="token inserted">+$ sudo add-apt-repository ppa:yubico/stable</span>
<span class="token inserted">+$ sudo apt-get install yubikey-manager-qt yubioath-desktop yubikey-personalization-gui</span>
<span class="token inserted">+\```</span>
<span class="token inserted">+</span>
<span class="token inserted">+## Setup U2F Key</span>
<span class="token inserted">+### U2F Keyの登録</span>
<span class="token inserted">+</span>
<span class="token inserted">+\```sh</span>
<span class="token inserted">+$ mkdir -p $HOME/.config/Yubico</span>
<span class="token inserted">+$ pamu2fcfg -u${USER} &#x26;gt; $HOME/.config/Yubico/u2f_keys</span>
<span class="token inserted">+\```</span>
<span class="token inserted">+</span>
<span class="token inserted">+またバックアップデバイスを追加する場合には`--nouser`をつけて追記[^pamu2fcfg].</span>
<span class="token inserted">+</span>
<span class="token inserted">+\```sh</span>
<span class="token inserted">+$ pamu2fcfg -n &#x26;gt;&#x26;gt; $HOME/.config/Yubico/u2f_keys</span>
<span class="token inserted">+\```</span>
<span class="token inserted">+</span>
<span class="token inserted">+### U2F for SUDO</span>
<span class="token inserted">+以下の6行目を追記. PAM(Pluggable Authentication Modules)での認証において，password入力後にYubikeyがrequireされるようになる(Yubikeyが無いとauthできない).</span>
<span class="token inserted">+</span>
<span class="token inserted">+**`/etc/pam.d/sudo`**</span>
<span class="token inserted">+</span>
<span class="token inserted">+\```diff</span>
<span class="token inserted">+ #%PAM-1.0</span>
<span class="token inserted">+</span>
<span class="token inserted">+ session    required    pam_env.so readenv=1 user_readenv=0</span>
<span class="token inserted">+ session    required    pam_env.so readenv=1 envfile=/etc/default/locale user_readenv=0</span>
<span class="token inserted">+ @include   common-auth</span>
<span class="token inserted">++auth       required    pam_u2f.so</span>
<span class="token inserted">+ @include   common-account</span>
<span class="token inserted">+ @include   common-session-noninteractive</span>
<span class="token inserted">+\```</span>
<span class="token inserted">+</span>
<span class="token inserted">+### U2F for Login</span>
<span class="token inserted">+Display ManagerにGDM(Gnome Display Manager)を用いている場合は以下のファイルに`pam_u2f.so`の行を追記する.  </span>
<span class="token inserted">+**`/etc/pam.d/gdm-password`**</span>
<span class="token inserted">+その他のDMを用いている場合(KDE等)は **`/etc/pam.d/lightdm`** に追記する.</span>
<span class="token inserted">+</span>
<span class="token inserted">+</span>
<span class="token inserted">+\```diff</span>
<span class="token inserted">+ #%PAM-1.0</span>
<span class="token inserted">+ auth     requisite       pam_nologin.so</span>
<span class="token inserted">+ auth     required        pam_succeed_if.so user != root quiet_success</span>
<span class="token inserted">+ @include common-auth</span>
<span class="token inserted">++auth     required        pam_u2f.so</span>
<span class="token inserted">+ auth     optional        pam_gnome_keyring.so</span>
<span class="token inserted">+ @include common-account</span>
<span class="token inserted">+ ...omit</span>
<span class="token inserted">+\```</span>
<span class="token inserted">+</span>
<span class="token inserted">+## Auto-lock without U2F</span>
<span class="token inserted">+ここからが本題. U2F Keyの接続が解除されると端末をロックする.  </span>
<span class="token inserted">+</span>
<span class="token inserted">+もともと自分の使っているLaptopには指紋認証センサが付属している．一般に生体認証はU2Fよりもセキュアであるし，自分も異論はない.  </span>
<span class="token inserted">+ではU2Fが生体認証より優れている点はなにか. 自分の答えは認証の持続性をコントロールできる点である.  </span>
<span class="token inserted">+</span>
<span class="token inserted">+指紋認証を例に取ると，一度ログインした端末は一定時間操作をしない際のオートロックまたはユーザ自身の能動的なログアウトをしない限り，認証を再度必要としない.  </span>
<span class="token inserted">+対してU2Fでは**デバイスが接続されている間だけ認証されている**という状態をもたらすことができる.</span>
<span class="token inserted">+</span>
<span class="token inserted">+Apple Watchを身に着けた状態でMacの自動ログインが可能[^applewatch]という例がある.</span>
<span class="token inserted">+これはbluetooth接続したU2Fデバイスが一定距離離れるもしくはUSB接続したデバイスをejectすることで端末からログアウトする，という仕様で再現できる.</span>
<span class="token inserted">+</span>
<span class="token inserted">+### monitoring U2F key by udev</span>
<span class="token inserted">+U2F Keyモニターをudevに任せることにする. まず対象のIDを特定する.</span>
<span class="token inserted">+`udevadm monitor`でudevのイベントをモニタリングした状態でU2F Keyを抜き差しすると `bind`, `remove` イベントが通知されるので， `$ID_MODEL_ID` 及び `$ID_VENDOR_ID` を取得する.</span>
<span class="token inserted">+</span>
<span class="token inserted">+\```sh</span>
<span class="token inserted">+$ udevadm monitor --environment --udev</span>
<span class="token inserted">+</span>
<span class="token inserted">+UDEV  [28028.490650] bind     /devices/pci0000:00/0000:00:14.0/usb1/1-3 (usb)</span>
<span class="token inserted">+ACTION=bind</span>
<span class="token inserted">+BUSNUM=001</span>
<span class="token inserted">+DEVNAME=/dev/bus/usb/001/013</span>
<span class="token inserted">+DEVNUM=013</span>
<span class="token inserted">+DEVPATH=/devices/pci0000:00/0000:00:14.0/usb1/1-3</span>
<span class="token inserted">+DEVTYPE=usb_device</span>
<span class="token inserted">+DRIVER=usb</span>
<span class="token inserted">+ID_BUS=usb</span>
<span class="token inserted">+ID_MODEL=XXXXX</span>
<span class="token inserted">+ID_MODEL_ENC=XXXXX</span>
<span class="token inserted">+ID_MODEL_ID=f025</span>
<span class="token inserted">+ID_REVISION=0100</span>
<span class="token inserted">+ID_SERIAL=ExcelSecu_EsecuFIDO_HID</span>
<span class="token inserted">+ID_USB_INTERFACES=:030000:</span>
<span class="token inserted">+ID_VENDOR=ExcelSecu</span>
<span class="token inserted">+ID_VENDOR_ENC=ExcelSecu</span>
<span class="token inserted">+ID_VENDOR_ID=1ea8</span>
<span class="token inserted">+MAJOR=189</span>
<span class="token inserted">+MINOR=12</span>
<span class="token inserted">+PRODUCT=1ea8/f025/100</span>
<span class="token inserted">+SEQNUM=12938</span>
<span class="token inserted">+SUBSYSTEM=usb</span>
<span class="token inserted">+TYPE=0/0/0</span>
<span class="token inserted">+USEC_INITIALIZED=28027949334</span>
<span class="token inserted">+\```</span>
<span class="token inserted">+</span>
<span class="token inserted">+上記の例では `ID_MODEL_ID=f025`，`ID_VENDOR_ID=1ea8` となっている.</span>
<span class="token inserted">+このIDペアを用いて，U2F Key解除時の`udev`ルールを作成する.</span>
<span class="token inserted">+</span>
<span class="token inserted">+**`/etc/udev/rules.d/xx-u2fkey.rules`** (xxは適当な数字)</span>
<span class="token inserted">+</span>
<span class="token inserted">+\```config</span>
<span class="token inserted">+ACTION=="remove", ENV{ID_VENDOR_ID}=="1ea8", ENV{ID_MODEL_ID}=="f025", RUN+="/usr/local/bin/i3lock"</span>
<span class="token inserted">+\```</span>
<span class="token inserted">+</span>
<span class="token inserted">+最後にrulesを登録し完了.</span>
<span class="token inserted">+</span>
<span class="token inserted">+\```sh</span>
<span class="token inserted">+$ udevadm control --reload-rules</span>
<span class="token inserted">+$ service udev reload</span>
<span class="token inserted">+\```</span>
<span class="token inserted">+</span>
<span class="token inserted">+---</span>
<span class="token inserted">+フリーランスという職業柄，PCを所持して企業へ出向くことが多くどうやってセキュリティ担保するかなーと考えてたところ`pamu2fcfg`を見かけたので試してみた.  </span>
<span class="token inserted">+Yubikeyを忘れて外出するという失態を犯した[^twi]ので既に運用が危ういがデータは守れてるのでよし(よくないが)</span>
<span class="token inserted">+</span>
<span class="token inserted">+</span>
<span class="token inserted">+## Reference</span>
<span class="token inserted">+[^pamu2fcfg]: [developers.yubico.com/pam-u2f/Manuals/pamu2fcfg.1.html](https://developers.yubico.com/pam-u2f/Manuals/pamu2fcfg.1.html)</span>
<span class="token inserted">+[^applewatch]: [support.apple.com/ja-jp/HT206995](https://support.apple.com/ja-jp/HT206995)</span>
<span class="token inserted">+[^twi]: [twitter.com/k_0ka/status/1159312312156561408](https://twitter.com/k_0ka/status/1159312312156561408)</span>
<span class="token inserted">+- [Enable FIDO U2F USB support](https://wiki.gentoo.org/wiki/Pam_u2f)</span>
<span class="token inserted">+- [support.yubico.com#enabling the Yubico PPA on Ubuntu](https://support.yubico.com/support/solutions/articles/15000010964-enabling-the-yubico-ppa-on-ubuntu)</span>
<span class="token inserted">+- [support.yubico.com#Ubuntu Linux Login Guide - U2F](https://support.yubico.com/support/solutions/articles/15000011356-ubuntu-linux-login-guide-u2f)</span>
</code></pre></div></div></details></div><div class="Comments_comment__S1sQU" role="comment"><h2 class="Comments_title__494X3">Comments</h2><div id="github-comment-container"></div></div></div><aside class="slug_aside__Ow2nH"><nav class="Toc_toc__nav__MM10v" role="navigation"><ul class="Toc_toc__f9CQa"></ul></nav></aside></div></main><footer class="Footer_footer__UaG1g"><small>Code snippets licensed under MIT, unless otherwise noted.</small></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"slug":"2019-08-08-autolock-with-yubikey","title":"Linux: Login/sudo with Yubikey","categories":["diary"],"image":"https://koka831.github.io/img/icon.png","tags":["Linux","udev","yubikey"],"content":"\u003ch2 id=\"abstract\"\u003e\u003ca href=\"#abstract\"\u003eAbstract\u003c/a\u003e\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eLinux Desktopのログイン時及び\u003ccode\u003esudo\u003c/code\u003e時にYubikey + Passwordを必須にしてみた.\u003c/li\u003e\n\u003cli\u003eログインした状態でYubikeyを抜くとlockするようにした.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"env\"\u003e\u003ca href=\"#env\"\u003eEnv\u003c/a\u003e\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eUbuntu 18.04\u003c/li\u003e\n\u003cli\u003eFIDO U2F Security Key(自分は\u003ca href=\"https://www.amazon.co.jp/dp/B06XHTKFH3/ref=cm_sw_em_r_mt_dp_U_Ha5sDbS6H12P6\" rel=\"nofollow\"\u003eこれ\u003c/a\u003eつかってます. 端子ガードついてるKey他にも出てほしい)\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"install-dependencies\"\u003e\u003ca href=\"#install-dependencies\"\u003eInstall Dependencies\u003c/a\u003e\u003c/h2\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"terminal\" class=\"language-shell-session\"\u003e\u003ccode class=\"language-shell-session\"\u003e\u003cspan class=\"token command\"\u003e\u003cspan class=\"token shell-symbol important\"\u003e$\u003c/span\u003e \u003cspan class=\"token bash language-bash\"\u003e\u003cspan class=\"token function\"\u003esudo\u003c/span\u003e add-apt-repository ppa:yubico/stable\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token command\"\u003e\u003cspan class=\"token shell-symbol important\"\u003e$\u003c/span\u003e \u003cspan class=\"token bash language-bash\"\u003e\u003cspan class=\"token function\"\u003esudo\u003c/span\u003e \u003cspan class=\"token function\"\u003eapt-get\u003c/span\u003e \u003cspan class=\"token function\"\u003einstall\u003c/span\u003e yubikey-manager-qt yubioath-desktop yubikey-personalization-gui\u003c/span\u003e\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2 id=\"setup-u2f-key\"\u003e\u003ca href=\"#setup-u2f-key\"\u003eSetup U2F Key\u003c/a\u003e\u003c/h2\u003e\n\u003ch3 id=\"u2f-keyの登録\"\u003e\u003ca href=\"#u2f-keyの登録\"\u003eU2F Keyの登録\u003c/a\u003e\u003c/h3\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"terminal\" class=\"language-shell-session\"\u003e\u003ccode class=\"language-shell-session\"\u003e\u003cspan class=\"token command\"\u003e\u003cspan class=\"token shell-symbol important\"\u003e$\u003c/span\u003e \u003cspan class=\"token bash language-bash\"\u003e\u003cspan class=\"token function\"\u003emkdir\u003c/span\u003e -p \u003cspan class=\"token environment constant\"\u003e$HOME\u003c/span\u003e/.config/Yubico\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token command\"\u003e\u003cspan class=\"token shell-symbol important\"\u003e$\u003c/span\u003e \u003cspan class=\"token bash language-bash\"\u003epamu2fcfg -u\u003cspan class=\"token variable\"\u003e${\u003cspan class=\"token environment constant\"\u003eUSER\u003c/span\u003e}\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token environment constant\"\u003e$HOME\u003c/span\u003e/.config/Yubico/u2f_keys\u003c/span\u003e\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eまたバックアップデバイスを追加する場合には\u003ccode\u003e--nouser\u003c/code\u003eをつけて追記\u003csup\u003e\u003ca href=\"#user-content-fn-pamu2fcfg\" id=\"user-content-fnref-pamu2fcfg\" data-footnote-ref=\"\" aria-describedby=\"footnote-label\"\u003e1\u003c/a\u003e\u003c/sup\u003e.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"terminal\" class=\"language-shell-session\"\u003e\u003ccode class=\"language-shell-session\"\u003e\u003cspan class=\"token command\"\u003e\u003cspan class=\"token shell-symbol important\"\u003e$\u003c/span\u003e \u003cspan class=\"token bash language-bash\"\u003epamu2fcfg -n \u003cspan class=\"token operator\"\u003e\u003e\u003e\u003c/span\u003e \u003cspan class=\"token environment constant\"\u003e$HOME\u003c/span\u003e/.config/Yubico/u2f_keys\u003c/span\u003e\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch3 id=\"u2f-for-sudo\"\u003e\u003ca href=\"#u2f-for-sudo\"\u003eU2F for SUDO\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003e以下の6行目を追記. PAM(Pluggable Authentication Modules)での認証において，password入力後にYubikeyがrequireされるようになる(Yubikeyが無いとauthできない).\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e\u003ccode\u003e/etc/pam.d/sudo\u003c/code\u003e\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"/etc/pam.d/sudo\" class=\"language-diff\"\u003e\u003ccode class=\"language-diff\"\u003e\u003cspan class=\"token unchanged\"\u003e\u003cspan class=\"token prefix unchanged\"\u003e \u003c/span\u003e#%PAM-1.0\n\u003c/span\u003e\n\u003cspan class=\"token unchanged\"\u003e\u003cspan class=\"token prefix unchanged\"\u003e \u003c/span\u003esession    required    pam_env.so readenv=1 user_readenv=0\n\u003cspan class=\"token prefix unchanged\"\u003e \u003c/span\u003esession    required    pam_env.so readenv=1 envfile=/etc/default/locale user_readenv=0\n\u003cspan class=\"token prefix unchanged\"\u003e \u003c/span\u003e@include   common-auth\n\u003c/span\u003e\u003cspan class=\"token inserted-sign inserted\"\u003e\u003cspan class=\"token prefix inserted\"\u003e+\u003c/span\u003eauth       required    pam_u2f.so\n\u003c/span\u003e\u003cspan class=\"token unchanged\"\u003e\u003cspan class=\"token prefix unchanged\"\u003e \u003c/span\u003e@include   common-account\n\u003cspan class=\"token prefix unchanged\"\u003e \u003c/span\u003e@include   common-session-noninteractive\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch3 id=\"u2f-for-login\"\u003e\u003ca href=\"#u2f-for-login\"\u003eU2F for Login\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003eDisplay ManagerにGDM(Gnome Display Manager)を用いている場合は以下のファイルに\u003ccode\u003epam_u2f.so\u003c/code\u003eの行を追記する.\u003cbr\u003e\n\u003cstrong\u003e\u003ccode\u003e/etc/pam.d/gdm-password\u003c/code\u003e\u003c/strong\u003e\nその他のDMを用いている場合(KDE等)は \u003cstrong\u003e\u003ccode\u003e/etc/pam.d/lightdm\u003c/code\u003e\u003c/strong\u003e に追記する.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"/etc/pam.d/gdm-password\" class=\"language-diff\"\u003e\u003ccode class=\"language-diff\"\u003e\u003cspan class=\"token unchanged\"\u003e\u003cspan class=\"token prefix unchanged\"\u003e \u003c/span\u003e#%PAM-1.0\n\u003cspan class=\"token prefix unchanged\"\u003e \u003c/span\u003eauth     requisite       pam_nologin.so\n\u003cspan class=\"token prefix unchanged\"\u003e \u003c/span\u003eauth     required        pam_succeed_if.so user != root quiet_success\n\u003cspan class=\"token prefix unchanged\"\u003e \u003c/span\u003e@include common-auth\n\u003c/span\u003e\u003cspan class=\"token inserted-sign inserted\"\u003e\u003cspan class=\"token prefix inserted\"\u003e+\u003c/span\u003eauth     required        pam_u2f.so\n\u003c/span\u003e\u003cspan class=\"token unchanged\"\u003e\u003cspan class=\"token prefix unchanged\"\u003e \u003c/span\u003eauth     optional        pam_gnome_keyring.so\n\u003cspan class=\"token prefix unchanged\"\u003e \u003c/span\u003e@include common-account\n\u003cspan class=\"token prefix unchanged\"\u003e \u003c/span\u003e...omit\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2 id=\"auto-lock-without-u2f\"\u003e\u003ca href=\"#auto-lock-without-u2f\"\u003eAuto-lock without U2F\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003eここからが本題. U2F Keyの接続が解除されると端末をロックする.\u003c/p\u003e\n\u003cp\u003eもともと自分の使っているLaptopには指紋認証センサが付属している．一般に生体認証はU2Fよりもセキュアであるし，自分も異論はない.\u003cbr\u003e\nではU2Fが生体認証より優れている点はなにか. 自分の答えは認証の持続性をコントロールできる点である.\u003c/p\u003e\n\u003cp\u003e指紋認証を例に取ると，一度ログインした端末は一定時間操作をしない際のオートロックまたはユーザ自身の能動的なログアウトをしない限り，認証を再度必要としない.\u003cbr\u003e\n対してU2Fでは\u003cstrong\u003eデバイスが接続されている間だけ認証されている\u003c/strong\u003eという状態をもたらすことができる.\u003c/p\u003e\n\u003cp\u003eApple Watchを身に着けた状態でMacの自動ログインが可能\u003csup\u003e\u003ca href=\"#user-content-fn-applewatch\" id=\"user-content-fnref-applewatch\" data-footnote-ref=\"\" aria-describedby=\"footnote-label\"\u003e2\u003c/a\u003e\u003c/sup\u003eという例がある.\nこれはbluetooth接続したU2Fデバイスが一定距離離れるもしくはUSB接続したデバイスをejectすることで端末からログアウトする，という仕様で再現できる.\u003c/p\u003e\n\u003ch3 id=\"monitoring-u2f-key-by-udev\"\u003e\u003ca href=\"#monitoring-u2f-key-by-udev\"\u003emonitoring U2F key by udev\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003eU2F Keyモニターをudevに任せることにする. まず対象のIDを特定する.\n\u003ccode\u003eudevadm monitor\u003c/code\u003eでudevのイベントをモニタリングした状態でU2F Keyを抜き差しすると \u003ccode\u003ebind\u003c/code\u003e, \u003ccode\u003eremove\u003c/code\u003e イベントが通知されるので， \u003ccode\u003e$ID_MODEL_ID\u003c/code\u003e 及び \u003ccode\u003e$ID_VENDOR_ID\u003c/code\u003e を取得する.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"terminal\" class=\"language-shell-session\"\u003e\u003ccode class=\"language-shell-session\"\u003e\u003cspan class=\"token command\"\u003e\u003cspan class=\"token shell-symbol important\"\u003e$\u003c/span\u003e \u003cspan class=\"token bash language-bash\"\u003eudevadm monitor --environment --udev\u003c/span\u003e\u003c/span\u003e\n\n\u003cspan class=\"token output\"\u003eUDEV  [28028.490650] bind     /devices/pci0000:00/0000:00:14.0/usb1/1-3 (usb)\u003c/span\u003e\n\u003cspan class=\"token output\"\u003eACTION=bind\u003c/span\u003e\n\u003cspan class=\"token output\"\u003eBUSNUM=001\u003c/span\u003e\n\u003cspan class=\"token output\"\u003eDEVNAME=/dev/bus/usb/001/013\u003c/span\u003e\n\u003cspan class=\"token output\"\u003eDEVNUM=013\u003c/span\u003e\n\u003cspan class=\"token output\"\u003eDEVPATH=/devices/pci0000:00/0000:00:14.0/usb1/1-3\u003c/span\u003e\n\u003cspan class=\"token output\"\u003eDEVTYPE=usb_device\u003c/span\u003e\n\u003cspan class=\"token output\"\u003eDRIVER=usb\u003c/span\u003e\n\u003cspan class=\"token output\"\u003eID_BUS=usb\u003c/span\u003e\n\u003cspan class=\"token output\"\u003eID_MODEL=XXXXX\u003c/span\u003e\n\u003cspan class=\"token output\"\u003eID_MODEL_ENC=XXXXX\u003c/span\u003e\n\u003cspan class=\"token output\"\u003eID_MODEL_ID=f025\u003c/span\u003e\n\u003cspan class=\"token output\"\u003eID_REVISION=0100\u003c/span\u003e\n\u003cspan class=\"token output\"\u003eID_SERIAL=ExcelSecu_EsecuFIDO_HID\u003c/span\u003e\n\u003cspan class=\"token output\"\u003eID_USB_INTERFACES=:030000:\u003c/span\u003e\n\u003cspan class=\"token output\"\u003eID_VENDOR=ExcelSecu\u003c/span\u003e\n\u003cspan class=\"token output\"\u003eID_VENDOR_ENC=ExcelSecu\u003c/span\u003e\n\u003cspan class=\"token output\"\u003eID_VENDOR_ID=1ea8\u003c/span\u003e\n\u003cspan class=\"token output\"\u003eMAJOR=189\u003c/span\u003e\n\u003cspan class=\"token output\"\u003eMINOR=12\u003c/span\u003e\n\u003cspan class=\"token output\"\u003ePRODUCT=1ea8/f025/100\u003c/span\u003e\n\u003cspan class=\"token output\"\u003eSEQNUM=12938\u003c/span\u003e\n\u003cspan class=\"token output\"\u003eSUBSYSTEM=usb\u003c/span\u003e\n\u003cspan class=\"token output\"\u003eTYPE=0/0/0\u003c/span\u003e\n\u003cspan class=\"token output\"\u003eUSEC_INITIALIZED=28027949334\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e上記の例では \u003ccode\u003eID_MODEL_ID=f025\u003c/code\u003e，\u003ccode\u003eID_VENDOR_ID=1ea8\u003c/code\u003e となっている.\nこのIDペアを用いて，U2F Key解除時の\u003ccode\u003eudev\u003c/code\u003eルールを作成する.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e\u003ccode\u003e/etc/udev/rules.d/xx-u2fkey.rules\u003c/code\u003e\u003c/strong\u003e (xxは適当な数字)\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"/etc/udev/rules.d/xx-u2fkey.rules\" class=\"language-config\"\u003e\u003ccode class=\"language-config\"\u003eACTION==\u0026#x26;quot;remove\u0026#x26;quot;, ENV{ID_VENDOR_ID}==\u0026#x26;quot;1ea8\u0026#x26;quot;, ENV{ID_MODEL_ID}==\u0026#x26;quot;f025\u0026#x26;quot;, RUN+=\u0026#x26;quot;/usr/local/bin/i3lock\u0026#x26;quot;\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e最後にrulesを登録し完了.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"terminal\" class=\"language-shell-session\"\u003e\u003ccode class=\"language-shell-session\"\u003e\u003cspan class=\"token command\"\u003e\u003cspan class=\"token shell-symbol important\"\u003e$\u003c/span\u003e \u003cspan class=\"token bash language-bash\"\u003eudevadm control --reload-rules\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token command\"\u003e\u003cspan class=\"token shell-symbol important\"\u003e$\u003c/span\u003e \u003cspan class=\"token bash language-bash\"\u003e\u003cspan class=\"token function\"\u003eservice\u003c/span\u003e udev reload\u003c/span\u003e\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003chr\u003e\n\u003cp\u003eフリーランスという職業柄，PCを所持して企業へ出向くことが多くどうやってセキュリティ担保するかなーと考えてたところ\u003ccode\u003epamu2fcfg\u003c/code\u003eを見かけたので試してみた.\u003cbr\u003e\nYubikeyを忘れて外出するという失態を犯した\u003csup\u003e\u003ca href=\"#user-content-fn-twi\" id=\"user-content-fnref-twi\" data-footnote-ref=\"\" aria-describedby=\"footnote-label\"\u003e3\u003c/a\u003e\u003c/sup\u003eので既に運用が危ういがデータは守れてるのでよし(よくないが)\u003c/p\u003e\n\u003ch2 id=\"reference\"\u003e\u003ca href=\"#reference\"\u003eReference\u003c/a\u003e\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://wiki.gentoo.org/wiki/Pam_u2f\" rel=\"nofollow\"\u003eEnable FIDO U2F USB support\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://support.yubico.com/support/solutions/articles/15000010964-enabling-the-yubico-ppa-on-ubuntu\" rel=\"nofollow\"\u003esupport.yubico.com#enabling the Yubico PPA on Ubuntu\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://support.yubico.com/support/solutions/articles/15000011356-ubuntu-linux-login-guide-u2f\" rel=\"nofollow\"\u003esupport.yubico.com#Ubuntu Linux Login Guide - U2F\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003csection data-footnotes=\"\" class=\"footnotes\"\u003e\u003ch2 class=\"sr-only\" id=\"footnote-label\"\u003e\u003ca href=\"#footnote-label\"\u003eFootnotes\u003c/a\u003e\u003c/h2\u003e\n\u003col\u003e\n\u003cli id=\"user-content-fn-pamu2fcfg\"\u003e\n\u003cp\u003e\u003ca href=\"https://developers.yubico.com/pam-u2f/Manuals/pamu2fcfg.1.html\" rel=\"nofollow\"\u003edevelopers.yubico.com/pam-u2f/Manuals/pamu2fcfg.1.html\u003c/a\u003e \u003ca href=\"#user-content-fnref-pamu2fcfg\" data-footnote-backref=\"\" aria-label=\"Back to reference 1\" class=\"data-footnote-backref\"\u003e↩\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli id=\"user-content-fn-applewatch\"\u003e\n\u003cp\u003e\u003ca href=\"https://support.apple.com/ja-jp/HT206995\" rel=\"nofollow\"\u003esupport.apple.com/ja-jp/HT206995\u003c/a\u003e \u003ca href=\"#user-content-fnref-applewatch\" data-footnote-backref=\"\" aria-label=\"Back to reference 2\" class=\"data-footnote-backref\"\u003e↩\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli id=\"user-content-fn-twi\"\u003e\n\u003cp\u003e\u003ca href=\"https://twitter.com/k_0ka/status/1159312312156561408\" rel=\"nofollow\"\u003etwitter.com/k_0ka/status/1159312312156561408\u003c/a\u003e \u003ca href=\"#user-content-fnref-twi\" data-footnote-backref=\"\" aria-label=\"Back to reference 3\" class=\"data-footnote-backref\"\u003e↩\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/section\u003e","description":"Yubikeyを自宅に忘れて１敗","commits":[{"title":"update","date":"2021-04-10 17:49:51","hash":"7fc1fe90","diff":"\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"7fc1fe90.patch\" class=\"language-git language-diff\"\u003e\u003ccode class=\"language-git\"\u003e\u003cspan class=\"token commit-sha1\"\u003ecommit 7fc1fe9095a4a16d5b29f42b7ce90933aa17d91e\u003c/span\u003e\nAuthor: koka \u0026#x26;\u003ca href=\"mailto:lt;koka.code@gmail.com\" class=\"token email-link\"\u003elt;koka.code@gmail.com\u003c/a\u003e\u0026#x26;gt;\nDate:   Sat Apr 10 17:49:51 2021 +0900\n\n  update\n\ndiff --git a/_posts/2019-08-08-autolock-with-yubikey.md b/_posts/2019-08-08-autolock-with-yubikey.md\nindex f40e591..e3bfc43 100644\n\u003cspan class=\"token deleted\"\u003e--- a/_posts/2019-08-08-autolock-with-yubikey.md\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+++ b/_posts/2019-08-08-autolock-with-yubikey.md\u003c/span\u003e\n@@ -20,7 +20,7 @@ description: Yubikeyを自宅に忘れて１敗\n\n\u003cspan class=\"token comment\"\u003e## Install Dependencies\u003c/span\u003e\n\n\u003cspan class=\"token deleted\"\u003e-\\```sh\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```shell-session[data-file=\"terminal\"]\u003c/span\u003e\n$ sudo add-apt-repository ppa:yubico/stable\n$ sudo apt-get install yubikey-manager-qt yubioath-desktop yubikey-personalization-gui\n\\```\n@@ -28,14 +28,14 @@ $ sudo apt-get install yubikey-manager-qt yubioath-desktop yubikey-personalizati\n\u003cspan class=\"token comment\"\u003e## Setup U2F Key\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e### U2F Keyの登録\u003c/span\u003e\n\n\u003cspan class=\"token deleted\"\u003e-\\```sh\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```shell-session[data-file=\"terminal\"]\u003c/span\u003e\n$ mkdir -p $HOME/.config/Yubico\n$ pamu2fcfg -u${USER} \u0026#x26;gt; $HOME/.config/Yubico/u2f_keys\n\\```\n\nまたバックアップデバイスを追加する場合には`--nouser`をつけて追記[^pamu2fcfg].\n\n\u003cspan class=\"token deleted\"\u003e-\\```sh\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```shell-session[data-file=\"terminal\"]\u003c/span\u003e\n$ pamu2fcfg -n \u0026#x26;gt;\u0026#x26;gt; $HOME/.config/Yubico/u2f_keys\n\\```\n\n@@ -44,7 +44,7 @@ $ pamu2fcfg -n \u0026#x26;gt;\u0026#x26;gt; $HOME/.config/Yubico/u2f_keys\n\n**`/etc/pam.d/sudo`**\n\n\u003cspan class=\"token deleted\"\u003e-\\```diff\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```diff[data-file=\"/etc/pam.d/sudo\"]\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e#%PAM-1.0\u003c/span\u003e\n\nsession    required    pam_env.so readenv=1 user_readenv=0\n@@ -61,7 +61,7 @@ Display ManagerにGDM(Gnome Display Manager)を用いている場合は以下の\nその他のDMを用いている場合(KDE等)は **`/etc/pam.d/lightdm`** に追記する.\n\n\n\u003cspan class=\"token deleted\"\u003e-\\```diff\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```diff[data-file=\"/etc/pam.d/gdm-password\"]\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e#%PAM-1.0\u003c/span\u003e\nauth     requisite       pam_nologin.so\nauth     required        pam_succeed_if.so user != root quiet_success\n@@ -88,7 +88,7 @@ Apple Watchを身に着けた状態でMacの自動ログインが可能[^applewa\nU2F Keyモニターをudevに任せることにする. まず対象のIDを特定する.\n`udevadm monitor`でudevのイベントをモニタリングした状態でU2F Keyを抜き差しすると `bind`, `remove` イベントが通知されるので， `$ID_MODEL_ID` 及び `$ID_VENDOR_ID` を取得する.\n\n\u003cspan class=\"token deleted\"\u003e-\\```sh\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```shell-session[data-file=\"terminal\"]\u003c/span\u003e\n$ udevadm monitor --environment --udev\n\nUDEV  [28028.490650] bind     /devices/pci0000:00/0000:00:14.0/usb1/1-3 (usb)\n@@ -123,13 +123,13 @@ USEC_INITIALIZED=28027949334\n\n**`/etc/udev/rules.d/xx-u2fkey.rules`** (xxは適当な数字)\n\n\u003cspan class=\"token deleted\"\u003e-\\```config\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```config[data-file=\"/etc/udev/rules.d/xx-u2fkey.rules\"]\u003c/span\u003e\nACTION==\u003cspan class=\"token string\"\u003e\"remove\"\u003c/span\u003e, ENV{ID_VENDOR_ID}==\u003cspan class=\"token string\"\u003e\"1ea8\"\u003c/span\u003e, ENV{ID_MODEL_ID}==\u003cspan class=\"token string\"\u003e\"f025\"\u003c/span\u003e, RUN+=\u003cspan class=\"token string\"\u003e\"/usr/local/bin/i3lock\"\u003c/span\u003e\n\\```\n\n最後にrulesを登録し完了.\n\n\u003cspan class=\"token deleted\"\u003e-\\```sh\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```shell-session[data-file=\"terminal\"]\u003c/span\u003e\n$ udevadm control --reload-rules\n$ service udev reload\n\\```\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e"},{"title":"copy md","date":"2021-01-30 22:18:17","hash":"35b550ae","diff":"\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"35b550ae.patch\" class=\"language-git language-diff\"\u003e\u003ccode class=\"language-git\"\u003e\u003cspan class=\"token commit-sha1\"\u003ecommit 35b550ae83af4efaeadf33471c8ca8a32c1079c8\u003c/span\u003e\nAuthor: koka \u0026#x26;\u003ca href=\"mailto:lt;koka.code@gmail.com\" class=\"token email-link\"\u003elt;koka.code@gmail.com\u003c/a\u003e\u0026#x26;gt;\nDate:   Sat Jan 30 22:18:17 2021 +0900\n\n  copy md\n\ndiff --git a/_posts/2019-08-08-autolock-with-yubikey.md b/_posts/2019-08-08-autolock-with-yubikey.md\nnew file mode 100644\nindex 0000000..f40e591\n\u003cspan class=\"token deleted\"\u003e--- /dev/null\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+++ b/_posts/2019-08-08-autolock-with-yubikey.md\u003c/span\u003e\n\u003cspan class=\"token coord\"\u003e@@ -0,0 +1,148 @@\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+---\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+title: 'Linux: Login/sudo with Yubikey'\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+date: 2019-08-08\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+categories:\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- diary\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+tags:\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- Linux\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- udev\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- yubikey\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+description: Yubikeyを自宅に忘れて１敗\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+---\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+## Abstract\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- Linux Desktopのログイン時及び`sudo`時にYubikey + Passwordを必須にしてみた.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- ログインした状態でYubikeyを抜くとlockするようにした.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+## Env\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- Ubuntu 18.04\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- FIDO U2F Security Key(自分は[これ](https://www.amazon.co.jp/dp/B06XHTKFH3/ref=cm_sw_em_r_mt_dp_U_Ha5sDbS6H12P6)つかってます. 端子ガードついてるKey他にも出てほしい)\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+## Install Dependencies\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```sh\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+$ sudo add-apt-repository ppa:yubico/stable\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+$ sudo apt-get install yubikey-manager-qt yubioath-desktop yubikey-personalization-gui\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+## Setup U2F Key\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+### U2F Keyの登録\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```sh\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+$ mkdir -p $HOME/.config/Yubico\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+$ pamu2fcfg -u${USER} \u0026#x26;gt; $HOME/.config/Yubico/u2f_keys\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+またバックアップデバイスを追加する場合には`--nouser`をつけて追記[^pamu2fcfg].\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```sh\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+$ pamu2fcfg -n \u0026#x26;gt;\u0026#x26;gt; $HOME/.config/Yubico/u2f_keys\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+### U2F for SUDO\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+以下の6行目を追記. PAM(Pluggable Authentication Modules)での認証において，password入力後にYubikeyがrequireされるようになる(Yubikeyが無いとauthできない).\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+**`/etc/pam.d/sudo`**\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```diff\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ #%PAM-1.0\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ session    required    pam_env.so readenv=1 user_readenv=0\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ session    required    pam_env.so readenv=1 envfile=/etc/default/locale user_readenv=0\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ @include   common-auth\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e++auth       required    pam_u2f.so\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ @include   common-account\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ @include   common-session-noninteractive\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+### U2F for Login\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+Display ManagerにGDM(Gnome Display Manager)を用いている場合は以下のファイルに`pam_u2f.so`の行を追記する.  \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+**`/etc/pam.d/gdm-password`**\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+その他のDMを用いている場合(KDE等)は **`/etc/pam.d/lightdm`** に追記する.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```diff\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ #%PAM-1.0\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ auth     requisite       pam_nologin.so\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ auth     required        pam_succeed_if.so user != root quiet_success\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ @include common-auth\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e++auth     required        pam_u2f.so\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ auth     optional        pam_gnome_keyring.so\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ @include common-account\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ ...omit\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+## Auto-lock without U2F\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ここからが本題. U2F Keyの接続が解除されると端末をロックする.  \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+もともと自分の使っているLaptopには指紋認証センサが付属している．一般に生体認証はU2Fよりもセキュアであるし，自分も異論はない.  \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ではU2Fが生体認証より優れている点はなにか. 自分の答えは認証の持続性をコントロールできる点である.  \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+指紋認証を例に取ると，一度ログインした端末は一定時間操作をしない際のオートロックまたはユーザ自身の能動的なログアウトをしない限り，認証を再度必要としない.  \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+対してU2Fでは**デバイスが接続されている間だけ認証されている**という状態をもたらすことができる.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+Apple Watchを身に着けた状態でMacの自動ログインが可能[^applewatch]という例がある.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+これはbluetooth接続したU2Fデバイスが一定距離離れるもしくはUSB接続したデバイスをejectすることで端末からログアウトする，という仕様で再現できる.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+### monitoring U2F key by udev\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+U2F Keyモニターをudevに任せることにする. まず対象のIDを特定する.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+`udevadm monitor`でudevのイベントをモニタリングした状態でU2F Keyを抜き差しすると `bind`, `remove` イベントが通知されるので， `$ID_MODEL_ID` 及び `$ID_VENDOR_ID` を取得する.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```sh\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+$ udevadm monitor --environment --udev\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+UDEV  [28028.490650] bind     /devices/pci0000:00/0000:00:14.0/usb1/1-3 (usb)\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ACTION=bind\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+BUSNUM=001\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+DEVNAME=/dev/bus/usb/001/013\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+DEVNUM=013\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+DEVPATH=/devices/pci0000:00/0000:00:14.0/usb1/1-3\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+DEVTYPE=usb_device\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+DRIVER=usb\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ID_BUS=usb\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ID_MODEL=XXXXX\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ID_MODEL_ENC=XXXXX\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ID_MODEL_ID=f025\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ID_REVISION=0100\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ID_SERIAL=ExcelSecu_EsecuFIDO_HID\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ID_USB_INTERFACES=:030000:\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ID_VENDOR=ExcelSecu\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ID_VENDOR_ENC=ExcelSecu\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ID_VENDOR_ID=1ea8\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+MAJOR=189\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+MINOR=12\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+PRODUCT=1ea8/f025/100\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+SEQNUM=12938\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+SUBSYSTEM=usb\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+TYPE=0/0/0\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+USEC_INITIALIZED=28027949334\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+上記の例では `ID_MODEL_ID=f025`，`ID_VENDOR_ID=1ea8` となっている.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+このIDペアを用いて，U2F Key解除時の`udev`ルールを作成する.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+**`/etc/udev/rules.d/xx-u2fkey.rules`** (xxは適当な数字)\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```config\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ACTION==\"remove\", ENV{ID_VENDOR_ID}==\"1ea8\", ENV{ID_MODEL_ID}==\"f025\", RUN+=\"/usr/local/bin/i3lock\"\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+最後にrulesを登録し完了.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```sh\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+$ udevadm control --reload-rules\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+$ service udev reload\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+---\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+フリーランスという職業柄，PCを所持して企業へ出向くことが多くどうやってセキュリティ担保するかなーと考えてたところ`pamu2fcfg`を見かけたので試してみた.  \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+Yubikeyを忘れて外出するという失態を犯した[^twi]ので既に運用が危ういがデータは守れてるのでよし(よくないが)\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+## Reference\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+[^pamu2fcfg]: [developers.yubico.com/pam-u2f/Manuals/pamu2fcfg.1.html](https://developers.yubico.com/pam-u2f/Manuals/pamu2fcfg.1.html)\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+[^applewatch]: [support.apple.com/ja-jp/HT206995](https://support.apple.com/ja-jp/HT206995)\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+[^twi]: [twitter.com/k_0ka/status/1159312312156561408](https://twitter.com/k_0ka/status/1159312312156561408)\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- [Enable FIDO U2F USB support](https://wiki.gentoo.org/wiki/Pam_u2f)\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- [support.yubico.com#enabling the Yubico PPA on Ubuntu](https://support.yubico.com/support/solutions/articles/15000010964-enabling-the-yubico-ppa-on-ubuntu)\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- [support.yubico.com#Ubuntu Linux Login Guide - U2F](https://support.yubico.com/support/solutions/articles/15000011356-ubuntu-linux-login-guide-u2f)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e"}],"publishedAt":"2019-08-08","updatedAt":"2021-04-10"}},"__N_SSG":true},"page":"/archives/[slug]","query":{"slug":"2019-08-08-autolock-with-yubikey"},"buildId":"cFpM8iTjps8Dc6EBauz9R","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>