<!DOCTYPE html><html lang="en"><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><meta name="theme-color" content="#ddd4bb"/><meta property="og:type" content="website"/><meta property="og:url" content="https://koka831.github.io"/><meta property="og:site_name" content="/var/log/koka"/><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="/var/log/koka"/><meta name="twitter:site" content="@k_0ka"/><meta name="twitter:description" content="cat /var/log/koka &gt; /dev/null"/><link rel="alternate" type="application/rss+xml" href="https://koka831.github.io/feed.xml" title="/var/log/koka RSS2.0"/><title>Renewal Blog | /var/log/koka</title><meta property="title" content="Renewal Blog | /var/log/koka"/><meta property="og:title" content="Renewal Blog | /var/log/koka"/><meta property="twitter:title" content="Renewal Blog | /var/log/koka"/><meta property="description" content="scratch new blog with Next.js; switched from VuePress"/><meta property="og:description" content="scratch new blog with Next.js; switched from VuePress"/><meta property="twitter:description" content="scratch new blog with Next.js; switched from VuePress"/><meta property="og:image" content="https://koka831.github.io/img/icon.png"/><meta name="next-head-count" content="19"/><link rel="preload" href="/_next/static/css/c6af7bd612faeb7c.css" as="style"/><link rel="stylesheet" href="/_next/static/css/c6af7bd612faeb7c.css" data-n-g=""/><link rel="preload" href="/_next/static/css/9a908afc1d99510a.css" as="style"/><link rel="stylesheet" href="/_next/static/css/9a908afc1d99510a.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-9b312e20a4e32339.js" defer=""></script><script src="/_next/static/chunks/framework-5f4595e5518b5600.js" defer=""></script><script src="/_next/static/chunks/main-a054bbf31fb90f6a.js" defer=""></script><script src="/_next/static/chunks/pages/_app-e0fcf5a3a528e4c5.js" defer=""></script><script src="/_next/static/chunks/cb1608f2-ecfb8d9b659208e2.js" defer=""></script><script src="/_next/static/chunks/956-4e50aca8308ec128.js" defer=""></script><script src="/_next/static/chunks/291-6b2ab5605142007f.js" defer=""></script><script src="/_next/static/chunks/pages/archives/%5Bslug%5D-f3c25ca7c16881be.js" defer=""></script><script src="/_next/static/-5kDKO-iBXqcRsFR54_iY/_buildManifest.js" defer=""></script><script src="/_next/static/-5kDKO-iBXqcRsFR54_iY/_ssgManifest.js" defer=""></script><script src="/_next/static/-5kDKO-iBXqcRsFR54_iY/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><nav class="Header_navigation__container__Xjar7"><div class="Header_navigation__qZpeO"><a href="/">/var/log/koka</a></div><div><a href="/archives">archive</a></div></nav><main class="Layout_container__LBFOo"><div class="slug_container__f_fjw"><div class="slug_main__WMOpC"><article class="slug_article__cOl2p" role="article"><div itemscope="" class="ArticleHeader_header__container__5Gs_X"><a class="ArticleHeader_post__title__gVFje" href="/archives/2021-04-25-nextjs-from-vuepress">Renewal Blog</a><p>scratch new blog with Next.js; switched from VuePress</p><div class="ArticleHeader_flex__yDiMS"><div class="ArticleHeader_post__tags__uCQyx"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="tags" class="svg-inline--fa fa-tags ArticleHeader_tags__icon__U9c_O" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M472.8 168.4C525.1 221.4 525.1 306.6 472.8 359.6L360.8 472.9C351.5 482.3 336.3 482.4 326.9 473.1C317.4 463.8 317.4 448.6 326.7 439.1L438.6 325.9C472.5 291.6 472.5 236.4 438.6 202.1L310.9 72.87C301.5 63.44 301.6 48.25 311.1 38.93C320.5 29.61 335.7 29.7 344.1 39.13L472.8 168.4zM.0003 229.5V80C.0003 53.49 21.49 32 48 32H197.5C214.5 32 230.7 38.74 242.7 50.75L410.7 218.7C435.7 243.7 435.7 284.3 410.7 309.3L277.3 442.7C252.3 467.7 211.7 467.7 186.7 442.7L18.75 274.7C6.743 262.7 0 246.5 0 229.5L.0003 229.5zM112 112C94.33 112 80 126.3 80 144C80 161.7 94.33 176 112 176C129.7 176 144 161.7 144 144C144 126.3 129.7 112 112 112z"></path></svg><p class="Tag_tag__rl8WL">Diary</p></div><div class="ArticleHeader_post__dates__6uEwt"><time dateTime="2021-04-26" itemProp="datePublished" class="PublishDate_post__date__jhH_w">published: <!-- -->2021-04-26</time><time dateTime="2021-10-26" itemProp="datePublished" class="PublishDate_post__date__jhH_w">updated: 2021-10-26</time></div></div></div><div class="slug_article__body__m2pRS"><p>1年ぶりになります．今年もよろしくお願いします．</p>
<p>最近は紅茶コーディネータになるべく日々精進しています<sup><a href="#user-content-fn-tea" id="user-content-fnref-tea" data-footnote-ref aria-describedby="footnote-label">1</a></sup>．</p>
<h2 id="tldr"><a href="#tldr">TL;DR</a></h2>
<ul>
<li><a href="https://vuepress.vuejs.org/" target="_blank" rel="nofollow noopener noreferrer">VuePress</a>のアルファ版を使っていて，メンテが辛くなった</li>
<li><a href="https://nextjs.org/" target="_blank" rel="nofollow noopener noreferrer">Next.js</a> + <a href="https://github.com/remarkjs/remark" target="_blank" rel="nofollow noopener noreferrer">remark</a>でMarkdown->HTMLのSGを構築した</li>
<li><a href="https://github.com/koka831/koka831.github.io" target="_blank" rel="nofollow noopener noreferrer">できたもの</a></li>
</ul>
<h2 id="about"><a href="#about">About</a></h2>
<p>ブログを書こうと思い立って，以前構築したブログを久々に確認した.
今つかってるパソコンにブログのソースコードを持ってきていなかったので，<code>npm install</code>すると脆弱性の嵐.</p>
<div class="remark-highlight"><pre data-file="terminal" class="language-shell-session"><code class="language-shell-session"><span class="token output">$npm i</span>
<span class="token output">removed 22 packages, changed 14 packages, and audited 1090 packages in 8s</span>
<span class="token output"></span>
<span class="token output">33 vulnerabilities (7 low, 15 moderate, 11 high)</span>
<span class="token output"></span>
<span class="token output">To address issues that do not require attention, run:</span>
<span class="token output">  npm audit fix</span>
<span class="token output"></span>
<span class="token output">To address all issues, run:</span>
<span class="token output">  npm audit fix --force</span>
<span class="token output"></span>
<span class="token output">Run `npm audit` for details.</span>
</code></pre></div>
<p>また，ブログシステムのベースに使っているVuePressが0.xから1.8までバージョンアップしていたので，これは追従しよう.</p>
<p>しかし早々に更新を断念. デザインをフルスクラッチでやるためにVuePressのソースを<code>eject</code>していたため，追従をすべて手でやる必要があった.</p>
<p>ブログ自体のメンテにはそこまでコストをかけてられないので，今度は<code>eject</code>しなくてもデザインを触れるライブラリを選定することにした.</p>
<ul>
<li>開発言語自体にはこだわりはないが，型システムはほしい</li>
<li>マークダウンで書ける</li>
<li>サーバ管理は避けたいので，GitHub Pagesに載せられるもの</li>
</ul>
<p>を探した.最終的には次の2つから選んだ. <del>結局相当のyak shavingが発生した.</del></p>
<h3 id="gatsbyjs"><a href="#gatsbyjs">Gatsby.js</a></h3>
<p><a href="https://www.gatsbyjs.com/" target="_blank" rel="nofollow noopener noreferrer">Gatsby.js</a>はReact.jsをベースにしたリッチなCMSフレームワーク.バックエンドとはGraphQLで連携し，コンテンツの取得は<a href="https://www.contentful.com/" target="_blank" rel="nofollow noopener noreferrer">contentful</a>+Markdownだったりと選定の自由度が高い.</p>
<p>SGのプロセスについてもAPIの呼び出し回数は全ページに対して1回で済む(ようなquery buildをする必要はある)ようなので，productionでの利用をするならGatsby.jsを選ぶと思う.</p>
<h3 id="nextjs"><a href="#nextjs">Next.js</a></h3>
<p><a href="https://nextjs.org/" target="_blank" rel="nofollow noopener noreferrer">Next.js</a>はGatsby.jsと比べると薄いフレームワークで，ビルドやルーティング等ベースとなる機能の提供がメインになっている.
Static Generationの仕組みはあるが，Gatsby.jsほどの最適化は行われていない感じ.</p>
<p>したがってCMSとして使うためにはそれ相当の機能の実装が必要となるため，<del>コストは高い</del>面白そう.</p>
<h2 id="artifacts"><a href="#artifacts">Artifacts</a></h2>
<p><a href="https://koka831.github.io/" target="_blank" rel="nofollow noopener noreferrer">これ</a>ができた.</p>
<h3 id="architecture"><a href="#architecture">Architecture</a></h3>
<p>Next.jsの<a href="https://nextjs.org/docs/basic-features/data-fetching#getstaticprops-static-generation" target="_blank" rel="nofollow noopener noreferrer"><code>getStaticProps</code></a>と<a href="https://nextjs.org/docs/basic-features/data-fetching#getstaticpaths-static-generation" target="_blank" rel="nofollow noopener noreferrer"><code>getStaticPaths</code></a>を用いて一覧・詳細ページをSG.
コンテンツはMarkdownで記述し，<a href="https://github.com/remarkjs/remark" target="_blank" rel="nofollow noopener noreferrer">remark</a>を用いてHTMLを生成している．
Next.js側でも<a href="https://nextjs.org/blog/markdown" target="_blank" rel="nofollow noopener noreferrer">MDX</a>(Markdown+React Component)を描画できる仕組みがあったけど，内部で呼ばれているコンパイラに手を加えるのに難儀したため，情報の多いremarkを選んだ.</p>
<p>(<a href="https://github.com/mizchi/amdx" target="_blank" rel="nofollow noopener noreferrer">amdx</a>はマジですごいと思う)</p>
<p>remarkはMarkdownを入力として，指定した形式での出力を行うプロセッサで，fig.1のように<code>Parser</code>，<code>Transformer</code>や<code>Compiler</code>といったプラグインを処理に挟むことができる.
受け取ったMarkdownは<a href="https://github.com/syntax-tree/mdast" target="_blank" rel="nofollow noopener noreferrer">mdast</a><sup><a href="#user-content-fn-1" id="user-content-fnref-1" data-footnote-ref aria-describedby="footnote-label">2</a></sup>という形式のastに変換され，プラグインはmdastを受取りmdastを返すよう要求される.</p>
<div class="remark-highlight"><pre data-file="process" class="language-asciidoc"><code class="language-asciidoc">| ........................ process ........................... |
| .......... parse ... | ... run ... | ... stringify ..........|

          <span class="token inline"><span class="token punctuation">+</span>--------<span class="token punctuation">+</span></span>                     <span class="token inline"><span class="token punctuation">+</span>----------<span class="token punctuation">+</span></span>
Input ->- | Parser | ->- Syntax Tree ->- | Compiler | ->- Output
          <span class="token inline"><span class="token punctuation">+</span>--------<span class="token punctuation">+</span></span>          |          <span class="token inline"><span class="token punctuation">+</span>----------<span class="token punctuation">+</span></span>
                              X
                              |
                       <span class="token inline"><span class="token punctuation">+</span>--------------<span class="token punctuation">+</span></span>
                       | Transformers |
                       <span class="token inline"><span class="token punctuation">+</span>--------------<span class="token punctuation">+</span></span>
</code></pre></div>
<p><strong>fig.1 remarkの変換プロセス. 図はベースとなるunifiedから. [<a href="https://github.com/unifiedjs/unified#description" target="_blank" rel="nofollow noopener noreferrer">出典</a>]</strong></p>
<p>このブログではそこそこプラグインを使っていて，中には自作したものもある<sup><a href="#user-content-fn-2" id="user-content-fnref-2" data-footnote-ref aria-describedby="footnote-label">3</a></sup>.</p>
<div class="remark-highlight"><pre data-file="interpreter.ts" class="language-typescript  line-numbers"><code class="language-typescript"><span class="token keyword">const</span> markdownToHtml <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>markdown<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&#x3C;</span><span class="token builtin">string</span><span class="token operator">></span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">remark</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>gfm<span class="token punctuation">)</span> <span class="token comment">// remark-gfm</span>
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>math<span class="token punctuation">)</span> <span class="token comment">// remark-math</span>
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>emoji<span class="token punctuation">)</span> <span class="token comment">// remark-emoji</span>
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span> <span class="token comment">// 自作 | VuePressで使っていたCustom Container記法に対応</span>
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>caption<span class="token punctuation">)</span> <span class="token comment">// 自作 | Markdown中の画像に対して通し番号+figcaptionを付与</span>
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>prism<span class="token punctuation">)</span> <span class="token comment">// remark-prism</span>
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>externalLink<span class="token punctuation">)</span> <span class="token comment">// remark-external-links</span>
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>slug<span class="token punctuation">)</span> <span class="token comment">// remark-slug</span>
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>headings<span class="token punctuation">,</span> <span class="token punctuation">{</span> behavior<span class="token operator">:</span> <span class="token string">"wrap"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// remark-autolink-headings</span>
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>footnotes<span class="token punctuation">)</span> <span class="token comment">// remark-footnotes</span>
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>remark2rehype<span class="token punctuation">)</span> <span class="token comment">// remark-rehype | mdastからhast形式へ変換</span>
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>katex<span class="token punctuation">)</span> <span class="token comment">// rehype-katex | remark-mathで変換したmarkdownでの数式をkatex記法へ変換</span>
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>stringify<span class="token punctuation">)</span> <span class="token comment">// rehype-stringify</span>
    <span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>markdown<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span class=""></span><span class=""></span><span class=""></span><span class=""></span><span class=""></span><span class=""></span><span class=""></span><span class=""></span><span class=""></span><span class=""></span><span class=""></span><span class=""></span><span class=""></span><span class=""></span><span class=""></span><span class=""></span><span class=""></span><span class=""></span><span class=""></span></span>
</code></pre></div>
<p><strong>fig.2 プラグイン一覧</strong></p>
<h3 id="remark-plugin"><a href="#remark-plugin">remark plugin</a></h3>
<p>実際作ってみると結構簡単に実装できる. READMEにあるサンプルだと型情報がなかったりで結構辛いけど，fig.1と<a href="https://unifiedjs.com/learn/guide/create-a-plugin/" target="_blank" rel="nofollow noopener noreferrer">guide</a>が参考になる.</p>
<ul>
<li><strong>remark-container</strong></li>
</ul>
<p>もともと使っていたVuePressでは，Custom Containersと呼ばれるMarkdownの拡張記法が使える<sup><a href="#user-content-fn-3" id="user-content-fnref-3" data-footnote-ref aria-describedby="footnote-label">4</a></sup>.</p>
<div class="remark-highlight"><pre data-file="custom-container.md" class="language-markdown"><code class="language-markdown">::: info Custom Title
Custom Container Body
:::
</code></pre></div>
<p><strong>fig.3 これがこうじゃ</strong></p>
<p><div class="remark-container info"><div class="remark-container__title">Custom Title</div>Custom Container Body</div></p>
<p>remark版を探すといくつか見つかったけど，どれも動かなかったので作ることにした.</p>
<p>実装は正規表現でdirectiveにマッチした行のastを書き換えるもので，単純なため対応してないケースもある(directive内のcode blockとかnodeが分割されるケース).
これらの対応は<a href="https://github.com/remarkjs/remark-directive" target="_blank" rel="nofollow noopener noreferrer">remark-directive</a>を用いて後々やりたい.</p>
<ul>
<li><strong>remark-image-caption</strong></li>
</ul>
<p>img要素のようなself-closing tagについては<code>::before</code>等の疑似要素が使えないため，例えばMarkdownで記述した画像のタイトルをCSSのみで抽出・表示するといったことができない．</p>
<p>画像に対してcaptionを付与するプラグインは動作するいくつか見つかったけど，画像に対して連番を振ってくれるようなものは見当たらなかった.</p>
<div class="remark-highlight"><pre data-file="image.md" class="language-markdown"><code class="language-markdown"><span class="token url"><span class="token operator">!</span>[<span class="token content">alt text</span>](<span class="token url">image.png</span> <span class="token string">"image title"</span>)</span>
</code></pre></div>
<p><figure><img src="/img/icon.png" alt="alt text" title="image title"><figcaption>img.1 image title</figcaption></figure></p>
<p>今回作成したプラグインでは，画像を<code>&#x3C;figure></code>タグで囲んでタイトルを<code>&#x3C;figcaption></code>に設定するようにした.
ただ，この手法は例えばtableのようなMarkdown記法でタイトルを付与できない要素に対しては使えないため，画像やコード，テーブル等の直下の<code>em</code>や<code>strong</code>をcaptionとみなすといったやり方に移行すると思う.</p>
<h3 id="commit-log"><a href="#commit-log">Commit Log</a></h3>
<p>各記事の編集履歴を表示する<strong>Commits</strong>コンポーネント(↓の<strong>Commits</strong>).</p>
<p>やっていることは単純で，<code>getStaticProps</code>呼び出し時に該当するファイルに対してのGit履歴を取得しているだけ.</p>
<h3 id="table-of-contents"><a href="#table-of-contents">Table of Contents</a></h3>
<p>現在のページにあるheadingsから目次を構築するコンポーネント(→の目次.表示されてない人は1200px以上の画面で見てね).</p>
<p>これは単に実装したことがなかったから作った<sup><a href="#user-content-fn-4" id="user-content-fnref-4" data-footnote-ref aria-describedby="footnote-label">5</a></sup>.
原理は単純で，現在のスクロール位置を取得して，通り過ぎたheadingのうち最も近いものをhighlightしている.
最初はmarkdownを与えてheadingを抽出するやり方にしていたけど，markdown外にあるCommitsやComments等，そのページにあるheadingを動的に抽出する方針に切り替えた.</p>
<h3 id="comments"><a href="#comments">Comments</a></h3>
<p>GitHub Issueと連携したコメントコンポーネント(↓の<strong>Comments</strong>).
<a href="https://utteranc.es" target="_blank" rel="nofollow noopener noreferrer">utterances</a>というサービスを利用した. ブログからコメントするにはGitHub AccountでのAuthが必要だけど，<a href="https://github.com/koka831/blog/issues" target="_blank" rel="nofollow noopener noreferrer">Issues</a>に直接コメントすることもできる.</p>
<h2 id="これから"><a href="#これから">これから</a></h2>
<p>フリーランスとしてのお仕事も現在は募集しておらず，自身の身の振り方については少なくとも今年いっぱいは考える予定.
とりあえずプライベートではアルゴリズムやデータ構造等再度やっていこうと思う.</p>
<p>紅茶コーディネータについては年初からの受講なので，順調に行けば今年の秋ころには取れるかなあ，という感じ.
ミーハーなので今年のセカンドフラッシュを楽しみにしてたりする.</p>
<section data-footnotes class="footnotes"><h2 id="footnote-label" class="sr-only"><a href="#footnote-label">Footnotes</a></h2>
<ol>
<li id="user-content-fn-tea">
<p>余談だけど茶葉のテイスティングカップ，料理の際に調味料を混ぜる小さい容器に最適すぎる <a href="#user-content-fnref-tea" data-footnote-backref class="data-footnote-backref" aria-label="Back to content">↩</a></p>
</li>
<li id="user-content-fn-1">
<p>mdastは<a href="https://github.com/syntax-tree/unist" target="_blank" rel="nofollow noopener noreferrer">unist</a>という規格に従っていて，他にはHTMLのunist表記である<a href="https://github.com/syntax-tree/hast" target="_blank" rel="nofollow noopener noreferrer">hast</a>などがある. またmdastのプロセッサ実装(remark)があるように，hastのプロセッサには<a href="https://github.com/rehypejs/rehype" target="_blank" rel="nofollow noopener noreferrer">rehype</a>がある. <a href="#user-content-fnref-1" data-footnote-backref class="data-footnote-backref" aria-label="Back to content">↩</a></p>
</li>
<li id="user-content-fn-2">
<p>remark内部で使っている<a href="https://github.com/remarkjs/remark/pull/536" target="_blank" rel="nofollow noopener noreferrer">ライブラリの移行</a>が2020後半にあって，npmに上がっているプラグインの中にも動作しないものが少なくない. 実際動作するプラグインの中には(This plugin is made for the new parser in remark (micromark, see remarkjs/remark#536).)のように注釈があったりする. <a href="#user-content-fnref-2" data-footnote-backref class="data-footnote-backref" aria-label="Back to content">↩</a></p>
</li>
<li id="user-content-fn-3">
<p>大元は<a href="https://talk.commonmark.org/t/generic-directives-plugins-syntax/444/155" target="_blank" rel="nofollow noopener noreferrer">これ</a>っぽい. <a href="#user-content-fnref-3" data-footnote-backref class="data-footnote-backref" aria-label="Back to content">↩</a></p>
</li>
<li id="user-content-fn-4">
<p>今回UIコンポーネントライブラリは一切使わなかった. <del>コストとは</del> <a href="#user-content-fnref-4" data-footnote-backref class="data-footnote-backref" aria-label="Back to content">↩</a></p>
</li>
</ol>
</section></div></article><div class="CommitLogs_commit_logs__W6xPi" role="log"><h2>Commits</h2><details><summary><span class="CommitLogs_commit__date___q8bm">2021-10-26 22:37:38</span><span class="CommitLogs_commit__hash__Xyu7v">6b966820</span><span class="CommitLogs_commit__message__IGUPv">fix: use Static Generation(SG) instead of SSG</span></summary><div><div class="remark-highlight"><pre data-file="6b966820.patch" class="language-git  language-diff"><code class="language-git"><span class="token commit-sha1">commit 6b96682060f7a7b2f2c20048d55e37f2f9ae44eb</span>
Author: koka &#x26;<a href="mailto:lt;koka.code@gmail.com" class="token email-link">lt;koka.code@gmail.com</a>&#x26;gt;
Date:   Tue Oct 26 22:37:38 2021 +0900

  fix: use Static Generation(SG) instead of SSG

diff --git a/_posts/2021-04-25-nextjs-from-vuepress.md b/_posts/2021-04-25-nextjs-from-vuepress.md
index e2e9415..5c8ea91 100644
<span class="token deleted">--- a/_posts/2021-04-25-nextjs-from-vuepress.md</span>
<span class="token inserted">+++ b/_posts/2021-04-25-nextjs-from-vuepress.md</span>
@@ -15,7 +15,7 @@ description: scratch new blog with Next.js; switched from VuePress
<span class="token comment">## TL;DR</span>

<span class="token deleted">- [VuePress][vuepress]のアルファ版を使っていて，メンテが辛くなった</span>
<span class="token deleted">-- [Next.js][next] + [remark][remark]でMarkdown-&#x26;gt;HTMLのSSGを構築した</span>
<span class="token inserted">+- [Next.js][next] + [remark][remark]でMarkdown-&#x26;gt;HTMLのSGを構築した</span>
<span class="token deleted">- [できたもの](https://github.com/koka831/koka831.github.io)</span>

<span class="token comment">## About</span>
@@ -54,12 +54,12 @@ Run `npm audit` for details.

[Gatsby.js][gatsby]はReact.jsをベースにしたリッチなCMSフレームワーク.バックエンドとはGraphQLで連携し，コンテンツの取得は[contentful][contentful]+Markdownだったりと選定の自由度が高い.

<span class="token deleted">-SSGのプロセスについてもAPIの呼び出し回数は全ページに対して1回で済む(ようなquery buildをする必要はある)ようなので，productionでの利用をするならGatsby.jsを選ぶと思う.</span>
<span class="token inserted">+SGのプロセスについてもAPIの呼び出し回数は全ページに対して1回で済む(ようなquery buildをする必要はある)ようなので，productionでの利用をするならGatsby.jsを選ぶと思う.</span>

<span class="token comment">### Next.js</span>

[Next.js][next]はGatsby.jsと比べると薄いフレームワークで，ビルドやルーティング等ベースとなる機能の提供がメインになっている.
<span class="token deleted">-Server-Side Generationの仕組みはあるが，Gatsby.jsほどの最適化は行われていない感じ.</span>
<span class="token inserted">+Static Generationの仕組みはあるが，Gatsby.jsほどの最適化は行われていない感じ.</span>

したがってCMSとして使うためにはそれ相当の機能の実装が必要となるため，~コストは高い~面白そう.

@@ -69,7 +69,7 @@ Server-Side Generationの仕組みはあるが，Gatsby.jsほどの最適化は

<span class="token comment">### Architecture</span>

<span class="token deleted">-Next.jsの[`getStaticProps`][getStaticProps]と[`getStaticPaths`][getStaticPaths]を用いて一覧・詳細ページをSSG.</span>
<span class="token inserted">+Next.jsの[`getStaticProps`][getStaticProps]と[`getStaticPaths`][getStaticPaths]を用いて一覧・詳細ページをSG.</span>
コンテンツはMarkdownで記述し，[remark][remark]を用いてHTMLを生成している．
Next.js側でも[MDX][mdx](Markdown+React Component)を描画できる仕組みがあったけど，内部で呼ばれているコンパイラに手を加えるのに難儀したため，情報の多いremarkを選んだ.
</code></pre></div></div></details><details><summary><span class="CommitLogs_commit__date___q8bm">2021-04-27 22:23:26</span><span class="CommitLogs_commit__hash__Xyu7v">de03b5e2</span><span class="CommitLogs_commit__message__IGUPv">add link to github</span></summary><div><div class="remark-highlight"><pre data-file="de03b5e2.patch" class="language-git  language-diff"><code class="language-git"><span class="token commit-sha1">commit de03b5e21ad5799aed5d6ba2c87af059a6115aa2</span>
Author: koka &#x26;<a href="mailto:lt;koka.code@gmail.com" class="token email-link">lt;koka.code@gmail.com</a>&#x26;gt;
Date:   Tue Apr 27 22:23:26 2021 +0900

  add link to github

diff --git a/_posts/2021-04-25-nextjs-from-vuepress.md b/_posts/2021-04-25-nextjs-from-vuepress.md
index f99a404..e2e9415 100644
<span class="token deleted">--- a/_posts/2021-04-25-nextjs-from-vuepress.md</span>
<span class="token inserted">+++ b/_posts/2021-04-25-nextjs-from-vuepress.md</span>
@@ -16,6 +16,7 @@ description: scratch new blog with Next.js; switched from VuePress

<span class="token deleted">- [VuePress][vuepress]のアルファ版を使っていて，メンテが辛くなった</span>
<span class="token deleted">- [Next.js][next] + [remark][remark]でMarkdown-&#x26;gt;HTMLのSSGを構築した</span>
<span class="token inserted">+- [できたもの](https://github.com/koka831/koka831.github.io)</span>

<span class="token comment">## About</span>
</code></pre></div></div></details><details><summary><span class="CommitLogs_commit__date___q8bm">2021-04-27 16:59:33</span><span class="CommitLogs_commit__hash__Xyu7v">ae6500c9</span><span class="CommitLogs_commit__message__IGUPv">add</span></summary><div><div class="remark-highlight"><pre data-file="ae6500c9.patch" class="language-git  language-diff"><code class="language-git"><span class="token commit-sha1">commit ae6500c9b2a3b5fd76fbf543286171fd2fb60b3f</span>
Author: koka &#x26;<a href="mailto:lt;koka.code@gmail.com" class="token email-link">lt;koka.code@gmail.com</a>&#x26;gt;
Date:   Tue Apr 27 16:59:33 2021 +0900

  add

diff --git a/_posts/2021-04-25-nextjs-from-vuepress.md b/_posts/2021-04-25-nextjs-from-vuepress.md
new file mode 100644
index 0000000..f99a404
<span class="token deleted">--- /dev/null</span>
<span class="token inserted">+++ b/_posts/2021-04-25-nextjs-from-vuepress.md</span>
<span class="token coord">@@ -0,0 +1,211 @@</span>
<span class="token inserted">+---</span>
<span class="token inserted">+title: 'Renewal Blog'</span>
<span class="token inserted">+date: 2021-04-26</span>
<span class="token inserted">+categories:</span>
<span class="token inserted">+- Diary</span>
<span class="token inserted">+tags:</span>
<span class="token inserted">+- Diary</span>
<span class="token inserted">+description: scratch new blog with Next.js; switched from VuePress</span>
<span class="token inserted">+---</span>
<span class="token inserted">+</span>
<span class="token inserted">+1年ぶりになります．今年もよろしくお願いします．</span>
<span class="token inserted">+</span>
<span class="token inserted">+最近は紅茶コーディネータになるべく日々精進しています[^tea]．</span>
<span class="token inserted">+</span>
<span class="token inserted">+## TL;DR</span>
<span class="token inserted">+</span>
<span class="token inserted">+- [VuePress][vuepress]のアルファ版を使っていて，メンテが辛くなった</span>
<span class="token inserted">+- [Next.js][next] + [remark][remark]でMarkdown-&#x26;gt;HTMLのSSGを構築した</span>
<span class="token inserted">+</span>
<span class="token inserted">+## About</span>
<span class="token inserted">+</span>
<span class="token inserted">+ブログを書こうと思い立って，以前構築したブログを久々に確認した.</span>
<span class="token inserted">+今つかってるパソコンにブログのソースコードを持ってきていなかったので，`npm install`すると脆弱性の嵐.</span>
<span class="token inserted">+</span>
<span class="token inserted">+\```shell-session[data-file="terminal"]</span>
<span class="token inserted">+$npm i</span>
<span class="token inserted">+removed 22 packages, changed 14 packages, and audited 1090 packages in 8s</span>
<span class="token inserted">+</span>
<span class="token inserted">+33 vulnerabilities (7 low, 15 moderate, 11 high)</span>
<span class="token inserted">+</span>
<span class="token inserted">+To address issues that do not require attention, run:</span>
<span class="token inserted">+  npm audit fix</span>
<span class="token inserted">+</span>
<span class="token inserted">+To address all issues, run:</span>
<span class="token inserted">+  npm audit fix --force</span>
<span class="token inserted">+</span>
<span class="token inserted">+Run `npm audit` for details.</span>
<span class="token inserted">+\```</span>
<span class="token inserted">+</span>
<span class="token inserted">+また，ブログシステムのベースに使っているVuePressが0.xから1.8までバージョンアップしていたので，これは追従しよう.</span>
<span class="token inserted">+</span>
<span class="token inserted">+しかし早々に更新を断念. デザインをフルスクラッチでやるためにVuePressのソースを`eject`していたため，追従をすべて手でやる必要があった.</span>
<span class="token inserted">+</span>
<span class="token inserted">+ブログ自体のメンテにはそこまでコストをかけてられないので，今度は`eject`しなくてもデザインを触れるライブラリを選定することにした.</span>
<span class="token inserted">+</span>
<span class="token inserted">+- 開発言語自体にはこだわりはないが，型システムはほしい</span>
<span class="token inserted">+- マークダウンで書ける</span>
<span class="token inserted">+- サーバ管理は避けたいので，GitHub Pagesに載せられるもの</span>
<span class="token inserted">+</span>
<span class="token inserted">+を探した.最終的には次の2つから選んだ. ~結局相当のyak shavingが発生した.~</span>
<span class="token inserted">+</span>
<span class="token inserted">+### Gatsby.js</span>
<span class="token inserted">+</span>
<span class="token inserted">+[Gatsby.js][gatsby]はReact.jsをベースにしたリッチなCMSフレームワーク.バックエンドとはGraphQLで連携し，コンテンツの取得は[contentful][contentful]+Markdownだったりと選定の自由度が高い.</span>
<span class="token inserted">+</span>
<span class="token inserted">+SSGのプロセスについてもAPIの呼び出し回数は全ページに対して1回で済む(ようなquery buildをする必要はある)ようなので，productionでの利用をするならGatsby.jsを選ぶと思う.</span>
<span class="token inserted">+</span>
<span class="token inserted">+### Next.js</span>
<span class="token inserted">+</span>
<span class="token inserted">+[Next.js][next]はGatsby.jsと比べると薄いフレームワークで，ビルドやルーティング等ベースとなる機能の提供がメインになっている.</span>
<span class="token inserted">+Server-Side Generationの仕組みはあるが，Gatsby.jsほどの最適化は行われていない感じ.</span>
<span class="token inserted">+</span>
<span class="token inserted">+したがってCMSとして使うためにはそれ相当の機能の実装が必要となるため，~コストは高い~面白そう.</span>
<span class="token inserted">+</span>
<span class="token inserted">+## Artifacts</span>
<span class="token inserted">+</span>
<span class="token inserted">+[これ][blog]ができた.</span>
<span class="token inserted">+</span>
<span class="token inserted">+### Architecture</span>
<span class="token inserted">+</span>
<span class="token inserted">+Next.jsの[`getStaticProps`][getStaticProps]と[`getStaticPaths`][getStaticPaths]を用いて一覧・詳細ページをSSG.</span>
<span class="token inserted">+コンテンツはMarkdownで記述し，[remark][remark]を用いてHTMLを生成している．</span>
<span class="token inserted">+Next.js側でも[MDX][mdx](Markdown+React Component)を描画できる仕組みがあったけど，内部で呼ばれているコンパイラに手を加えるのに難儀したため，情報の多いremarkを選んだ.</span>
<span class="token inserted">+</span>
<span class="token inserted">+([amdx][amdx]はマジですごいと思う)</span>
<span class="token inserted">+</span>
<span class="token inserted">+remarkはMarkdownを入力として，指定した形式での出力を行うプロセッサで，fig.1のように`Parser`，`Transformer`や`Compiler`といったプラグインを処理に挟むことができる.</span>
<span class="token inserted">+受け取ったMarkdownは[mdast][mdast][^1]という形式のastに変換され，プラグインはmdastを受取りmdastを返すよう要求される.</span>
<span class="token inserted">+</span>
<span class="token inserted">+\```asciidoc[data-file="process"]</span>
<span class="token inserted">+| ........................ process ........................... |</span>
<span class="token inserted">+| .......... parse ... | ... run ... | ... stringify ..........|</span>
<span class="token inserted">+</span>
<span class="token inserted">+          +--------+                     +----------+</span>
<span class="token inserted">+Input -&#x26;gt;- | Parser | -&#x26;gt;- Syntax Tree -&#x26;gt;- | Compiler | -&#x26;gt;- Output</span>
<span class="token inserted">+          +--------+          |          +----------+</span>
<span class="token inserted">+                              X</span>
<span class="token inserted">+                              |</span>
<span class="token inserted">+                       +--------------+</span>
<span class="token inserted">+                       | Transformers |</span>
<span class="token inserted">+                       +--------------+</span>
<span class="token inserted">+\```</span>
<span class="token inserted">+**fig.1 remarkの変換プロセス. 図はベースとなるunifiedから. [[出典][unified-process]]**</span>
<span class="token inserted">+</span>
<span class="token inserted">+このブログではそこそこプラグインを使っていて，中には自作したものもある[^2].</span>
<span class="token inserted">+</span>
<span class="token inserted">+\```typescript[data-file="interpreter.ts"][class="line-numbers"]</span>
<span class="token inserted">+const markdownToHtml = async (markdown: string): Promise&#x26;lt;string&#x26;gt; =&#x26;gt; {</span>
<span class="token inserted">+  const result = await remark()</span>
<span class="token inserted">+    .use(gfm) // remark-gfm</span>
<span class="token inserted">+    .use(math) // remark-math</span>
<span class="token inserted">+    .use(emoji) // remark-emoji</span>
<span class="token inserted">+    .use(container) // 自作 | VuePressで使っていたCustom Container記法に対応</span>
<span class="token inserted">+    .use(caption) // 自作 | Markdown中の画像に対して通し番号+figcaptionを付与</span>
<span class="token inserted">+    .use(prism) // remark-prism</span>
<span class="token inserted">+    .use(externalLink) // remark-external-links</span>
<span class="token inserted">+    .use(slug) // remark-slug</span>
<span class="token inserted">+    .use(headings, { behavior: "wrap" }) // remark-autolink-headings</span>
<span class="token inserted">+    .use(footnotes) // remark-footnotes</span>
<span class="token inserted">+    .use(remark2rehype) // remark-rehype | mdastからhast形式へ変換</span>
<span class="token inserted">+    .use(katex) // rehype-katex | remark-mathで変換したmarkdownでの数式をkatex記法へ変換</span>
<span class="token inserted">+    .use(stringify) // rehype-stringify</span>
<span class="token inserted">+    .process(markdown);</span>
<span class="token inserted">+</span>
<span class="token inserted">+  return result.toString();</span>
<span class="token inserted">+};</span>
<span class="token inserted">+\```</span>
<span class="token inserted">+**fig.2 プラグイン一覧**</span>
<span class="token inserted">+</span>
<span class="token inserted">+### remark plugin</span>
<span class="token inserted">+</span>
<span class="token inserted">+実際作ってみると結構簡単に実装できる. READMEにあるサンプルだと型情報がなかったりで結構辛いけど，fig.1と[guide][unified-guide]が参考になる.</span>
<span class="token inserted">+</span>
<span class="token inserted">+* **remark-container**</span>
<span class="token inserted">+</span>
<span class="token inserted">+もともと使っていたVuePressでは，Custom Containersと呼ばれるMarkdownの拡張記法が使える[^3].</span>
<span class="token inserted">+</span>
<span class="token inserted">+\```markdown[data-file="custom-container.md"]</span>
<span class="token inserted">+::: info Custom Title</span>
<span class="token inserted">+Custom Container Body</span>
<span class="token inserted">+:::</span>
<span class="token inserted">+\```</span>
<span class="token inserted">+**fig.3 これがこうじゃ**</span>
<span class="token inserted">+</span>
<span class="token inserted">+::: info Custom Title</span>
<span class="token inserted">+Custom Container Body</span>
<span class="token inserted">+:::</span>
<span class="token inserted">+</span>
<span class="token inserted">+remark版を探すといくつか見つかったけど，どれも動かなかったので作ることにした.</span>
<span class="token inserted">+</span>
<span class="token inserted">+実装は正規表現でdirectiveにマッチした行のastを書き換えるもので，単純なため対応してないケースもある(directive内のcode blockとかnodeが分割されるケース).</span>
<span class="token inserted">+これらの対応は[remark-directive][remark-directive]を用いて後々やりたい.</span>
<span class="token inserted">+</span>
<span class="token inserted">+* **remark-image-caption**</span>
<span class="token inserted">+</span>
<span class="token inserted">+img要素のようなself-closing tagについては`::before`等の疑似要素が使えないため，例えばMarkdownで記述した画像のタイトルをCSSのみで抽出・表示するといったことができない．</span>
<span class="token inserted">+</span>
<span class="token inserted">+画像に対してcaptionを付与するプラグインは動作するいくつか見つかったけど，画像に対して連番を振ってくれるようなものは見当たらなかった.</span>
<span class="token inserted">+</span>
<span class="token inserted">+\```markdown[data-file="image.md"]</span>
<span class="token inserted">+![alt text](image.png "image title")</span>
<span class="token inserted">+\```</span>
<span class="token inserted">+</span>
<span class="token inserted">+![alt text](/img/icon.png "image title")</span>
<span class="token inserted">+</span>
<span class="token inserted">+今回作成したプラグインでは，画像を`&#x26;lt;figure&#x26;gt;`タグで囲んでタイトルを`&#x26;lt;figcaption&#x26;gt;`に設定するようにした.</span>
<span class="token inserted">+ただ，この手法は例えばtableのようなMarkdown記法でタイトルを付与できない要素に対しては使えないため，画像やコード，テーブル等の直下の`em`や`strong`をcaptionとみなすといったやり方に移行すると思う.</span>
<span class="token inserted">+</span>
<span class="token inserted">+### Commit Log</span>
<span class="token inserted">+</span>
<span class="token inserted">+各記事の編集履歴を表示する**Commits**コンポーネント(↓の**Commits**).</span>
<span class="token inserted">+</span>
<span class="token inserted">+やっていることは単純で，`getStaticProps`呼び出し時に該当するファイルに対してのGit履歴を取得しているだけ.</span>
<span class="token inserted">+</span>
<span class="token inserted">+### Table of Contents</span>
<span class="token inserted">+</span>
<span class="token inserted">+現在のページにあるheadingsから目次を構築するコンポーネント(→の目次.表示されてない人は1200px以上の画面で見てね).</span>
<span class="token inserted">+</span>
<span class="token inserted">+これは単に実装したことがなかったから作った[^4].</span>
<span class="token inserted">+原理は単純で，現在のスクロール位置を取得して，通り過ぎたheadingのうち最も近いものをhighlightしている.</span>
<span class="token inserted">+最初はmarkdownを与えてheadingを抽出するやり方にしていたけど，markdown外にあるCommitsやComments等，そのページにあるheadingを動的に抽出する方針に切り替えた.</span>
<span class="token inserted">+</span>
<span class="token inserted">+### Comments</span>
<span class="token inserted">+</span>
<span class="token inserted">+GitHub Issueと連携したコメントコンポーネント(↓の**Comments**).</span>
<span class="token inserted">+[utterances][utterances]というサービスを利用した. ブログからコメントするにはGitHub AccountでのAuthが必要だけど，[Issues][issues]に直接コメントすることもできる.</span>
<span class="token inserted">+</span>
<span class="token inserted">+## これから</span>
<span class="token inserted">+</span>
<span class="token inserted">+フリーランスとしてのお仕事も現在は募集しておらず，自身の身の振り方については少なくとも今年いっぱいは考える予定.</span>
<span class="token inserted">+とりあえずプライベートではアルゴリズムやデータ構造等再度やっていこうと思う.</span>
<span class="token inserted">+</span>
<span class="token inserted">+紅茶コーディネータについては年初からの受講なので，順調に行けば今年の秋ころには取れるかなあ，という感じ.</span>
<span class="token inserted">+ミーハーなので今年のセカンドフラッシュを楽しみにしてたりする.</span>
<span class="token inserted">+</span>
<span class="token inserted">+[blog]: https://koka831.github.io/</span>
<span class="token inserted">+[vuepress]: https://vuepress.vuejs.org/</span>
<span class="token inserted">+[next]: https://nextjs.org/</span>
<span class="token inserted">+[remark]: https://github.com/remarkjs/remark</span>
<span class="token inserted">+[remark-directive]: https://github.com/remarkjs/remark-directive</span>
<span class="token inserted">+[gatsby]: https://www.gatsbyjs.com/</span>
<span class="token inserted">+[contentful]: https://www.contentful.com/</span>
<span class="token inserted">+[getStaticProps]: https://nextjs.org/docs/basic-features/data-fetching#getstaticprops-static-generation</span>
<span class="token inserted">+[getStaticPaths]: https://nextjs.org/docs/basic-features/data-fetching#getstaticpaths-static-generation</span>
<span class="token inserted">+[mdx]: https://nextjs.org/blog/markdown</span>
<span class="token inserted">+[amdx]: https://github.com/mizchi/amdx</span>
<span class="token inserted">+[unified-process]: https://github.com/unifiedjs/unified#description</span>
<span class="token inserted">+[unified-guide]: https://unifiedjs.com/learn/guide/create-a-plugin/</span>
<span class="token inserted">+[unist]: https://github.com/syntax-tree/unist</span>
<span class="token inserted">+[mdast]: https://github.com/syntax-tree/mdast</span>
<span class="token inserted">+[hast]: https://github.com/syntax-tree/hast</span>
<span class="token inserted">+[rehype]: https://github.com/rehypejs/rehype</span>
<span class="token inserted">+[remark#536]: https://github.com/remarkjs/remark/pull/536</span>
<span class="token inserted">+[utterances]: https://utteranc.es</span>
<span class="token inserted">+[issues]: https://github.com/koka831/blog/issues</span>
<span class="token inserted">+</span>
<span class="token inserted">+[^tea]: 余談だけど茶葉のテイスティングカップ，料理の際に調味料を混ぜる小さい容器に最適すぎる</span>
<span class="token inserted">+[^1]: mdastは[unist][unist]という規格に従っていて，他にはHTMLのunist表記である[hast][hast]などがある. またmdastのプロセッサ実装(remark)があるように，hastのプロセッサには[rehype][rehype]がある.</span>
<span class="token inserted">+[^2]: remark内部で使っている[ライブラリの移行][remark#536]が2020後半にあって，npmに上がっているプラグインの中にも動作しないものが少なくない. 実際動作するプラグインの中には(This plugin is made for the new parser in remark (micromark, see remarkjs/remark#536).)のように注釈があったりする.</span>
<span class="token inserted">+[^3]: 大元は[これ](https://talk.commonmark.org/t/generic-directives-plugins-syntax/444/155)っぽい.</span>
<span class="token inserted">+[^4]: 今回UIコンポーネントライブラリは一切使わなかった. ~コストとは~</span>
</code></pre></div></div></details></div><div class="Comments_comment__WxfzD" role="comment"><h2 class="Comments_title__YENiL">Comments</h2><div id="github-comment-container"></div></div></div><aside class="slug_aside__gL3UH"><nav class="Toc_toc__nav__rl0h7" role="navigation"><ul class="Toc_toc__Y4dWA"></ul></nav></aside></div></main><footer class="Footer_footer__FDcZZ"><small>Code snippets licensed under MIT, unless otherwise noted.</small></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"slug":"2021-04-25-nextjs-from-vuepress","title":"Renewal Blog","categories":["Diary"],"image":"https://koka831.github.io/img/icon.png","tags":["Diary"],"content":"\u003cp\u003e1年ぶりになります．今年もよろしくお願いします．\u003c/p\u003e\n\u003cp\u003e最近は紅茶コーディネータになるべく日々精進しています\u003csup\u003e\u003ca href=\"#user-content-fn-tea\" id=\"user-content-fnref-tea\" data-footnote-ref aria-describedby=\"footnote-label\"\u003e1\u003c/a\u003e\u003c/sup\u003e．\u003c/p\u003e\n\u003ch2 id=\"tldr\"\u003e\u003ca href=\"#tldr\"\u003eTL;DR\u003c/a\u003e\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://vuepress.vuejs.org/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eVuePress\u003c/a\u003eのアルファ版を使っていて，メンテが辛くなった\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://nextjs.org/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eNext.js\u003c/a\u003e + \u003ca href=\"https://github.com/remarkjs/remark\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eremark\u003c/a\u003eでMarkdown-\u003eHTMLのSGを構築した\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/koka831/koka831.github.io\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eできたもの\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"about\"\u003e\u003ca href=\"#about\"\u003eAbout\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003eブログを書こうと思い立って，以前構築したブログを久々に確認した.\n今つかってるパソコンにブログのソースコードを持ってきていなかったので，\u003ccode\u003enpm install\u003c/code\u003eすると脆弱性の嵐.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"terminal\" class=\"language-shell-session\"\u003e\u003ccode class=\"language-shell-session\"\u003e\u003cspan class=\"token output\"\u003e$npm i\u003c/span\u003e\n\u003cspan class=\"token output\"\u003eremoved 22 packages, changed 14 packages, and audited 1090 packages in 8s\u003c/span\u003e\n\u003cspan class=\"token output\"\u003e\u003c/span\u003e\n\u003cspan class=\"token output\"\u003e33 vulnerabilities (7 low, 15 moderate, 11 high)\u003c/span\u003e\n\u003cspan class=\"token output\"\u003e\u003c/span\u003e\n\u003cspan class=\"token output\"\u003eTo address issues that do not require attention, run:\u003c/span\u003e\n\u003cspan class=\"token output\"\u003e  npm audit fix\u003c/span\u003e\n\u003cspan class=\"token output\"\u003e\u003c/span\u003e\n\u003cspan class=\"token output\"\u003eTo address all issues, run:\u003c/span\u003e\n\u003cspan class=\"token output\"\u003e  npm audit fix --force\u003c/span\u003e\n\u003cspan class=\"token output\"\u003e\u003c/span\u003e\n\u003cspan class=\"token output\"\u003eRun `npm audit` for details.\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eまた，ブログシステムのベースに使っているVuePressが0.xから1.8までバージョンアップしていたので，これは追従しよう.\u003c/p\u003e\n\u003cp\u003eしかし早々に更新を断念. デザインをフルスクラッチでやるためにVuePressのソースを\u003ccode\u003eeject\u003c/code\u003eしていたため，追従をすべて手でやる必要があった.\u003c/p\u003e\n\u003cp\u003eブログ自体のメンテにはそこまでコストをかけてられないので，今度は\u003ccode\u003eeject\u003c/code\u003eしなくてもデザインを触れるライブラリを選定することにした.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e開発言語自体にはこだわりはないが，型システムはほしい\u003c/li\u003e\n\u003cli\u003eマークダウンで書ける\u003c/li\u003e\n\u003cli\u003eサーバ管理は避けたいので，GitHub Pagesに載せられるもの\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eを探した.最終的には次の2つから選んだ. \u003cdel\u003e結局相当のyak shavingが発生した.\u003c/del\u003e\u003c/p\u003e\n\u003ch3 id=\"gatsbyjs\"\u003e\u003ca href=\"#gatsbyjs\"\u003eGatsby.js\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003e\u003ca href=\"https://www.gatsbyjs.com/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eGatsby.js\u003c/a\u003eはReact.jsをベースにしたリッチなCMSフレームワーク.バックエンドとはGraphQLで連携し，コンテンツの取得は\u003ca href=\"https://www.contentful.com/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003econtentful\u003c/a\u003e+Markdownだったりと選定の自由度が高い.\u003c/p\u003e\n\u003cp\u003eSGのプロセスについてもAPIの呼び出し回数は全ページに対して1回で済む(ようなquery buildをする必要はある)ようなので，productionでの利用をするならGatsby.jsを選ぶと思う.\u003c/p\u003e\n\u003ch3 id=\"nextjs\"\u003e\u003ca href=\"#nextjs\"\u003eNext.js\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003e\u003ca href=\"https://nextjs.org/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eNext.js\u003c/a\u003eはGatsby.jsと比べると薄いフレームワークで，ビルドやルーティング等ベースとなる機能の提供がメインになっている.\nStatic Generationの仕組みはあるが，Gatsby.jsほどの最適化は行われていない感じ.\u003c/p\u003e\n\u003cp\u003eしたがってCMSとして使うためにはそれ相当の機能の実装が必要となるため，\u003cdel\u003eコストは高い\u003c/del\u003e面白そう.\u003c/p\u003e\n\u003ch2 id=\"artifacts\"\u003e\u003ca href=\"#artifacts\"\u003eArtifacts\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003ca href=\"https://koka831.github.io/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eこれ\u003c/a\u003eができた.\u003c/p\u003e\n\u003ch3 id=\"architecture\"\u003e\u003ca href=\"#architecture\"\u003eArchitecture\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003eNext.jsの\u003ca href=\"https://nextjs.org/docs/basic-features/data-fetching#getstaticprops-static-generation\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003ccode\u003egetStaticProps\u003c/code\u003e\u003c/a\u003eと\u003ca href=\"https://nextjs.org/docs/basic-features/data-fetching#getstaticpaths-static-generation\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003ccode\u003egetStaticPaths\u003c/code\u003e\u003c/a\u003eを用いて一覧・詳細ページをSG.\nコンテンツはMarkdownで記述し，\u003ca href=\"https://github.com/remarkjs/remark\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eremark\u003c/a\u003eを用いてHTMLを生成している．\nNext.js側でも\u003ca href=\"https://nextjs.org/blog/markdown\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eMDX\u003c/a\u003e(Markdown+React Component)を描画できる仕組みがあったけど，内部で呼ばれているコンパイラに手を加えるのに難儀したため，情報の多いremarkを選んだ.\u003c/p\u003e\n\u003cp\u003e(\u003ca href=\"https://github.com/mizchi/amdx\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eamdx\u003c/a\u003eはマジですごいと思う)\u003c/p\u003e\n\u003cp\u003eremarkはMarkdownを入力として，指定した形式での出力を行うプロセッサで，fig.1のように\u003ccode\u003eParser\u003c/code\u003e，\u003ccode\u003eTransformer\u003c/code\u003eや\u003ccode\u003eCompiler\u003c/code\u003eといったプラグインを処理に挟むことができる.\n受け取ったMarkdownは\u003ca href=\"https://github.com/syntax-tree/mdast\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003emdast\u003c/a\u003e\u003csup\u003e\u003ca href=\"#user-content-fn-1\" id=\"user-content-fnref-1\" data-footnote-ref aria-describedby=\"footnote-label\"\u003e2\u003c/a\u003e\u003c/sup\u003eという形式のastに変換され，プラグインはmdastを受取りmdastを返すよう要求される.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"process\" class=\"language-asciidoc\"\u003e\u003ccode class=\"language-asciidoc\"\u003e| ........................ process ........................... |\n| .......... parse ... | ... run ... | ... stringify ..........|\n\n          \u003cspan class=\"token inline\"\u003e\u003cspan class=\"token punctuation\"\u003e+\u003c/span\u003e--------\u003cspan class=\"token punctuation\"\u003e+\u003c/span\u003e\u003c/span\u003e                     \u003cspan class=\"token inline\"\u003e\u003cspan class=\"token punctuation\"\u003e+\u003c/span\u003e----------\u003cspan class=\"token punctuation\"\u003e+\u003c/span\u003e\u003c/span\u003e\nInput -\u003e- | Parser | -\u003e- Syntax Tree -\u003e- | Compiler | -\u003e- Output\n          \u003cspan class=\"token inline\"\u003e\u003cspan class=\"token punctuation\"\u003e+\u003c/span\u003e--------\u003cspan class=\"token punctuation\"\u003e+\u003c/span\u003e\u003c/span\u003e          |          \u003cspan class=\"token inline\"\u003e\u003cspan class=\"token punctuation\"\u003e+\u003c/span\u003e----------\u003cspan class=\"token punctuation\"\u003e+\u003c/span\u003e\u003c/span\u003e\n                              X\n                              |\n                       \u003cspan class=\"token inline\"\u003e\u003cspan class=\"token punctuation\"\u003e+\u003c/span\u003e--------------\u003cspan class=\"token punctuation\"\u003e+\u003c/span\u003e\u003c/span\u003e\n                       | Transformers |\n                       \u003cspan class=\"token inline\"\u003e\u003cspan class=\"token punctuation\"\u003e+\u003c/span\u003e--------------\u003cspan class=\"token punctuation\"\u003e+\u003c/span\u003e\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003cstrong\u003efig.1 remarkの変換プロセス. 図はベースとなるunifiedから. [\u003ca href=\"https://github.com/unifiedjs/unified#description\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e出典\u003c/a\u003e]\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eこのブログではそこそこプラグインを使っていて，中には自作したものもある\u003csup\u003e\u003ca href=\"#user-content-fn-2\" id=\"user-content-fnref-2\" data-footnote-ref aria-describedby=\"footnote-label\"\u003e3\u003c/a\u003e\u003c/sup\u003e.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"interpreter.ts\" class=\"language-typescript  line-numbers\"\u003e\u003ccode class=\"language-typescript\"\u003e\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e markdownToHtml \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003easync\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003emarkdown\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token builtin\"\u003estring\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token builtin\"\u003ePromise\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token builtin\"\u003estring\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e result \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eawait\u003c/span\u003e \u003cspan class=\"token function\"\u003eremark\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003euse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003egfm\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// remark-gfm\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003euse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003emath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// remark-math\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003euse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eemoji\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// remark-emoji\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003euse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003econtainer\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// 自作 | VuePressで使っていたCustom Container記法に対応\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003euse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ecaption\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// 自作 | Markdown中の画像に対して通し番号+figcaptionを付与\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003euse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eprism\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// remark-prism\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003euse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eexternalLink\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// remark-external-links\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003euse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eslug\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// remark-slug\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003euse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eheadings\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e behavior\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"wrap\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// remark-autolink-headings\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003euse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003efootnotes\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// remark-footnotes\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003euse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eremark2rehype\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// remark-rehype | mdastからhast形式へ変換\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003euse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ekatex\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// rehype-katex | remark-mathで変換したmarkdownでの数式をkatex記法へ変換\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003euse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estringify\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// rehype-stringify\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eprocess\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003emarkdown\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n  \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e result\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003etoString\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\u003cspan aria-hidden=\"true\" class=\"line-numbers-rows\"\u003e\u003cspan class=\"\"\u003e\u003c/span\u003e\u003cspan class=\"\"\u003e\u003c/span\u003e\u003cspan class=\"\"\u003e\u003c/span\u003e\u003cspan class=\"\"\u003e\u003c/span\u003e\u003cspan class=\"\"\u003e\u003c/span\u003e\u003cspan class=\"\"\u003e\u003c/span\u003e\u003cspan class=\"\"\u003e\u003c/span\u003e\u003cspan class=\"\"\u003e\u003c/span\u003e\u003cspan class=\"\"\u003e\u003c/span\u003e\u003cspan class=\"\"\u003e\u003c/span\u003e\u003cspan class=\"\"\u003e\u003c/span\u003e\u003cspan class=\"\"\u003e\u003c/span\u003e\u003cspan class=\"\"\u003e\u003c/span\u003e\u003cspan class=\"\"\u003e\u003c/span\u003e\u003cspan class=\"\"\u003e\u003c/span\u003e\u003cspan class=\"\"\u003e\u003c/span\u003e\u003cspan class=\"\"\u003e\u003c/span\u003e\u003cspan class=\"\"\u003e\u003c/span\u003e\u003cspan class=\"\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003cstrong\u003efig.2 プラグイン一覧\u003c/strong\u003e\u003c/p\u003e\n\u003ch3 id=\"remark-plugin\"\u003e\u003ca href=\"#remark-plugin\"\u003eremark plugin\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003e実際作ってみると結構簡単に実装できる. READMEにあるサンプルだと型情報がなかったりで結構辛いけど，fig.1と\u003ca href=\"https://unifiedjs.com/learn/guide/create-a-plugin/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eguide\u003c/a\u003eが参考になる.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eremark-container\u003c/strong\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eもともと使っていたVuePressでは，Custom Containersと呼ばれるMarkdownの拡張記法が使える\u003csup\u003e\u003ca href=\"#user-content-fn-3\" id=\"user-content-fnref-3\" data-footnote-ref aria-describedby=\"footnote-label\"\u003e4\u003c/a\u003e\u003c/sup\u003e.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"custom-container.md\" class=\"language-markdown\"\u003e\u003ccode class=\"language-markdown\"\u003e::: info Custom Title\nCustom Container Body\n:::\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003cstrong\u003efig.3 これがこうじゃ\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e\u003cdiv class=\"remark-container info\"\u003e\u003cdiv class=\"remark-container__title\"\u003eCustom Title\u003c/div\u003eCustom Container Body\u003c/div\u003e\u003c/p\u003e\n\u003cp\u003eremark版を探すといくつか見つかったけど，どれも動かなかったので作ることにした.\u003c/p\u003e\n\u003cp\u003e実装は正規表現でdirectiveにマッチした行のastを書き換えるもので，単純なため対応してないケースもある(directive内のcode blockとかnodeが分割されるケース).\nこれらの対応は\u003ca href=\"https://github.com/remarkjs/remark-directive\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eremark-directive\u003c/a\u003eを用いて後々やりたい.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eremark-image-caption\u003c/strong\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eimg要素のようなself-closing tagについては\u003ccode\u003e::before\u003c/code\u003e等の疑似要素が使えないため，例えばMarkdownで記述した画像のタイトルをCSSのみで抽出・表示するといったことができない．\u003c/p\u003e\n\u003cp\u003e画像に対してcaptionを付与するプラグインは動作するいくつか見つかったけど，画像に対して連番を振ってくれるようなものは見当たらなかった.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"image.md\" class=\"language-markdown\"\u003e\u003ccode class=\"language-markdown\"\u003e\u003cspan class=\"token url\"\u003e\u003cspan class=\"token operator\"\u003e!\u003c/span\u003e[\u003cspan class=\"token content\"\u003ealt text\u003c/span\u003e](\u003cspan class=\"token url\"\u003eimage.png\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"image title\"\u003c/span\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003cfigure\u003e\u003cimg src=\"/img/icon.png\" alt=\"alt text\" title=\"image title\"\u003e\u003cfigcaption\u003eimg.1 image title\u003c/figcaption\u003e\u003c/figure\u003e\u003c/p\u003e\n\u003cp\u003e今回作成したプラグインでは，画像を\u003ccode\u003e\u0026#x3C;figure\u003e\u003c/code\u003eタグで囲んでタイトルを\u003ccode\u003e\u0026#x3C;figcaption\u003e\u003c/code\u003eに設定するようにした.\nただ，この手法は例えばtableのようなMarkdown記法でタイトルを付与できない要素に対しては使えないため，画像やコード，テーブル等の直下の\u003ccode\u003eem\u003c/code\u003eや\u003ccode\u003estrong\u003c/code\u003eをcaptionとみなすといったやり方に移行すると思う.\u003c/p\u003e\n\u003ch3 id=\"commit-log\"\u003e\u003ca href=\"#commit-log\"\u003eCommit Log\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003e各記事の編集履歴を表示する\u003cstrong\u003eCommits\u003c/strong\u003eコンポーネント(↓の\u003cstrong\u003eCommits\u003c/strong\u003e).\u003c/p\u003e\n\u003cp\u003eやっていることは単純で，\u003ccode\u003egetStaticProps\u003c/code\u003e呼び出し時に該当するファイルに対してのGit履歴を取得しているだけ.\u003c/p\u003e\n\u003ch3 id=\"table-of-contents\"\u003e\u003ca href=\"#table-of-contents\"\u003eTable of Contents\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003e現在のページにあるheadingsから目次を構築するコンポーネント(→の目次.表示されてない人は1200px以上の画面で見てね).\u003c/p\u003e\n\u003cp\u003eこれは単に実装したことがなかったから作った\u003csup\u003e\u003ca href=\"#user-content-fn-4\" id=\"user-content-fnref-4\" data-footnote-ref aria-describedby=\"footnote-label\"\u003e5\u003c/a\u003e\u003c/sup\u003e.\n原理は単純で，現在のスクロール位置を取得して，通り過ぎたheadingのうち最も近いものをhighlightしている.\n最初はmarkdownを与えてheadingを抽出するやり方にしていたけど，markdown外にあるCommitsやComments等，そのページにあるheadingを動的に抽出する方針に切り替えた.\u003c/p\u003e\n\u003ch3 id=\"comments\"\u003e\u003ca href=\"#comments\"\u003eComments\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003eGitHub Issueと連携したコメントコンポーネント(↓の\u003cstrong\u003eComments\u003c/strong\u003e).\n\u003ca href=\"https://utteranc.es\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eutterances\u003c/a\u003eというサービスを利用した. ブログからコメントするにはGitHub AccountでのAuthが必要だけど，\u003ca href=\"https://github.com/koka831/blog/issues\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eIssues\u003c/a\u003eに直接コメントすることもできる.\u003c/p\u003e\n\u003ch2 id=\"これから\"\u003e\u003ca href=\"#これから\"\u003eこれから\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003eフリーランスとしてのお仕事も現在は募集しておらず，自身の身の振り方については少なくとも今年いっぱいは考える予定.\nとりあえずプライベートではアルゴリズムやデータ構造等再度やっていこうと思う.\u003c/p\u003e\n\u003cp\u003e紅茶コーディネータについては年初からの受講なので，順調に行けば今年の秋ころには取れるかなあ，という感じ.\nミーハーなので今年のセカンドフラッシュを楽しみにしてたりする.\u003c/p\u003e\n\u003csection data-footnotes class=\"footnotes\"\u003e\u003ch2 id=\"footnote-label\" class=\"sr-only\"\u003e\u003ca href=\"#footnote-label\"\u003eFootnotes\u003c/a\u003e\u003c/h2\u003e\n\u003col\u003e\n\u003cli id=\"user-content-fn-tea\"\u003e\n\u003cp\u003e余談だけど茶葉のテイスティングカップ，料理の際に調味料を混ぜる小さい容器に最適すぎる \u003ca href=\"#user-content-fnref-tea\" data-footnote-backref class=\"data-footnote-backref\" aria-label=\"Back to content\"\u003e↩\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli id=\"user-content-fn-1\"\u003e\n\u003cp\u003emdastは\u003ca href=\"https://github.com/syntax-tree/unist\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eunist\u003c/a\u003eという規格に従っていて，他にはHTMLのunist表記である\u003ca href=\"https://github.com/syntax-tree/hast\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003ehast\u003c/a\u003eなどがある. またmdastのプロセッサ実装(remark)があるように，hastのプロセッサには\u003ca href=\"https://github.com/rehypejs/rehype\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003erehype\u003c/a\u003eがある. \u003ca href=\"#user-content-fnref-1\" data-footnote-backref class=\"data-footnote-backref\" aria-label=\"Back to content\"\u003e↩\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli id=\"user-content-fn-2\"\u003e\n\u003cp\u003eremark内部で使っている\u003ca href=\"https://github.com/remarkjs/remark/pull/536\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eライブラリの移行\u003c/a\u003eが2020後半にあって，npmに上がっているプラグインの中にも動作しないものが少なくない. 実際動作するプラグインの中には(This plugin is made for the new parser in remark (micromark, see remarkjs/remark#536).)のように注釈があったりする. \u003ca href=\"#user-content-fnref-2\" data-footnote-backref class=\"data-footnote-backref\" aria-label=\"Back to content\"\u003e↩\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli id=\"user-content-fn-3\"\u003e\n\u003cp\u003e大元は\u003ca href=\"https://talk.commonmark.org/t/generic-directives-plugins-syntax/444/155\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eこれ\u003c/a\u003eっぽい. \u003ca href=\"#user-content-fnref-3\" data-footnote-backref class=\"data-footnote-backref\" aria-label=\"Back to content\"\u003e↩\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli id=\"user-content-fn-4\"\u003e\n\u003cp\u003e今回UIコンポーネントライブラリは一切使わなかった. \u003cdel\u003eコストとは\u003c/del\u003e \u003ca href=\"#user-content-fnref-4\" data-footnote-backref class=\"data-footnote-backref\" aria-label=\"Back to content\"\u003e↩\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/section\u003e","description":"scratch new blog with Next.js; switched from VuePress","commits":[{"title":"fix: use Static Generation(SG) instead of SSG","date":"2021-10-26 22:37:38","hash":"6b966820","diff":"\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"6b966820.patch\" class=\"language-git  language-diff\"\u003e\u003ccode class=\"language-git\"\u003e\u003cspan class=\"token commit-sha1\"\u003ecommit 6b96682060f7a7b2f2c20048d55e37f2f9ae44eb\u003c/span\u003e\nAuthor: koka \u0026#x26;\u003ca href=\"mailto:lt;koka.code@gmail.com\" class=\"token email-link\"\u003elt;koka.code@gmail.com\u003c/a\u003e\u0026#x26;gt;\nDate:   Tue Oct 26 22:37:38 2021 +0900\n\n  fix: use Static Generation(SG) instead of SSG\n\ndiff --git a/_posts/2021-04-25-nextjs-from-vuepress.md b/_posts/2021-04-25-nextjs-from-vuepress.md\nindex e2e9415..5c8ea91 100644\n\u003cspan class=\"token deleted\"\u003e--- a/_posts/2021-04-25-nextjs-from-vuepress.md\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+++ b/_posts/2021-04-25-nextjs-from-vuepress.md\u003c/span\u003e\n@@ -15,7 +15,7 @@ description: scratch new blog with Next.js; switched from VuePress\n\u003cspan class=\"token comment\"\u003e## TL;DR\u003c/span\u003e\n\n\u003cspan class=\"token deleted\"\u003e- [VuePress][vuepress]のアルファ版を使っていて，メンテが辛くなった\u003c/span\u003e\n\u003cspan class=\"token deleted\"\u003e-- [Next.js][next] + [remark][remark]でMarkdown-\u0026#x26;gt;HTMLのSSGを構築した\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- [Next.js][next] + [remark][remark]でMarkdown-\u0026#x26;gt;HTMLのSGを構築した\u003c/span\u003e\n\u003cspan class=\"token deleted\"\u003e- [できたもの](https://github.com/koka831/koka831.github.io)\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e## About\u003c/span\u003e\n@@ -54,12 +54,12 @@ Run `npm audit` for details.\n\n[Gatsby.js][gatsby]はReact.jsをベースにしたリッチなCMSフレームワーク.バックエンドとはGraphQLで連携し，コンテンツの取得は[contentful][contentful]+Markdownだったりと選定の自由度が高い.\n\n\u003cspan class=\"token deleted\"\u003e-SSGのプロセスについてもAPIの呼び出し回数は全ページに対して1回で済む(ようなquery buildをする必要はある)ようなので，productionでの利用をするならGatsby.jsを選ぶと思う.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+SGのプロセスについてもAPIの呼び出し回数は全ページに対して1回で済む(ようなquery buildをする必要はある)ようなので，productionでの利用をするならGatsby.jsを選ぶと思う.\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e### Next.js\u003c/span\u003e\n\n[Next.js][next]はGatsby.jsと比べると薄いフレームワークで，ビルドやルーティング等ベースとなる機能の提供がメインになっている.\n\u003cspan class=\"token deleted\"\u003e-Server-Side Generationの仕組みはあるが，Gatsby.jsほどの最適化は行われていない感じ.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+Static Generationの仕組みはあるが，Gatsby.jsほどの最適化は行われていない感じ.\u003c/span\u003e\n\nしたがってCMSとして使うためにはそれ相当の機能の実装が必要となるため，~コストは高い~面白そう.\n\n@@ -69,7 +69,7 @@ Server-Side Generationの仕組みはあるが，Gatsby.jsほどの最適化は\n\n\u003cspan class=\"token comment\"\u003e### Architecture\u003c/span\u003e\n\n\u003cspan class=\"token deleted\"\u003e-Next.jsの[`getStaticProps`][getStaticProps]と[`getStaticPaths`][getStaticPaths]を用いて一覧・詳細ページをSSG.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+Next.jsの[`getStaticProps`][getStaticProps]と[`getStaticPaths`][getStaticPaths]を用いて一覧・詳細ページをSG.\u003c/span\u003e\nコンテンツはMarkdownで記述し，[remark][remark]を用いてHTMLを生成している．\nNext.js側でも[MDX][mdx](Markdown+React Component)を描画できる仕組みがあったけど，内部で呼ばれているコンパイラに手を加えるのに難儀したため，情報の多いremarkを選んだ.\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e"},{"title":"add link to github","date":"2021-04-27 22:23:26","hash":"de03b5e2","diff":"\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"de03b5e2.patch\" class=\"language-git  language-diff\"\u003e\u003ccode class=\"language-git\"\u003e\u003cspan class=\"token commit-sha1\"\u003ecommit de03b5e21ad5799aed5d6ba2c87af059a6115aa2\u003c/span\u003e\nAuthor: koka \u0026#x26;\u003ca href=\"mailto:lt;koka.code@gmail.com\" class=\"token email-link\"\u003elt;koka.code@gmail.com\u003c/a\u003e\u0026#x26;gt;\nDate:   Tue Apr 27 22:23:26 2021 +0900\n\n  add link to github\n\ndiff --git a/_posts/2021-04-25-nextjs-from-vuepress.md b/_posts/2021-04-25-nextjs-from-vuepress.md\nindex f99a404..e2e9415 100644\n\u003cspan class=\"token deleted\"\u003e--- a/_posts/2021-04-25-nextjs-from-vuepress.md\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+++ b/_posts/2021-04-25-nextjs-from-vuepress.md\u003c/span\u003e\n@@ -16,6 +16,7 @@ description: scratch new blog with Next.js; switched from VuePress\n\n\u003cspan class=\"token deleted\"\u003e- [VuePress][vuepress]のアルファ版を使っていて，メンテが辛くなった\u003c/span\u003e\n\u003cspan class=\"token deleted\"\u003e- [Next.js][next] + [remark][remark]でMarkdown-\u0026#x26;gt;HTMLのSSGを構築した\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- [できたもの](https://github.com/koka831/koka831.github.io)\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e## About\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e"},{"title":"add","date":"2021-04-27 16:59:33","hash":"ae6500c9","diff":"\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"ae6500c9.patch\" class=\"language-git  language-diff\"\u003e\u003ccode class=\"language-git\"\u003e\u003cspan class=\"token commit-sha1\"\u003ecommit ae6500c9b2a3b5fd76fbf543286171fd2fb60b3f\u003c/span\u003e\nAuthor: koka \u0026#x26;\u003ca href=\"mailto:lt;koka.code@gmail.com\" class=\"token email-link\"\u003elt;koka.code@gmail.com\u003c/a\u003e\u0026#x26;gt;\nDate:   Tue Apr 27 16:59:33 2021 +0900\n\n  add\n\ndiff --git a/_posts/2021-04-25-nextjs-from-vuepress.md b/_posts/2021-04-25-nextjs-from-vuepress.md\nnew file mode 100644\nindex 0000000..f99a404\n\u003cspan class=\"token deleted\"\u003e--- /dev/null\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+++ b/_posts/2021-04-25-nextjs-from-vuepress.md\u003c/span\u003e\n\u003cspan class=\"token coord\"\u003e@@ -0,0 +1,211 @@\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+---\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+title: 'Renewal Blog'\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+date: 2021-04-26\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+categories:\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- Diary\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+tags:\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- Diary\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+description: scratch new blog with Next.js; switched from VuePress\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+---\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+1年ぶりになります．今年もよろしくお願いします．\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+最近は紅茶コーディネータになるべく日々精進しています[^tea]．\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+## TL;DR\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- [VuePress][vuepress]のアルファ版を使っていて，メンテが辛くなった\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- [Next.js][next] + [remark][remark]でMarkdown-\u0026#x26;gt;HTMLのSSGを構築した\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+## About\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ブログを書こうと思い立って，以前構築したブログを久々に確認した.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+今つかってるパソコンにブログのソースコードを持ってきていなかったので，`npm install`すると脆弱性の嵐.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```shell-session[data-file=\"terminal\"]\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+$npm i\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+removed 22 packages, changed 14 packages, and audited 1090 packages in 8s\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+33 vulnerabilities (7 low, 15 moderate, 11 high)\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+To address issues that do not require attention, run:\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  npm audit fix\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+To address all issues, run:\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  npm audit fix --force\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+Run `npm audit` for details.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+また，ブログシステムのベースに使っているVuePressが0.xから1.8までバージョンアップしていたので，これは追従しよう.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+しかし早々に更新を断念. デザインをフルスクラッチでやるためにVuePressのソースを`eject`していたため，追従をすべて手でやる必要があった.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ブログ自体のメンテにはそこまでコストをかけてられないので，今度は`eject`しなくてもデザインを触れるライブラリを選定することにした.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- 開発言語自体にはこだわりはないが，型システムはほしい\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- マークダウンで書ける\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- サーバ管理は避けたいので，GitHub Pagesに載せられるもの\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+を探した.最終的には次の2つから選んだ. ~結局相当のyak shavingが発生した.~\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+### Gatsby.js\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+[Gatsby.js][gatsby]はReact.jsをベースにしたリッチなCMSフレームワーク.バックエンドとはGraphQLで連携し，コンテンツの取得は[contentful][contentful]+Markdownだったりと選定の自由度が高い.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+SSGのプロセスについてもAPIの呼び出し回数は全ページに対して1回で済む(ようなquery buildをする必要はある)ようなので，productionでの利用をするならGatsby.jsを選ぶと思う.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+### Next.js\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+[Next.js][next]はGatsby.jsと比べると薄いフレームワークで，ビルドやルーティング等ベースとなる機能の提供がメインになっている.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+Server-Side Generationの仕組みはあるが，Gatsby.jsほどの最適化は行われていない感じ.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+したがってCMSとして使うためにはそれ相当の機能の実装が必要となるため，~コストは高い~面白そう.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+## Artifacts\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+[これ][blog]ができた.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+### Architecture\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+Next.jsの[`getStaticProps`][getStaticProps]と[`getStaticPaths`][getStaticPaths]を用いて一覧・詳細ページをSSG.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+コンテンツはMarkdownで記述し，[remark][remark]を用いてHTMLを生成している．\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+Next.js側でも[MDX][mdx](Markdown+React Component)を描画できる仕組みがあったけど，内部で呼ばれているコンパイラに手を加えるのに難儀したため，情報の多いremarkを選んだ.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+([amdx][amdx]はマジですごいと思う)\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+remarkはMarkdownを入力として，指定した形式での出力を行うプロセッサで，fig.1のように`Parser`，`Transformer`や`Compiler`といったプラグインを処理に挟むことができる.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+受け取ったMarkdownは[mdast][mdast][^1]という形式のastに変換され，プラグインはmdastを受取りmdastを返すよう要求される.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```asciidoc[data-file=\"process\"]\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+| ........................ process ........................... |\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+| .......... parse ... | ... run ... | ... stringify ..........|\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+          +--------+                     +----------+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+Input -\u0026#x26;gt;- | Parser | -\u0026#x26;gt;- Syntax Tree -\u0026#x26;gt;- | Compiler | -\u0026#x26;gt;- Output\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+          +--------+          |          +----------+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+                              X\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+                              |\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+                       +--------------+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+                       | Transformers |\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+                       +--------------+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+**fig.1 remarkの変換プロセス. 図はベースとなるunifiedから. [[出典][unified-process]]**\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+このブログではそこそこプラグインを使っていて，中には自作したものもある[^2].\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```typescript[data-file=\"interpreter.ts\"][class=\"line-numbers\"]\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+const markdownToHtml = async (markdown: string): Promise\u0026#x26;lt;string\u0026#x26;gt; =\u0026#x26;gt; {\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  const result = await remark()\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    .use(gfm) // remark-gfm\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    .use(math) // remark-math\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    .use(emoji) // remark-emoji\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    .use(container) // 自作 | VuePressで使っていたCustom Container記法に対応\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    .use(caption) // 自作 | Markdown中の画像に対して通し番号+figcaptionを付与\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    .use(prism) // remark-prism\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    .use(externalLink) // remark-external-links\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    .use(slug) // remark-slug\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    .use(headings, { behavior: \"wrap\" }) // remark-autolink-headings\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    .use(footnotes) // remark-footnotes\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    .use(remark2rehype) // remark-rehype | mdastからhast形式へ変換\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    .use(katex) // rehype-katex | remark-mathで変換したmarkdownでの数式をkatex記法へ変換\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    .use(stringify) // rehype-stringify\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    .process(markdown);\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  return result.toString();\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+};\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+**fig.2 プラグイン一覧**\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+### remark plugin\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+実際作ってみると結構簡単に実装できる. READMEにあるサンプルだと型情報がなかったりで結構辛いけど，fig.1と[guide][unified-guide]が参考になる.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+* **remark-container**\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+もともと使っていたVuePressでは，Custom Containersと呼ばれるMarkdownの拡張記法が使える[^3].\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```markdown[data-file=\"custom-container.md\"]\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+::: info Custom Title\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+Custom Container Body\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+:::\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+**fig.3 これがこうじゃ**\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+::: info Custom Title\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+Custom Container Body\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+:::\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+remark版を探すといくつか見つかったけど，どれも動かなかったので作ることにした.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+実装は正規表現でdirectiveにマッチした行のastを書き換えるもので，単純なため対応してないケースもある(directive内のcode blockとかnodeが分割されるケース).\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+これらの対応は[remark-directive][remark-directive]を用いて後々やりたい.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+* **remark-image-caption**\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+img要素のようなself-closing tagについては`::before`等の疑似要素が使えないため，例えばMarkdownで記述した画像のタイトルをCSSのみで抽出・表示するといったことができない．\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+画像に対してcaptionを付与するプラグインは動作するいくつか見つかったけど，画像に対して連番を振ってくれるようなものは見当たらなかった.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```markdown[data-file=\"image.md\"]\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+![alt text](image.png \"image title\")\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+![alt text](/img/icon.png \"image title\")\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+今回作成したプラグインでは，画像を`\u0026#x26;lt;figure\u0026#x26;gt;`タグで囲んでタイトルを`\u0026#x26;lt;figcaption\u0026#x26;gt;`に設定するようにした.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ただ，この手法は例えばtableのようなMarkdown記法でタイトルを付与できない要素に対しては使えないため，画像やコード，テーブル等の直下の`em`や`strong`をcaptionとみなすといったやり方に移行すると思う.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+### Commit Log\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+各記事の編集履歴を表示する**Commits**コンポーネント(↓の**Commits**).\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+やっていることは単純で，`getStaticProps`呼び出し時に該当するファイルに対してのGit履歴を取得しているだけ.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+### Table of Contents\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+現在のページにあるheadingsから目次を構築するコンポーネント(→の目次.表示されてない人は1200px以上の画面で見てね).\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+これは単に実装したことがなかったから作った[^4].\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+原理は単純で，現在のスクロール位置を取得して，通り過ぎたheadingのうち最も近いものをhighlightしている.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+最初はmarkdownを与えてheadingを抽出するやり方にしていたけど，markdown外にあるCommitsやComments等，そのページにあるheadingを動的に抽出する方針に切り替えた.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+### Comments\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+GitHub Issueと連携したコメントコンポーネント(↓の**Comments**).\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+[utterances][utterances]というサービスを利用した. ブログからコメントするにはGitHub AccountでのAuthが必要だけど，[Issues][issues]に直接コメントすることもできる.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+## これから\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+フリーランスとしてのお仕事も現在は募集しておらず，自身の身の振り方については少なくとも今年いっぱいは考える予定.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+とりあえずプライベートではアルゴリズムやデータ構造等再度やっていこうと思う.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+紅茶コーディネータについては年初からの受講なので，順調に行けば今年の秋ころには取れるかなあ，という感じ.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ミーハーなので今年のセカンドフラッシュを楽しみにしてたりする.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+[blog]: https://koka831.github.io/\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+[vuepress]: https://vuepress.vuejs.org/\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+[next]: https://nextjs.org/\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+[remark]: https://github.com/remarkjs/remark\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+[remark-directive]: https://github.com/remarkjs/remark-directive\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+[gatsby]: https://www.gatsbyjs.com/\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+[contentful]: https://www.contentful.com/\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+[getStaticProps]: https://nextjs.org/docs/basic-features/data-fetching#getstaticprops-static-generation\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+[getStaticPaths]: https://nextjs.org/docs/basic-features/data-fetching#getstaticpaths-static-generation\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+[mdx]: https://nextjs.org/blog/markdown\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+[amdx]: https://github.com/mizchi/amdx\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+[unified-process]: https://github.com/unifiedjs/unified#description\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+[unified-guide]: https://unifiedjs.com/learn/guide/create-a-plugin/\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+[unist]: https://github.com/syntax-tree/unist\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+[mdast]: https://github.com/syntax-tree/mdast\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+[hast]: https://github.com/syntax-tree/hast\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+[rehype]: https://github.com/rehypejs/rehype\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+[remark#536]: https://github.com/remarkjs/remark/pull/536\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+[utterances]: https://utteranc.es\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+[issues]: https://github.com/koka831/blog/issues\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+[^tea]: 余談だけど茶葉のテイスティングカップ，料理の際に調味料を混ぜる小さい容器に最適すぎる\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+[^1]: mdastは[unist][unist]という規格に従っていて，他にはHTMLのunist表記である[hast][hast]などがある. またmdastのプロセッサ実装(remark)があるように，hastのプロセッサには[rehype][rehype]がある.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+[^2]: remark内部で使っている[ライブラリの移行][remark#536]が2020後半にあって，npmに上がっているプラグインの中にも動作しないものが少なくない. 実際動作するプラグインの中には(This plugin is made for the new parser in remark (micromark, see remarkjs/remark#536).)のように注釈があったりする.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+[^3]: 大元は[これ](https://talk.commonmark.org/t/generic-directives-plugins-syntax/444/155)っぽい.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+[^4]: 今回UIコンポーネントライブラリは一切使わなかった. ~コストとは~\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e"}],"publishedAt":"2021-04-26","updatedAt":"2021-10-26"}},"__N_SSG":true},"page":"/archives/[slug]","query":{"slug":"2021-04-25-nextjs-from-vuepress"},"buildId":"-5kDKO-iBXqcRsFR54_iY","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>