<!DOCTYPE html><html lang="en"><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><meta name="theme-color" content="#ddd4bb"/><meta property="og:type" content="website"/><meta property="og:url" content="https://koka831.github.io"/><meta property="og:site_name" content="/var/log/koka"/><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="/var/log/koka"/><meta name="twitter:site" content="@k_0ka"/><meta name="twitter:description" content="cat /var/log/koka &gt; /dev/null"/><link rel="alternate" type="application/rss+xml" href="https://koka831.github.io/feed.xml" title="/var/log/koka RSS2.0"/><title>InfluxDB | /var/log/koka</title><meta property="title" content="InfluxDB | /var/log/koka"/><meta property="og:title" content="InfluxDB | /var/log/koka"/><meta property="twitter:title" content="InfluxDB | /var/log/koka"/><meta property="description" content="色々と必要になったのでまとめ"/><meta property="og:description" content="色々と必要になったのでまとめ"/><meta property="twitter:description" content="色々と必要になったのでまとめ"/><meta property="og:image" content="https://koka831.github.io/img/icon.png"/><meta name="next-head-count" content="19"/><link rel="preload" href="/_next/static/css/54bc1785866df5154e99.css" as="style"/><link rel="stylesheet" href="/_next/static/css/54bc1785866df5154e99.css" data-n-g=""/><link rel="preload" href="/_next/static/css/8b02ed477dd0257678be.css" as="style"/><link rel="stylesheet" href="/_next/static/css/8b02ed477dd0257678be.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a40ef1678bae11e696dba45124eadd70.js"></script><script src="/_next/static/chunks/webpack-90a60b87fd0d5fc150f2.js" defer=""></script><script src="/_next/static/chunks/framework-2191d16384373197bc0a.js" defer=""></script><script src="/_next/static/chunks/main-7c56bfc6d8ecbcc62d76.js" defer=""></script><script src="/_next/static/chunks/pages/_app-bd023273eebc14b656bf.js" defer=""></script><script src="/_next/static/chunks/cb1608f2-13e86362beaa0dcfd98b.js" defer=""></script><script src="/_next/static/chunks/935-9adc676da7ae634c9229.js" defer=""></script><script src="/_next/static/chunks/pages/archives/%5Bslug%5D-13d8b5ea136af0c63861.js" defer=""></script><script src="/_next/static/Xu1zwATJm2jOsh2Qe7l0N/_buildManifest.js" defer=""></script><script src="/_next/static/Xu1zwATJm2jOsh2Qe7l0N/_ssgManifest.js" defer=""></script></head><body><div id="__next"><nav class="Header_navigation__container__3D5xg"><div class="Header_navigation__16lxy"><a href="/">/var/log/koka</a></div><div><a href="/archives">archive</a></div></nav><main class="Layout_container__QVNsN"><div class="slug_container__2Nysm"><div class="slug_main__1TLKU"><article class="slug_article__3n4cv" role="article"><div itemscope="" class="ArticleHeader_header__container__AO3KC"><a class="ArticleHeader_post__title__2ujta" href="/archives/2018-11-11-influxdb">InfluxDB</a><p>色々と必要になったのでまとめ</p><div class="ArticleHeader_flex__36wQ5"><div class="ArticleHeader_post__tags__18geI"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="tags" class="svg-inline--fa fa-tags fa-w-20 ArticleHeader_tags__icon__3kOkK" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path fill="currentColor" d="M497.941 225.941L286.059 14.059A48 48 0 0 0 252.118 0H48C21.49 0 0 21.49 0 48v204.118a48 48 0 0 0 14.059 33.941l211.882 211.882c18.744 18.745 49.136 18.746 67.882 0l204.118-204.118c18.745-18.745 18.745-49.137 0-67.882zM112 160c-26.51 0-48-21.49-48-48s21.49-48 48-48 48 21.49 48 48-21.49 48-48 48zm513.941 133.823L421.823 497.941c-18.745 18.745-49.137 18.745-67.882 0l-.36-.36L527.64 323.522c16.999-16.999 26.36-39.6 26.36-63.64s-9.362-46.641-26.36-63.64L331.397 0h48.721a48 48 0 0 1 33.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882z"></path></svg><p class="Tag_tag__FntIt">database</p><p class="Tag_tag__FntIt">時系列データ</p></div><div class="ArticleHeader_post__dates__s80K2"><time dateTime="2018-11-11" itemProp="datePublished" class="PublishDate_post__date__2Kcmg">published: <!-- -->2018-11-11</time><time dateTime="2021-01-30" itemProp="datePublished" class="PublishDate_post__date__2Kcmg">updated: 2021-01-30</time></div></div></div><div class="slug_article__body__3hx8l"><h2 id="background"><a href="#background">Background</a></h2>
<p>センサから取得した時系列データを解析することになった.<br>
普段の研究ではDynamoDB等のNoSQLを利用しているのだけど, 今回のセンサデータはセンサ数が多い上に欠損率が結構高い.</p>
<p>なので,</p>
<ul>
<li>書き込み速度重視</li>
<li>データの線形補間ができる・やりやすい</li>
<li>できればローカルで使える
ことを要件として調査した.<br>
補間に関してはDB側で巻いてくれると嬉しいけど, パフォーマンスをみてクライアント側でやるのでもまあいい.<br>
これはそのときのログと, (結果的にInfluxDBを選択したのだけど)その結果をまとめたもの.</li>
</ul>
<h1 id="調査"><a href="#%E8%AA%BF%E6%9F%BB">調査</a></h1>
<p>今回調べたソフトウェアは以下.</p>
<ul>
<li>OpenTSDB 2.3.0</li>
<li>InfluxDB 1.7</li>
<li>Prometheus 2.5.0</li>
</ul>
<p>調査対象はデータベースの中でも時系列データベースと呼ばれるものに絞った.<br>
一般的なRDBはそのインデクスにBTree(もしくはB+Tree)を用いているが, BTreeの挿入コストはO(n) ~ O(log n)程度かかってしまう. もちろん最適化はされているのだろうからコストは抑えられるだろうが, 挿入に限ってはO(1)で行いたい.  このあたり勉強しないとなあ</p>
<h2 id="opentsdb"><a href="#opentsdb">OpenTSDB</a></h2>
<ul>
<li>open source time series database</li>
<li>store trillions of data points(!)</li>
<li>scales using HBase</li>
</ul>
<p>分散型の時系列データベース. OpenTSDBでのデータはHBase/Hadoopのクラスタ側で保持する.</p>
<p>PinterestやYahooで使われているとのこと<sup><a href="#user-content-fn-1" id="user-content-fnref-1" data-footnote-ref aria-describedby="footnote-label">1</a></sup>.
Yahooの例では, 200k TSD / s の書き込みを50サーバで行っており, 10億件を超えるデータを保持している.</p>
<h4 id="tsd形式"><a href="#tsd%E5%BD%A2%E5%BC%8F">TSD形式</a></h4>
<ul>
<li>metric: 時系列データの属性の名前. RDBでいうテーブル名.</li>
<li>timestamp</li>
<li>value: integer / float</li>
<li>tag(s): { "key": "value" }のペア.</li>
</ul>
<p>tagについては最低一つつける必要がある(最大8つまでサポートされているが, usually up to 4 or 5 tags とのこと).<br>
時系列DBではvalueが数値しか取れない代わりに, tagsのkeyを組み合わせて集計を行うみたい.</p>
<p>APIはHTTP RestとTelnet Style(!)がある.</p>
<p>補間については, 分散データベースなので物理的な断片化が考慮されており, OpenTSDB側で線形補間・スキップ・ゼロ補間がサポートされている.</p>
<h2 id="prometheus"><a href="#prometheus">Prometheus</a></h2>
<ul>
<li>monitoring system &#x26; time series database</li>
</ul>
<p>今回調べるまで存在を知らなかった. 用途を見るとどうもElasticSearch等の用途と似ていて, モニター側に重きを置いているっぽい.</p>
<p>そのためデータは別口からインポートする必要がある.</p>
<p>データについては15日間分の保持がデフォルトのようで, Prometheus単体で利用するのは(データ解析のフェーズにおいても)今回の用途では厳しそう.</p>
<h2 id="influxdb"><a href="#influxdb">InfluxDB</a></h2>
<h4 id="tsd形式-1"><a href="#tsd%E5%BD%A2%E5%BC%8F-1">TSD形式</a></h4>
<p><a href="https://docs.influxdata.com/influxdb/v1.7/write_protocols/line_protocol_tutorial/" target="_blank" rel="nofollow noopener noreferrer">Line Protocol</a>と呼ばれる行データの書式に従う.<br>
以下の書式のように, 配列はスペースなしのカンマ区切りで, tagとmeasurementの区切り, measurementとtimestampの区切りにはスペースをいれる.<br>
measurementが値部分となっていて, こちらもtagと同様カンマ区切りで複数のtag付のmeasurementを持てる.</p>
<div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">metrix,&#x26;lt;tag_key&#x26;gt;=&#x26;lt;tag_value&#x26;gt;,&#x26;lt;tag_key&#x26;gt;=&#x26;lt;tag_value&#x26;gt; &#x26;lt;measurement&#x26;gt;=&#x26;lt;value&#x26;gt; &#x26;lt;timestamp&#x26;gt;</code></pre></div>
<p>Measurementにはinteger, floatの他にstring, booleanも扱える.</p>
<p>補間については, <code>fill()</code>を用いてnull, 指定値, 線形補間, 前データ値が利用できる.<sup><a href="#user-content-fn-2" id="user-content-fnref-2" data-footnote-ref aria-describedby="footnote-label">2</a></sup></p>
<p><a href="https://www.influxdata.com/blog/influxdb-markedly-outperforms-opentsdb-in-time-series-data-metrics-benchmark/" target="_blank" rel="nofollow noopener noreferrer">blog</a> によるとwrite performanceがOpenTSDBの9倍.</p>
<h2 id="まとめ"><a href="#%E3%81%BE%E3%81%A8%E3%82%81">まとめ</a></h2>
<p>結論としては補間が必要なデータストアにはInfluxDB一択だと思う.</p>
<table>
<thead>
<tr>
<th align="center">DB</th>
<th align="center">書き込み</th>
<th align="center">データ量</th>
<th align="center">補間</th>
<th align="center">ローカル</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">OpenTSDB</td>
<td align="center">○</td>
<td align="center">◎</td>
<td align="center">○</td>
<td align="center">Docker</td>
</tr>
<tr>
<td align="center">InfluxDB</td>
<td align="center">◎</td>
<td align="center">○</td>
<td align="center">○</td>
<td align="center">Docker</td>
</tr>
<tr>
<td align="center">Prometheus</td>
<td align="center">-</td>
<td align="center">x</td>
<td align="center">-</td>
<td align="center">Docker</td>
</tr>
</tbody>
</table>
<h2 id="ref"><a href="#ref">ref</a></h2>
<section data-footnotes class="footnotes"><h2 id="footnote-label" class="sr-only">Footnotes</h2>
<ol>
<li id="user-content-fn-1">
<p><a href="https://www.slideshare.net/HBaseCon/operations-session-3-49043534?qid=5547eada-f70d-4730-bacb-6aeb6f37c068&#x26;v=&#x26;b=&#x26;from_search=5" target="_blank" rel="nofollow noopener noreferrer">slideshare</a> <a href="#user-content-fnref-1" data-footnote-backref class="data-footnote-backref" aria-label="Back to content">↩</a></p>
</li>
<li id="user-content-fn-2">
<p><a href="https://docs.influxdata.com/influxdb/v1.3/query_language/data_exploration/#advanced-group-by-time-syntax" target="_blank" rel="nofollow noopener noreferrer">document</a> <a href="#user-content-fnref-2" data-footnote-backref class="data-footnote-backref" aria-label="Back to content">↩</a></p>
</li>
</ol>
</section></div></article><div class="CommitLogs_commit_logs__2xJyI" role="log"><h2>Commits</h2><details><summary><span class="CommitLogs_commit__date__Vg5RN">2021-01-30 22:18:17</span><span class="CommitLogs_commit__hash__2k3a3">35b550ae</span><span class="CommitLogs_commit__message__nS85e">copy md</span></summary><div><div class="remark-highlight"><pre data-file="35b550ae.patch" class="language-git  language-diff"><code class="language-git"><span class="token commit-sha1">commit 35b550ae83af4efaeadf33471c8ca8a32c1079c8</span>
Author: koka &#x26;<a href="mailto:lt;koka.code@gmail.com" class="token email-link">lt;koka.code@gmail.com</a>&#x26;gt;
Date:   Sat Jan 30 22:18:17 2021 +0900

  copy md

diff --git a/_posts/2018-11-11-influxdb.md b/_posts/2018-11-11-influxdb.md
new file mode 100644
index 0000000..534d52b
<span class="token deleted">--- /dev/null</span>
<span class="token inserted">+++ b/_posts/2018-11-11-influxdb.md</span>
<span class="token coord">@@ -0,0 +1,97 @@</span>
<span class="token inserted">+---</span>
<span class="token inserted">+title: InfluxDB</span>
<span class="token inserted">+date: 2018-11-11</span>
<span class="token inserted">+categories:</span>
<span class="token inserted">+- memo</span>
<span class="token inserted">+tags:</span>
<span class="token inserted">+  - database</span>
<span class="token inserted">+  - 時系列データ</span>
<span class="token inserted">+description: 色々と必要になったのでまとめ</span>
<span class="token inserted">+---</span>
<span class="token inserted">+</span>
<span class="token inserted">+## Background</span>
<span class="token inserted">+センサから取得した時系列データを解析することになった.  </span>
<span class="token inserted">+普段の研究ではDynamoDB等のNoSQLを利用しているのだけど, 今回のセンサデータはセンサ数が多い上に欠損率が結構高い.</span>
<span class="token inserted">+</span>
<span class="token inserted">+なので, </span>
<span class="token inserted">+- 書き込み速度重視</span>
<span class="token inserted">+- データの線形補間ができる・やりやすい</span>
<span class="token inserted">+- できればローカルで使える</span>
<span class="token inserted">+ことを要件として調査した.   </span>
<span class="token inserted">+補間に関してはDB側で巻いてくれると嬉しいけど, パフォーマンスをみてクライアント側でやるのでもまあいい.  </span>
<span class="token inserted">+これはそのときのログと, (結果的にInfluxDBを選択したのだけど)その結果をまとめたもの.</span>
<span class="token inserted">+</span>
<span class="token inserted">+# 調査</span>
<span class="token inserted">+今回調べたソフトウェアは以下.</span>
<span class="token inserted">+</span>
<span class="token inserted">+- OpenTSDB 2.3.0</span>
<span class="token inserted">+- InfluxDB 1.7</span>
<span class="token inserted">+- Prometheus 2.5.0</span>
<span class="token inserted">+</span>
<span class="token inserted">+調査対象はデータベースの中でも時系列データベースと呼ばれるものに絞った.  </span>
<span class="token inserted">+一般的なRDBはそのインデクスにBTree(もしくはB+Tree)を用いているが, BTreeの挿入コストはO(n) ~ O(log n)程度かかってしまう. もちろん最適化はされているのだろうからコストは抑えられるだろうが, 挿入に限ってはO(1)で行いたい.  このあたり勉強しないとなあ</span>
<span class="token inserted">+## OpenTSDB</span>
<span class="token inserted">+- open source time series database</span>
<span class="token inserted">+- store trillions of data points(!)</span>
<span class="token inserted">+- scales using HBase</span>
<span class="token inserted">+</span>
<span class="token inserted">+分散型の時系列データベース. OpenTSDBでのデータはHBase/Hadoopのクラスタ側で保持する.</span>
<span class="token inserted">+</span>
<span class="token inserted">+PinterestやYahooで使われているとのこと[^1].</span>
<span class="token inserted">+Yahooの例では, 200k TSD / s の書き込みを50サーバで行っており, 10億件を超えるデータを保持している.  </span>
<span class="token inserted">+</span>
<span class="token inserted">+#### TSD形式</span>
<span class="token inserted">+- metric: 時系列データの属性の名前. RDBでいうテーブル名.</span>
<span class="token inserted">+- timestamp </span>
<span class="token inserted">+- value: integer / float</span>
<span class="token inserted">+- tag(s): { "key": "value" }のペア. </span>
<span class="token inserted">+</span>
<span class="token inserted">+tagについては最低一つつける必要がある(最大8つまでサポートされているが, usually up to 4 or 5 tags とのこと).  </span>
<span class="token inserted">+時系列DBではvalueが数値しか取れない代わりに, tagsのkeyを組み合わせて集計を行うみたい.</span>
<span class="token inserted">+</span>
<span class="token inserted">+APIはHTTP RestとTelnet Style(!)がある. </span>
<span class="token inserted">+</span>
<span class="token inserted">+</span>
<span class="token inserted">+補間については, 分散データベースなので物理的な断片化が考慮されており, OpenTSDB側で線形補間・スキップ・ゼロ補間がサポートされている.</span>
<span class="token inserted">+</span>
<span class="token inserted">+## Prometheus</span>
<span class="token inserted">+- monitoring system &#x26; time series database</span>
<span class="token inserted">+</span>
<span class="token inserted">+今回調べるまで存在を知らなかった. 用途を見るとどうもElasticSearch等の用途と似ていて, モニター側に重きを置いているっぽい.</span>
<span class="token inserted">+</span>
<span class="token inserted">+そのためデータは別口からインポートする必要がある.</span>
<span class="token inserted">+</span>
<span class="token inserted">+データについては15日間分の保持がデフォルトのようで, Prometheus単体で利用するのは(データ解析のフェーズにおいても)今回の用途では厳しそう.</span>
<span class="token inserted">+</span>
<span class="token inserted">+## InfluxDB</span>
<span class="token inserted">+</span>
<span class="token inserted">+</span>
<span class="token inserted">+#### TSD形式</span>
<span class="token inserted">+[Line Protocol](https://docs.influxdata.com/influxdb/v1.7/write_protocols/line_protocol_tutorial/)と呼ばれる行データの書式に従う.  </span>
<span class="token inserted">+以下の書式のように, 配列はスペースなしのカンマ区切りで, tagとmeasurementの区切り, measurementとtimestampの区切りにはスペースをいれる.  </span>
<span class="token inserted">+measurementが値部分となっていて, こちらもtagと同様カンマ区切りで複数のtag付のmeasurementを持てる.</span>
<span class="token inserted">+\```</span>
<span class="token inserted">+metrix,&#x26;lt;tag_key&#x26;gt;=&#x26;lt;tag_value&#x26;gt;,&#x26;lt;tag_key&#x26;gt;=&#x26;lt;tag_value&#x26;gt; &#x26;lt;measurement&#x26;gt;=&#x26;lt;value&#x26;gt; &#x26;lt;timestamp&#x26;gt;</span>
<span class="token inserted">+\```</span>
<span class="token inserted">+</span>
<span class="token inserted">+Measurementにはinteger, floatの他にstring, booleanも扱える.</span>
<span class="token inserted">+</span>
<span class="token inserted">+補間については, `fill()`を用いてnull, 指定値, 線形補間, 前データ値が利用できる.[^2]</span>
<span class="token inserted">+</span>
<span class="token inserted">+[blog](https://www.influxdata.com/blog/influxdb-markedly-outperforms-opentsdb-in-time-series-data-metrics-benchmark/) によるとwrite performanceがOpenTSDBの9倍.</span>
<span class="token inserted">+</span>
<span class="token inserted">+## まとめ</span>
<span class="token inserted">+結論としては補間が必要なデータストアにはInfluxDB一択だと思う.</span>
<span class="token inserted">+</span>
<span class="token inserted">+|   DB   | 書き込み |  データ量 |  補間 | ローカル |</span>
<span class="token inserted">+|:------:|:--------:|:---------:|:-----:|:--------:|</span>
<span class="token inserted">+|OpenTSDB|  ○       |  ◎        |   ○   | Docker   |</span>
<span class="token inserted">+|InfluxDB|  ◎       |  ○        |   ○   | Docker   |</span>
<span class="token inserted">+|Prometheus| -      |  x        |   -   | Docker   |</span>
<span class="token inserted">+</span>
<span class="token inserted">+</span>
<span class="token inserted">+## ref</span>
<span class="token inserted">+</span>
<span class="token inserted">+[^1]: [slideshare](https://www.slideshare.net/HBaseCon/operations-session-3-49043534?qid=5547eada-f70d-4730-bacb-6aeb6f37c068&#x26;v=&#x26;b=&#x26;from_search=5)</span>
<span class="token inserted">+</span>
<span class="token inserted">+[^2]: [document](https://docs.influxdata.com/influxdb/v1.3/query_language/data_exploration/#advanced-group-by-time-syntax)</span>
</code></pre></div></div></details></div><div class="Comments_comment__3jxzl" role="comment"><h2 class="Comments_title__19pGw">Comments</h2><div id="github-comment-container"></div></div></div><aside class="slug_aside__1vC-U"><nav class="Toc_toc__nav__2o5GC" role="navigation"><ul class="Toc_toc__3i1gg"></ul></nav></aside></div></main><footer class="Footer_footer__cAlbN"><small>Code snippets licensed under MIT, unless otherwise noted.</small></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"slug":"2018-11-11-influxdb","title":"InfluxDB","categories":["memo"],"image":"https://koka831.github.io/img/icon.png","tags":["database","時系列データ"],"content":"\u003ch2 id=\"background\"\u003e\u003ca href=\"#background\"\u003eBackground\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003eセンサから取得した時系列データを解析することになった.\u003cbr\u003e\n普段の研究ではDynamoDB等のNoSQLを利用しているのだけど, 今回のセンサデータはセンサ数が多い上に欠損率が結構高い.\u003c/p\u003e\n\u003cp\u003eなので,\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e書き込み速度重視\u003c/li\u003e\n\u003cli\u003eデータの線形補間ができる・やりやすい\u003c/li\u003e\n\u003cli\u003eできればローカルで使える\nことを要件として調査した.\u003cbr\u003e\n補間に関してはDB側で巻いてくれると嬉しいけど, パフォーマンスをみてクライアント側でやるのでもまあいい.\u003cbr\u003e\nこれはそのときのログと, (結果的にInfluxDBを選択したのだけど)その結果をまとめたもの.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1 id=\"調査\"\u003e\u003ca href=\"#%E8%AA%BF%E6%9F%BB\"\u003e調査\u003c/a\u003e\u003c/h1\u003e\n\u003cp\u003e今回調べたソフトウェアは以下.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eOpenTSDB 2.3.0\u003c/li\u003e\n\u003cli\u003eInfluxDB 1.7\u003c/li\u003e\n\u003cli\u003ePrometheus 2.5.0\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e調査対象はデータベースの中でも時系列データベースと呼ばれるものに絞った.\u003cbr\u003e\n一般的なRDBはそのインデクスにBTree(もしくはB+Tree)を用いているが, BTreeの挿入コストはO(n) ~ O(log n)程度かかってしまう. もちろん最適化はされているのだろうからコストは抑えられるだろうが, 挿入に限ってはO(1)で行いたい.  このあたり勉強しないとなあ\u003c/p\u003e\n\u003ch2 id=\"opentsdb\"\u003e\u003ca href=\"#opentsdb\"\u003eOpenTSDB\u003c/a\u003e\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eopen source time series database\u003c/li\u003e\n\u003cli\u003estore trillions of data points(!)\u003c/li\u003e\n\u003cli\u003escales using HBase\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e分散型の時系列データベース. OpenTSDBでのデータはHBase/Hadoopのクラスタ側で保持する.\u003c/p\u003e\n\u003cp\u003ePinterestやYahooで使われているとのこと\u003csup\u003e\u003ca href=\"#user-content-fn-1\" id=\"user-content-fnref-1\" data-footnote-ref aria-describedby=\"footnote-label\"\u003e1\u003c/a\u003e\u003c/sup\u003e.\nYahooの例では, 200k TSD / s の書き込みを50サーバで行っており, 10億件を超えるデータを保持している.\u003c/p\u003e\n\u003ch4 id=\"tsd形式\"\u003e\u003ca href=\"#tsd%E5%BD%A2%E5%BC%8F\"\u003eTSD形式\u003c/a\u003e\u003c/h4\u003e\n\u003cul\u003e\n\u003cli\u003emetric: 時系列データの属性の名前. RDBでいうテーブル名.\u003c/li\u003e\n\u003cli\u003etimestamp\u003c/li\u003e\n\u003cli\u003evalue: integer / float\u003c/li\u003e\n\u003cli\u003etag(s): { \"key\": \"value\" }のペア.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003etagについては最低一つつける必要がある(最大8つまでサポートされているが, usually up to 4 or 5 tags とのこと).\u003cbr\u003e\n時系列DBではvalueが数値しか取れない代わりに, tagsのkeyを組み合わせて集計を行うみたい.\u003c/p\u003e\n\u003cp\u003eAPIはHTTP RestとTelnet Style(!)がある.\u003c/p\u003e\n\u003cp\u003e補間については, 分散データベースなので物理的な断片化が考慮されており, OpenTSDB側で線形補間・スキップ・ゼロ補間がサポートされている.\u003c/p\u003e\n\u003ch2 id=\"prometheus\"\u003e\u003ca href=\"#prometheus\"\u003ePrometheus\u003c/a\u003e\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003emonitoring system \u0026#x26; time series database\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e今回調べるまで存在を知らなかった. 用途を見るとどうもElasticSearch等の用途と似ていて, モニター側に重きを置いているっぽい.\u003c/p\u003e\n\u003cp\u003eそのためデータは別口からインポートする必要がある.\u003c/p\u003e\n\u003cp\u003eデータについては15日間分の保持がデフォルトのようで, Prometheus単体で利用するのは(データ解析のフェーズにおいても)今回の用途では厳しそう.\u003c/p\u003e\n\u003ch2 id=\"influxdb\"\u003e\u003ca href=\"#influxdb\"\u003eInfluxDB\u003c/a\u003e\u003c/h2\u003e\n\u003ch4 id=\"tsd形式-1\"\u003e\u003ca href=\"#tsd%E5%BD%A2%E5%BC%8F-1\"\u003eTSD形式\u003c/a\u003e\u003c/h4\u003e\n\u003cp\u003e\u003ca href=\"https://docs.influxdata.com/influxdb/v1.7/write_protocols/line_protocol_tutorial/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eLine Protocol\u003c/a\u003eと呼ばれる行データの書式に従う.\u003cbr\u003e\n以下の書式のように, 配列はスペースなしのカンマ区切りで, tagとmeasurementの区切り, measurementとtimestampの区切りにはスペースをいれる.\u003cbr\u003e\nmeasurementが値部分となっていて, こちらもtagと同様カンマ区切りで複数のtag付のmeasurementを持てる.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003emetrix,\u0026#x26;lt;tag_key\u0026#x26;gt;=\u0026#x26;lt;tag_value\u0026#x26;gt;,\u0026#x26;lt;tag_key\u0026#x26;gt;=\u0026#x26;lt;tag_value\u0026#x26;gt; \u0026#x26;lt;measurement\u0026#x26;gt;=\u0026#x26;lt;value\u0026#x26;gt; \u0026#x26;lt;timestamp\u0026#x26;gt;\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eMeasurementにはinteger, floatの他にstring, booleanも扱える.\u003c/p\u003e\n\u003cp\u003e補間については, \u003ccode\u003efill()\u003c/code\u003eを用いてnull, 指定値, 線形補間, 前データ値が利用できる.\u003csup\u003e\u003ca href=\"#user-content-fn-2\" id=\"user-content-fnref-2\" data-footnote-ref aria-describedby=\"footnote-label\"\u003e2\u003c/a\u003e\u003c/sup\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://www.influxdata.com/blog/influxdb-markedly-outperforms-opentsdb-in-time-series-data-metrics-benchmark/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eblog\u003c/a\u003e によるとwrite performanceがOpenTSDBの9倍.\u003c/p\u003e\n\u003ch2 id=\"まとめ\"\u003e\u003ca href=\"#%E3%81%BE%E3%81%A8%E3%82%81\"\u003eまとめ\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e結論としては補間が必要なデータストアにはInfluxDB一択だと思う.\u003c/p\u003e\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth align=\"center\"\u003eDB\u003c/th\u003e\n\u003cth align=\"center\"\u003e書き込み\u003c/th\u003e\n\u003cth align=\"center\"\u003eデータ量\u003c/th\u003e\n\u003cth align=\"center\"\u003e補間\u003c/th\u003e\n\u003cth align=\"center\"\u003eローカル\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd align=\"center\"\u003eOpenTSDB\u003c/td\u003e\n\u003ctd align=\"center\"\u003e○\u003c/td\u003e\n\u003ctd align=\"center\"\u003e◎\u003c/td\u003e\n\u003ctd align=\"center\"\u003e○\u003c/td\u003e\n\u003ctd align=\"center\"\u003eDocker\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd align=\"center\"\u003eInfluxDB\u003c/td\u003e\n\u003ctd align=\"center\"\u003e◎\u003c/td\u003e\n\u003ctd align=\"center\"\u003e○\u003c/td\u003e\n\u003ctd align=\"center\"\u003e○\u003c/td\u003e\n\u003ctd align=\"center\"\u003eDocker\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd align=\"center\"\u003ePrometheus\u003c/td\u003e\n\u003ctd align=\"center\"\u003e-\u003c/td\u003e\n\u003ctd align=\"center\"\u003ex\u003c/td\u003e\n\u003ctd align=\"center\"\u003e-\u003c/td\u003e\n\u003ctd align=\"center\"\u003eDocker\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\u003ch2 id=\"ref\"\u003e\u003ca href=\"#ref\"\u003eref\u003c/a\u003e\u003c/h2\u003e\n\u003csection data-footnotes class=\"footnotes\"\u003e\u003ch2 id=\"footnote-label\" class=\"sr-only\"\u003eFootnotes\u003c/h2\u003e\n\u003col\u003e\n\u003cli id=\"user-content-fn-1\"\u003e\n\u003cp\u003e\u003ca href=\"https://www.slideshare.net/HBaseCon/operations-session-3-49043534?qid=5547eada-f70d-4730-bacb-6aeb6f37c068\u0026#x26;v=\u0026#x26;b=\u0026#x26;from_search=5\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eslideshare\u003c/a\u003e \u003ca href=\"#user-content-fnref-1\" data-footnote-backref class=\"data-footnote-backref\" aria-label=\"Back to content\"\u003e↩\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli id=\"user-content-fn-2\"\u003e\n\u003cp\u003e\u003ca href=\"https://docs.influxdata.com/influxdb/v1.3/query_language/data_exploration/#advanced-group-by-time-syntax\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003edocument\u003c/a\u003e \u003ca href=\"#user-content-fnref-2\" data-footnote-backref class=\"data-footnote-backref\" aria-label=\"Back to content\"\u003e↩\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/section\u003e","description":"色々と必要になったのでまとめ","commits":[{"title":"copy md","date":"2021-01-30 22:18:17","hash":"35b550ae","diff":"\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"35b550ae.patch\" class=\"language-git  language-diff\"\u003e\u003ccode class=\"language-git\"\u003e\u003cspan class=\"token commit-sha1\"\u003ecommit 35b550ae83af4efaeadf33471c8ca8a32c1079c8\u003c/span\u003e\nAuthor: koka \u0026#x26;\u003ca href=\"mailto:lt;koka.code@gmail.com\" class=\"token email-link\"\u003elt;koka.code@gmail.com\u003c/a\u003e\u0026#x26;gt;\nDate:   Sat Jan 30 22:18:17 2021 +0900\n\n  copy md\n\ndiff --git a/_posts/2018-11-11-influxdb.md b/_posts/2018-11-11-influxdb.md\nnew file mode 100644\nindex 0000000..534d52b\n\u003cspan class=\"token deleted\"\u003e--- /dev/null\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+++ b/_posts/2018-11-11-influxdb.md\u003c/span\u003e\n\u003cspan class=\"token coord\"\u003e@@ -0,0 +1,97 @@\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+---\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+title: InfluxDB\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+date: 2018-11-11\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+categories:\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- memo\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+tags:\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  - database\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  - 時系列データ\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+description: 色々と必要になったのでまとめ\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+---\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+## Background\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+センサから取得した時系列データを解析することになった.  \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+普段の研究ではDynamoDB等のNoSQLを利用しているのだけど, 今回のセンサデータはセンサ数が多い上に欠損率が結構高い.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+なので, \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- 書き込み速度重視\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- データの線形補間ができる・やりやすい\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- できればローカルで使える\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ことを要件として調査した.   \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+補間に関してはDB側で巻いてくれると嬉しいけど, パフォーマンスをみてクライアント側でやるのでもまあいい.  \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+これはそのときのログと, (結果的にInfluxDBを選択したのだけど)その結果をまとめたもの.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+# 調査\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+今回調べたソフトウェアは以下.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- OpenTSDB 2.3.0\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- InfluxDB 1.7\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- Prometheus 2.5.0\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+調査対象はデータベースの中でも時系列データベースと呼ばれるものに絞った.  \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+一般的なRDBはそのインデクスにBTree(もしくはB+Tree)を用いているが, BTreeの挿入コストはO(n) ~ O(log n)程度かかってしまう. もちろん最適化はされているのだろうからコストは抑えられるだろうが, 挿入に限ってはO(1)で行いたい.  このあたり勉強しないとなあ\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+## OpenTSDB\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- open source time series database\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- store trillions of data points(!)\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- scales using HBase\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+分散型の時系列データベース. OpenTSDBでのデータはHBase/Hadoopのクラスタ側で保持する.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+PinterestやYahooで使われているとのこと[^1].\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+Yahooの例では, 200k TSD / s の書き込みを50サーバで行っており, 10億件を超えるデータを保持している.  \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+#### TSD形式\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- metric: 時系列データの属性の名前. RDBでいうテーブル名.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- timestamp \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- value: integer / float\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- tag(s): { \"key\": \"value\" }のペア. \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+tagについては最低一つつける必要がある(最大8つまでサポートされているが, usually up to 4 or 5 tags とのこと).  \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+時系列DBではvalueが数値しか取れない代わりに, tagsのkeyを組み合わせて集計を行うみたい.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+APIはHTTP RestとTelnet Style(!)がある. \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+補間については, 分散データベースなので物理的な断片化が考慮されており, OpenTSDB側で線形補間・スキップ・ゼロ補間がサポートされている.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+## Prometheus\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- monitoring system \u0026#x26; time series database\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+今回調べるまで存在を知らなかった. 用途を見るとどうもElasticSearch等の用途と似ていて, モニター側に重きを置いているっぽい.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+そのためデータは別口からインポートする必要がある.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+データについては15日間分の保持がデフォルトのようで, Prometheus単体で利用するのは(データ解析のフェーズにおいても)今回の用途では厳しそう.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+## InfluxDB\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+#### TSD形式\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+[Line Protocol](https://docs.influxdata.com/influxdb/v1.7/write_protocols/line_protocol_tutorial/)と呼ばれる行データの書式に従う.  \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+以下の書式のように, 配列はスペースなしのカンマ区切りで, tagとmeasurementの区切り, measurementとtimestampの区切りにはスペースをいれる.  \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+measurementが値部分となっていて, こちらもtagと同様カンマ区切りで複数のtag付のmeasurementを持てる.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+metrix,\u0026#x26;lt;tag_key\u0026#x26;gt;=\u0026#x26;lt;tag_value\u0026#x26;gt;,\u0026#x26;lt;tag_key\u0026#x26;gt;=\u0026#x26;lt;tag_value\u0026#x26;gt; \u0026#x26;lt;measurement\u0026#x26;gt;=\u0026#x26;lt;value\u0026#x26;gt; \u0026#x26;lt;timestamp\u0026#x26;gt;\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+Measurementにはinteger, floatの他にstring, booleanも扱える.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+補間については, `fill()`を用いてnull, 指定値, 線形補間, 前データ値が利用できる.[^2]\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+[blog](https://www.influxdata.com/blog/influxdb-markedly-outperforms-opentsdb-in-time-series-data-metrics-benchmark/) によるとwrite performanceがOpenTSDBの9倍.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+## まとめ\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+結論としては補間が必要なデータストアにはInfluxDB一択だと思う.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+|   DB   | 書き込み |  データ量 |  補間 | ローカル |\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+|:------:|:--------:|:---------:|:-----:|:--------:|\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+|OpenTSDB|  ○       |  ◎        |   ○   | Docker   |\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+|InfluxDB|  ◎       |  ○        |   ○   | Docker   |\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+|Prometheus| -      |  x        |   -   | Docker   |\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+## ref\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+[^1]: [slideshare](https://www.slideshare.net/HBaseCon/operations-session-3-49043534?qid=5547eada-f70d-4730-bacb-6aeb6f37c068\u0026#x26;v=\u0026#x26;b=\u0026#x26;from_search=5)\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+[^2]: [document](https://docs.influxdata.com/influxdb/v1.3/query_language/data_exploration/#advanced-group-by-time-syntax)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e"}],"publishedAt":"2018-11-11","updatedAt":"2021-01-30"}},"__N_SSG":true},"page":"/archives/[slug]","query":{"slug":"2018-11-11-influxdb"},"buildId":"Xu1zwATJm2jOsh2Qe7l0N","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>