<!DOCTYPE html><html lang="en"><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><meta name="theme-color" content="#ddd4bb"/><meta property="og:type" content="website"/><meta property="og:url" content="https://koka831.github.io"/><meta property="og:site_name" content="/var/log/koka"/><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="/var/log/koka"/><meta name="twitter:site" content="@k_0ka"/><meta name="twitter:description" content="cat /var/log/koka &gt; /dev/null"/><link rel="alternate" type="application/rss+xml" href="https://koka831.github.io/feed.xml" title="/var/log/koka RSS2.0"/><title>Internal Vue.js 1 | /var/log/koka</title><meta property="title" content="Internal Vue.js 1 | /var/log/koka"/><meta property="og:title" content="Internal Vue.js 1 | /var/log/koka"/><meta property="twitter:title" content="Internal Vue.js 1 | /var/log/koka"/><meta property="description" content="internal Vue.js &amp; read how Vue compiler works"/><meta property="og:description" content="internal Vue.js &amp; read how Vue compiler works"/><meta property="twitter:description" content="internal Vue.js &amp; read how Vue compiler works"/><meta property="og:image" content="https://koka831.github.io/img/icon.png"/><meta name="next-head-count" content="19"/><link rel="preload" href="/_next/static/css/fec7387515ee4d96.css" as="style"/><link rel="stylesheet" href="/_next/static/css/fec7387515ee4d96.css" data-n-g=""/><link rel="preload" href="/_next/static/css/9a908afc1d99510a.css" as="style"/><link rel="stylesheet" href="/_next/static/css/9a908afc1d99510a.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-9b312e20a4e32339.js" defer=""></script><script src="/_next/static/chunks/framework-91d7f78b5b4003c8.js" defer=""></script><script src="/_next/static/chunks/main-101cfeaa18eb0e64.js" defer=""></script><script src="/_next/static/chunks/pages/_app-e0fcf5a3a528e4c5.js" defer=""></script><script src="/_next/static/chunks/cb1608f2-47ca080ef71602cd.js" defer=""></script><script src="/_next/static/chunks/956-02f4c2cb2ec13065.js" defer=""></script><script src="/_next/static/chunks/291-9c5c86f482a4e495.js" defer=""></script><script src="/_next/static/chunks/pages/archives/%5Bslug%5D-c119bff926c7db42.js" defer=""></script><script src="/_next/static/iEZvi0eyRNxzrGJJ8jEB8/_buildManifest.js" defer=""></script><script src="/_next/static/iEZvi0eyRNxzrGJJ8jEB8/_ssgManifest.js" defer=""></script><script src="/_next/static/iEZvi0eyRNxzrGJJ8jEB8/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><nav class="Header_navigation__container__Xjar7"><div class="Header_navigation__qZpeO"><a href="/">/var/log/koka</a></div><div><a href="/archives">archive</a></div></nav><main class="Layout_container__LBFOo"><div class="slug_container__f_fjw"><div class="slug_main__WMOpC"><article class="slug_article__cOl2p" role="article"><div itemscope="" class="ArticleHeader_header__container__5Gs_X"><a class="ArticleHeader_post__title__gVFje" href="/archives/2019-07-15-internal-vue">Internal Vue.js 1</a><p>internal Vue.js &amp; read how Vue compiler works</p><div class="ArticleHeader_flex__yDiMS"><div class="ArticleHeader_post__tags__uCQyx"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="tags" class="svg-inline--fa fa-tags fa-w-20 ArticleHeader_tags__icon__U9c_O" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path fill="currentColor" d="M497.941 225.941L286.059 14.059A48 48 0 0 0 252.118 0H48C21.49 0 0 21.49 0 48v204.118a48 48 0 0 0 14.059 33.941l211.882 211.882c18.744 18.745 49.136 18.746 67.882 0l204.118-204.118c18.745-18.745 18.745-49.137 0-67.882zM112 160c-26.51 0-48-21.49-48-48s21.49-48 48-48 48 21.49 48 48-21.49 48-48 48zm513.941 133.823L421.823 497.941c-18.745 18.745-49.137 18.745-67.882 0l-.36-.36L527.64 323.522c16.999-16.999 26.36-39.6 26.36-63.64s-9.362-46.641-26.36-63.64L331.397 0h48.721a48 48 0 0 1 33.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882z"></path></svg><p class="Tag_tag__rl8WL">Vue</p><p class="Tag_tag__rl8WL">Virtual DOM</p></div><div class="ArticleHeader_post__dates__6uEwt"><time dateTime="2019-07-15" itemProp="datePublished" class="PublishDate_post__date__jhH_w">published: <!-- -->2019-07-15</time><time dateTime="2021-01-30" itemProp="datePublished" class="PublishDate_post__date__jhH_w">updated: 2021-01-30</time></div></div></div><div class="slug_article__body__m2pRS"><p><a href="https://github.com/vuejs/vue" target="_blank" rel="nofollow noopener noreferrer">Vue.js</a>のreactive systemがどのように実装されているか追ってみた.
初回はコンパイラの挙動を確認.</p>
<ul>
<li>Vuejs v2.6.10</li>
</ul>
<h2 id="srccompilerindexjs"><a href="#srccompilerindexjs">src/compiler/index.js</a></h2>
<p>compilerのentrypointとなるのが<code>src/compiler/index.js</code>.<br>
(Vue.jsは<a href="https://flow.org" target="_blank" rel="nofollow noopener noreferrer">flow</a>を用いてtype checkを行っている. compiler周りの型は<code>flow/compiler.js</code>に記載.)</p>
<p><code>parse(template, options)</code>でASTを生成し，<code>generate(ast, options)</code>でcodeを生成する.<br>
Virtual DOMのpatch/mergeを効率よく行うため，返り値の<code>CompiledResult</code>に<code>code</code>だけでなくASTを持たせている.</p>
<p><code>staticRenderFns</code>についてはparser部分で説明する.</p>
<div class="remark-highlight"><pre class="language-js"><code class="language-js"><span class="token comment">// `createCompilerCreator` allows creating compilers that use alternative</span>
<span class="token comment">// parser/optimizer/codegen, e.g the SSR optimizing compiler.</span>
<span class="token comment">// Here we just export a default compiler using the default parts.</span>
<span class="token keyword module">export</span> <span class="token keyword">const</span> createCompiler <span class="token operator">=</span> <span class="token function">createCompilerCreator</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">baseCompile</span> <span class="token punctuation">(</span>
  <span class="token parameter">template<span class="token operator">:</span> string<span class="token punctuation">,</span>
  options<span class="token operator">:</span> <span class="token maybe-class-name">CompilerOptions</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">CompiledResult</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>template<span class="token punctuation">.</span><span class="token method function property-access">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span><span class="token property-access">optimize</span> <span class="token operator">!==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">optimize</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token function">generate</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
    ast<span class="token punctuation">,</span>
    render<span class="token operator">:</span> code<span class="token punctuation">.</span><span class="token property-access">render</span><span class="token punctuation">,</span>
    staticRenderFns<span class="token operator">:</span> code<span class="token punctuation">.</span><span class="token property-access">staticRenderFns</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div>
<h2 id="srccompilerparserindexjs"><a href="#srccompilerparserindexjs">src/compiler/parser/index.js</a></h2>
<p><code>.vue</code>ファイルからASTを生成する部分. <code>parse</code>関数内部で関数定義してて長いので，重要なところだけピックアップする.<br>
VueのテンプレートはHTMLのDOMをベースにしていて，特に</p>
<ul>
<li>Mustache</li>
<li>Directive
の2点を拡張記法としてもっている．</li>
</ul>
<p>そのためパース自体は<code>html-parse</code>を用いており，<code>parse</code>の主な仕事はHTML DOMのASTを返すのとパース時のエラー出力となっている．</p>
<div class="remark-highlight"><pre class="language-js"><code class="language-js"><span class="token doc-comment comment">/**</span>
<span class="token doc-comment comment"> * Convert HTML string to AST.</span>
<span class="token doc-comment comment"> */</span>
<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">parse</span> <span class="token punctuation">(</span>
  <span class="token parameter">template<span class="token operator">:</span> string<span class="token punctuation">,</span>
  options<span class="token operator">:</span> <span class="token maybe-class-name">CompilerOptions</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">ASTElement</span> <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  warn <span class="token operator">=</span> options<span class="token punctuation">.</span><span class="token property-access">warn</span> <span class="token operator">||</span> baseWarn
  <span class="token comment">/* omit */</span>

  <span class="token function">parseHTML</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token comment">/* omit */</span><span class="token punctuation">,</span>
    <span class="token function">start</span> <span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> unary<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* omit */</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword control-flow">return</span> root <span class="token comment">// ASTのroot Node</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>関係ないけど階段状にインポートしてるの好き.</p>
<div class="remark-highlight"><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>
  addProp<span class="token punctuation">,</span>
  addAttr<span class="token punctuation">,</span>
  baseWarn<span class="token punctuation">,</span>
  addHandler<span class="token punctuation">,</span>
  addDirective<span class="token punctuation">,</span>
  getBindingAttr<span class="token punctuation">,</span>
  getAndRemoveAttr<span class="token punctuation">,</span>
  getRawBindingAttr<span class="token punctuation">,</span>
  pluckModuleFunction<span class="token punctuation">,</span>
  getAndRemoveAttrByRegex
<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'../helpers'</span>
</code></pre></div>
<h2 id="abstract-syntax-tree"><a href="#abstract-syntax-tree">Abstract Syntax Tree</a></h2>
<p><code>generate</code>が受け取る<code>ast</code>の型<code>ASTElement</code>は<code>flow/compiler.js</code>に定義されている．<br>
ASTは以下の3種類に分類され，<code>ASTNode</code>がそれぞれの<code>type</code>を元に判別している．</p>
<ul>
<li><code>ASTElement</code>: type: 1</li>
<li><code>ASTText</code>: type: 2</li>
<li><code>ASTExpression</code>: type: 3</li>
</ul>
<p><code>type ASTNode = ASTElement | ASTText | ASTExpression</code></p>
<p><code>ASTElement</code>を例にとると以下のようになっている．</p>
<div class="remark-highlight"><pre class="language-js"><code class="language-js">declare type <span class="token maybe-class-name">ASTElement</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
  tag<span class="token operator">:</span> string<span class="token punctuation">;</span>
  attrsList<span class="token operator">:</span> <span class="token known-class-name class-name">Array</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">ASTAttr</span><span class="token operator">></span><span class="token punctuation">;</span>
  attrsMap<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>key<span class="token operator">:</span> string<span class="token punctuation">]</span><span class="token operator">:</span> any <span class="token punctuation">}</span><span class="token punctuation">;</span>
  rawAttrsMap<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>key<span class="token operator">:</span> string<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token maybe-class-name">ASTAttr</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  parent<span class="token operator">:</span> <span class="token maybe-class-name">ASTElement</span> <span class="token operator">|</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  children<span class="token operator">:</span> <span class="token known-class-name class-name">Array</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">ASTNode</span><span class="token operator">></span><span class="token punctuation">;</span>

  <span class="token comment">/* omit */</span>
  staticRoot<span class="token operator">?</span><span class="token operator">:</span> boolean<span class="token punctuation">;</span>
  text<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">;</span>
  component<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">;</span>
  <span class="token keyword control-flow">if</span><span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">;</span>
  <span class="token keyword control-flow">for</span><span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">;</span>
  transition<span class="token operator">?</span><span class="token operator">:</span> string <span class="token operator">|</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

  <span class="token comment">/* omit */</span>

  model<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    value<span class="token operator">:</span> string<span class="token punctuation">;</span>
    callback<span class="token operator">:</span> string<span class="token punctuation">;</span>
    expression<span class="token operator">:</span> string<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>ASTの構造は<code>ASTElement</code>がrootとなり，branchに<code>ASTNode</code>を再帰的に持つ構造になる.
<code>staticRoot?</code>や<code>component?</code>等のパラメータは，その<code>ASTNode</code>以下が<code>static</code>であるか<code>dynamic</code>であるか，等レンダリングの最適化の際に参照される．
この最適化機構は<code>src/compiler/optimizer.js</code>の<code>markStatic</code>及び<code>markStaticRoot</code>が担う.</p>
<h2 id="srccompilercodegenindexjs"><a href="#srccompilercodegenindexjs">src/compiler/codegen/index.js</a></h2>
<p><code>generate</code>はASTから<code>render</code>と<code>staticRenderFns</code>の２つを生成する．<br>
<code>render</code>がVueのDynamic Renderingを担当し，<code>staticRenderFns</code>は静的な(変更のない)DOMを生成する.</p>
<div class="remark-highlight"><pre class="language-js"><code class="language-js"><span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">generate</span> <span class="token punctuation">(</span>
  <span class="token parameter">ast<span class="token operator">:</span> <span class="token maybe-class-name">ASTElement</span> <span class="token operator">|</span> <span class="token keyword">void</span><span class="token punctuation">,</span>
  options<span class="token operator">:</span> <span class="token maybe-class-name">CompilerOptions</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">CodegenResult</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CodegenState</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
  <span class="token keyword">const</span> code <span class="token operator">=</span> ast <span class="token operator">?</span> <span class="token function">genElement</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> state<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">'_c("div")'</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
    render<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">with(this){return </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">}</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    staticRenderFns<span class="token operator">:</span> state<span class="token punctuation">.</span><span class="token property-access">staticRenderFns</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p><code>genElement</code>は<code>ASTElement</code>の<code>staticRoot?</code>や<code>for?</code>等を確認し，それぞれのディレクティブ・タグに対応する<code>Element</code>, <code>Component</code>を生成する.
各々の生成は<code>genStatic</code>, <code>genIf</code>のようにそれぞれのジェネレータで行う．
各々のジェネレータは受け取ったASTを処理した後に再帰的に<code>genElement</code>を呼び出す．<br>
最終的に<code>genElement</code>は最小単位である<code>Element</code>の生成を行う．<br>
<code>Element</code>は<code>&#x3C;tag data>children&#x3C;/tag></code>からなるDOMである．</p>
<p>以下がその生成部分.</p>
<div class="remark-highlight"><pre class="language-js"><code class="language-js">data <span class="token operator">=</span> <span class="token function">genData</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span>
<span class="token comment">/* omit */</span>
<span class="token keyword">const</span> children <span class="token operator">=</span> el<span class="token punctuation">.</span><span class="token property-access">inlineTemplate</span> <span class="token operator">?</span> <span class="token keyword null nil">null</span> <span class="token operator">:</span> <span class="token function">genChildren</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
code <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_c('</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>el<span class="token punctuation">.</span><span class="token property-access">tag</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
  data <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">,</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token string">''</span> <span class="token comment">// data</span>
<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
  children <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">,</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>children<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token string">''</span> <span class="token comment">// children</span>
<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span>
</code></pre></div>
<p><code>Element</code>のdata部分は<code>genData</code>が担当する. data部分に含まれるのは<code>class</code>, <code>directive</code>, <code>model</code>.</p>
<div class="remark-highlight"><pre class="language-js"><code class="language-js"><span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">genData</span> <span class="token punctuation">(</span><span class="token parameter">el<span class="token operator">:</span> <span class="token maybe-class-name">ASTElement</span><span class="token punctuation">,</span> state<span class="token operator">:</span> <span class="token maybe-class-name">CodegenState</span></span><span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token punctuation">{</span>
  <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token string">'{'</span>

  <span class="token comment">// directives first.</span>
  <span class="token comment">// directives may mutate the el's other properties before they are generated.</span>
  <span class="token keyword">const</span> dirs <span class="token operator">=</span> <span class="token function">genDirectives</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>dirs<span class="token punctuation">)</span> data <span class="token operator">+=</span> dirs <span class="token operator">+</span> <span class="token string">','</span>

  <span class="token comment">/* omit */</span>
  <span class="token comment">// component v-model</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span><span class="token property-access">model</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    data <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">model:{value:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
      el<span class="token punctuation">.</span><span class="token property-access">model</span><span class="token punctuation">.</span><span class="token property-access">value</span>
    <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,callback:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
      el<span class="token punctuation">.</span><span class="token property-access">model</span><span class="token punctuation">.</span><span class="token property-access">callback</span>
    <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,expression:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
      el<span class="token punctuation">.</span><span class="token property-access">model</span><span class="token punctuation">.</span><span class="token property-access">expression</span>
    <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">},</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span>
  <span class="token comment">/* omit */</span>
  <span class="token keyword control-flow">return</span> data
<span class="token punctuation">}</span>
</code></pre></div>
<p>最終的に<code>CompiledResult</code>が生成される.</p>
<div class="remark-highlight"><pre class="language-js"><code class="language-js">declare type <span class="token maybe-class-name">CompiledResult</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  ast<span class="token operator">:</span> <span class="token operator">?</span><span class="token maybe-class-name">ASTElement</span><span class="token punctuation">;</span>
  render<span class="token operator">:</span> string<span class="token punctuation">;</span>
  staticRenderFns<span class="token operator">:</span> <span class="token known-class-name class-name">Array</span><span class="token operator">&#x3C;</span>string<span class="token operator">></span><span class="token punctuation">;</span>
  stringRenderFns<span class="token operator">?</span><span class="token operator">:</span> <span class="token known-class-name class-name">Array</span><span class="token operator">&#x3C;</span>string<span class="token operator">></span><span class="token punctuation">;</span>
  errors<span class="token operator">?</span><span class="token operator">:</span> <span class="token known-class-name class-name">Array</span><span class="token operator">&#x3C;</span>string <span class="token operator">|</span> <span class="token maybe-class-name">WarningMessage</span><span class="token operator">></span><span class="token punctuation">;</span>
  tips<span class="token operator">?</span><span class="token operator">:</span> <span class="token known-class-name class-name">Array</span><span class="token operator">&#x3C;</span>string <span class="token operator">|</span> <span class="token maybe-class-name">WarningMessage</span><span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div>
<h2 id="summary"><a href="#summary">Summary</a></h2>
<ul>
<li>Vueのコンパイラは<code>parser</code>と<code>generator</code>からなる.</li>
<li><code>parser</code>は<code>html-parse</code>を元にASTを生成する.</li>
<li><code>generator</code>はASTを元に動的部分と静的部分の<code>render</code>群を生成する</li>
</ul>
<h2 id="next"><a href="#next">Next</a></h2>
<p>次回は<code>src/core/observer</code>を読む.<br>
(名前からVueのreactive systemがObserver patternベースなんだろうな)</p>
<ul>
<li><a href="/2019/08/08/internal-vue-2/">次回</a></li>
</ul></div></article><div class="CommitLogs_commit_logs__W6xPi" role="log"><h2>Commits</h2><details><summary><span class="CommitLogs_commit__date___q8bm">2021-01-30 22:18:17</span><span class="CommitLogs_commit__hash__Xyu7v">35b550ae</span><span class="CommitLogs_commit__message__IGUPv">copy md</span></summary><div><div class="remark-highlight"><pre data-file="35b550ae.patch" class="language-git  language-diff"><code class="language-git"><span class="token commit-sha1">commit 35b550ae83af4efaeadf33471c8ca8a32c1079c8</span>
Author: koka &#x26;<a href="mailto:lt;koka.code@gmail.com" class="token email-link">lt;koka.code@gmail.com</a>&#x26;gt;
Date:   Sat Jan 30 22:18:17 2021 +0900

  copy md

diff --git a/_posts/2019-07-15-internal-vue.md b/_posts/2019-07-15-internal-vue.md
new file mode 100644
index 0000000..b460b95
<span class="token deleted">--- /dev/null</span>
<span class="token inserted">+++ b/_posts/2019-07-15-internal-vue.md</span>
<span class="token coord">@@ -0,0 +1,228 @@</span>
<span class="token inserted">+---</span>
<span class="token inserted">+title: 'Internal Vue.js 1'</span>
<span class="token inserted">+date: 2019-07-15</span>
<span class="token inserted">+categories:</span>
<span class="token inserted">+- Code Reading</span>
<span class="token inserted">+tags:</span>
<span class="token inserted">+- Vue</span>
<span class="token inserted">+- Virtual DOM</span>
<span class="token inserted">+description: internal Vue.js &#x26; read how Vue compiler works</span>
<span class="token inserted">+---</span>
<span class="token inserted">+</span>
<span class="token inserted">+[Vue.js](https://github.com/vuejs/vue)のreactive systemがどのように実装されているか追ってみた.</span>
<span class="token inserted">+初回はコンパイラの挙動を確認.</span>
<span class="token inserted">+</span>
<span class="token inserted">+- Vuejs v2.6.10</span>
<span class="token inserted">+</span>
<span class="token inserted">+</span>
<span class="token inserted">+## src/compiler/index.js</span>
<span class="token inserted">+compilerのentrypointとなるのが`src/compiler/index.js`.  </span>
<span class="token inserted">+(Vue.jsは[flow](https://flow.org)を用いてtype checkを行っている. compiler周りの型は`flow/compiler.js`に記載.)</span>
<span class="token inserted">+</span>
<span class="token inserted">+`parse(template, options)`でASTを生成し，`generate(ast, options)`でcodeを生成する.  </span>
<span class="token inserted">+Virtual DOMのpatch/mergeを効率よく行うため，返り値の`CompiledResult`に`code`だけでなくASTを持たせている.</span>
<span class="token inserted">+</span>
<span class="token inserted">+`staticRenderFns`についてはparser部分で説明する.</span>
<span class="token inserted">+</span>
<span class="token inserted">+\```js</span>
<span class="token inserted">+// `createCompilerCreator` allows creating compilers that use alternative</span>
<span class="token inserted">+// parser/optimizer/codegen, e.g the SSR optimizing compiler.</span>
<span class="token inserted">+// Here we just export a default compiler using the default parts.</span>
<span class="token inserted">+export const createCompiler = createCompilerCreator(function baseCompile (</span>
<span class="token inserted">+  template: string,</span>
<span class="token inserted">+  options: CompilerOptions</span>
<span class="token inserted">+): CompiledResult {</span>
<span class="token inserted">+  const ast = parse(template.trim(), options)</span>
<span class="token inserted">+  if (options.optimize !== false) {</span>
<span class="token inserted">+    optimize(ast, options)</span>
<span class="token inserted">+  }</span>
<span class="token inserted">+  const code = generate(ast, options)</span>
<span class="token inserted">+  return {</span>
<span class="token inserted">+    ast,</span>
<span class="token inserted">+    render: code.render,</span>
<span class="token inserted">+    staticRenderFns: code.staticRenderFns</span>
<span class="token inserted">+  }</span>
<span class="token inserted">+})</span>
<span class="token inserted">+\```</span>
<span class="token inserted">+</span>
<span class="token inserted">+## src/compiler/parser/index.js</span>
<span class="token inserted">+`.vue`ファイルからASTを生成する部分. `parse`関数内部で関数定義してて長いので，重要なところだけピックアップする.  </span>
<span class="token inserted">+VueのテンプレートはHTMLのDOMをベースにしていて，特に</span>
<span class="token inserted">+- Mustache</span>
<span class="token inserted">+- Directive</span>
<span class="token inserted">+の2点を拡張記法としてもっている．</span>
<span class="token inserted">+</span>
<span class="token inserted">+そのためパース自体は`html-parse`を用いており，`parse`の主な仕事はHTML DOMのASTを返すのとパース時のエラー出力となっている．</span>
<span class="token inserted">+</span>
<span class="token inserted">+</span>
<span class="token inserted">+\```js</span>
<span class="token inserted">+/**</span>
<span class="token inserted">+ * Convert HTML string to AST.</span>
<span class="token inserted">+ */</span>
<span class="token inserted">+export function parse (</span>
<span class="token inserted">+  template: string,</span>
<span class="token inserted">+  options: CompilerOptions</span>
<span class="token inserted">+): ASTElement | void {</span>
<span class="token inserted">+  warn = options.warn || baseWarn</span>
<span class="token inserted">+  /* omit */</span>
<span class="token inserted">+</span>
<span class="token inserted">+  parseHTML(template, {</span>
<span class="token inserted">+    /* omit */,</span>
<span class="token inserted">+    start (tag, attrs, unary, start, end) { /* omit */ },</span>
<span class="token inserted">+  })</span>
<span class="token inserted">+  return root // ASTのroot Node</span>
<span class="token inserted">+}</span>
<span class="token inserted">+\```</span>
<span class="token inserted">+</span>
<span class="token inserted">+</span>
<span class="token inserted">+関係ないけど階段状にインポートしてるの好き.</span>
<span class="token inserted">+</span>
<span class="token inserted">+\```js</span>
<span class="token inserted">+import {</span>
<span class="token inserted">+  addProp,</span>
<span class="token inserted">+  addAttr,</span>
<span class="token inserted">+  baseWarn,</span>
<span class="token inserted">+  addHandler,</span>
<span class="token inserted">+  addDirective,</span>
<span class="token inserted">+  getBindingAttr,</span>
<span class="token inserted">+  getAndRemoveAttr,</span>
<span class="token inserted">+  getRawBindingAttr,</span>
<span class="token inserted">+  pluckModuleFunction,</span>
<span class="token inserted">+  getAndRemoveAttrByRegex</span>
<span class="token inserted">+} from '../helpers'</span>
<span class="token inserted">+\```</span>
<span class="token inserted">+</span>
<span class="token inserted">+## Abstract Syntax Tree</span>
<span class="token inserted">+`generate`が受け取る`ast`の型`ASTElement`は`flow/compiler.js`に定義されている．  </span>
<span class="token inserted">+ASTは以下の3種類に分類され，`ASTNode`がそれぞれの`type`を元に判別している．</span>
<span class="token inserted">+- `ASTElement`: type: 1</span>
<span class="token inserted">+- `ASTText`: type: 2</span>
<span class="token inserted">+- `ASTExpression`: type: 3</span>
<span class="token inserted">+</span>
<span class="token inserted">+`type ASTNode = ASTElement | ASTText | ASTExpression`</span>
<span class="token inserted">+</span>
<span class="token inserted">+`ASTElement`を例にとると以下のようになっている．</span>
<span class="token inserted">+</span>
<span class="token inserted">+\```js</span>
<span class="token inserted">+declare type ASTElement = {</span>
<span class="token inserted">+  type: 1;</span>
<span class="token inserted">+  tag: string;</span>
<span class="token inserted">+  attrsList: Array&#x26;lt;ASTAttr&#x26;gt;;</span>
<span class="token inserted">+  attrsMap: { [key: string]: any };</span>
<span class="token inserted">+  rawAttrsMap: { [key: string]: ASTAttr };</span>
<span class="token inserted">+  parent: ASTElement | void;</span>
<span class="token inserted">+  children: Array&#x26;lt;ASTNode&#x26;gt;;</span>
<span class="token inserted">+</span>
<span class="token inserted">+  /* omit */</span>
<span class="token inserted">+  staticRoot?: boolean;</span>
<span class="token inserted">+  text?: string;</span>
<span class="token inserted">+  component?: string;</span>
<span class="token inserted">+  if?: string;</span>
<span class="token inserted">+  for?: string;</span>
<span class="token inserted">+  transition?: string | true;</span>
<span class="token inserted">+</span>
<span class="token inserted">+  /* omit */</span>
<span class="token inserted">+</span>
<span class="token inserted">+  model?: {</span>
<span class="token inserted">+    value: string;</span>
<span class="token inserted">+    callback: string;</span>
<span class="token inserted">+    expression: string;</span>
<span class="token inserted">+  };</span>
<span class="token inserted">+}</span>
<span class="token inserted">+\```</span>
<span class="token inserted">+</span>
<span class="token inserted">+ASTの構造は`ASTElement`がrootとなり，branchに`ASTNode`を再帰的に持つ構造になる.</span>
<span class="token inserted">+`staticRoot?`や`component?`等のパラメータは，その`ASTNode`以下が`static`であるか`dynamic`であるか，等レンダリングの最適化の際に参照される．</span>
<span class="token inserted">+この最適化機構は`src/compiler/optimizer.js`の`markStatic`及び`markStaticRoot`が担う.</span>
<span class="token inserted">+</span>
<span class="token inserted">+</span>
<span class="token inserted">+## src/compiler/codegen/index.js</span>
<span class="token inserted">+</span>
<span class="token inserted">+`generate`はASTから`render`と`staticRenderFns`の２つを生成する．  </span>
<span class="token inserted">+`render`がVueのDynamic Renderingを担当し，`staticRenderFns`は静的な(変更のない)DOMを生成する.</span>
<span class="token inserted">+</span>
<span class="token inserted">+</span>
<span class="token inserted">+\```js</span>
<span class="token inserted">+export function generate (</span>
<span class="token inserted">+  ast: ASTElement | void,</span>
<span class="token inserted">+  options: CompilerOptions</span>
<span class="token inserted">+): CodegenResult {</span>
<span class="token inserted">+  const state = new CodegenState(options)</span>
<span class="token inserted">+  const code = ast ? genElement(ast, state) : '_c("div")'</span>
<span class="token inserted">+  return {</span>
<span class="token inserted">+    render: `with(this){return ${code}}`,</span>
<span class="token inserted">+    staticRenderFns: state.staticRenderFns</span>
<span class="token inserted">+  }</span>
<span class="token inserted">+}</span>
<span class="token inserted">+\```</span>
<span class="token inserted">+</span>
<span class="token inserted">+`genElement`は`ASTElement`の`staticRoot?`や`for?`等を確認し，それぞれのディレクティブ・タグに対応する`Element`, `Component`を生成する.</span>
<span class="token inserted">+各々の生成は`genStatic`, `genIf`のようにそれぞれのジェネレータで行う．</span>
<span class="token inserted">+各々のジェネレータは受け取ったASTを処理した後に再帰的に`genElement`を呼び出す．  </span>
<span class="token inserted">+最終的に`genElement`は最小単位である`Element`の生成を行う．  </span>
<span class="token inserted">+`Element`は`&#x26;lt;tag data&#x26;gt;children&#x26;lt;/tag&#x26;gt;`からなるDOMである．</span>
<span class="token inserted">+</span>
<span class="token inserted">+以下がその生成部分.</span>
<span class="token inserted">+\```js</span>
<span class="token inserted">+data = genData(el, state)</span>
<span class="token inserted">+/* omit */</span>
<span class="token inserted">+const children = el.inlineTemplate ? null : genChildren(el, state, true)</span>
<span class="token inserted">+code = `_c('${el.tag}'${</span>
<span class="token inserted">+  data ? `,${data}` : '' // data</span>
<span class="token inserted">+}${</span>
<span class="token inserted">+  children ? `,${children}` : '' // children</span>
<span class="token inserted">+})`</span>
<span class="token inserted">+\```</span>
<span class="token inserted">+</span>
<span class="token inserted">+`Element`のdata部分は`genData`が担当する. data部分に含まれるのは`class`, `directive`, `model`.</span>
<span class="token inserted">+</span>
<span class="token inserted">+</span>
<span class="token inserted">+\```js</span>
<span class="token inserted">+export function genData (el: ASTElement, state: CodegenState): string {</span>
<span class="token inserted">+  let data = '{'</span>
<span class="token inserted">+</span>
<span class="token inserted">+  // directives first.</span>
<span class="token inserted">+  // directives may mutate the el's other properties before they are generated.</span>
<span class="token inserted">+  const dirs = genDirectives(el, state)</span>
<span class="token inserted">+  if (dirs) data += dirs + ','</span>
<span class="token inserted">+</span>
<span class="token inserted">+  /* omit */</span>
<span class="token inserted">+  // component v-model</span>
<span class="token inserted">+  if (el.model) {</span>
<span class="token inserted">+    data += `model:{value:${</span>
<span class="token inserted">+      el.model.value</span>
<span class="token inserted">+    },callback:${</span>
<span class="token inserted">+      el.model.callback</span>
<span class="token inserted">+    },expression:${</span>
<span class="token inserted">+      el.model.expression</span>
<span class="token inserted">+    }},`</span>
<span class="token inserted">+  }</span>
<span class="token inserted">+  /* omit */</span>
<span class="token inserted">+  return data</span>
<span class="token inserted">+}</span>
<span class="token inserted">+\```</span>
<span class="token inserted">+</span>
<span class="token inserted">+最終的に`CompiledResult`が生成される.</span>
<span class="token inserted">+</span>
<span class="token inserted">+\```js</span>
<span class="token inserted">+declare type CompiledResult = {</span>
<span class="token inserted">+  ast: ?ASTElement;</span>
<span class="token inserted">+  render: string;</span>
<span class="token inserted">+  staticRenderFns: Array&#x26;lt;string&#x26;gt;;</span>
<span class="token inserted">+  stringRenderFns?: Array&#x26;lt;string&#x26;gt;;</span>
<span class="token inserted">+  errors?: Array&#x26;lt;string | WarningMessage&#x26;gt;;</span>
<span class="token inserted">+  tips?: Array&#x26;lt;string | WarningMessage&#x26;gt;;</span>
<span class="token inserted">+};</span>
<span class="token inserted">+\```</span>
<span class="token inserted">+</span>
<span class="token inserted">+## Summary</span>
<span class="token inserted">+- Vueのコンパイラは`parser`と`generator`からなる.</span>
<span class="token inserted">+- `parser`は`html-parse`を元にASTを生成する.</span>
<span class="token inserted">+- `generator`はASTを元に動的部分と静的部分の`render`群を生成する</span>
<span class="token inserted">+</span>
<span class="token inserted">+</span>
<span class="token inserted">+## Next</span>
<span class="token inserted">+次回は`src/core/observer`を読む.  </span>
<span class="token inserted">+(名前からVueのreactive systemがObserver patternベースなんだろうな)</span>
<span class="token inserted">+</span>
<span class="token inserted">+- [次回](/2019/08/08/internal-vue-2/)</span>
</code></pre></div></div></details></div><div class="Comments_comment__WxfzD" role="comment"><h2 class="Comments_title__YENiL">Comments</h2><div id="github-comment-container"></div></div></div><aside class="slug_aside__gL3UH"><nav class="Toc_toc__nav__rl0h7" role="navigation"><ul class="Toc_toc__Y4dWA"></ul></nav></aside></div></main><footer class="Footer_footer__FDcZZ"><small>Code snippets licensed under MIT, unless otherwise noted.</small></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"slug":"2019-07-15-internal-vue","title":"Internal Vue.js 1","categories":["Code Reading"],"image":"https://koka831.github.io/img/icon.png","tags":["Vue","Virtual DOM"],"content":"\u003cp\u003e\u003ca href=\"https://github.com/vuejs/vue\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eVue.js\u003c/a\u003eのreactive systemがどのように実装されているか追ってみた.\n初回はコンパイラの挙動を確認.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eVuejs v2.6.10\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"srccompilerindexjs\"\u003e\u003ca href=\"#srccompilerindexjs\"\u003esrc/compiler/index.js\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003ecompilerのentrypointとなるのが\u003ccode\u003esrc/compiler/index.js\u003c/code\u003e.\u003cbr\u003e\n(Vue.jsは\u003ca href=\"https://flow.org\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eflow\u003c/a\u003eを用いてtype checkを行っている. compiler周りの型は\u003ccode\u003eflow/compiler.js\u003c/code\u003eに記載.)\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eparse(template, options)\u003c/code\u003eでASTを生成し，\u003ccode\u003egenerate(ast, options)\u003c/code\u003eでcodeを生成する.\u003cbr\u003e\nVirtual DOMのpatch/mergeを効率よく行うため，返り値の\u003ccode\u003eCompiledResult\u003c/code\u003eに\u003ccode\u003ecode\u003c/code\u003eだけでなくASTを持たせている.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003estaticRenderFns\u003c/code\u003eについてはparser部分で説明する.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-js\"\u003e\u003ccode class=\"language-js\"\u003e\u003cspan class=\"token comment\"\u003e// `createCompilerCreator` allows creating compilers that use alternative\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// parser/optimizer/codegen, e.g the SSR optimizing compiler.\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// Here we just export a default compiler using the default parts.\u003c/span\u003e\n\u003cspan class=\"token keyword module\"\u003eexport\u003c/span\u003e \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e createCompiler \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003ecreateCompilerCreator\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token function\"\u003ebaseCompile\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n  \u003cspan class=\"token parameter\"\u003etemplate\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e string\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  options\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token maybe-class-name\"\u003eCompilerOptions\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token maybe-class-name\"\u003eCompiledResult\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e ast \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003eparse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003etemplate\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003etrim\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e options\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token keyword control-flow\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eoptions\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003eoptimize\u003c/span\u003e \u003cspan class=\"token operator\"\u003e!==\u003c/span\u003e \u003cspan class=\"token boolean\"\u003efalse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003eoptimize\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003east\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e options\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e code \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003egenerate\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003east\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e options\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token keyword control-flow\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    ast\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    render\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e code\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003erender\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    staticRenderFns\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e code\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003estaticRenderFns\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2 id=\"srccompilerparserindexjs\"\u003e\u003ca href=\"#srccompilerparserindexjs\"\u003esrc/compiler/parser/index.js\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003ccode\u003e.vue\u003c/code\u003eファイルからASTを生成する部分. \u003ccode\u003eparse\u003c/code\u003e関数内部で関数定義してて長いので，重要なところだけピックアップする.\u003cbr\u003e\nVueのテンプレートはHTMLのDOMをベースにしていて，特に\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eMustache\u003c/li\u003e\n\u003cli\u003eDirective\nの2点を拡張記法としてもっている．\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eそのためパース自体は\u003ccode\u003ehtml-parse\u003c/code\u003eを用いており，\u003ccode\u003eparse\u003c/code\u003eの主な仕事はHTML DOMのASTを返すのとパース時のエラー出力となっている．\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-js\"\u003e\u003ccode class=\"language-js\"\u003e\u003cspan class=\"token doc-comment comment\"\u003e/**\u003c/span\u003e\n\u003cspan class=\"token doc-comment comment\"\u003e * Convert HTML string to AST.\u003c/span\u003e\n\u003cspan class=\"token doc-comment comment\"\u003e */\u003c/span\u003e\n\u003cspan class=\"token keyword module\"\u003eexport\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token function\"\u003eparse\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n  \u003cspan class=\"token parameter\"\u003etemplate\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e string\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  options\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token maybe-class-name\"\u003eCompilerOptions\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token maybe-class-name\"\u003eASTElement\u003c/span\u003e \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e \u003cspan class=\"token keyword\"\u003evoid\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  warn \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e options\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003ewarn\u003c/span\u003e \u003cspan class=\"token operator\"\u003e||\u003c/span\u003e baseWarn\n  \u003cspan class=\"token comment\"\u003e/* omit */\u003c/span\u003e\n\n  \u003cspan class=\"token function\"\u003eparseHTML\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003etemplate\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e/* omit */\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003estart\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003etag\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e attrs\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e unary\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e start\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e end\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e \u003cspan class=\"token comment\"\u003e/* omit */\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token keyword control-flow\"\u003ereturn\u003c/span\u003e root \u003cspan class=\"token comment\"\u003e// ASTのroot Node\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e関係ないけど階段状にインポートしてるの好き.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-js\"\u003e\u003ccode class=\"language-js\"\u003e\u003cspan class=\"token keyword module\"\u003eimport\u003c/span\u003e \u003cspan class=\"token imports\"\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  addProp\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  addAttr\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  baseWarn\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  addHandler\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  addDirective\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  getBindingAttr\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  getAndRemoveAttr\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  getRawBindingAttr\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  pluckModuleFunction\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  getAndRemoveAttrByRegex\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token keyword module\"\u003efrom\u003c/span\u003e \u003cspan class=\"token string\"\u003e'../helpers'\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2 id=\"abstract-syntax-tree\"\u003e\u003ca href=\"#abstract-syntax-tree\"\u003eAbstract Syntax Tree\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003ccode\u003egenerate\u003c/code\u003eが受け取る\u003ccode\u003east\u003c/code\u003eの型\u003ccode\u003eASTElement\u003c/code\u003eは\u003ccode\u003eflow/compiler.js\u003c/code\u003eに定義されている．\u003cbr\u003e\nASTは以下の3種類に分類され，\u003ccode\u003eASTNode\u003c/code\u003eがそれぞれの\u003ccode\u003etype\u003c/code\u003eを元に判別している．\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eASTElement\u003c/code\u003e: type: 1\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eASTText\u003c/code\u003e: type: 2\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eASTExpression\u003c/code\u003e: type: 3\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003ccode\u003etype ASTNode = ASTElement | ASTText | ASTExpression\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eASTElement\u003c/code\u003eを例にとると以下のようになっている．\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-js\"\u003e\u003ccode class=\"language-js\"\u003edeclare type \u003cspan class=\"token maybe-class-name\"\u003eASTElement\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  type\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  tag\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e string\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  attrsList\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token known-class-name class-name\"\u003eArray\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token maybe-class-name\"\u003eASTAttr\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  attrsMap\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ekey\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e string\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e any \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  rawAttrsMap\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ekey\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e string\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token maybe-class-name\"\u003eASTAttr\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  parent\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token maybe-class-name\"\u003eASTElement\u003c/span\u003e \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e \u003cspan class=\"token keyword\"\u003evoid\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  children\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token known-class-name class-name\"\u003eArray\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token maybe-class-name\"\u003eASTNode\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n  \u003cspan class=\"token comment\"\u003e/* omit */\u003c/span\u003e\n  staticRoot\u003cspan class=\"token operator\"\u003e?\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e boolean\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  text\u003cspan class=\"token operator\"\u003e?\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e string\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  component\u003cspan class=\"token operator\"\u003e?\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e string\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"token keyword control-flow\"\u003eif\u003c/span\u003e\u003cspan class=\"token operator\"\u003e?\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e string\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"token keyword control-flow\"\u003efor\u003c/span\u003e\u003cspan class=\"token operator\"\u003e?\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e string\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  transition\u003cspan class=\"token operator\"\u003e?\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e string \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n  \u003cspan class=\"token comment\"\u003e/* omit */\u003c/span\u003e\n\n  model\u003cspan class=\"token operator\"\u003e?\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    value\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e string\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    callback\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e string\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    expression\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e string\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eASTの構造は\u003ccode\u003eASTElement\u003c/code\u003eがrootとなり，branchに\u003ccode\u003eASTNode\u003c/code\u003eを再帰的に持つ構造になる.\n\u003ccode\u003estaticRoot?\u003c/code\u003eや\u003ccode\u003ecomponent?\u003c/code\u003e等のパラメータは，その\u003ccode\u003eASTNode\u003c/code\u003e以下が\u003ccode\u003estatic\u003c/code\u003eであるか\u003ccode\u003edynamic\u003c/code\u003eであるか，等レンダリングの最適化の際に参照される．\nこの最適化機構は\u003ccode\u003esrc/compiler/optimizer.js\u003c/code\u003eの\u003ccode\u003emarkStatic\u003c/code\u003e及び\u003ccode\u003emarkStaticRoot\u003c/code\u003eが担う.\u003c/p\u003e\n\u003ch2 id=\"srccompilercodegenindexjs\"\u003e\u003ca href=\"#srccompilercodegenindexjs\"\u003esrc/compiler/codegen/index.js\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003ccode\u003egenerate\u003c/code\u003eはASTから\u003ccode\u003erender\u003c/code\u003eと\u003ccode\u003estaticRenderFns\u003c/code\u003eの２つを生成する．\u003cbr\u003e\n\u003ccode\u003erender\u003c/code\u003eがVueのDynamic Renderingを担当し，\u003ccode\u003estaticRenderFns\u003c/code\u003eは静的な(変更のない)DOMを生成する.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-js\"\u003e\u003ccode class=\"language-js\"\u003e\u003cspan class=\"token keyword module\"\u003eexport\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token function\"\u003egenerate\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n  \u003cspan class=\"token parameter\"\u003east\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token maybe-class-name\"\u003eASTElement\u003c/span\u003e \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e \u003cspan class=\"token keyword\"\u003evoid\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  options\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token maybe-class-name\"\u003eCompilerOptions\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token maybe-class-name\"\u003eCodegenResult\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e state \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eCodegenState\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eoptions\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e code \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e ast \u003cspan class=\"token operator\"\u003e?\u003c/span\u003e \u003cspan class=\"token function\"\u003egenElement\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003east\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e state\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'_c(\"div\")'\u003c/span\u003e\n  \u003cspan class=\"token keyword control-flow\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    render\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token template-string\"\u003e\u003cspan class=\"token template-punctuation string\"\u003e`\u003c/span\u003e\u003cspan class=\"token string\"\u003ewith(this){return \u003c/span\u003e\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token interpolation-punctuation punctuation\"\u003e${\u003c/span\u003ecode\u003cspan class=\"token interpolation-punctuation punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token string\"\u003e}\u003c/span\u003e\u003cspan class=\"token template-punctuation string\"\u003e`\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    staticRenderFns\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e state\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003estaticRenderFns\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003ccode\u003egenElement\u003c/code\u003eは\u003ccode\u003eASTElement\u003c/code\u003eの\u003ccode\u003estaticRoot?\u003c/code\u003eや\u003ccode\u003efor?\u003c/code\u003e等を確認し，それぞれのディレクティブ・タグに対応する\u003ccode\u003eElement\u003c/code\u003e, \u003ccode\u003eComponent\u003c/code\u003eを生成する.\n各々の生成は\u003ccode\u003egenStatic\u003c/code\u003e, \u003ccode\u003egenIf\u003c/code\u003eのようにそれぞれのジェネレータで行う．\n各々のジェネレータは受け取ったASTを処理した後に再帰的に\u003ccode\u003egenElement\u003c/code\u003eを呼び出す．\u003cbr\u003e\n最終的に\u003ccode\u003egenElement\u003c/code\u003eは最小単位である\u003ccode\u003eElement\u003c/code\u003eの生成を行う．\u003cbr\u003e\n\u003ccode\u003eElement\u003c/code\u003eは\u003ccode\u003e\u0026#x3C;tag data\u003echildren\u0026#x3C;/tag\u003e\u003c/code\u003eからなるDOMである．\u003c/p\u003e\n\u003cp\u003e以下がその生成部分.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-js\"\u003e\u003ccode class=\"language-js\"\u003edata \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003egenData\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eel\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e state\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e/* omit */\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e children \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e el\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003einlineTemplate\u003c/span\u003e \u003cspan class=\"token operator\"\u003e?\u003c/span\u003e \u003cspan class=\"token keyword null nil\"\u003enull\u003c/span\u003e \u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token function\"\u003egenChildren\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eel\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e state\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\ncode \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token template-string\"\u003e\u003cspan class=\"token template-punctuation string\"\u003e`\u003c/span\u003e\u003cspan class=\"token string\"\u003e_c('\u003c/span\u003e\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token interpolation-punctuation punctuation\"\u003e${\u003c/span\u003eel\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003etag\u003c/span\u003e\u003cspan class=\"token interpolation-punctuation punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token string\"\u003e'\u003c/span\u003e\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token interpolation-punctuation punctuation\"\u003e${\u003c/span\u003e\n  data \u003cspan class=\"token operator\"\u003e?\u003c/span\u003e \u003cspan class=\"token template-string\"\u003e\u003cspan class=\"token template-punctuation string\"\u003e`\u003c/span\u003e\u003cspan class=\"token string\"\u003e,\u003c/span\u003e\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token interpolation-punctuation punctuation\"\u003e${\u003c/span\u003edata\u003cspan class=\"token interpolation-punctuation punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token template-punctuation string\"\u003e`\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e''\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// data\u003c/span\u003e\n\u003cspan class=\"token interpolation-punctuation punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token interpolation-punctuation punctuation\"\u003e${\u003c/span\u003e\n  children \u003cspan class=\"token operator\"\u003e?\u003c/span\u003e \u003cspan class=\"token template-string\"\u003e\u003cspan class=\"token template-punctuation string\"\u003e`\u003c/span\u003e\u003cspan class=\"token string\"\u003e,\u003c/span\u003e\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token interpolation-punctuation punctuation\"\u003e${\u003c/span\u003echildren\u003cspan class=\"token interpolation-punctuation punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token template-punctuation string\"\u003e`\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e''\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// children\u003c/span\u003e\n\u003cspan class=\"token interpolation-punctuation punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token string\"\u003e)\u003c/span\u003e\u003cspan class=\"token template-punctuation string\"\u003e`\u003c/span\u003e\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003ccode\u003eElement\u003c/code\u003eのdata部分は\u003ccode\u003egenData\u003c/code\u003eが担当する. data部分に含まれるのは\u003ccode\u003eclass\u003c/code\u003e, \u003ccode\u003edirective\u003c/code\u003e, \u003ccode\u003emodel\u003c/code\u003e.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-js\"\u003e\u003ccode class=\"language-js\"\u003e\u003cspan class=\"token keyword module\"\u003eexport\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token function\"\u003egenData\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003eel\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token maybe-class-name\"\u003eASTElement\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e state\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token maybe-class-name\"\u003eCodegenState\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e string \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e data \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e'{'\u003c/span\u003e\n\n  \u003cspan class=\"token comment\"\u003e// directives first.\u003c/span\u003e\n  \u003cspan class=\"token comment\"\u003e// directives may mutate the el's other properties before they are generated.\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e dirs \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003egenDirectives\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eel\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e state\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token keyword control-flow\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003edirs\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e data \u003cspan class=\"token operator\"\u003e+=\u003c/span\u003e dirs \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token string\"\u003e','\u003c/span\u003e\n\n  \u003cspan class=\"token comment\"\u003e/* omit */\u003c/span\u003e\n  \u003cspan class=\"token comment\"\u003e// component v-model\u003c/span\u003e\n  \u003cspan class=\"token keyword control-flow\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eel\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003emodel\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    data \u003cspan class=\"token operator\"\u003e+=\u003c/span\u003e \u003cspan class=\"token template-string\"\u003e\u003cspan class=\"token template-punctuation string\"\u003e`\u003c/span\u003e\u003cspan class=\"token string\"\u003emodel:{value:\u003c/span\u003e\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token interpolation-punctuation punctuation\"\u003e${\u003c/span\u003e\n      el\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003emodel\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003evalue\u003c/span\u003e\n    \u003cspan class=\"token interpolation-punctuation punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token string\"\u003e,callback:\u003c/span\u003e\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token interpolation-punctuation punctuation\"\u003e${\u003c/span\u003e\n      el\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003emodel\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003ecallback\u003c/span\u003e\n    \u003cspan class=\"token interpolation-punctuation punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token string\"\u003e,expression:\u003c/span\u003e\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token interpolation-punctuation punctuation\"\u003e${\u003c/span\u003e\n      el\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003emodel\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003eexpression\u003c/span\u003e\n    \u003cspan class=\"token interpolation-punctuation punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token string\"\u003e},\u003c/span\u003e\u003cspan class=\"token template-punctuation string\"\u003e`\u003c/span\u003e\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token comment\"\u003e/* omit */\u003c/span\u003e\n  \u003cspan class=\"token keyword control-flow\"\u003ereturn\u003c/span\u003e data\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e最終的に\u003ccode\u003eCompiledResult\u003c/code\u003eが生成される.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-js\"\u003e\u003ccode class=\"language-js\"\u003edeclare type \u003cspan class=\"token maybe-class-name\"\u003eCompiledResult\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  ast\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token operator\"\u003e?\u003c/span\u003e\u003cspan class=\"token maybe-class-name\"\u003eASTElement\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  render\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e string\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  staticRenderFns\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token known-class-name class-name\"\u003eArray\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003estring\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  stringRenderFns\u003cspan class=\"token operator\"\u003e?\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token known-class-name class-name\"\u003eArray\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003estring\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  errors\u003cspan class=\"token operator\"\u003e?\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token known-class-name class-name\"\u003eArray\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003estring \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e \u003cspan class=\"token maybe-class-name\"\u003eWarningMessage\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  tips\u003cspan class=\"token operator\"\u003e?\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token known-class-name class-name\"\u003eArray\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003estring \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e \u003cspan class=\"token maybe-class-name\"\u003eWarningMessage\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2 id=\"summary\"\u003e\u003ca href=\"#summary\"\u003eSummary\u003c/a\u003e\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eVueのコンパイラは\u003ccode\u003eparser\u003c/code\u003eと\u003ccode\u003egenerator\u003c/code\u003eからなる.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eparser\u003c/code\u003eは\u003ccode\u003ehtml-parse\u003c/code\u003eを元にASTを生成する.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003egenerator\u003c/code\u003eはASTを元に動的部分と静的部分の\u003ccode\u003erender\u003c/code\u003e群を生成する\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"next\"\u003e\u003ca href=\"#next\"\u003eNext\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e次回は\u003ccode\u003esrc/core/observer\u003c/code\u003eを読む.\u003cbr\u003e\n(名前からVueのreactive systemがObserver patternベースなんだろうな)\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"/2019/08/08/internal-vue-2/\"\u003e次回\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e","description":"internal Vue.js \u0026 read how Vue compiler works","commits":[{"title":"copy md","date":"2021-01-30 22:18:17","hash":"35b550ae","diff":"\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"35b550ae.patch\" class=\"language-git  language-diff\"\u003e\u003ccode class=\"language-git\"\u003e\u003cspan class=\"token commit-sha1\"\u003ecommit 35b550ae83af4efaeadf33471c8ca8a32c1079c8\u003c/span\u003e\nAuthor: koka \u0026#x26;\u003ca href=\"mailto:lt;koka.code@gmail.com\" class=\"token email-link\"\u003elt;koka.code@gmail.com\u003c/a\u003e\u0026#x26;gt;\nDate:   Sat Jan 30 22:18:17 2021 +0900\n\n  copy md\n\ndiff --git a/_posts/2019-07-15-internal-vue.md b/_posts/2019-07-15-internal-vue.md\nnew file mode 100644\nindex 0000000..b460b95\n\u003cspan class=\"token deleted\"\u003e--- /dev/null\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+++ b/_posts/2019-07-15-internal-vue.md\u003c/span\u003e\n\u003cspan class=\"token coord\"\u003e@@ -0,0 +1,228 @@\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+---\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+title: 'Internal Vue.js 1'\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+date: 2019-07-15\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+categories:\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- Code Reading\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+tags:\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- Vue\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- Virtual DOM\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+description: internal Vue.js \u0026#x26; read how Vue compiler works\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+---\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+[Vue.js](https://github.com/vuejs/vue)のreactive systemがどのように実装されているか追ってみた.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+初回はコンパイラの挙動を確認.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- Vuejs v2.6.10\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+## src/compiler/index.js\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+compilerのentrypointとなるのが`src/compiler/index.js`.  \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+(Vue.jsは[flow](https://flow.org)を用いてtype checkを行っている. compiler周りの型は`flow/compiler.js`に記載.)\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+`parse(template, options)`でASTを生成し，`generate(ast, options)`でcodeを生成する.  \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+Virtual DOMのpatch/mergeを効率よく行うため，返り値の`CompiledResult`に`code`だけでなくASTを持たせている.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+`staticRenderFns`についてはparser部分で説明する.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```js\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+// `createCompilerCreator` allows creating compilers that use alternative\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+// parser/optimizer/codegen, e.g the SSR optimizing compiler.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+// Here we just export a default compiler using the default parts.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+export const createCompiler = createCompilerCreator(function baseCompile (\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  template: string,\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  options: CompilerOptions\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+): CompiledResult {\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  const ast = parse(template.trim(), options)\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  if (options.optimize !== false) {\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    optimize(ast, options)\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  }\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  const code = generate(ast, options)\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  return {\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    ast,\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    render: code.render,\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    staticRenderFns: code.staticRenderFns\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  }\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+})\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+## src/compiler/parser/index.js\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+`.vue`ファイルからASTを生成する部分. `parse`関数内部で関数定義してて長いので，重要なところだけピックアップする.  \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+VueのテンプレートはHTMLのDOMをベースにしていて，特に\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- Mustache\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- Directive\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+の2点を拡張記法としてもっている．\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+そのためパース自体は`html-parse`を用いており，`parse`の主な仕事はHTML DOMのASTを返すのとパース時のエラー出力となっている．\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```js\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+/**\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ * Convert HTML string to AST.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ */\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+export function parse (\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  template: string,\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  options: CompilerOptions\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+): ASTElement | void {\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  warn = options.warn || baseWarn\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  /* omit */\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  parseHTML(template, {\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    /* omit */,\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    start (tag, attrs, unary, start, end) { /* omit */ },\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  })\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  return root // ASTのroot Node\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+}\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+関係ないけど階段状にインポートしてるの好き.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```js\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+import {\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  addProp,\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  addAttr,\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  baseWarn,\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  addHandler,\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  addDirective,\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  getBindingAttr,\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  getAndRemoveAttr,\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  getRawBindingAttr,\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  pluckModuleFunction,\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  getAndRemoveAttrByRegex\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+} from '../helpers'\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+## Abstract Syntax Tree\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+`generate`が受け取る`ast`の型`ASTElement`は`flow/compiler.js`に定義されている．  \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ASTは以下の3種類に分類され，`ASTNode`がそれぞれの`type`を元に判別している．\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- `ASTElement`: type: 1\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- `ASTText`: type: 2\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- `ASTExpression`: type: 3\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+`type ASTNode = ASTElement | ASTText | ASTExpression`\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+`ASTElement`を例にとると以下のようになっている．\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```js\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+declare type ASTElement = {\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  type: 1;\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  tag: string;\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  attrsList: Array\u0026#x26;lt;ASTAttr\u0026#x26;gt;;\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  attrsMap: { [key: string]: any };\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  rawAttrsMap: { [key: string]: ASTAttr };\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  parent: ASTElement | void;\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  children: Array\u0026#x26;lt;ASTNode\u0026#x26;gt;;\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  /* omit */\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  staticRoot?: boolean;\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  text?: string;\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  component?: string;\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  if?: string;\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  for?: string;\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  transition?: string | true;\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  /* omit */\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  model?: {\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    value: string;\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    callback: string;\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    expression: string;\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  };\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+}\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ASTの構造は`ASTElement`がrootとなり，branchに`ASTNode`を再帰的に持つ構造になる.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+`staticRoot?`や`component?`等のパラメータは，その`ASTNode`以下が`static`であるか`dynamic`であるか，等レンダリングの最適化の際に参照される．\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+この最適化機構は`src/compiler/optimizer.js`の`markStatic`及び`markStaticRoot`が担う.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+## src/compiler/codegen/index.js\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+`generate`はASTから`render`と`staticRenderFns`の２つを生成する．  \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+`render`がVueのDynamic Renderingを担当し，`staticRenderFns`は静的な(変更のない)DOMを生成する.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```js\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+export function generate (\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  ast: ASTElement | void,\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  options: CompilerOptions\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+): CodegenResult {\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  const state = new CodegenState(options)\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  const code = ast ? genElement(ast, state) : '_c(\"div\")'\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  return {\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    render: `with(this){return ${code}}`,\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    staticRenderFns: state.staticRenderFns\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  }\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+}\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+`genElement`は`ASTElement`の`staticRoot?`や`for?`等を確認し，それぞれのディレクティブ・タグに対応する`Element`, `Component`を生成する.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+各々の生成は`genStatic`, `genIf`のようにそれぞれのジェネレータで行う．\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+各々のジェネレータは受け取ったASTを処理した後に再帰的に`genElement`を呼び出す．  \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+最終的に`genElement`は最小単位である`Element`の生成を行う．  \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+`Element`は`\u0026#x26;lt;tag data\u0026#x26;gt;children\u0026#x26;lt;/tag\u0026#x26;gt;`からなるDOMである．\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+以下がその生成部分.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```js\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+data = genData(el, state)\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+/* omit */\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+const children = el.inlineTemplate ? null : genChildren(el, state, true)\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+code = `_c('${el.tag}'${\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  data ? `,${data}` : '' // data\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+}${\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  children ? `,${children}` : '' // children\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+})`\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+`Element`のdata部分は`genData`が担当する. data部分に含まれるのは`class`, `directive`, `model`.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```js\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+export function genData (el: ASTElement, state: CodegenState): string {\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  let data = '{'\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  // directives first.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  // directives may mutate the el's other properties before they are generated.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  const dirs = genDirectives(el, state)\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  if (dirs) data += dirs + ','\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  /* omit */\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  // component v-model\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  if (el.model) {\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    data += `model:{value:${\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+      el.model.value\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    },callback:${\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+      el.model.callback\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    },expression:${\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+      el.model.expression\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    }},`\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  }\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  /* omit */\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  return data\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+}\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+最終的に`CompiledResult`が生成される.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```js\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+declare type CompiledResult = {\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  ast: ?ASTElement;\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  render: string;\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  staticRenderFns: Array\u0026#x26;lt;string\u0026#x26;gt;;\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  stringRenderFns?: Array\u0026#x26;lt;string\u0026#x26;gt;;\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  errors?: Array\u0026#x26;lt;string | WarningMessage\u0026#x26;gt;;\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  tips?: Array\u0026#x26;lt;string | WarningMessage\u0026#x26;gt;;\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+};\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+## Summary\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- Vueのコンパイラは`parser`と`generator`からなる.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- `parser`は`html-parse`を元にASTを生成する.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- `generator`はASTを元に動的部分と静的部分の`render`群を生成する\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+## Next\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+次回は`src/core/observer`を読む.  \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+(名前からVueのreactive systemがObserver patternベースなんだろうな)\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- [次回](/2019/08/08/internal-vue-2/)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e"}],"publishedAt":"2019-07-15","updatedAt":"2021-01-30"}},"__N_SSG":true},"page":"/archives/[slug]","query":{"slug":"2019-07-15-internal-vue"},"buildId":"iEZvi0eyRNxzrGJJ8jEB8","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>