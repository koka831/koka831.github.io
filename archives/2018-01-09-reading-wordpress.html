<!DOCTYPE html><html lang="en"><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><meta name="theme-color" content="#ddd4bb"/><meta property="og:type" content="website"/><meta property="og:url" content="https://koka831.github.io"/><meta property="og:site_name" content="/var/log/koka"/><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="/var/log/koka"/><meta name="twitter:site" content="@k_0ka"/><meta name="twitter:description" content="cat /var/log/koka &gt; /dev/null"/><link rel="alternate" type="application/rss+xml" href="https://koka831.github.io/feed.xml" title="/var/log/koka RSS2.0"/><title>reading wordpress | /var/log/koka</title><meta property="title" content="reading wordpress | /var/log/koka"/><meta property="og:title" content="reading wordpress | /var/log/koka"/><meta property="twitter:title" content="reading wordpress | /var/log/koka"/><meta property="description" content="How to read source code with an example"/><meta property="og:description" content="How to read source code with an example"/><meta property="twitter:description" content="How to read source code with an example"/><meta property="og:image" content="https://koka831.github.io/img/2018-01-10-thumb.png"/><meta name="next-head-count" content="19"/><link rel="preload" href="/_next/static/css/c6af7bd612faeb7c.css" as="style"/><link rel="stylesheet" href="/_next/static/css/c6af7bd612faeb7c.css" data-n-g=""/><link rel="preload" href="/_next/static/css/9a908afc1d99510a.css" as="style"/><link rel="stylesheet" href="/_next/static/css/9a908afc1d99510a.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-9b312e20a4e32339.js" defer=""></script><script src="/_next/static/chunks/framework-5f4595e5518b5600.js" defer=""></script><script src="/_next/static/chunks/main-a054bbf31fb90f6a.js" defer=""></script><script src="/_next/static/chunks/pages/_app-e0fcf5a3a528e4c5.js" defer=""></script><script src="/_next/static/chunks/cb1608f2-ecfb8d9b659208e2.js" defer=""></script><script src="/_next/static/chunks/956-4e50aca8308ec128.js" defer=""></script><script src="/_next/static/chunks/291-6b2ab5605142007f.js" defer=""></script><script src="/_next/static/chunks/pages/archives/%5Bslug%5D-f3c25ca7c16881be.js" defer=""></script><script src="/_next/static/-5kDKO-iBXqcRsFR54_iY/_buildManifest.js" defer=""></script><script src="/_next/static/-5kDKO-iBXqcRsFR54_iY/_ssgManifest.js" defer=""></script><script src="/_next/static/-5kDKO-iBXqcRsFR54_iY/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><nav class="Header_navigation__container__Xjar7"><div class="Header_navigation__qZpeO"><a href="/">/var/log/koka</a></div><div><a href="/archives">archive</a></div></nav><main class="Layout_container__LBFOo"><div class="slug_container__f_fjw"><div class="slug_main__WMOpC"><article class="slug_article__cOl2p" role="article"><div itemscope="" class="ArticleHeader_header__container__5Gs_X"><a class="ArticleHeader_post__title__gVFje" href="/archives/2018-01-09-reading-wordpress">reading wordpress</a><p>How to read source code with an example</p><div class="ArticleHeader_flex__yDiMS"><div class="ArticleHeader_post__tags__uCQyx"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="tags" class="svg-inline--fa fa-tags ArticleHeader_tags__icon__U9c_O" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M472.8 168.4C525.1 221.4 525.1 306.6 472.8 359.6L360.8 472.9C351.5 482.3 336.3 482.4 326.9 473.1C317.4 463.8 317.4 448.6 326.7 439.1L438.6 325.9C472.5 291.6 472.5 236.4 438.6 202.1L310.9 72.87C301.5 63.44 301.6 48.25 311.1 38.93C320.5 29.61 335.7 29.7 344.1 39.13L472.8 168.4zM.0003 229.5V80C.0003 53.49 21.49 32 48 32H197.5C214.5 32 230.7 38.74 242.7 50.75L410.7 218.7C435.7 243.7 435.7 284.3 410.7 309.3L277.3 442.7C252.3 467.7 211.7 467.7 186.7 442.7L18.75 274.7C6.743 262.7 0 246.5 0 229.5L.0003 229.5zM112 112C94.33 112 80 126.3 80 144C80 161.7 94.33 176 112 176C129.7 176 144 161.7 144 144C144 126.3 129.7 112 112 112z"></path></svg><p class="Tag_tag__rl8WL">Wordpress</p></div><div class="ArticleHeader_post__dates__6uEwt"><time dateTime="2018-01-09" itemProp="datePublished" class="PublishDate_post__date__jhH_w">published: <!-- -->2018-01-09</time><time dateTime="2021-04-22" itemProp="datePublished" class="PublishDate_post__date__jhH_w">updated: 2021-04-22</time></div></div></div><div class="slug_article__body__m2pRS"><p>友人からコードリーディングの方法について聞かれたので,僕自身もCSバックグラウンドではないけれどソースコードの読み方を説明しようと思う.<br>
以下友人向け文体.</p>
<p>途中でプロジェクトにアサインされた時、過去の自分のコードをリファクタリングする時、OSSのコードを読む時など、ある程度の規模のソースコードを読む機会があると思う.<br>
サーバーだったりコマンドラインツールだったり,言語も責務も異なる様々なプログラムを読む際に一貫した読み方はあるのだろうか.
完全な解はないと思うが、僕個人の経験からすると、</p>
<ul>
<li>抽象化・抽象度を意識すること</li>
<li>読まないこと
これらを意識するだけででソースコードはだいぶ読みやすくなる.</li>
</ul>
<p>抽象化・抽象度を意識するとはどういうことか.
具体的に言うと、自分が今、全体の処理の流れのうち、どの部分を読んでいるかを意識することである。</p>
<p>僕らは普段プログラムを書くためにOSを使っているけれど、OSは実際どんなことをしてくれているのか.<br>
プログラムをコンパイラに喰わせると実行可能なファイルを吐いてくれるけれど、内部ではなにをしているのか.<br>
CPUはフリップフロップ<sup><a href="#user-content-fn-1" id="user-content-fnref-1" data-footnote-ref aria-describedby="footnote-label">1</a></sup>という素子からできているし、フリップフロップは半導体からできている.<br>
けれど、プログラムを組む上で僕らはそんなこと気にする必要がない.<br>
これが抽象化である. 内部構造を隠蔽し、表に見えるのはユーザが触って良い部分だけ.</p>
<p>注意して欲しいのが、ここで言うユーザは必ずしも人間だけではないということ.<br>
例えば実行中のプログラムがメモリの状態を知りたい時、直接メモリを参照するのは無理がある.
実行中のプログラムからメモリまでには以下のような層がある.</p>
<div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">+-----+    +-----+    +-----------+    +---------+
| mem | == | CPU | == | kernel/OS | == | program |
+-----+    +-----+    +-----------+    +---------+</code></pre></div>
<p>ではどうするか. 見えないものは下の層が知っているかもしれない.
OSにメモリの使用状況を尋ねる命令を送るのである.</p>
<p>上の例では物理的に層が分かれていたので抽象化の区切りが分かりやすかったが、ソフトウェアの構成も同様に抽象化が行われている.<br>
ソフトウェアのコードを読む時にも、自分が今メモリを見ているのかOSの命令を見ているのか、また隠蔽されている処理なのか、表に見えている部分なのか、どのレベルを見ているのかを意識することが必要なのがわかると思う.</p>
<p>次に、読まないこと.
これは<strong>読むべき情報以外を読まない</strong>という意味.</p>
<p>全体像を知る、というのは全部を知ることではない. 上の話でも言ったように、基本的にソフトウェアは抽象化の繰り返しで構成されている.<br>
つまり、自分が欲しい情報の層に立った時に、表に見える情報以外は読まなくていい.
OSがどうなっているか知りたいのにメモリを分解してみてもどうにもならない.</p>
<p>恐らくソースコードを読むことに慣れているエンジニアはこれらを無意識に行っている.
そのため同じ抽象度のものを見る時に,自分の培ったパターンを当てはめることができ、更に自分がコードを書く際に、同様の設計で実装することが出来る.<br>
プロジェクトが書けるエンジニアは読む力もある.</p>
<p>以上を踏まえてWordPressのソースコード<sup><a href="#user-content-fn-2" id="user-content-fnref-2" data-footnote-ref aria-describedby="footnote-label">2</a></sup>を読んでみよう.</p>
<p>まずなにを知りたいか.
ここでは全体的な構成とCMSとしての処理の流れを把握することを目標としてみよう.</p>
<p>全体構成を把握する場合、複数の層の責務を把握する必要があるため、特に<strong>読まない</strong>ことが重要である.<br>
コードを実際に読む前に、まずは公式サイトやリファレンスに書いていないか確認してみよう.
リファレンスがダメならコメントだ.</p>
<p>公式に<a href="http://wpdocs.osdn.jp/%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88%E9%9A%8E%E5%B1%A4" target="_blank" rel="nofollow noopener noreferrer">ディレクトリ階層</a>というページがある.<br>
見てみるとこれは自作テーマにおけるディレクトリ階層のようだ. 今回はWordPress自体がどのように動作するのかを知りたいので、今回は素直にコードを読むしかなさそうだ.</p>
<p>では実際にディレクトリ構成を見てみよう.</p>
<div class="remark-highlight"><pre class="language-shell"><code class="language-shell">index.php
license.txt
readme.html
wp-activate.php
wp-blog-header.php
wp-comments-post.php
wp-config-sample.php
wp-cron.php
wp-links-opml.php
wp-load.php
wp-login.php
wp-mail.php
wp-settings.php
wp-signup.php
wp-trackback.php
xmlrpc.php
<span class="token builtin class-name">.</span>
├── wp-admin
│   ├── css
│   ├── images
│   ├── includes
│   ├── js
│   ├── maint
│   ├── network
│   └── user
├── wp-content
│   ├── plugins
│   ├── themes
│   └index.php
└── wp-includes
    ├── certificates
    ├── css
    ├── customize
    ├── fonts
    ├── ID3
    ├── images
    ├── IXR
    ├── js
    ├── pomo
    ├── random_compat
    ├── Requests
    ├── rest-api
    ├── SimplePie
    ├── Text
    ├── theme-compat
    ├── widgets
    └<span class="token punctuation">..</span>.

<span class="token number">28</span> directories
</code></pre></div>
<p>構成を見つつ、このうちどれが読まなくてもいいものか考えてみよう.</p>
<p>まず<code>wp-admin/</code>. これは管理者パネル用のディレクトリだろう. CMSとしてはとりあえず読まなくても良さそうだ.</p>
<p>次に<code>wp-content/</code>配下. <code>plugins/</code>, <code>themes/</code>は それぞれユーザインストールのプラグインとテーマ用のディレクトリだろうか.<br>
<code>index.php</code>はルートディレクトリにもあったがどちらがエントリーポイントになるのだろう. テーマを読み込む処理はルーティング後に行われるだろうからとりあえずは後回しにしよう.</p>
<p>最後に<code>wp-includes</code>はどうだろう.<br>
大抵<code>includes/</code>ディレクトリにはシステムで利用するライブラリ等が置かれる. 読むのは必要な機能が出てきてからで良さそうだ.</p>
<p>つまり最初に読む必要があるのはこれらになりそうだ.</p>
<div class="remark-highlight"><pre class="language-shell"><code class="language-shell">$ tree -I <span class="token string">'wp-includes|wp-admin|themes|plugins|licence|readme'</span>

├── index.php
├── wp-activate.php
├── wp-blog-header.php
├── wp-comments-post.php
├── wp-config-sample.php
├── wp-content
│   └── index.php
├── wp-cron.php
├── wp-links-opml.php
├── wp-load.php
├── wp-login.php
├── wp-mail.php
├── wp-settings.php
├── wp-signup.php
├── wp-trackback.php
└── xmlrpc.php

<span class="token number">1</span> directory, <span class="token number">17</span> files
</code></pre></div>
<p>では実際の処理の流れを追っていこう.</p>
<p>大抵WordPressはApacheやNginx等のウェブサーバを介してPHP-FPMやFastCGIを用いてホスティングされる.<br>
Apacheであれば<code>DirectoryIndex</code>, Nginxであれば<code>http</code>ディレクティブ内の<code>index</code>に、ウェブサーバにアクセスがあった時に最初にアクセスされるファイルが指定されている.</p>
<div class="remark-highlight"><pre class="language-nginx"><code class="language-nginx"><span class="token comment"># nginx.conf</span>
<span class="token directive"><span class="token keyword">http</span></span> <span class="token punctuation">{</span>
  <span class="token comment"># ...</span>
  <span class="token directive"><span class="token keyword">index</span>                index.php index.html index.htm</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>なので<code>/index.php</code>が最初に読み込まれる.
処理より流れを把握することを意識して実際に読んでいこう.</p>
<div class="remark-highlight"><pre class="language-php"><code class="language-php"><span class="token comment">/* index.php */</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'WP_USE_THEMES'</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">require</span><span class="token punctuation">(</span> <span class="token function">dirname</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string single-quoted-string">'/wp-blog-header.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div>
<p><code>index.php</code>では定数を定義して、<code>wp-blog-header.php</code>を読み込んでいる.
では<code>wp-blog-header.php</code>を見てみよう.</p>
<div class="remark-highlight"><pre class="language-php"><code class="language-php"><span class="token comment">/* wp-blog-header.php */</span>
<span class="token comment">/* Loads the WordPress environment and template. */</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$wp_did_header</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token variable">$wp_did_header</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
  <span class="token comment">/* Load the WordPress library. */</span>
  <span class="token keyword">require_once</span><span class="token punctuation">(</span> <span class="token function">dirname</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'/wp-load.php'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* Set up the WordPress query. */</span>
  <span class="token function">wp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* Load the theme template. */</span>
  <span class="token keyword">require_once</span><span class="token punctuation">(</span> <span class="token constant">ABSPATH</span> <span class="token operator">.</span> <span class="token constant">WPINC</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'/template-loader.php'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div>
<blockquote>
<p>Loads the WordPress environment and template.</p>
</blockquote>
<p>とあるので、<code>wp-load.php</code>が"environment"、定数やデータベースの設定を、<code>template-loader.php</code>が"template"、<code>wp-contents/themes</code>のテーマテンプレートをロードするファイルなのだろう.<br>
では<code>wp()</code>は? <code>wp()</code>を呼ぶ前にインクルードしたファイルは<code>wp-load.php</code>しかないので、ここで定義されているのだろう.<br>
そして"Set up the WordPress query."とはどういうことだろう.<br>
順に追っていこう.</p>
<h4 id="wp-loadphp"><a href="#wp-loadphp">wp-load.php</a></h4>
<p>コメントを読むと</p>
<ul>
<li>ABSPATHの定義</li>
<li><code>wp-config.php</code>, <code>wp-settings.php</code>のロード
<ul>
<li>ファイルが存在しなければセットアップするように表示する
と書いてある.
セットアップ時のエラーハンドリングもCMSの機能としては本質ではないので、ここもコメントを読んでこれくらいで次に進むようにしよう.</li>
</ul>
</li>
</ul>
<h4 id="wp-configphp"><a href="#wp-configphp">wp-config.php</a></h4>
<p>これは初期状態では存在しない. <code>wp-config-sample.php</code>をベースにセットアップ時に作成されるようだ.
このファイルでは</p>
<ul>
<li>MySQL settings</li>
<li>Secret Keys</li>
<li>Database table prefix</li>
<li>ABSPATH
の定義がされるようだ.</li>
</ul>
<p><code>wp-load.php</code>でABSPATHの定義をしたはずなのに、どうしてまた定義するのだろうか?
とりあえず全体像を確認するためにこれは置いておこう.</p>
<h4 id="wp-settingsphp"><a href="#wp-settingsphp">wp-settings.php</a></h4>
<p>トップレベルコメントには、</p>
<blockquote>
<p>Used to set up and fix common variables and include the WordPress procedural and class library</p>
</blockquote>
<p>とあるので、基本的な関数やクラスのロードが行われるのだろう.</p>
<p>次に進みたいけれどまだ<code>wp()</code>が見つかっていない. 恐らく<code>wp-settings.php</code>で読み込んでいるファイルのどれかに定義されているのだろう.<br>
ただこの量の<code>require</code>文を全て読んでいくのはしんどい.</p>
<p>こんな時は<strong>タグジャンプ</strong>を使ってみよう.<br>
タグジャンプとは、ctagsを用いてソースコードを静的解析し、定義元のファイルを開く方法である.
VimやSublime Textのプラグインとして公開されているものがあるので使ってみよう.
もちろんgrepでもいい.</p>
<p>そうして<code>wp-includes/functions.php</code>に<code>wp()</code>を見つけた.</p>
<div class="remark-highlight"><pre class="language-php"><code class="language-php"><span class="token doc-comment comment">/**
 * Set up the WordPress query.
 *
 * <span class="token keyword">@since</span> 2.0.0
 *
 * <span class="token keyword">@global</span> <span class="token class-name">WP</span>       <span class="token parameter">$wp_locale</span>
 * <span class="token keyword">@global</span> <span class="token class-name">WP_Query</span> <span class="token parameter">$wp_query</span>
 * <span class="token keyword">@global</span> <span class="token class-name">WP_Query</span> <span class="token parameter">$wp_the_query</span>
 *
 * <span class="token keyword">@param</span> <span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">|</span><span class="token keyword">array</span></span> <span class="token parameter">$query_vars</span> Default WP_Query arguments.
 */</span>
<span class="token keyword">function</span> <span class="token function-definition function">wp</span><span class="token punctuation">(</span> <span class="token variable">$query_vars</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">global</span> <span class="token variable">$wp</span><span class="token punctuation">,</span> <span class="token variable">$wp_query</span><span class="token punctuation">,</span> <span class="token variable">$wp_the_query</span><span class="token punctuation">;</span>
  <span class="token variable">$wp</span><span class="token operator">-></span><span class="token function">main</span><span class="token punctuation">(</span> <span class="token variable">$query_vars</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$wp_the_query</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
    <span class="token variable">$wp_the_query</span> <span class="token operator">=</span> <span class="token variable">$wp_query</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>なるほど、この<code>$wp</code>がメインのオブジェクトなのだろう.<br>
@globalとあるので、<code>$GLOBALS['wp']</code>を定義している箇所を探してみよう.</p>
<div class="remark-highlight"><pre class="language-php"><code class="language-php"><span class="token comment">// wp-settings.php</span>
<span class="token doc-comment comment">/**
 * WordPress Object
 * <span class="token keyword">@global</span> <span class="token class-name">WP</span> <span class="token parameter">$wp</span>
 * <span class="token keyword">@since</span> 2.0.0
 */</span>
<span class="token global">$GLOBALS</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'wp'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div>
<p><code>$wp</code>の実態はclass WPのインスタンスだった.<br>
<code>$wp->main( $query_vars )</code>とあったので、WPクラスのmainメソッドを見てみよう.<br>
WPクラスは<code>wp-includes/class-wp.php</code>に定義されている.</p>
<div class="remark-highlight"><pre class="language-php"><code class="language-php"><span class="token doc-comment comment">/**
 * Sets up all of the variables required by the WordPress environment.
 *
 * The action <span class="token punctuation">{</span><span class="token keyword">@see</span> 'wp'<span class="token punctuation">}</span> has one parameter that references the WP object. It
 * allows for accessing the properties and methods to further manipulate the
 * object.
 *
 * <span class="token keyword">@param</span> <span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">|</span><span class="token keyword">array</span></span> <span class="token parameter">$query_args</span> Passed to parse_request().
 */</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token variable">$query_args</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token this keyword">$this</span><span class="token operator">-></span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token this keyword">$this</span><span class="token operator">-></span><span class="token function">parse_request</span><span class="token punctuation">(</span><span class="token variable">$query_args</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token this keyword">$this</span><span class="token operator">-></span><span class="token function">send_headers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token this keyword">$this</span><span class="token operator">-></span><span class="token function">query_posts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token this keyword">$this</span><span class="token operator">-></span><span class="token function">handle_404</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token this keyword">$this</span><span class="token operator">-></span><span class="token function">register_globals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token doc-comment comment">/**
   * Fires once the WordPress environment has been set up.
   *
   * <span class="token keyword">@since</span> 2.1.0
   *
   * <span class="token keyword">@param</span> <span class="token class-name">WP</span> <span class="token parameter">$this</span> Current WordPress environment instance (passed by reference).
   */</span>
  <span class="token function">do_action_ref_array</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'wp'</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span> <span class="token operator">&#x26;</span><span class="token this keyword">$this</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>ようやく実態が見えてきた. ここでそれぞれのメソッドを読みたい気持ちをこらえて、最後のフェーズ、<code>wp-includes/template-loader.php</code>を読んでいこう.</p>
<h4 id="template-loaderphp"><a href="#template-loaderphp">template-loader.php</a></h4>
<p>まず<code>do_action( 'template_redirect' )</code>が目につく.<br>
コメントを見るとどのテンプレートを読むかを判断する命令を送っているようだ.<br>
<code>do_action()</code>は命令に応じたアクションを呼び出す関数らしい. これも後で確認してみよう.</p>
<p>読み進めると、elseifの分岐に圧倒されるが<code>is_</code>でリクエストされたページのタイプを判定して、それにあったテンプレートをレンダリングする関数を呼んでいるだけのようだ.<br>
<code>is_</code>系の関数が全て引数を取っていないので、先の<code>main()</code>関数で読んでいた<br>
<code>$this->register_globals()</code>でそれらの情報もグローバル変数に定義しているのだろう.</p>
<p>ここまで読んだ流れをまとめると次のようになる.</p>
<p><figure><img src="./img/2018-01-10.png" alt=""><figcaption>img.1 </figcaption></figure></p>
<h4 id="終わりに"><a href="#終わりに">終わりに</a></h4>
<p>これで予想も交えながらではあったが処理の流れをさらうことができた.<br>
内容の確認よりも確認する手順を自分の思考とともに紹介することに重きをおいたので、課題がそのまま残っている. 良かったら読んで教えて欲しい.</p>
<h3 id="reference"><a href="#reference">reference</a></h3>
<section data-footnotes class="footnotes"><h2 id="footnote-label" class="sr-only"><a href="#footnote-label">Footnotes</a></h2>
<ol>
<li id="user-content-fn-1">
<p><a href="https://ja.wikipedia.org/wiki/%E3%83%95%E3%83%AA%E3%83%83%E3%83%97%E3%83%95%E3%83%AD%E3%83%83%E3%83%97#D%E5%9E%8B%E3%83%95%E3%83%AA%E3%83%83%E3%83%97%E3%83%95%E3%83%AD%E3%83%83%E3%83%97" target="_blank" rel="nofollow noopener noreferrer">wikipedia</a> <a href="#user-content-fnref-1" data-footnote-backref class="data-footnote-backref" aria-label="Back to content">↩</a></p>
</li>
<li id="user-content-fn-2">
<p>WordPress/ver.4.9 <a href="#user-content-fnref-2" data-footnote-backref class="data-footnote-backref" aria-label="Back to content">↩</a></p>
</li>
</ol>
</section></div></article><div class="CommitLogs_commit_logs__W6xPi" role="log"><h2>Commits</h2><details><summary><span class="CommitLogs_commit__date___q8bm">2021-04-22 15:12:31</span><span class="CommitLogs_commit__hash__Xyu7v">cd43e57e</span><span class="CommitLogs_commit__message__IGUPv">tweak ogp</span></summary><div><div class="remark-highlight"><pre data-file="cd43e57e.patch" class="language-git  language-diff"><code class="language-git"><span class="token commit-sha1">commit cd43e57eef247d695ae5d7ec91dd77bdd26b3d1d</span>
Author: koka &#x26;<a href="mailto:lt;koka.code@gmail.com" class="token email-link">lt;koka.code@gmail.com</a>&#x26;gt;
Date:   Thu Apr 22 15:12:31 2021 +0900

  tweak ogp

diff --git a/_posts/2018-01-09-reading-wordpress.md b/_posts/2018-01-09-reading-wordpress.md
index f6c20d2..d0792b0 100644
<span class="token deleted">--- a/_posts/2018-01-09-reading-wordpress.md</span>
<span class="token inserted">+++ b/_posts/2018-01-09-reading-wordpress.md</span>
@@ -3,7 +3,7 @@ title: reading wordpress
date: 2018-01-09
categories:
<span class="token deleted">- Code Reading</span>
<span class="token deleted">-image: /img/2018-01-10-thumb.png</span>
<span class="token inserted">+image: 2018-01-10-thumb.png</span>
tags:
 - Wordpress
description: How to read source code with an example
</code></pre></div></div></details><details><summary><span class="CommitLogs_commit__date___q8bm">2021-04-22 01:20:00</span><span class="CommitLogs_commit__hash__Xyu7v">fabe928f</span><span class="CommitLogs_commit__message__IGUPv">tweak</span></summary><div><div class="remark-highlight"><pre data-file="fabe928f.patch" class="language-git  language-diff"><code class="language-git"><span class="token commit-sha1">commit fabe928f5f60875b34ca333ba1bd5f4c21c143d1</span>
Author: koka &#x26;<a href="mailto:lt;koka.code@gmail.com" class="token email-link">lt;koka.code@gmail.com</a>&#x26;gt;
Date:   Thu Apr 22 01:20:00 2021 +0900

  tweak

diff --git a/_posts/2018-01-09-reading-wordpress.md b/_posts/2018-01-09-reading-wordpress.md
index 4934b7f..f6c20d2 100644
<span class="token deleted">--- a/_posts/2018-01-09-reading-wordpress.md</span>
<span class="token inserted">+++ b/_posts/2018-01-09-reading-wordpress.md</span>
@@ -3,7 +3,7 @@ title: reading wordpress
date: 2018-01-09
categories:
<span class="token deleted">- Code Reading</span>
<span class="token deleted">-image: /assets/img/2018-01-10-thumb.png</span>
<span class="token inserted">+image: /img/2018-01-10-thumb.png</span>
tags:
 - Wordpress
description: How to read source code with an example
</code></pre></div></div></details><details><summary><span class="CommitLogs_commit__date___q8bm">2021-01-30 22:18:17</span><span class="CommitLogs_commit__hash__Xyu7v">35b550ae</span><span class="CommitLogs_commit__message__IGUPv">copy md</span></summary><div><div class="remark-highlight"><pre data-file="35b550ae.patch" class="language-git  language-diff"><code class="language-git"><span class="token commit-sha1">commit 35b550ae83af4efaeadf33471c8ca8a32c1079c8</span>
Author: koka &#x26;<a href="mailto:lt;koka.code@gmail.com" class="token email-link">lt;koka.code@gmail.com</a>&#x26;gt;
Date:   Sat Jan 30 22:18:17 2021 +0900

  copy md

diff --git a/_posts/2018-01-09-reading-wordpress.md b/_posts/2018-01-09-reading-wordpress.md
new file mode 100644
index 0000000..4934b7f
<span class="token deleted">--- /dev/null</span>
<span class="token inserted">+++ b/_posts/2018-01-09-reading-wordpress.md</span>
<span class="token coord">@@ -0,0 +1,334 @@</span>
<span class="token inserted">+---</span>
<span class="token inserted">+title: reading wordpress</span>
<span class="token inserted">+date: 2018-01-09</span>
<span class="token inserted">+categories:</span>
<span class="token inserted">+- Code Reading</span>
<span class="token inserted">+image: /assets/img/2018-01-10-thumb.png</span>
<span class="token inserted">+tags:</span>
<span class="token inserted">+  - Wordpress</span>
<span class="token inserted">+description: How to read source code with an example</span>
<span class="token inserted">+---</span>
<span class="token inserted">+ </span>
<span class="token inserted">+友人からコードリーディングの方法について聞かれたので,僕自身もCSバックグラウンドではないけれどソースコードの読み方を説明しようと思う.  </span>
<span class="token inserted">+以下友人向け文体.</span>
<span class="token inserted">+</span>
<span class="token inserted">+</span>
<span class="token inserted">+途中でプロジェクトにアサインされた時、過去の自分のコードをリファクタリングする時、OSSのコードを読む時など、ある程度の規模のソースコードを読む機会があると思う.  </span>
<span class="token inserted">+サーバーだったりコマンドラインツールだったり,言語も責務も異なる様々なプログラムを読む際に一貫した読み方はあるのだろうか.</span>
<span class="token inserted">+完全な解はないと思うが、僕個人の経験からすると、</span>
<span class="token inserted">+- 抽象化・抽象度を意識すること</span>
<span class="token inserted">+- 読まないこと</span>
<span class="token inserted">+これらを意識するだけででソースコードはだいぶ読みやすくなる.</span>
<span class="token inserted">+</span>
<span class="token inserted">+抽象化・抽象度を意識するとはどういうことか.</span>
<span class="token inserted">+具体的に言うと、自分が今、全体の処理の流れのうち、どの部分を読んでいるかを意識することである。</span>
<span class="token inserted">+</span>
<span class="token inserted">+僕らは普段プログラムを書くためにOSを使っているけれど、OSは実際どんなことをしてくれているのか.  </span>
<span class="token inserted">+プログラムをコンパイラに喰わせると実行可能なファイルを吐いてくれるけれど、内部ではなにをしているのか.  </span>
<span class="token inserted">+CPUはフリップフロップ[^1]という素子からできているし、フリップフロップは半導体からできている.  </span>
<span class="token inserted">+けれど、プログラムを組む上で僕らはそんなこと気にする必要がない.  </span>
<span class="token inserted">+これが抽象化である. 内部構造を隠蔽し、表に見えるのはユーザが触って良い部分だけ.</span>
<span class="token inserted">+</span>
<span class="token inserted">+注意して欲しいのが、ここで言うユーザは必ずしも人間だけではないということ.  </span>
<span class="token inserted">+例えば実行中のプログラムがメモリの状態を知りたい時、直接メモリを参照するのは無理がある.</span>
<span class="token inserted">+実行中のプログラムからメモリまでには以下のような層がある.</span>
<span class="token inserted">+</span>
<span class="token inserted">+\```</span>
<span class="token inserted">++-----+    +-----+    +-----------+    +---------+</span>
<span class="token inserted">+| mem | == | CPU | == | kernel/OS | == | program |</span>
<span class="token inserted">++-----+    +-----+    +-----------+    +---------+</span>
<span class="token inserted">+\```</span>
<span class="token inserted">+</span>
<span class="token inserted">+ではどうするか. 見えないものは下の層が知っているかもしれない.</span>
<span class="token inserted">+OSにメモリの使用状況を尋ねる命令を送るのである.</span>
<span class="token inserted">+</span>
<span class="token inserted">+上の例では物理的に層が分かれていたので抽象化の区切りが分かりやすかったが、ソフトウェアの構成も同様に抽象化が行われている.  </span>
<span class="token inserted">+ソフトウェアのコードを読む時にも、自分が今メモリを見ているのかOSの命令を見ているのか、また隠蔽されている処理なのか、表に見えている部分なのか、どのレベルを見ているのかを意識することが必要なのがわかると思う.</span>
<span class="token inserted">+</span>
<span class="token inserted">+次に、読まないこと.</span>
<span class="token inserted">+これは**読むべき情報以外を読まない**という意味.</span>
<span class="token inserted">+</span>
<span class="token inserted">+全体像を知る、というのは全部を知ることではない. 上の話でも言ったように、基本的にソフトウェアは抽象化の繰り返しで構成されている.  </span>
<span class="token inserted">+つまり、自分が欲しい情報の層に立った時に、表に見える情報以外は読まなくていい.</span>
<span class="token inserted">+OSがどうなっているか知りたいのにメモリを分解してみてもどうにもならない.</span>
<span class="token inserted">+</span>
<span class="token inserted">+</span>
<span class="token inserted">+恐らくソースコードを読むことに慣れているエンジニアはこれらを無意識に行っている.</span>
<span class="token inserted">+そのため同じ抽象度のものを見る時に,自分の培ったパターンを当てはめることができ、更に自分がコードを書く際に、同様の設計で実装することが出来る.  </span>
<span class="token inserted">+プロジェクトが書けるエンジニアは読む力もある.</span>
<span class="token inserted">+</span>
<span class="token inserted">+以上を踏まえてWordPressのソースコード[^2]を読んでみよう.</span>
<span class="token inserted">+</span>
<span class="token inserted">+まずなにを知りたいか.</span>
<span class="token inserted">+ここでは全体的な構成とCMSとしての処理の流れを把握することを目標としてみよう.</span>
<span class="token inserted">+</span>
<span class="token inserted">+全体構成を把握する場合、複数の層の責務を把握する必要があるため、特に**読まない**ことが重要である.  </span>
<span class="token inserted">+コードを実際に読む前に、まずは公式サイトやリファレンスに書いていないか確認してみよう.</span>
<span class="token inserted">+リファレンスがダメならコメントだ. </span>
<span class="token inserted">+</span>
<span class="token inserted">+公式に[ディレクトリ階層](http://wpdocs.osdn.jp/%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88%E9%9A%8E%E5%B1%A4)というページがある.   </span>
<span class="token inserted">+見てみるとこれは自作テーマにおけるディレクトリ階層のようだ. 今回はWordPress自体がどのように動作するのかを知りたいので、今回は素直にコードを読むしかなさそうだ.</span>
<span class="token inserted">+</span>
<span class="token inserted">+では実際にディレクトリ構成を見てみよう.</span>
<span class="token inserted">+</span>
<span class="token inserted">+\```shell</span>
<span class="token inserted">+index.php</span>
<span class="token inserted">+license.txt</span>
<span class="token inserted">+readme.html</span>
<span class="token inserted">+wp-activate.php</span>
<span class="token inserted">+wp-blog-header.php</span>
<span class="token inserted">+wp-comments-post.php</span>
<span class="token inserted">+wp-config-sample.php</span>
<span class="token inserted">+wp-cron.php</span>
<span class="token inserted">+wp-links-opml.php</span>
<span class="token inserted">+wp-load.php</span>
<span class="token inserted">+wp-login.php</span>
<span class="token inserted">+wp-mail.php</span>
<span class="token inserted">+wp-settings.php</span>
<span class="token inserted">+wp-signup.php</span>
<span class="token inserted">+wp-trackback.php</span>
<span class="token inserted">+xmlrpc.php</span>
<span class="token inserted">+.</span>
<span class="token inserted">+├── wp-admin</span>
<span class="token inserted">+│   ├── css</span>
<span class="token inserted">+│   ├── images</span>
<span class="token inserted">+│   ├── includes</span>
<span class="token inserted">+│   ├── js</span>
<span class="token inserted">+│   ├── maint</span>
<span class="token inserted">+│   ├── network</span>
<span class="token inserted">+│   └── user</span>
<span class="token inserted">+├── wp-content</span>
<span class="token inserted">+│   ├── plugins</span>
<span class="token inserted">+│   ├── themes</span>
<span class="token inserted">+│   └index.php</span>
<span class="token inserted">+└── wp-includes</span>
<span class="token inserted">+    ├── certificates</span>
<span class="token inserted">+    ├── css</span>
<span class="token inserted">+    ├── customize</span>
<span class="token inserted">+    ├── fonts</span>
<span class="token inserted">+    ├── ID3</span>
<span class="token inserted">+    ├── images</span>
<span class="token inserted">+    ├── IXR</span>
<span class="token inserted">+    ├── js</span>
<span class="token inserted">+    ├── pomo</span>
<span class="token inserted">+    ├── random_compat</span>
<span class="token inserted">+    ├── Requests</span>
<span class="token inserted">+    ├── rest-api</span>
<span class="token inserted">+    ├── SimplePie</span>
<span class="token inserted">+    ├── Text</span>
<span class="token inserted">+    ├── theme-compat</span>
<span class="token inserted">+    ├── widgets</span>
<span class="token inserted">+    └...</span>
<span class="token inserted">+</span>
<span class="token inserted">+28 directories</span>
<span class="token inserted">+\```</span>
<span class="token inserted">+</span>
<span class="token inserted">+構成を見つつ、このうちどれが読まなくてもいいものか考えてみよう.</span>
<span class="token inserted">+</span>
<span class="token inserted">+まず`wp-admin/`. これは管理者パネル用のディレクトリだろう. CMSとしてはとりあえず読まなくても良さそうだ.</span>
<span class="token inserted">+</span>
<span class="token inserted">+次に`wp-content/`配下. `plugins/`, `themes/`は それぞれユーザインストールのプラグインとテーマ用のディレクトリだろうか.  </span>
<span class="token inserted">+`index.php`はルートディレクトリにもあったがどちらがエントリーポイントになるのだろう. テーマを読み込む処理はルーティング後に行われるだろうからとりあえずは後回しにしよう.</span>
<span class="token inserted">+</span>
<span class="token inserted">+最後に`wp-includes`はどうだろう.  </span>
<span class="token inserted">+大抵`includes/`ディレクトリにはシステムで利用するライブラリ等が置かれる. 読むのは必要な機能が出てきてからで良さそうだ.</span>
<span class="token inserted">+</span>
<span class="token inserted">+つまり最初に読む必要があるのはこれらになりそうだ.</span>
<span class="token inserted">+</span>
<span class="token inserted">+\```shell</span>
<span class="token inserted">+$ tree -I 'wp-includes|wp-admin|themes|plugins|licence|readme'</span>
<span class="token inserted">+</span>
<span class="token inserted">+├── index.php</span>
<span class="token inserted">+├── wp-activate.php</span>
<span class="token inserted">+├── wp-blog-header.php</span>
<span class="token inserted">+├── wp-comments-post.php</span>
<span class="token inserted">+├── wp-config-sample.php</span>
<span class="token inserted">+├── wp-content</span>
<span class="token inserted">+│   └── index.php</span>
<span class="token inserted">+├── wp-cron.php</span>
<span class="token inserted">+├── wp-links-opml.php</span>
<span class="token inserted">+├── wp-load.php</span>
<span class="token inserted">+├── wp-login.php</span>
<span class="token inserted">+├── wp-mail.php</span>
<span class="token inserted">+├── wp-settings.php</span>
<span class="token inserted">+├── wp-signup.php</span>
<span class="token inserted">+├── wp-trackback.php</span>
<span class="token inserted">+└── xmlrpc.php</span>
<span class="token inserted">+</span>
<span class="token inserted">+1 directory, 17 files</span>
<span class="token inserted">+\```</span>
<span class="token inserted">+</span>
<span class="token inserted">+では実際の処理の流れを追っていこう.</span>
<span class="token inserted">+</span>
<span class="token inserted">+大抵WordPressはApacheやNginx等のウェブサーバを介してPHP-FPMやFastCGIを用いてホスティングされる.  </span>
<span class="token inserted">+Apacheであれば`DirectoryIndex`, Nginxであれば`http`ディレクティブ内の`index`に、ウェブサーバにアクセスがあった時に最初にアクセスされるファイルが指定されている.</span>
<span class="token inserted">+</span>
<span class="token inserted">+\```nginx</span>
<span class="token inserted">+# nginx.conf</span>
<span class="token inserted">+http {</span>
<span class="token inserted">+  # ...</span>
<span class="token inserted">+  index                index.php index.html index.htm;</span>
<span class="token inserted">+}</span>
<span class="token inserted">+\```</span>
<span class="token inserted">+</span>
<span class="token inserted">+なので`/index.php`が最初に読み込まれる.</span>
<span class="token inserted">+処理より流れを把握することを意識して実際に読んでいこう.</span>
<span class="token inserted">+</span>
<span class="token inserted">+\```php</span>
<span class="token inserted">+/* index.php */</span>
<span class="token inserted">+define('WP_USE_THEMES', true);</span>
<span class="token inserted">+require( dirname(__FILE__).'/wp-blog-header.php');</span>
<span class="token inserted">+\```</span>
<span class="token inserted">+</span>
<span class="token inserted">+`index.php`では定数を定義して、`wp-blog-header.php`を読み込んでいる.</span>
<span class="token inserted">+では`wp-blog-header.php`を見てみよう.</span>
<span class="token inserted">+</span>
<span class="token inserted">+\```php</span>
<span class="token inserted">+/* wp-blog-header.php */</span>
<span class="token inserted">+/* Loads the WordPress environment and template. */</span>
<span class="token inserted">+if (!isset($wp_did_header)) {</span>
<span class="token inserted">+  $wp_did_header = true;</span>
<span class="token inserted">+  /* Load the WordPress library. */</span>
<span class="token inserted">+  require_once( dirname(__FILE__) . '/wp-load.php' );</span>
<span class="token inserted">+  /* Set up the WordPress query. */</span>
<span class="token inserted">+  wp();</span>
<span class="token inserted">+  /* Load the theme template. */</span>
<span class="token inserted">+  require_once( ABSPATH . WPINC . '/template-loader.php' );</span>
<span class="token inserted">+}</span>
<span class="token inserted">+\```</span>
<span class="token inserted">+&#x26;gt; Loads the WordPress environment and template.</span>
<span class="token inserted">+</span>
<span class="token inserted">+とあるので、`wp-load.php`が"environment"、定数やデータベースの設定を、`template-loader.php`が"template"、`wp-contents/themes`のテーマテンプレートをロードするファイルなのだろう.  </span>
<span class="token inserted">+では`wp()`は? `wp()`を呼ぶ前にインクルードしたファイルは`wp-load.php`しかないので、ここで定義されているのだろう.  </span>
<span class="token inserted">+そして"Set up the WordPress query."とはどういうことだろう.  </span>
<span class="token inserted">+順に追っていこう.</span>
<span class="token inserted">+</span>
<span class="token inserted">+#### wp-load.php</span>
<span class="token inserted">+コメントを読むと</span>
<span class="token inserted">+- ABSPATHの定義</span>
<span class="token inserted">+- `wp-config.php`, `wp-settings.php`のロード</span>
<span class="token inserted">+  - ファイルが存在しなければセットアップするように表示する</span>
<span class="token inserted">+と書いてある.</span>
<span class="token inserted">+セットアップ時のエラーハンドリングもCMSの機能としては本質ではないので、ここもコメントを読んでこれくらいで次に進むようにしよう.</span>
<span class="token inserted">+</span>
<span class="token inserted">+#### wp-config.php</span>
<span class="token inserted">+これは初期状態では存在しない. `wp-config-sample.php`をベースにセットアップ時に作成されるようだ.</span>
<span class="token inserted">+このファイルでは</span>
<span class="token inserted">+- MySQL settings</span>
<span class="token inserted">+- Secret Keys</span>
<span class="token inserted">+- Database table prefix</span>
<span class="token inserted">+- ABSPATH</span>
<span class="token inserted">+の定義がされるようだ.</span>
<span class="token inserted">+</span>
<span class="token inserted">+`wp-load.php`でABSPATHの定義をしたはずなのに、どうしてまた定義するのだろうか?</span>
<span class="token inserted">+とりあえず全体像を確認するためにこれは置いておこう.</span>
<span class="token inserted">+</span>
<span class="token inserted">+#### wp-settings.php</span>
<span class="token inserted">+トップレベルコメントには、</span>
<span class="token inserted">+&#x26;gt; Used to set up and fix common variables and include the WordPress procedural and class library</span>
<span class="token inserted">+</span>
<span class="token inserted">+とあるので、基本的な関数やクラスのロードが行われるのだろう.</span>
<span class="token inserted">+</span>
<span class="token inserted">+次に進みたいけれどまだ`wp()`が見つかっていない. 恐らく`wp-settings.php`で読み込んでいるファイルのどれかに定義されているのだろう.   </span>
<span class="token inserted">+ただこの量の`require`文を全て読んでいくのはしんどい.</span>
<span class="token inserted">+</span>
<span class="token inserted">+こんな時は**タグジャンプ**を使ってみよう.  </span>
<span class="token inserted">+タグジャンプとは、ctagsを用いてソースコードを静的解析し、定義元のファイルを開く方法である.</span>
<span class="token inserted">+VimやSublime Textのプラグインとして公開されているものがあるので使ってみよう.</span>
<span class="token inserted">+もちろんgrepでもいい.</span>
<span class="token inserted">+</span>
<span class="token inserted">+そうして`wp-includes/functions.php`に`wp()`を見つけた.</span>
<span class="token inserted">+</span>
<span class="token inserted">+\```php</span>
<span class="token inserted">+/**</span>
<span class="token inserted">+ * Set up the WordPress query.</span>
<span class="token inserted">+ *</span>
<span class="token inserted">+ * @since 2.0.0</span>
<span class="token inserted">+ *</span>
<span class="token inserted">+ * @global WP       $wp_locale</span>
<span class="token inserted">+ * @global WP_Query $wp_query</span>
<span class="token inserted">+ * @global WP_Query $wp_the_query</span>
<span class="token inserted">+ *</span>
<span class="token inserted">+ * @param string|array $query_vars Default WP_Query arguments.</span>
<span class="token inserted">+ */</span>
<span class="token inserted">+function wp( $query_vars = '' ) {</span>
<span class="token inserted">+  global $wp, $wp_query, $wp_the_query;</span>
<span class="token inserted">+  $wp-&#x26;gt;main( $query_vars );</span>
<span class="token inserted">+</span>
<span class="token inserted">+  if ( !isset($wp_the_query) )</span>
<span class="token inserted">+    $wp_the_query = $wp_query;</span>
<span class="token inserted">+}</span>
<span class="token inserted">+\```</span>
<span class="token inserted">+</span>
<span class="token inserted">+なるほど、この`$wp`がメインのオブジェクトなのだろう.   </span>
<span class="token inserted">+@globalとあるので、`$GLOBALS['wp']`を定義している箇所を探してみよう.</span>
<span class="token inserted">+</span>
<span class="token inserted">+</span>
<span class="token inserted">+\```php</span>
<span class="token inserted">+// wp-settings.php</span>
<span class="token inserted">+/**</span>
<span class="token inserted">+ * WordPress Object</span>
<span class="token inserted">+ * @global WP $wp</span>
<span class="token inserted">+ * @since 2.0.0</span>
<span class="token inserted">+ */</span>
<span class="token inserted">+$GLOBALS['wp'] = new WP();</span>
<span class="token inserted">+\```</span>
<span class="token inserted">+</span>
<span class="token inserted">+`$wp`の実態はclass WPのインスタンスだった.  </span>
<span class="token inserted">+`$wp-&#x26;gt;main( $query_vars )`とあったので、WPクラスのmainメソッドを見てみよう.  </span>
<span class="token inserted">+WPクラスは`wp-includes/class-wp.php`に定義されている.</span>
<span class="token inserted">+</span>
<span class="token inserted">+\```php</span>
<span class="token inserted">+/**</span>
<span class="token inserted">+ * Sets up all of the variables required by the WordPress environment.</span>
<span class="token inserted">+ *</span>
<span class="token inserted">+ * The action {@see 'wp'} has one parameter that references the WP object. It</span>
<span class="token inserted">+ * allows for accessing the properties and methods to further manipulate the</span>
<span class="token inserted">+ * object.</span>
<span class="token inserted">+ *</span>
<span class="token inserted">+ * @param string|array $query_args Passed to parse_request().</span>
<span class="token inserted">+ */</span>
<span class="token inserted">+public function main($query_args = '') {</span>
<span class="token inserted">+  $this-&#x26;gt;init();</span>
<span class="token inserted">+  $this-&#x26;gt;parse_request($query_args);</span>
<span class="token inserted">+  $this-&#x26;gt;send_headers();</span>
<span class="token inserted">+  $this-&#x26;gt;query_posts();</span>
<span class="token inserted">+  $this-&#x26;gt;handle_404();</span>
<span class="token inserted">+  $this-&#x26;gt;register_globals();</span>
<span class="token inserted">+</span>
<span class="token inserted">+  /**</span>
<span class="token inserted">+   * Fires once the WordPress environment has been set up.</span>
<span class="token inserted">+   *</span>
<span class="token inserted">+   * @since 2.1.0</span>
<span class="token inserted">+   *</span>
<span class="token inserted">+   * @param WP $this Current WordPress environment instance (passed by reference).</span>
<span class="token inserted">+   */</span>
<span class="token inserted">+  do_action_ref_array( 'wp', array( &#x26;$this ) );</span>
<span class="token inserted">+}</span>
<span class="token inserted">+\```</span>
<span class="token inserted">+</span>
<span class="token inserted">+ようやく実態が見えてきた. ここでそれぞれのメソッドを読みたい気持ちをこらえて、最後のフェーズ、`wp-includes/template-loader.php`を読んでいこう.</span>
<span class="token inserted">+</span>
<span class="token inserted">+#### template-loader.php</span>
<span class="token inserted">+まず`do_action( 'template_redirect' )`が目につく.   </span>
<span class="token inserted">+コメントを見るとどのテンプレートを読むかを判断する命令を送っているようだ.   </span>
<span class="token inserted">+`do_action()`は命令に応じたアクションを呼び出す関数らしい. これも後で確認してみよう.</span>
<span class="token inserted">+</span>
<span class="token inserted">+読み進めると、elseifの分岐に圧倒されるが`is_`でリクエストされたページのタイプを判定して、それにあったテンプレートをレンダリングする関数を呼んでいるだけのようだ.   </span>
<span class="token inserted">+`is_`系の関数が全て引数を取っていないので、先の`main()`関数で読んでいた  </span>
<span class="token inserted">+`$this-&#x26;gt;register_globals()`でそれらの情報もグローバル変数に定義しているのだろう.</span>
<span class="token inserted">+  </span>
<span class="token inserted">+ここまで読んだ流れをまとめると次のようになる.</span>
<span class="token inserted">+</span>
<span class="token inserted">+![](./img/2018-01-10.png)</span>
<span class="token inserted">+</span>
<span class="token inserted">+</span>
<span class="token inserted">+#### 終わりに</span>
<span class="token inserted">+これで予想も交えながらではあったが処理の流れをさらうことができた.  </span>
<span class="token inserted">+内容の確認よりも確認する手順を自分の思考とともに紹介することに重きをおいたので、課題がそのまま残っている. 良かったら読んで教えて欲しい.</span>
<span class="token inserted">+</span>
<span class="token inserted">+</span>
<span class="token inserted">+### reference</span>
<span class="token inserted">+[^1]: [wikipedia](https://ja.wikipedia.org/wiki/%E3%83%95%E3%83%AA%E3%83%83%E3%83%97%E3%83%95%E3%83%AD%E3%83%83%E3%83%97#D%E5%9E%8B%E3%83%95%E3%83%AA%E3%83%83%E3%83%97%E3%83%95%E3%83%AD%E3%83%83%E3%83%97)</span>
<span class="token inserted">+</span>
<span class="token inserted">+[^2]: WordPress/ver.4.9</span>
</code></pre></div></div></details></div><div class="Comments_comment__WxfzD" role="comment"><h2 class="Comments_title__YENiL">Comments</h2><div id="github-comment-container"></div></div></div><aside class="slug_aside__gL3UH"><nav class="Toc_toc__nav__rl0h7" role="navigation"><ul class="Toc_toc__Y4dWA"></ul></nav></aside></div></main><footer class="Footer_footer__FDcZZ"><small>Code snippets licensed under MIT, unless otherwise noted.</small></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"slug":"2018-01-09-reading-wordpress","title":"reading wordpress","categories":["Code Reading"],"image":"https://koka831.github.io/img/2018-01-10-thumb.png","tags":["Wordpress"],"content":"\u003cp\u003e友人からコードリーディングの方法について聞かれたので,僕自身もCSバックグラウンドではないけれどソースコードの読み方を説明しようと思う.\u003cbr\u003e\n以下友人向け文体.\u003c/p\u003e\n\u003cp\u003e途中でプロジェクトにアサインされた時、過去の自分のコードをリファクタリングする時、OSSのコードを読む時など、ある程度の規模のソースコードを読む機会があると思う.\u003cbr\u003e\nサーバーだったりコマンドラインツールだったり,言語も責務も異なる様々なプログラムを読む際に一貫した読み方はあるのだろうか.\n完全な解はないと思うが、僕個人の経験からすると、\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e抽象化・抽象度を意識すること\u003c/li\u003e\n\u003cli\u003e読まないこと\nこれらを意識するだけででソースコードはだいぶ読みやすくなる.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e抽象化・抽象度を意識するとはどういうことか.\n具体的に言うと、自分が今、全体の処理の流れのうち、どの部分を読んでいるかを意識することである。\u003c/p\u003e\n\u003cp\u003e僕らは普段プログラムを書くためにOSを使っているけれど、OSは実際どんなことをしてくれているのか.\u003cbr\u003e\nプログラムをコンパイラに喰わせると実行可能なファイルを吐いてくれるけれど、内部ではなにをしているのか.\u003cbr\u003e\nCPUはフリップフロップ\u003csup\u003e\u003ca href=\"#user-content-fn-1\" id=\"user-content-fnref-1\" data-footnote-ref aria-describedby=\"footnote-label\"\u003e1\u003c/a\u003e\u003c/sup\u003eという素子からできているし、フリップフロップは半導体からできている.\u003cbr\u003e\nけれど、プログラムを組む上で僕らはそんなこと気にする必要がない.\u003cbr\u003e\nこれが抽象化である. 内部構造を隠蔽し、表に見えるのはユーザが触って良い部分だけ.\u003c/p\u003e\n\u003cp\u003e注意して欲しいのが、ここで言うユーザは必ずしも人間だけではないということ.\u003cbr\u003e\n例えば実行中のプログラムがメモリの状態を知りたい時、直接メモリを参照するのは無理がある.\n実行中のプログラムからメモリまでには以下のような層がある.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003e+-----+    +-----+    +-----------+    +---------+\n| mem | == | CPU | == | kernel/OS | == | program |\n+-----+    +-----+    +-----------+    +---------+\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eではどうするか. 見えないものは下の層が知っているかもしれない.\nOSにメモリの使用状況を尋ねる命令を送るのである.\u003c/p\u003e\n\u003cp\u003e上の例では物理的に層が分かれていたので抽象化の区切りが分かりやすかったが、ソフトウェアの構成も同様に抽象化が行われている.\u003cbr\u003e\nソフトウェアのコードを読む時にも、自分が今メモリを見ているのかOSの命令を見ているのか、また隠蔽されている処理なのか、表に見えている部分なのか、どのレベルを見ているのかを意識することが必要なのがわかると思う.\u003c/p\u003e\n\u003cp\u003e次に、読まないこと.\nこれは\u003cstrong\u003e読むべき情報以外を読まない\u003c/strong\u003eという意味.\u003c/p\u003e\n\u003cp\u003e全体像を知る、というのは全部を知ることではない. 上の話でも言ったように、基本的にソフトウェアは抽象化の繰り返しで構成されている.\u003cbr\u003e\nつまり、自分が欲しい情報の層に立った時に、表に見える情報以外は読まなくていい.\nOSがどうなっているか知りたいのにメモリを分解してみてもどうにもならない.\u003c/p\u003e\n\u003cp\u003e恐らくソースコードを読むことに慣れているエンジニアはこれらを無意識に行っている.\nそのため同じ抽象度のものを見る時に,自分の培ったパターンを当てはめることができ、更に自分がコードを書く際に、同様の設計で実装することが出来る.\u003cbr\u003e\nプロジェクトが書けるエンジニアは読む力もある.\u003c/p\u003e\n\u003cp\u003e以上を踏まえてWordPressのソースコード\u003csup\u003e\u003ca href=\"#user-content-fn-2\" id=\"user-content-fnref-2\" data-footnote-ref aria-describedby=\"footnote-label\"\u003e2\u003c/a\u003e\u003c/sup\u003eを読んでみよう.\u003c/p\u003e\n\u003cp\u003eまずなにを知りたいか.\nここでは全体的な構成とCMSとしての処理の流れを把握することを目標としてみよう.\u003c/p\u003e\n\u003cp\u003e全体構成を把握する場合、複数の層の責務を把握する必要があるため、特に\u003cstrong\u003e読まない\u003c/strong\u003eことが重要である.\u003cbr\u003e\nコードを実際に読む前に、まずは公式サイトやリファレンスに書いていないか確認してみよう.\nリファレンスがダメならコメントだ.\u003c/p\u003e\n\u003cp\u003e公式に\u003ca href=\"http://wpdocs.osdn.jp/%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88%E9%9A%8E%E5%B1%A4\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eディレクトリ階層\u003c/a\u003eというページがある.\u003cbr\u003e\n見てみるとこれは自作テーマにおけるディレクトリ階層のようだ. 今回はWordPress自体がどのように動作するのかを知りたいので、今回は素直にコードを読むしかなさそうだ.\u003c/p\u003e\n\u003cp\u003eでは実際にディレクトリ構成を見てみよう.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-shell\"\u003e\u003ccode class=\"language-shell\"\u003eindex.php\nlicense.txt\nreadme.html\nwp-activate.php\nwp-blog-header.php\nwp-comments-post.php\nwp-config-sample.php\nwp-cron.php\nwp-links-opml.php\nwp-load.php\nwp-login.php\nwp-mail.php\nwp-settings.php\nwp-signup.php\nwp-trackback.php\nxmlrpc.php\n\u003cspan class=\"token builtin class-name\"\u003e.\u003c/span\u003e\n├── wp-admin\n│   ├── css\n│   ├── images\n│   ├── includes\n│   ├── js\n│   ├── maint\n│   ├── network\n│   └── user\n├── wp-content\n│   ├── plugins\n│   ├── themes\n│   └index.php\n└── wp-includes\n    ├── certificates\n    ├── css\n    ├── customize\n    ├── fonts\n    ├── ID3\n    ├── images\n    ├── IXR\n    ├── js\n    ├── pomo\n    ├── random_compat\n    ├── Requests\n    ├── rest-api\n    ├── SimplePie\n    ├── Text\n    ├── theme-compat\n    ├── widgets\n    └\u003cspan class=\"token punctuation\"\u003e..\u003c/span\u003e.\n\n\u003cspan class=\"token number\"\u003e28\u003c/span\u003e directories\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e構成を見つつ、このうちどれが読まなくてもいいものか考えてみよう.\u003c/p\u003e\n\u003cp\u003eまず\u003ccode\u003ewp-admin/\u003c/code\u003e. これは管理者パネル用のディレクトリだろう. CMSとしてはとりあえず読まなくても良さそうだ.\u003c/p\u003e\n\u003cp\u003e次に\u003ccode\u003ewp-content/\u003c/code\u003e配下. \u003ccode\u003eplugins/\u003c/code\u003e, \u003ccode\u003ethemes/\u003c/code\u003eは それぞれユーザインストールのプラグインとテーマ用のディレクトリだろうか.\u003cbr\u003e\n\u003ccode\u003eindex.php\u003c/code\u003eはルートディレクトリにもあったがどちらがエントリーポイントになるのだろう. テーマを読み込む処理はルーティング後に行われるだろうからとりあえずは後回しにしよう.\u003c/p\u003e\n\u003cp\u003e最後に\u003ccode\u003ewp-includes\u003c/code\u003eはどうだろう.\u003cbr\u003e\n大抵\u003ccode\u003eincludes/\u003c/code\u003eディレクトリにはシステムで利用するライブラリ等が置かれる. 読むのは必要な機能が出てきてからで良さそうだ.\u003c/p\u003e\n\u003cp\u003eつまり最初に読む必要があるのはこれらになりそうだ.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-shell\"\u003e\u003ccode class=\"language-shell\"\u003e$ tree -I \u003cspan class=\"token string\"\u003e'wp-includes|wp-admin|themes|plugins|licence|readme'\u003c/span\u003e\n\n├── index.php\n├── wp-activate.php\n├── wp-blog-header.php\n├── wp-comments-post.php\n├── wp-config-sample.php\n├── wp-content\n│   └── index.php\n├── wp-cron.php\n├── wp-links-opml.php\n├── wp-load.php\n├── wp-login.php\n├── wp-mail.php\n├── wp-settings.php\n├── wp-signup.php\n├── wp-trackback.php\n└── xmlrpc.php\n\n\u003cspan class=\"token number\"\u003e1\u003c/span\u003e directory, \u003cspan class=\"token number\"\u003e17\u003c/span\u003e files\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eでは実際の処理の流れを追っていこう.\u003c/p\u003e\n\u003cp\u003e大抵WordPressはApacheやNginx等のウェブサーバを介してPHP-FPMやFastCGIを用いてホスティングされる.\u003cbr\u003e\nApacheであれば\u003ccode\u003eDirectoryIndex\u003c/code\u003e, Nginxであれば\u003ccode\u003ehttp\u003c/code\u003eディレクティブ内の\u003ccode\u003eindex\u003c/code\u003eに、ウェブサーバにアクセスがあった時に最初にアクセスされるファイルが指定されている.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-nginx\"\u003e\u003ccode class=\"language-nginx\"\u003e\u003cspan class=\"token comment\"\u003e# nginx.conf\u003c/span\u003e\n\u003cspan class=\"token directive\"\u003e\u003cspan class=\"token keyword\"\u003ehttp\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token comment\"\u003e# ...\u003c/span\u003e\n  \u003cspan class=\"token directive\"\u003e\u003cspan class=\"token keyword\"\u003eindex\u003c/span\u003e                index.php index.html index.htm\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eなので\u003ccode\u003e/index.php\u003c/code\u003eが最初に読み込まれる.\n処理より流れを把握することを意識して実際に読んでいこう.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-php\"\u003e\u003ccode class=\"language-php\"\u003e\u003cspan class=\"token comment\"\u003e/* index.php */\u003c/span\u003e\n\u003cspan class=\"token function\"\u003edefine\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'WP_USE_THEMES'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token constant boolean\"\u003etrue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003erequire\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e \u003cspan class=\"token function\"\u003edirname\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token constant\"\u003e__FILE__\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e.\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'/wp-blog-header.php'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003ccode\u003eindex.php\u003c/code\u003eでは定数を定義して、\u003ccode\u003ewp-blog-header.php\u003c/code\u003eを読み込んでいる.\nでは\u003ccode\u003ewp-blog-header.php\u003c/code\u003eを見てみよう.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-php\"\u003e\u003ccode class=\"language-php\"\u003e\u003cspan class=\"token comment\"\u003e/* wp-blog-header.php */\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e/* Loads the WordPress environment and template. */\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e!\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eisset\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$wp_did_header\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token variable\"\u003e$wp_did_header\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token constant boolean\"\u003etrue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"token comment\"\u003e/* Load the WordPress library. */\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003erequire_once\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e \u003cspan class=\"token function\"\u003edirname\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token constant\"\u003e__FILE__\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e.\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'/wp-load.php'\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"token comment\"\u003e/* Set up the WordPress query. */\u003c/span\u003e\n  \u003cspan class=\"token function\"\u003ewp\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"token comment\"\u003e/* Load the theme template. */\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003erequire_once\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e \u003cspan class=\"token constant\"\u003eABSPATH\u003c/span\u003e \u003cspan class=\"token operator\"\u003e.\u003c/span\u003e \u003cspan class=\"token constant\"\u003eWPINC\u003c/span\u003e \u003cspan class=\"token operator\"\u003e.\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'/template-loader.php'\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cblockquote\u003e\n\u003cp\u003eLoads the WordPress environment and template.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eとあるので、\u003ccode\u003ewp-load.php\u003c/code\u003eが\"environment\"、定数やデータベースの設定を、\u003ccode\u003etemplate-loader.php\u003c/code\u003eが\"template\"、\u003ccode\u003ewp-contents/themes\u003c/code\u003eのテーマテンプレートをロードするファイルなのだろう.\u003cbr\u003e\nでは\u003ccode\u003ewp()\u003c/code\u003eは? \u003ccode\u003ewp()\u003c/code\u003eを呼ぶ前にインクルードしたファイルは\u003ccode\u003ewp-load.php\u003c/code\u003eしかないので、ここで定義されているのだろう.\u003cbr\u003e\nそして\"Set up the WordPress query.\"とはどういうことだろう.\u003cbr\u003e\n順に追っていこう.\u003c/p\u003e\n\u003ch4 id=\"wp-loadphp\"\u003e\u003ca href=\"#wp-loadphp\"\u003ewp-load.php\u003c/a\u003e\u003c/h4\u003e\n\u003cp\u003eコメントを読むと\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eABSPATHの定義\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003ewp-config.php\u003c/code\u003e, \u003ccode\u003ewp-settings.php\u003c/code\u003eのロード\n\u003cul\u003e\n\u003cli\u003eファイルが存在しなければセットアップするように表示する\nと書いてある.\nセットアップ時のエラーハンドリングもCMSの機能としては本質ではないので、ここもコメントを読んでこれくらいで次に進むようにしよう.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch4 id=\"wp-configphp\"\u003e\u003ca href=\"#wp-configphp\"\u003ewp-config.php\u003c/a\u003e\u003c/h4\u003e\n\u003cp\u003eこれは初期状態では存在しない. \u003ccode\u003ewp-config-sample.php\u003c/code\u003eをベースにセットアップ時に作成されるようだ.\nこのファイルでは\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eMySQL settings\u003c/li\u003e\n\u003cli\u003eSecret Keys\u003c/li\u003e\n\u003cli\u003eDatabase table prefix\u003c/li\u003e\n\u003cli\u003eABSPATH\nの定義がされるようだ.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003ccode\u003ewp-load.php\u003c/code\u003eでABSPATHの定義をしたはずなのに、どうしてまた定義するのだろうか?\nとりあえず全体像を確認するためにこれは置いておこう.\u003c/p\u003e\n\u003ch4 id=\"wp-settingsphp\"\u003e\u003ca href=\"#wp-settingsphp\"\u003ewp-settings.php\u003c/a\u003e\u003c/h4\u003e\n\u003cp\u003eトップレベルコメントには、\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eUsed to set up and fix common variables and include the WordPress procedural and class library\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eとあるので、基本的な関数やクラスのロードが行われるのだろう.\u003c/p\u003e\n\u003cp\u003e次に進みたいけれどまだ\u003ccode\u003ewp()\u003c/code\u003eが見つかっていない. 恐らく\u003ccode\u003ewp-settings.php\u003c/code\u003eで読み込んでいるファイルのどれかに定義されているのだろう.\u003cbr\u003e\nただこの量の\u003ccode\u003erequire\u003c/code\u003e文を全て読んでいくのはしんどい.\u003c/p\u003e\n\u003cp\u003eこんな時は\u003cstrong\u003eタグジャンプ\u003c/strong\u003eを使ってみよう.\u003cbr\u003e\nタグジャンプとは、ctagsを用いてソースコードを静的解析し、定義元のファイルを開く方法である.\nVimやSublime Textのプラグインとして公開されているものがあるので使ってみよう.\nもちろんgrepでもいい.\u003c/p\u003e\n\u003cp\u003eそうして\u003ccode\u003ewp-includes/functions.php\u003c/code\u003eに\u003ccode\u003ewp()\u003c/code\u003eを見つけた.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-php\"\u003e\u003ccode class=\"language-php\"\u003e\u003cspan class=\"token doc-comment comment\"\u003e/**\n * Set up the WordPress query.\n *\n * \u003cspan class=\"token keyword\"\u003e@since\u003c/span\u003e 2.0.0\n *\n * \u003cspan class=\"token keyword\"\u003e@global\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eWP\u003c/span\u003e       \u003cspan class=\"token parameter\"\u003e$wp_locale\u003c/span\u003e\n * \u003cspan class=\"token keyword\"\u003e@global\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eWP_Query\u003c/span\u003e \u003cspan class=\"token parameter\"\u003e$wp_query\u003c/span\u003e\n * \u003cspan class=\"token keyword\"\u003e@global\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eWP_Query\u003c/span\u003e \u003cspan class=\"token parameter\"\u003e$wp_the_query\u003c/span\u003e\n *\n * \u003cspan class=\"token keyword\"\u003e@param\u003c/span\u003e \u003cspan class=\"token class-name\"\u003e\u003cspan class=\"token keyword\"\u003estring\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e|\u003c/span\u003e\u003cspan class=\"token keyword\"\u003earray\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token parameter\"\u003e$query_vars\u003c/span\u003e Default WP_Query arguments.\n */\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token function-definition function\"\u003ewp\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$query_vars\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e''\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003eglobal\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$wp\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$wp_query\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$wp_the_query\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"token variable\"\u003e$wp\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003emain\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$query_vars\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n  \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e \u003cspan class=\"token operator\"\u003e!\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eisset\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$wp_the_query\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token variable\"\u003e$wp_the_query\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$wp_query\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eなるほど、この\u003ccode\u003e$wp\u003c/code\u003eがメインのオブジェクトなのだろう.\u003cbr\u003e\n@globalとあるので、\u003ccode\u003e$GLOBALS['wp']\u003c/code\u003eを定義している箇所を探してみよう.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-php\"\u003e\u003ccode class=\"language-php\"\u003e\u003cspan class=\"token comment\"\u003e// wp-settings.php\u003c/span\u003e\n\u003cspan class=\"token doc-comment comment\"\u003e/**\n * WordPress Object\n * \u003cspan class=\"token keyword\"\u003e@global\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eWP\u003c/span\u003e \u003cspan class=\"token parameter\"\u003e$wp\u003c/span\u003e\n * \u003cspan class=\"token keyword\"\u003e@since\u003c/span\u003e 2.0.0\n */\u003c/span\u003e\n\u003cspan class=\"token global\"\u003e$GLOBALS\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'wp'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eWP\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003ccode\u003e$wp\u003c/code\u003eの実態はclass WPのインスタンスだった.\u003cbr\u003e\n\u003ccode\u003e$wp-\u003emain( $query_vars )\u003c/code\u003eとあったので、WPクラスのmainメソッドを見てみよう.\u003cbr\u003e\nWPクラスは\u003ccode\u003ewp-includes/class-wp.php\u003c/code\u003eに定義されている.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-php\"\u003e\u003ccode class=\"language-php\"\u003e\u003cspan class=\"token doc-comment comment\"\u003e/**\n * Sets up all of the variables required by the WordPress environment.\n *\n * The action \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token keyword\"\u003e@see\u003c/span\u003e 'wp'\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e has one parameter that references the WP object. It\n * allows for accessing the properties and methods to further manipulate the\n * object.\n *\n * \u003cspan class=\"token keyword\"\u003e@param\u003c/span\u003e \u003cspan class=\"token class-name\"\u003e\u003cspan class=\"token keyword\"\u003estring\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e|\u003c/span\u003e\u003cspan class=\"token keyword\"\u003earray\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token parameter\"\u003e$query_args\u003c/span\u003e Passed to parse_request().\n */\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token function-definition function\"\u003emain\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$query_args\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e''\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token this keyword\"\u003e$this\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003einit\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"token this keyword\"\u003e$this\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eparse_request\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$query_args\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"token this keyword\"\u003e$this\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003esend_headers\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"token this keyword\"\u003e$this\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003equery_posts\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"token this keyword\"\u003e$this\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003ehandle_404\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"token this keyword\"\u003e$this\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eregister_globals\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n  \u003cspan class=\"token doc-comment comment\"\u003e/**\n   * Fires once the WordPress environment has been set up.\n   *\n   * \u003cspan class=\"token keyword\"\u003e@since\u003c/span\u003e 2.1.0\n   *\n   * \u003cspan class=\"token keyword\"\u003e@param\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eWP\u003c/span\u003e \u003cspan class=\"token parameter\"\u003e$this\u003c/span\u003e Current WordPress environment instance (passed by reference).\n   */\u003c/span\u003e\n  \u003cspan class=\"token function\"\u003edo_action_ref_array\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'wp'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003earray\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u003c/span\u003e\u003cspan class=\"token this keyword\"\u003e$this\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eようやく実態が見えてきた. ここでそれぞれのメソッドを読みたい気持ちをこらえて、最後のフェーズ、\u003ccode\u003ewp-includes/template-loader.php\u003c/code\u003eを読んでいこう.\u003c/p\u003e\n\u003ch4 id=\"template-loaderphp\"\u003e\u003ca href=\"#template-loaderphp\"\u003etemplate-loader.php\u003c/a\u003e\u003c/h4\u003e\n\u003cp\u003eまず\u003ccode\u003edo_action( 'template_redirect' )\u003c/code\u003eが目につく.\u003cbr\u003e\nコメントを見るとどのテンプレートを読むかを判断する命令を送っているようだ.\u003cbr\u003e\n\u003ccode\u003edo_action()\u003c/code\u003eは命令に応じたアクションを呼び出す関数らしい. これも後で確認してみよう.\u003c/p\u003e\n\u003cp\u003e読み進めると、elseifの分岐に圧倒されるが\u003ccode\u003eis_\u003c/code\u003eでリクエストされたページのタイプを判定して、それにあったテンプレートをレンダリングする関数を呼んでいるだけのようだ.\u003cbr\u003e\n\u003ccode\u003eis_\u003c/code\u003e系の関数が全て引数を取っていないので、先の\u003ccode\u003emain()\u003c/code\u003e関数で読んでいた\u003cbr\u003e\n\u003ccode\u003e$this-\u003eregister_globals()\u003c/code\u003eでそれらの情報もグローバル変数に定義しているのだろう.\u003c/p\u003e\n\u003cp\u003eここまで読んだ流れをまとめると次のようになる.\u003c/p\u003e\n\u003cp\u003e\u003cfigure\u003e\u003cimg src=\"./img/2018-01-10.png\" alt=\"\"\u003e\u003cfigcaption\u003eimg.1 \u003c/figcaption\u003e\u003c/figure\u003e\u003c/p\u003e\n\u003ch4 id=\"終わりに\"\u003e\u003ca href=\"#終わりに\"\u003e終わりに\u003c/a\u003e\u003c/h4\u003e\n\u003cp\u003eこれで予想も交えながらではあったが処理の流れをさらうことができた.\u003cbr\u003e\n内容の確認よりも確認する手順を自分の思考とともに紹介することに重きをおいたので、課題がそのまま残っている. 良かったら読んで教えて欲しい.\u003c/p\u003e\n\u003ch3 id=\"reference\"\u003e\u003ca href=\"#reference\"\u003ereference\u003c/a\u003e\u003c/h3\u003e\n\u003csection data-footnotes class=\"footnotes\"\u003e\u003ch2 id=\"footnote-label\" class=\"sr-only\"\u003e\u003ca href=\"#footnote-label\"\u003eFootnotes\u003c/a\u003e\u003c/h2\u003e\n\u003col\u003e\n\u003cli id=\"user-content-fn-1\"\u003e\n\u003cp\u003e\u003ca href=\"https://ja.wikipedia.org/wiki/%E3%83%95%E3%83%AA%E3%83%83%E3%83%97%E3%83%95%E3%83%AD%E3%83%83%E3%83%97#D%E5%9E%8B%E3%83%95%E3%83%AA%E3%83%83%E3%83%97%E3%83%95%E3%83%AD%E3%83%83%E3%83%97\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003ewikipedia\u003c/a\u003e \u003ca href=\"#user-content-fnref-1\" data-footnote-backref class=\"data-footnote-backref\" aria-label=\"Back to content\"\u003e↩\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli id=\"user-content-fn-2\"\u003e\n\u003cp\u003eWordPress/ver.4.9 \u003ca href=\"#user-content-fnref-2\" data-footnote-backref class=\"data-footnote-backref\" aria-label=\"Back to content\"\u003e↩\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/section\u003e","description":"How to read source code with an example","commits":[{"title":"tweak ogp","date":"2021-04-22 15:12:31","hash":"cd43e57e","diff":"\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"cd43e57e.patch\" class=\"language-git  language-diff\"\u003e\u003ccode class=\"language-git\"\u003e\u003cspan class=\"token commit-sha1\"\u003ecommit cd43e57eef247d695ae5d7ec91dd77bdd26b3d1d\u003c/span\u003e\nAuthor: koka \u0026#x26;\u003ca href=\"mailto:lt;koka.code@gmail.com\" class=\"token email-link\"\u003elt;koka.code@gmail.com\u003c/a\u003e\u0026#x26;gt;\nDate:   Thu Apr 22 15:12:31 2021 +0900\n\n  tweak ogp\n\ndiff --git a/_posts/2018-01-09-reading-wordpress.md b/_posts/2018-01-09-reading-wordpress.md\nindex f6c20d2..d0792b0 100644\n\u003cspan class=\"token deleted\"\u003e--- a/_posts/2018-01-09-reading-wordpress.md\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+++ b/_posts/2018-01-09-reading-wordpress.md\u003c/span\u003e\n@@ -3,7 +3,7 @@ title: reading wordpress\ndate: 2018-01-09\ncategories:\n\u003cspan class=\"token deleted\"\u003e- Code Reading\u003c/span\u003e\n\u003cspan class=\"token deleted\"\u003e-image: /img/2018-01-10-thumb.png\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+image: 2018-01-10-thumb.png\u003c/span\u003e\ntags:\n - Wordpress\ndescription: How to read source code with an example\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e"},{"title":"tweak","date":"2021-04-22 01:20:00","hash":"fabe928f","diff":"\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"fabe928f.patch\" class=\"language-git  language-diff\"\u003e\u003ccode class=\"language-git\"\u003e\u003cspan class=\"token commit-sha1\"\u003ecommit fabe928f5f60875b34ca333ba1bd5f4c21c143d1\u003c/span\u003e\nAuthor: koka \u0026#x26;\u003ca href=\"mailto:lt;koka.code@gmail.com\" class=\"token email-link\"\u003elt;koka.code@gmail.com\u003c/a\u003e\u0026#x26;gt;\nDate:   Thu Apr 22 01:20:00 2021 +0900\n\n  tweak\n\ndiff --git a/_posts/2018-01-09-reading-wordpress.md b/_posts/2018-01-09-reading-wordpress.md\nindex 4934b7f..f6c20d2 100644\n\u003cspan class=\"token deleted\"\u003e--- a/_posts/2018-01-09-reading-wordpress.md\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+++ b/_posts/2018-01-09-reading-wordpress.md\u003c/span\u003e\n@@ -3,7 +3,7 @@ title: reading wordpress\ndate: 2018-01-09\ncategories:\n\u003cspan class=\"token deleted\"\u003e- Code Reading\u003c/span\u003e\n\u003cspan class=\"token deleted\"\u003e-image: /assets/img/2018-01-10-thumb.png\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+image: /img/2018-01-10-thumb.png\u003c/span\u003e\ntags:\n - Wordpress\ndescription: How to read source code with an example\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e"},{"title":"copy md","date":"2021-01-30 22:18:17","hash":"35b550ae","diff":"\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"35b550ae.patch\" class=\"language-git  language-diff\"\u003e\u003ccode class=\"language-git\"\u003e\u003cspan class=\"token commit-sha1\"\u003ecommit 35b550ae83af4efaeadf33471c8ca8a32c1079c8\u003c/span\u003e\nAuthor: koka \u0026#x26;\u003ca href=\"mailto:lt;koka.code@gmail.com\" class=\"token email-link\"\u003elt;koka.code@gmail.com\u003c/a\u003e\u0026#x26;gt;\nDate:   Sat Jan 30 22:18:17 2021 +0900\n\n  copy md\n\ndiff --git a/_posts/2018-01-09-reading-wordpress.md b/_posts/2018-01-09-reading-wordpress.md\nnew file mode 100644\nindex 0000000..4934b7f\n\u003cspan class=\"token deleted\"\u003e--- /dev/null\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+++ b/_posts/2018-01-09-reading-wordpress.md\u003c/span\u003e\n\u003cspan class=\"token coord\"\u003e@@ -0,0 +1,334 @@\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+---\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+title: reading wordpress\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+date: 2018-01-09\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+categories:\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- Code Reading\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+image: /assets/img/2018-01-10-thumb.png\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+tags:\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  - Wordpress\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+description: How to read source code with an example\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+---\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+友人からコードリーディングの方法について聞かれたので,僕自身もCSバックグラウンドではないけれどソースコードの読み方を説明しようと思う.  \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+以下友人向け文体.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+途中でプロジェクトにアサインされた時、過去の自分のコードをリファクタリングする時、OSSのコードを読む時など、ある程度の規模のソースコードを読む機会があると思う.  \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+サーバーだったりコマンドラインツールだったり,言語も責務も異なる様々なプログラムを読む際に一貫した読み方はあるのだろうか.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+完全な解はないと思うが、僕個人の経験からすると、\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- 抽象化・抽象度を意識すること\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- 読まないこと\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+これらを意識するだけででソースコードはだいぶ読みやすくなる.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+抽象化・抽象度を意識するとはどういうことか.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+具体的に言うと、自分が今、全体の処理の流れのうち、どの部分を読んでいるかを意識することである。\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+僕らは普段プログラムを書くためにOSを使っているけれど、OSは実際どんなことをしてくれているのか.  \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+プログラムをコンパイラに喰わせると実行可能なファイルを吐いてくれるけれど、内部ではなにをしているのか.  \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+CPUはフリップフロップ[^1]という素子からできているし、フリップフロップは半導体からできている.  \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+けれど、プログラムを組む上で僕らはそんなこと気にする必要がない.  \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+これが抽象化である. 内部構造を隠蔽し、表に見えるのはユーザが触って良い部分だけ.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+注意して欲しいのが、ここで言うユーザは必ずしも人間だけではないということ.  \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+例えば実行中のプログラムがメモリの状態を知りたい時、直接メモリを参照するのは無理がある.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+実行中のプログラムからメモリまでには以下のような層がある.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e++-----+    +-----+    +-----------+    +---------+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+| mem | == | CPU | == | kernel/OS | == | program |\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e++-----+    +-----+    +-----------+    +---------+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ではどうするか. 見えないものは下の層が知っているかもしれない.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+OSにメモリの使用状況を尋ねる命令を送るのである.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+上の例では物理的に層が分かれていたので抽象化の区切りが分かりやすかったが、ソフトウェアの構成も同様に抽象化が行われている.  \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ソフトウェアのコードを読む時にも、自分が今メモリを見ているのかOSの命令を見ているのか、また隠蔽されている処理なのか、表に見えている部分なのか、どのレベルを見ているのかを意識することが必要なのがわかると思う.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+次に、読まないこと.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+これは**読むべき情報以外を読まない**という意味.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+全体像を知る、というのは全部を知ることではない. 上の話でも言ったように、基本的にソフトウェアは抽象化の繰り返しで構成されている.  \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+つまり、自分が欲しい情報の層に立った時に、表に見える情報以外は読まなくていい.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+OSがどうなっているか知りたいのにメモリを分解してみてもどうにもならない.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+恐らくソースコードを読むことに慣れているエンジニアはこれらを無意識に行っている.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+そのため同じ抽象度のものを見る時に,自分の培ったパターンを当てはめることができ、更に自分がコードを書く際に、同様の設計で実装することが出来る.  \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+プロジェクトが書けるエンジニアは読む力もある.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+以上を踏まえてWordPressのソースコード[^2]を読んでみよう.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+まずなにを知りたいか.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ここでは全体的な構成とCMSとしての処理の流れを把握することを目標としてみよう.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+全体構成を把握する場合、複数の層の責務を把握する必要があるため、特に**読まない**ことが重要である.  \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+コードを実際に読む前に、まずは公式サイトやリファレンスに書いていないか確認してみよう.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+リファレンスがダメならコメントだ. \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+公式に[ディレクトリ階層](http://wpdocs.osdn.jp/%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88%E9%9A%8E%E5%B1%A4)というページがある.   \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+見てみるとこれは自作テーマにおけるディレクトリ階層のようだ. 今回はWordPress自体がどのように動作するのかを知りたいので、今回は素直にコードを読むしかなさそうだ.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+では実際にディレクトリ構成を見てみよう.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```shell\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+index.php\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+license.txt\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+readme.html\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+wp-activate.php\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+wp-blog-header.php\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+wp-comments-post.php\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+wp-config-sample.php\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+wp-cron.php\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+wp-links-opml.php\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+wp-load.php\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+wp-login.php\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+wp-mail.php\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+wp-settings.php\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+wp-signup.php\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+wp-trackback.php\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+xmlrpc.php\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+├── wp-admin\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+│   ├── css\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+│   ├── images\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+│   ├── includes\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+│   ├── js\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+│   ├── maint\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+│   ├── network\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+│   └── user\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+├── wp-content\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+│   ├── plugins\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+│   ├── themes\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+│   └index.php\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+└── wp-includes\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    ├── certificates\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    ├── css\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    ├── customize\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    ├── fonts\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    ├── ID3\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    ├── images\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    ├── IXR\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    ├── js\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    ├── pomo\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    ├── random_compat\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    ├── Requests\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    ├── rest-api\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    ├── SimplePie\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    ├── Text\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    ├── theme-compat\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    ├── widgets\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    └...\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+28 directories\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+構成を見つつ、このうちどれが読まなくてもいいものか考えてみよう.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+まず`wp-admin/`. これは管理者パネル用のディレクトリだろう. CMSとしてはとりあえず読まなくても良さそうだ.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+次に`wp-content/`配下. `plugins/`, `themes/`は それぞれユーザインストールのプラグインとテーマ用のディレクトリだろうか.  \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+`index.php`はルートディレクトリにもあったがどちらがエントリーポイントになるのだろう. テーマを読み込む処理はルーティング後に行われるだろうからとりあえずは後回しにしよう.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+最後に`wp-includes`はどうだろう.  \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+大抵`includes/`ディレクトリにはシステムで利用するライブラリ等が置かれる. 読むのは必要な機能が出てきてからで良さそうだ.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+つまり最初に読む必要があるのはこれらになりそうだ.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```shell\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+$ tree -I 'wp-includes|wp-admin|themes|plugins|licence|readme'\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+├── index.php\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+├── wp-activate.php\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+├── wp-blog-header.php\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+├── wp-comments-post.php\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+├── wp-config-sample.php\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+├── wp-content\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+│   └── index.php\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+├── wp-cron.php\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+├── wp-links-opml.php\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+├── wp-load.php\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+├── wp-login.php\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+├── wp-mail.php\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+├── wp-settings.php\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+├── wp-signup.php\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+├── wp-trackback.php\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+└── xmlrpc.php\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+1 directory, 17 files\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+では実際の処理の流れを追っていこう.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+大抵WordPressはApacheやNginx等のウェブサーバを介してPHP-FPMやFastCGIを用いてホスティングされる.  \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+Apacheであれば`DirectoryIndex`, Nginxであれば`http`ディレクティブ内の`index`に、ウェブサーバにアクセスがあった時に最初にアクセスされるファイルが指定されている.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```nginx\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+# nginx.conf\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+http {\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  # ...\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  index                index.php index.html index.htm;\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+}\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+なので`/index.php`が最初に読み込まれる.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+処理より流れを把握することを意識して実際に読んでいこう.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```php\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+/* index.php */\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+define('WP_USE_THEMES', true);\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+require( dirname(__FILE__).'/wp-blog-header.php');\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+`index.php`では定数を定義して、`wp-blog-header.php`を読み込んでいる.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+では`wp-blog-header.php`を見てみよう.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```php\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+/* wp-blog-header.php */\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+/* Loads the WordPress environment and template. */\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+if (!isset($wp_did_header)) {\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  $wp_did_header = true;\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  /* Load the WordPress library. */\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  require_once( dirname(__FILE__) . '/wp-load.php' );\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  /* Set up the WordPress query. */\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  wp();\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  /* Load the theme template. */\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  require_once( ABSPATH . WPINC . '/template-loader.php' );\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+}\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u0026#x26;gt; Loads the WordPress environment and template.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+とあるので、`wp-load.php`が\"environment\"、定数やデータベースの設定を、`template-loader.php`が\"template\"、`wp-contents/themes`のテーマテンプレートをロードするファイルなのだろう.  \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+では`wp()`は? `wp()`を呼ぶ前にインクルードしたファイルは`wp-load.php`しかないので、ここで定義されているのだろう.  \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+そして\"Set up the WordPress query.\"とはどういうことだろう.  \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+順に追っていこう.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+#### wp-load.php\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+コメントを読むと\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- ABSPATHの定義\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- `wp-config.php`, `wp-settings.php`のロード\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  - ファイルが存在しなければセットアップするように表示する\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+と書いてある.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+セットアップ時のエラーハンドリングもCMSの機能としては本質ではないので、ここもコメントを読んでこれくらいで次に進むようにしよう.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+#### wp-config.php\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+これは初期状態では存在しない. `wp-config-sample.php`をベースにセットアップ時に作成されるようだ.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+このファイルでは\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- MySQL settings\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- Secret Keys\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- Database table prefix\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- ABSPATH\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+の定義がされるようだ.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+`wp-load.php`でABSPATHの定義をしたはずなのに、どうしてまた定義するのだろうか?\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+とりあえず全体像を確認するためにこれは置いておこう.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+#### wp-settings.php\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+トップレベルコメントには、\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u0026#x26;gt; Used to set up and fix common variables and include the WordPress procedural and class library\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+とあるので、基本的な関数やクラスのロードが行われるのだろう.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+次に進みたいけれどまだ`wp()`が見つかっていない. 恐らく`wp-settings.php`で読み込んでいるファイルのどれかに定義されているのだろう.   \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ただこの量の`require`文を全て読んでいくのはしんどい.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+こんな時は**タグジャンプ**を使ってみよう.  \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+タグジャンプとは、ctagsを用いてソースコードを静的解析し、定義元のファイルを開く方法である.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+VimやSublime Textのプラグインとして公開されているものがあるので使ってみよう.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+もちろんgrepでもいい.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+そうして`wp-includes/functions.php`に`wp()`を見つけた.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```php\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+/**\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ * Set up the WordPress query.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ *\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ * @since 2.0.0\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ *\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ * @global WP       $wp_locale\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ * @global WP_Query $wp_query\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ * @global WP_Query $wp_the_query\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ *\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ * @param string|array $query_vars Default WP_Query arguments.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ */\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+function wp( $query_vars = '' ) {\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  global $wp, $wp_query, $wp_the_query;\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  $wp-\u0026#x26;gt;main( $query_vars );\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  if ( !isset($wp_the_query) )\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    $wp_the_query = $wp_query;\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+}\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+なるほど、この`$wp`がメインのオブジェクトなのだろう.   \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+@globalとあるので、`$GLOBALS['wp']`を定義している箇所を探してみよう.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```php\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+// wp-settings.php\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+/**\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ * WordPress Object\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ * @global WP $wp\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ * @since 2.0.0\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ */\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+$GLOBALS['wp'] = new WP();\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+`$wp`の実態はclass WPのインスタンスだった.  \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+`$wp-\u0026#x26;gt;main( $query_vars )`とあったので、WPクラスのmainメソッドを見てみよう.  \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+WPクラスは`wp-includes/class-wp.php`に定義されている.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```php\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+/**\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ * Sets up all of the variables required by the WordPress environment.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ *\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ * The action {@see 'wp'} has one parameter that references the WP object. It\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ * allows for accessing the properties and methods to further manipulate the\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ * object.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ *\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ * @param string|array $query_args Passed to parse_request().\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ */\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+public function main($query_args = '') {\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  $this-\u0026#x26;gt;init();\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  $this-\u0026#x26;gt;parse_request($query_args);\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  $this-\u0026#x26;gt;send_headers();\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  $this-\u0026#x26;gt;query_posts();\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  $this-\u0026#x26;gt;handle_404();\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  $this-\u0026#x26;gt;register_globals();\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  /**\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+   * Fires once the WordPress environment has been set up.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+   *\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+   * @since 2.1.0\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+   *\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+   * @param WP $this Current WordPress environment instance (passed by reference).\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+   */\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  do_action_ref_array( 'wp', array( \u0026#x26;$this ) );\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+}\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ようやく実態が見えてきた. ここでそれぞれのメソッドを読みたい気持ちをこらえて、最後のフェーズ、`wp-includes/template-loader.php`を読んでいこう.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+#### template-loader.php\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+まず`do_action( 'template_redirect' )`が目につく.   \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+コメントを見るとどのテンプレートを読むかを判断する命令を送っているようだ.   \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+`do_action()`は命令に応じたアクションを呼び出す関数らしい. これも後で確認してみよう.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+読み進めると、elseifの分岐に圧倒されるが`is_`でリクエストされたページのタイプを判定して、それにあったテンプレートをレンダリングする関数を呼んでいるだけのようだ.   \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+`is_`系の関数が全て引数を取っていないので、先の`main()`関数で読んでいた  \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+`$this-\u0026#x26;gt;register_globals()`でそれらの情報もグローバル変数に定義しているのだろう.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+ここまで読んだ流れをまとめると次のようになる.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+![](./img/2018-01-10.png)\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+#### 終わりに\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+これで予想も交えながらではあったが処理の流れをさらうことができた.  \u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+内容の確認よりも確認する手順を自分の思考とともに紹介することに重きをおいたので、課題がそのまま残っている. 良かったら読んで教えて欲しい.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+### reference\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+[^1]: [wikipedia](https://ja.wikipedia.org/wiki/%E3%83%95%E3%83%AA%E3%83%83%E3%83%97%E3%83%95%E3%83%AD%E3%83%83%E3%83%97#D%E5%9E%8B%E3%83%95%E3%83%AA%E3%83%83%E3%83%97%E3%83%95%E3%83%AD%E3%83%83%E3%83%97)\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+[^2]: WordPress/ver.4.9\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e"}],"publishedAt":"2018-01-09","updatedAt":"2021-04-22"}},"__N_SSG":true},"page":"/archives/[slug]","query":{"slug":"2018-01-09-reading-wordpress"},"buildId":"-5kDKO-iBXqcRsFR54_iY","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>