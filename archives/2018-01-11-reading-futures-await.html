<!DOCTYPE html><html lang="en"><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><meta name="theme-color" content="#ddd4bb"/><meta property="og:type" content="website"/><meta property="og:url" content="https://koka831.github.io"/><meta property="og:site_name" content="/var/log/koka"/><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="/var/log/koka"/><meta name="twitter:site" content="@k_0ka"/><meta name="twitter:description" content="cat /var/log/koka &gt; /dev/null"/><link rel="alternate" type="application/rss+xml" href="https://koka831.github.io/feed.xml" title="/var/log/koka RSS2.0"/><title>memo:reading futures-await | /var/log/koka</title><meta property="title" content="memo:reading futures-await | /var/log/koka"/><meta property="og:title" content="memo:reading futures-await | /var/log/koka"/><meta property="twitter:title" content="memo:reading futures-await | /var/log/koka"/><meta property="description" content="memo"/><meta property="og:description" content="memo"/><meta property="twitter:description" content="memo"/><meta property="og:image" content="https://koka831.github.io/img/icon.png"/><meta name="next-head-count" content="19"/><link rel="preload" href="/_next/static/css/fec7387515ee4d96.css" as="style"/><link rel="stylesheet" href="/_next/static/css/fec7387515ee4d96.css" data-n-g=""/><link rel="preload" href="/_next/static/css/9a908afc1d99510a.css" as="style"/><link rel="stylesheet" href="/_next/static/css/9a908afc1d99510a.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-9b312e20a4e32339.js" defer=""></script><script src="/_next/static/chunks/framework-5f4595e5518b5600.js" defer=""></script><script src="/_next/static/chunks/main-a054bbf31fb90f6a.js" defer=""></script><script src="/_next/static/chunks/pages/_app-e0fcf5a3a528e4c5.js" defer=""></script><script src="/_next/static/chunks/cb1608f2-ecfb8d9b659208e2.js" defer=""></script><script src="/_next/static/chunks/956-010db0f3f1d0c7bc.js" defer=""></script><script src="/_next/static/chunks/291-9c5c86f482a4e495.js" defer=""></script><script src="/_next/static/chunks/pages/archives/%5Bslug%5D-c119bff926c7db42.js" defer=""></script><script src="/_next/static/eMY6Po_c-RqT9Ravp8enm/_buildManifest.js" defer=""></script><script src="/_next/static/eMY6Po_c-RqT9Ravp8enm/_ssgManifest.js" defer=""></script><script src="/_next/static/eMY6Po_c-RqT9Ravp8enm/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><nav class="Header_navigation__container__Xjar7"><div class="Header_navigation__qZpeO"><a href="/">/var/log/koka</a></div><div><a href="/archives">archive</a></div></nav><main class="Layout_container__LBFOo"><div class="slug_container__f_fjw"><div class="slug_main__WMOpC"><article class="slug_article__cOl2p" role="article"><div itemscope="" class="ArticleHeader_header__container__5Gs_X"><a class="ArticleHeader_post__title__gVFje" href="/archives/2018-01-11-reading-futures-await">memo:reading futures-await</a><p>memo</p><div class="ArticleHeader_flex__yDiMS"><div class="ArticleHeader_post__tags__uCQyx"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="tags" class="svg-inline--fa fa-tags ArticleHeader_tags__icon__U9c_O" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M472.8 168.4C525.1 221.4 525.1 306.6 472.8 359.6L360.8 472.9C351.5 482.3 336.3 482.4 326.9 473.1C317.4 463.8 317.4 448.6 326.7 439.1L438.6 325.9C472.5 291.6 472.5 236.4 438.6 202.1L310.9 72.87C301.5 63.44 301.6 48.25 311.1 38.93C320.5 29.61 335.7 29.7 344.1 39.13L472.8 168.4zM.0003 229.5V80C.0003 53.49 21.49 32 48 32H197.5C214.5 32 230.7 38.74 242.7 50.75L410.7 218.7C435.7 243.7 435.7 284.3 410.7 309.3L277.3 442.7C252.3 467.7 211.7 467.7 186.7 442.7L18.75 274.7C6.743 262.7 0 246.5 0 229.5L.0003 229.5zM112 112C94.33 112 80 126.3 80 144C80 161.7 94.33 176 112 176C129.7 176 144 161.7 144 144C144 126.3 129.7 112 112 112z"></path></svg><p class="Tag_tag__rl8WL">Rust</p></div><div class="ArticleHeader_post__dates__6uEwt"><time dateTime="2018-01-11" itemProp="datePublished" class="PublishDate_post__date__jhH_w">published: <!-- -->2018-01-11</time><time dateTime="2021-01-30" itemProp="datePublished" class="PublishDate_post__date__jhH_w">updated: 2021-01-30</time></div></div></div><div class="slug_article__body__m2pRS"><p><a href="https://github.com/alexcrichton/futures-rs" target="_blank" rel="nofollow noopener noreferrer">futures-rs</a> is a libary allows zero cost abstruction of state machine; <code>Future</code> trait in Rust.</p>
<p>futures-await provides Async/await syntax for <code>futures-rs</code>.</p>
<h2 id="async"><a href="#async">#[async]</a></h2>
<p>make it returns future instead of result.</p>
<div class="remark-highlight"><pre class="language-rust"><code class="language-rust"><span class="token attribute attr-name">#[async]</span> <span class="token comment">// tagged with #[async] option</span>
<span class="token keyword">fn</span> <span class="token function-definition function">fetch</span><span class="token punctuation">(</span>c<span class="token punctuation">:</span> <span class="token class-name">Client</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&#x3C;</span><span class="token class-name">T</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token keyword">await</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span> <span class="token comment">// Optional</span>
  <span class="token keyword">if</span> <span class="token operator">!</span>res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_success</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Err }</span>

<span class="token punctuation">}</span>
</code></pre></div>
<h2 id="async_stream"><a href="#async_stream">#[async_stream]</a></h2>
<p>stream instead of future</p>
<div class="remark-highlight"><pre class="language-rust"><code class="language-rust"><span class="token attribute attr-name">#[async_stream(item=T)]</span>
<span class="token keyword">for</span> s <span class="token keyword">in</span> <span class="token class-name">T</span> <span class="token punctuation">{</span>
  <span class="token punctuation">...</span>
  <span class="token macro property">stream_yield!</span><span class="token punctuation">(</span><span class="token keyword">await</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div>
<h2 id="await-macro"><a href="#await-macro">await! macro</a></h2>
<p><code>await!</code> macro allows blocking the procedure until completion, not blocking the thread.</p>
<p>it behaves like a function returns <code>Result(e)</code></p>
<p>here is a brief procedure of <code>await!</code> macro.</p>
<div class="remark-highlight"><pre class="language-rust"><code class="language-rust"><span class="token macro property">macro_rules!</span> <span class="token keyword">await</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token keyword">mut</span> future <span class="token operator">=</span> <span class="token variable">$e</span>
  <span class="token keyword">loop</span> <span class="token punctuation">{</span>
    <span class="token keyword">match</span> <span class="token function">poll</span><span class="token punctuation">(</span><span class="token operator">&#x26;</span><span class="token keyword">mut</span> future<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">Ready</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">break</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">NotReady</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// continue and wait</span>
      <span class="token class-name">Err</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token class-name">Err</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// block until NotReady -> Ready(e)</span>
  <span class="token keyword">yield</span> <span class="token namespace">futures<span class="token punctuation">::</span></span><span class="token class-name">Async</span><span class="token punctuation">::</span><span class="token class-name">NotReady</span>
<span class="token punctuation">}</span>
</code></pre></div>
<h2 id="async_block-macro"><a href="#async_block-macro">async_block! macro</a></h2>
<p>it doesn't need a dedicated function like <code>#[async]</code>, (I think it's a like <code>thread::spawn()</code>, so it can be run with <code>core.run(Fn(async_block!))</code>)</p>
<div class="remark-highlight"><pre class="language-rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">spawn</span><span class="token operator">&#x3C;</span><span class="token class-name">F</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">(</span>f<span class="token punctuation">:</span> <span class="token class-name">F</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">JoinHandle</span><span class="token operator">&#x3C;</span><span class="token class-name">T</span><span class="token operator">></span>
  <span class="token keyword">where</span> <span class="token class-name">F</span><span class="token punctuation">:</span> <span class="token class-name">FnOnce</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">T</span><span class="token punctuation">,</span>
  <span class="token class-name">F</span><span class="token punctuation">:</span> <span class="token class-name">Send</span> <span class="token operator">+</span> <span class="token lifetime-annotation symbol">'static</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Send</span> <span class="token operator">+</span> <span class="token lifetime-annotation symbol">'static</span>

</code></pre></div>
<p>here's the brief internal procedure of async_block macro.</p>
<div class="remark-highlight"><pre class="language-rust"><code class="language-rust"><span class="token attribute attr-name">#[proc_macro]</span>
<span class="token keyword">fn</span> <span class="token function-definition function">async_block</span><span class="token punctuation">(</span>i<span class="token punctuation">:</span> <span class="token class-name">TokenStream</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">TokenStream</span> <span class="token punctuation">{</span>
  <span class="token comment">// input -> TokenTree -> TokenStream -> parse -> TokenStream</span>
  <span class="token keyword">let</span> input <span class="token operator">=</span> <span class="token class-name">TokenStream</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token class-name">TokenTree</span> <span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token punctuation">,</span>
    <span class="token comment">// parse input as token node</span>
    <span class="token punctuation">...</span><span class="token punctuation">,</span> kind<span class="token punctuation">:</span> <span class="token class-name">TokenNode</span><span class="token punctuation">::</span><span class="token class-name">Group</span><span class="token punctuation">(</span><span class="token class-name">Delimiter</span><span class="token punctuation">::</span><span class="token class-name">Brace</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">let</span> expr <span class="token operator">=</span> <span class="token namespace">syn<span class="token punctuation">::</span></span><span class="token function">parse</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span>

  <span class="token comment">// token construction..</span>
  token<span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// return Stream</span>
<span class="token punctuation">}</span>
</code></pre></div>
<h2 id="nightly-features"><a href="#nightly-features">nightly features</a></h2>
<ul>
<li><a href="https://github.com/rust-lang/rust/issues/43122" target="_blank" rel="nofollow noopener noreferrer">generators</a></li>
<li><a href="https://github.com/rust-lang/rust/issues/35896" target="_blank" rel="nofollow noopener noreferrer">proc_macro</a></li>
<li><a href="https://github.com/rust-lang/rust/issues/42183" target="_blank" rel="nofollow noopener noreferrer">conservative_impl_trait</a></li>
</ul></div></article><div class="CommitLogs_commit_logs__W6xPi" role="log"><h2>Commits</h2><details><summary><span class="CommitLogs_commit__date___q8bm">2021-01-30 22:18:17</span><span class="CommitLogs_commit__hash__Xyu7v">35b550ae</span><span class="CommitLogs_commit__message__IGUPv">copy md</span></summary><div><div class="remark-highlight"><pre data-file="35b550ae.patch" class="language-git  language-diff"><code class="language-git"><span class="token commit-sha1">commit 35b550ae83af4efaeadf33471c8ca8a32c1079c8</span>
Author: koka &#x26;<a href="mailto:lt;koka.code@gmail.com" class="token email-link">lt;koka.code@gmail.com</a>&#x26;gt;
Date:   Sat Jan 30 22:18:17 2021 +0900

  copy md

diff --git a/_posts/2018-01-11-reading-futures-await.md b/_posts/2018-01-11-reading-futures-await.md
new file mode 100644
index 0000000..6e034f0
<span class="token deleted">--- /dev/null</span>
<span class="token inserted">+++ b/_posts/2018-01-11-reading-futures-await.md</span>
<span class="token coord">@@ -0,0 +1,93 @@</span>
<span class="token inserted">+---</span>
<span class="token inserted">+title: memo:reading futures-await</span>
<span class="token inserted">+date: 2018-01-11</span>
<span class="token inserted">+categories:</span>
<span class="token inserted">+- Code Reading</span>
<span class="token inserted">+tags:</span>
<span class="token inserted">+  - Rust</span>
<span class="token inserted">+description: memo</span>
<span class="token inserted">+---</span>
<span class="token inserted">+</span>
<span class="token inserted">+[futures-rs](https://github.com/alexcrichton/futures-rs) is a libary allows zero cost abstruction of state machine; `Future` trait in Rust.</span>
<span class="token inserted">+</span>
<span class="token inserted">+futures-await provides Async/await syntax for `futures-rs`.</span>
<span class="token inserted">+</span>
<span class="token inserted">+</span>
<span class="token inserted">+## #[async]</span>
<span class="token inserted">+make it returns future instead of result.</span>
<span class="token inserted">+</span>
<span class="token inserted">+\```rust</span>
<span class="token inserted">+#[async] // tagged with #[async] option</span>
<span class="token inserted">+fn fetch(c: Client) -&#x26;gt; Result&#x26;lt;T&#x26;gt; {</span>
<span class="token inserted">+  let res = await!()?; // Optional</span>
<span class="token inserted">+  if !res.status().is_success() { // Err }</span>
<span class="token inserted">+</span>
<span class="token inserted">+}</span>
<span class="token inserted">+\```</span>
<span class="token inserted">+</span>
<span class="token inserted">+## #[async_stream]</span>
<span class="token inserted">+stream instead of future</span>
<span class="token inserted">+</span>
<span class="token inserted">+\```rust</span>
<span class="token inserted">+#[async_stream(item=T)]</span>
<span class="token inserted">+for s in T {</span>
<span class="token inserted">+  ...</span>
<span class="token inserted">+  stream_yield!(await!(..))</span>
<span class="token inserted">+}</span>
<span class="token inserted">+\```</span>
<span class="token inserted">+</span>
<span class="token inserted">+## await! macro</span>
<span class="token inserted">+`await!` macro allows blocking the procedure until completion, not blocking the thread.</span>
<span class="token inserted">+</span>
<span class="token inserted">+it behaves like a function returns `Result(e)`</span>
<span class="token inserted">+</span>
<span class="token inserted">+</span>
<span class="token inserted">+here is a brief procedure of `await!` macro.</span>
<span class="token inserted">+</span>
<span class="token inserted">+\```rust</span>
<span class="token inserted">+macro_rules! await {</span>
<span class="token inserted">+  let mut future = $e</span>
<span class="token inserted">+  loop {</span>
<span class="token inserted">+    match poll(&#x26;mut future) {</span>
<span class="token inserted">+      Ok(Ready(e)) =&#x26;gt; break Ok(e),</span>
<span class="token inserted">+      Ok(NotReady) =&#x26;gt; {}, // continue and wait</span>
<span class="token inserted">+      Err(e) =&#x26;gt; Err(e)</span>
<span class="token inserted">+    }</span>
<span class="token inserted">+  }</span>
<span class="token inserted">+  // block until NotReady -&#x26;gt; Ready(e)</span>
<span class="token inserted">+  yield futures::Async::NotReady</span>
<span class="token inserted">+}</span>
<span class="token inserted">+\```</span>
<span class="token inserted">+</span>
<span class="token inserted">+## async_block! macro</span>
<span class="token inserted">+it doesn't need a dedicated function like `#[async]`, (I think it's a like `thread::spawn()`, so it can be run with `core.run(Fn(async_block!))`)</span>
<span class="token inserted">+</span>
<span class="token inserted">+\```rust</span>
<span class="token inserted">+pub fn spawn&#x26;lt;F, T&#x26;gt;(f: F) -&#x26;gt; JoinHandle&#x26;lt;T&#x26;gt;</span>
<span class="token inserted">+  where F: FnOnce() -&#x26;gt; T,</span>
<span class="token inserted">+  F: Send + 'static, T: Send + 'static</span>
<span class="token inserted">+</span>
<span class="token inserted">+\```</span>
<span class="token inserted">+</span>
<span class="token inserted">+here's the brief internal procedure of async_block macro.</span>
<span class="token inserted">+</span>
<span class="token inserted">+\```rust</span>
<span class="token inserted">+#[proc_macro]</span>
<span class="token inserted">+fn async_block(i: TokenStream) -&#x26;gt; TokenStream {</span>
<span class="token inserted">+  // input -&#x26;gt; TokenTree -&#x26;gt; TokenStream -&#x26;gt; parse -&#x26;gt; TokenStream</span>
<span class="token inserted">+  let input = TokenStream::from(TokenTree {...,</span>
<span class="token inserted">+    // parse input as token node</span>
<span class="token inserted">+    ..., kind: TokenNode::Group(Delimiter::Brace, i)})</span>
<span class="token inserted">+</span>
<span class="token inserted">+  let expr = syn::parse(input)</span>
<span class="token inserted">+</span>
<span class="token inserted">+  // token construction..</span>
<span class="token inserted">+  token.into() // return Stream</span>
<span class="token inserted">+}</span>
<span class="token inserted">+\```</span>
<span class="token inserted">+</span>
<span class="token inserted">+## nightly features</span>
<span class="token inserted">+- [generators](https://github.com/rust-lang/rust/issues/43122)</span>
<span class="token inserted">+- [proc_macro](https://github.com/rust-lang/rust/issues/35896)</span>
<span class="token inserted">+- [conservative_impl_trait](https://github.com/rust-lang/rust/issues/42183)</span>
<span class="token inserted">+</span>
</code></pre></div></div></details></div><div class="Comments_comment__WxfzD" role="comment"><h2 class="Comments_title__YENiL">Comments</h2><div id="github-comment-container"></div></div></div><aside class="slug_aside__gL3UH"><nav class="Toc_toc__nav__rl0h7" role="navigation"><ul class="Toc_toc__Y4dWA"></ul></nav></aside></div></main><footer class="Footer_footer__FDcZZ"><small>Code snippets licensed under MIT, unless otherwise noted.</small></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"slug":"2018-01-11-reading-futures-await","title":"memo:reading futures-await","categories":["Code Reading"],"image":"https://koka831.github.io/img/icon.png","tags":["Rust"],"content":"\u003cp\u003e\u003ca href=\"https://github.com/alexcrichton/futures-rs\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003efutures-rs\u003c/a\u003e is a libary allows zero cost abstruction of state machine; \u003ccode\u003eFuture\u003c/code\u003e trait in Rust.\u003c/p\u003e\n\u003cp\u003efutures-await provides Async/await syntax for \u003ccode\u003efutures-rs\u003c/code\u003e.\u003c/p\u003e\n\u003ch2 id=\"async\"\u003e\u003ca href=\"#async\"\u003e#[async]\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003emake it returns future instead of result.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-rust\"\u003e\u003ccode class=\"language-rust\"\u003e\u003cspan class=\"token attribute attr-name\"\u003e#[async]\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// tagged with #[async] option\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003efn\u003c/span\u003e \u003cspan class=\"token function-definition function\"\u003efetch\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ec\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eClient\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e-\u003e\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eResult\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eT\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e res \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eawait\u003c/span\u003e\u003cspan class=\"token operator\"\u003e!\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e?\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// Optional\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token operator\"\u003e!\u003c/span\u003eres\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003estatus\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eis_success\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// Err }\u003c/span\u003e\n\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2 id=\"async_stream\"\u003e\u003ca href=\"#async_stream\"\u003e#[async_stream]\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003estream instead of future\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-rust\"\u003e\u003ccode class=\"language-rust\"\u003e\u003cspan class=\"token attribute attr-name\"\u003e#[async_stream(item=T)]\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e s \u003cspan class=\"token keyword\"\u003ein\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eT\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e...\u003c/span\u003e\n  \u003cspan class=\"token macro property\"\u003estream_yield!\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eawait\u003c/span\u003e\u003cspan class=\"token operator\"\u003e!\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e..\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2 id=\"await-macro\"\u003e\u003ca href=\"#await-macro\"\u003eawait! macro\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003ccode\u003eawait!\u003c/code\u003e macro allows blocking the procedure until completion, not blocking the thread.\u003c/p\u003e\n\u003cp\u003eit behaves like a function returns \u003ccode\u003eResult(e)\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003ehere is a brief procedure of \u003ccode\u003eawait!\u003c/code\u003e macro.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-rust\"\u003e\u003ccode class=\"language-rust\"\u003e\u003cspan class=\"token macro property\"\u003emacro_rules!\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eawait\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e \u003cspan class=\"token keyword\"\u003emut\u003c/span\u003e future \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$e\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003eloop\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003ematch\u003c/span\u003e \u003cspan class=\"token function\"\u003epoll\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x26;\u003c/span\u003e\u003cspan class=\"token keyword\"\u003emut\u003c/span\u003e future\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token class-name\"\u003eOk\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eReady\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ee\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ebreak\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eOk\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ee\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"token class-name\"\u003eOk\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eNotReady\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// continue and wait\u003c/span\u003e\n      \u003cspan class=\"token class-name\"\u003eErr\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ee\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eErr\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ee\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token comment\"\u003e// block until NotReady -\u003e Ready(e)\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003eyield\u003c/span\u003e \u003cspan class=\"token namespace\"\u003efutures\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eAsync\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eNotReady\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2 id=\"async_block-macro\"\u003e\u003ca href=\"#async_block-macro\"\u003easync_block! macro\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003eit doesn't need a dedicated function like \u003ccode\u003e#[async]\u003c/code\u003e, (I think it's a like \u003ccode\u003ethread::spawn()\u003c/code\u003e, so it can be run with \u003ccode\u003ecore.run(Fn(async_block!))\u003c/code\u003e)\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-rust\"\u003e\u003ccode class=\"language-rust\"\u003e\u003cspan class=\"token keyword\"\u003epub\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efn\u003c/span\u003e \u003cspan class=\"token function-definition function\"\u003espawn\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eF\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eT\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ef\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eF\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e-\u003e\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eJoinHandle\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eT\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003ewhere\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eF\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eFnOnce\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e-\u003e\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eT\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token class-name\"\u003eF\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eSend\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token lifetime-annotation symbol\"\u003e'static\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eT\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eSend\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token lifetime-annotation symbol\"\u003e'static\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003ehere's the brief internal procedure of async_block macro.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-rust\"\u003e\u003ccode class=\"language-rust\"\u003e\u003cspan class=\"token attribute attr-name\"\u003e#[proc_macro]\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003efn\u003c/span\u003e \u003cspan class=\"token function-definition function\"\u003easync_block\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eTokenStream\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e-\u003e\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eTokenStream\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token comment\"\u003e// input -\u003e TokenTree -\u003e TokenStream -\u003e parse -\u003e TokenStream\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e input \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eTokenStream\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003cspan class=\"token function\"\u003efrom\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eTokenTree\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e...\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e// parse input as token node\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e...\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e kind\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eTokenNode\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eGroup\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eDelimiter\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eBrace\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e i\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n  \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e expr \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token namespace\"\u003esyn\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eparse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003einput\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n  \u003cspan class=\"token comment\"\u003e// token construction..\u003c/span\u003e\n  token\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003einto\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// return Stream\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2 id=\"nightly-features\"\u003e\u003ca href=\"#nightly-features\"\u003enightly features\u003c/a\u003e\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/rust-lang/rust/issues/43122\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003egenerators\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/rust-lang/rust/issues/35896\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eproc_macro\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/rust-lang/rust/issues/42183\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003econservative_impl_trait\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e","description":"memo","commits":[{"title":"copy md","date":"2021-01-30 22:18:17","hash":"35b550ae","diff":"\u003cdiv class=\"remark-highlight\"\u003e\u003cpre data-file=\"35b550ae.patch\" class=\"language-git  language-diff\"\u003e\u003ccode class=\"language-git\"\u003e\u003cspan class=\"token commit-sha1\"\u003ecommit 35b550ae83af4efaeadf33471c8ca8a32c1079c8\u003c/span\u003e\nAuthor: koka \u0026#x26;\u003ca href=\"mailto:lt;koka.code@gmail.com\" class=\"token email-link\"\u003elt;koka.code@gmail.com\u003c/a\u003e\u0026#x26;gt;\nDate:   Sat Jan 30 22:18:17 2021 +0900\n\n  copy md\n\ndiff --git a/_posts/2018-01-11-reading-futures-await.md b/_posts/2018-01-11-reading-futures-await.md\nnew file mode 100644\nindex 0000000..6e034f0\n\u003cspan class=\"token deleted\"\u003e--- /dev/null\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+++ b/_posts/2018-01-11-reading-futures-await.md\u003c/span\u003e\n\u003cspan class=\"token coord\"\u003e@@ -0,0 +1,93 @@\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+---\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+title: memo:reading futures-await\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+date: 2018-01-11\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+categories:\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- Code Reading\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+tags:\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  - Rust\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+description: memo\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+---\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+[futures-rs](https://github.com/alexcrichton/futures-rs) is a libary allows zero cost abstruction of state machine; `Future` trait in Rust.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+futures-await provides Async/await syntax for `futures-rs`.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+## #[async]\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+make it returns future instead of result.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```rust\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+#[async] // tagged with #[async] option\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+fn fetch(c: Client) -\u0026#x26;gt; Result\u0026#x26;lt;T\u0026#x26;gt; {\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  let res = await!()?; // Optional\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  if !res.status().is_success() { // Err }\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+}\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+## #[async_stream]\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+stream instead of future\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```rust\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+#[async_stream(item=T)]\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+for s in T {\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  ...\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  stream_yield!(await!(..))\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+}\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+## await! macro\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+`await!` macro allows blocking the procedure until completion, not blocking the thread.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+it behaves like a function returns `Result(e)`\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+here is a brief procedure of `await!` macro.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```rust\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+macro_rules! await {\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  let mut future = $e\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  loop {\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    match poll(\u0026#x26;mut future) {\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+      Ok(Ready(e)) =\u0026#x26;gt; break Ok(e),\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+      Ok(NotReady) =\u0026#x26;gt; {}, // continue and wait\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+      Err(e) =\u0026#x26;gt; Err(e)\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    }\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  }\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  // block until NotReady -\u0026#x26;gt; Ready(e)\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  yield futures::Async::NotReady\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+}\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+## async_block! macro\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+it doesn't need a dedicated function like `#[async]`, (I think it's a like `thread::spawn()`, so it can be run with `core.run(Fn(async_block!))`)\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```rust\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+pub fn spawn\u0026#x26;lt;F, T\u0026#x26;gt;(f: F) -\u0026#x26;gt; JoinHandle\u0026#x26;lt;T\u0026#x26;gt;\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  where F: FnOnce() -\u0026#x26;gt; T,\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  F: Send + 'static, T: Send + 'static\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+here's the brief internal procedure of async_block macro.\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```rust\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+#[proc_macro]\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+fn async_block(i: TokenStream) -\u0026#x26;gt; TokenStream {\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  // input -\u0026#x26;gt; TokenTree -\u0026#x26;gt; TokenStream -\u0026#x26;gt; parse -\u0026#x26;gt; TokenStream\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  let input = TokenStream::from(TokenTree {...,\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    // parse input as token node\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+    ..., kind: TokenNode::Group(Delimiter::Brace, i)})\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  let expr = syn::parse(input)\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  // token construction..\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+  token.into() // return Stream\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+}\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\\```\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+## nightly features\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- [generators](https://github.com/rust-lang/rust/issues/43122)\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- [proc_macro](https://github.com/rust-lang/rust/issues/35896)\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+- [conservative_impl_trait](https://github.com/rust-lang/rust/issues/42183)\u003c/span\u003e\n\u003cspan class=\"token inserted\"\u003e+\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e"}],"publishedAt":"2018-01-11","updatedAt":"2021-01-30"}},"__N_SSG":true},"page":"/archives/[slug]","query":{"slug":"2018-01-11-reading-futures-await"},"buildId":"eMY6Po_c-RqT9Ravp8enm","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>